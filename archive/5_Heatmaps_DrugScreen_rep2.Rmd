---
title: "Validating hits from the epigenetic screening"
author: "Max Trauernicht"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    code.folding: show
    highlight: monochrome
    theme: journal
    toc: yes
    toc_float: yes
  word_document:
    toc: yes
  pdf_document:
    toc: yes
  editor_options:
    chunk_output_type: inline
---

# knitr document van Steensel lab

# Epigenetic Screening

# Introduction
This script tries to find out which drugs are able to significantly alter indel pattern formation in RSTP2#5 cells in different chromatin contexts. In the end, the aim is to couple biological relevance to these changes.

## Description of Data
How to make a good rendering table: 
```{r table1, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
tabl <- "
| column1	|	column2	|	column3	|	
|----|----|----|
|1	|	2	|	3	|	
|a	|	b	|	c	|	
"
cat(tabl) # output the table in a format good for HTML/PDF/docx conversion
```

# Data processing
## Path, Libraries, Parameters and Useful Functions
```{r setup, echo = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE)
StartTime <-Sys.time()

# 8-digit Date tag:
Date <- substr(gsub("-","",Sys.time()),1,8) 
# libraries:
library(tidyverse)
library(outliers)
library(ggplot2)
library(ggbeeswarm)
library(data.table)
library(circlize)
library(pheatmap)
library(gridGraphics)
library(gridExtra)
library(RColorBrewer)
library(VennDiagram)
library(ggforce)
library(ggpubr)
```

### Custom functions
Functions used thoughout this script.
```{r functions, echo = FALSE, warning = FALSE}
SetFileName <- function(filename, initials) {
  # Set filename with extension and initials to make filename with date integrated.
  filename <- substitute(filename)
  initials <- substitute(initials)
  filename <- paste0(initials, Date, filename)
  filename
}
```


## Data import
```{r Data Import, echo = FALSE, warning = FALSE}
file_list = list.files("/DATA/projects/DSBrepair/data/R/rs20210813_episcreen_2", full.names = TRUE)
file_list
episcreen_indels = readRDS(file_list[[1]])
episcreen_ratios_split = readRDS(file_list[[2]])
episcreen_ratios = readRDS(file_list[[3]])
validations_indels = readRDS(file_list[[4]])
validations_ratios = readRDS(file_list[[5]])

# # Import data from 5_HitValidation_drugScreen.Rmd
setwd("/DATA/usr/m.trauernicht/projects/EpiScreen/files_scripts/")
mapping_mean <- get(load("mt20190510_mapping_mean"))
indel.data <- get(load("mt20210608_indel.data"))
mapping_mean_long <- get(load("mt20190510_mapping_mean_long"))
chip_dendogram <- get(load("mt20190510_chip_dendogram"))
mapping_mean_all <- get(load("mt20190329_mapping_mean_all"))
barcode.order <- read.table("barcode_order.txt", header = T)
# 
# setwd("/DATA/projects/DSBrepair/scratch/")
# delay.df <- read.table("cl20190329_minus7_delay.tsv", header = T)
```
## Annotate heatmap columns and rows
```{r}
# Row annotation: annotate drugs with the target group
target <- episcreen_ratios %>% 
  filter(!target %in% c("Negative Control", "MRN", "DNA-PK")) %>% 
  distinct(drug, target) %>% 
  column_to_rownames(var="drug")



chromatin <- readRDS(
  "/DATA/usr/x.vergara/XV_ChIPIndels/XV20200902_DDR_RS_revision/XV20200902_DDR_RS_revision/data/xv20200915_DDR_data_CHIP.rds") %>% 
  distinct(barcode, chromatin) %>%
  left_join(distinct(episcreen_ratios, barcode, IPR)) %>%
  filter(IPR != "<NA>") %>% 
  select(-barcode) %>%
  column_to_rownames(var="IPR")

chrom_colors2 = c("Euchromatin" = "#F7941D", 
                     "other-heterochromatin" = "#838687",  
                     "H3K27me3" = "#D21F8A", 
                     "Triple Heterochromatin" = "#662D91")



# Change colors of annotations
colors <- brewer.pal(length(unique(barcode.annotation$cluster)), "Pastel2")
names(colors) <- unique(barcode.annotation$cluster)

annotation_colors_scr = list(
  chromatin = chrom_colors2,
  type = c(Active="#669966", Repressive="grey90"),
  target = c(HDAC="#60988D", HAT="#C6D0A8", Sirtuin="#8FCAAC",
             HMT="#FDCDAC", DNMT="#D69C81", `Histone Demethylase`="#FFF2AE",
             HIF="#E3DCD5", JAK="#C8D7E2", PIM="#9AB8C4", `Aurora Kinase`="#F4CAE4",
             PARP="#CB546F", `Epigenetic Reader Domain`= "#476D61", `DNA-PK`="#E07A43"
             ))



# Order the annotation legend
ordered_marks <- c("Euchromatin", 
                     "other-heterochromatin",  
                     "H3K27me3", 
                     "Triple Heterochromatin")

annotation_colors_scr$chromatin <- annotation_colors_scr$chromatin[ordered_marks]

ordered_marks2 <- c("DNA-PK","Epigenetic Reader Domain", "HDAC",  "Sirtuin", "HAT", 
                    "Histone Demethylase", "HMT", "DNMT", 
                    "HIF", "JAK", "PIM",
                    "Aurora Kinase", "PARP")
annotation_colors_scr$target <- annotation_colors_scr$target[ordered_marks2]
```

# Quick validation plot
```{r}
validations_ratios %>% 
  filter(drug %in% c("DMSO", "Vorinostat"),
         plasmid == "LBR2", 
         replicate == "mean") %>% 
  distinct(barcode, drug, MMEJ_MMEJNHEJ, HDAC1, H3K27me3) %>% 
  group_by(barcode) %>% 
  pivot_wider(names_from = drug, values_from = MMEJ_MMEJNHEJ) %>%
  mutate(MMEJ_diff = Vorinostat - DMSO,
         MMEJ_ratio = Vorinostat - DMSO) %>%
  ungroup() %>%
  ggplot(., aes(HDAC1, MMEJ_diff, color = H3K27me3)) + geom_point() +
geom_smooth(method= "loess") +
stat_cor(method = "spearman", label.x.npc = "center", label.y.npc = "top")



tib.model = validations_ratios %>% 
  filter(drug %in% c("DMSO", "Vorinostat"),
         plasmid == "LBR2", 
         replicate == "mean") %>% 
  distinct(barcode, drug, MMEJ_MMEJNHEJ, CTCF, EZH2, 
           H2AFZ, H3K27ac, H3K27me3, H3K36me3,
           H3K4me1, H3K4me2, H3K4me3, H3K79me2, H3K9me2, 
           H4K5acK8ac, HDAC1, HDAC2, HDAC3, POL2,
           POL2AS2, SMC3 , LMNB1, Dam,  DNAse ,   
           m5C, late_replicating,  TTseq) %>% 
  pivot_wider(names_from = drug, values_from = MMEJ_MMEJNHEJ) %>%
  mutate(MMEJ_diff = Vorinostat - DMSO,
         MMEJ_ratio = Vorinostat - DMSO) %>% 
  dplyr::select(-barcode, -Vorinostat, -DMSO) %>%
  filter(!is.na(MMEJ_diff))


y <- "MMEJ_diff"
x <- names(tib.model)[!names(tib.model) %in% y]
mymodel <- as.formula(paste(y, paste(x, collapse="+"), sep="~"))


mymodel <- MMEJ_diff ~ HDAC1
mymodel <- MMEJ_diff ~ H3K27me3
mymodel <- MMEJ_diff ~ H3K27ac

mymodel <- MMEJ_diff ~ H3K4me1

vorino_model <-lm(mymodel, data = tib.model)

get_regression_table(vorino_model, conf.level = 0.99)


vorino_model <- glm(MMEJ_diff~ , data = tib.model, family = 'binomial')
tib.model

```



```{r}
chip.mat = episcreen_ratios %>% distinct(IPR, CTCF, EZH2, H2AFZ, H3K27ac, H3K27me3, H3K36me3,
                                         H3K4me1, H3K4me2, H3K4me3, H3K79me2, H3K9me2, 
                                         H4K5acK8ac, HDAC1, HDAC2, HDAC3, POL2,
                                         POL2AS2, SMC3 , LMNB1, Dam,  DNAse ,   
                                         m5C, late_replicating,  TTseq) %>% 
  column_to_rownames(var="IPR") %>%
  as.matrix()

tree = pheatmap(chip.mat,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(500),
         annotation_colors = annotation_colors_scr, 
         border_color = "black", 
         annotation_row = chromatin, 
         cellwidth = 8, 
         cellheight = 12, 
         scale = "column")

tree

drugs100 = episcreen_ratios %>%
  filter(concentration == 100, sample == "drug", abs(MMEJ_zscore) > 4) %>% pull(drug) %>% unique()

drugs100

# Same as above, but using logratio data for each IPR vs each drug
ratios_mmej_score <- episcreen_ratios %>%
  filter(drug %in% drugs100) %>%
  dplyr::select(IPR, replicate, drug, concentration, MMEJ_zscore) %>%
  unique() %>%
  pivot_wider(values_from = MMEJ_zscore, names_from = drug)

mmej.mat = ratios_mmej_score %>%
  filter(concentration == 100, replicate == "E1504") %>%
  select_if(~all(!is.na(.))) %>%
  # remove_rownames %>%
  column_to_rownames(var="IPR") %>%
  select(-concentration, -replicate) %>%
  as.matrix(.)

paletteLength <- 400

myBreaks <- c(seq(min(mmej.mat), 0, length.out=ceiling(paletteLength/2) + 1),
              seq(-min(mmej.mat)/paletteLength, -min(mmej.mat), length.out=floor(paletteLength/2)))

colors_filter = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(400)

colors_filter[between(myBreaks, -3, 3)] = "gray80"

pheatmap(mmej.mat,
         color = colors_filter,
         breaks = myBreaks,
         annotation_col = target,
         cluster_rows = tree$tree_row,
         annotation_colors = annotation_colors_scr, 
         border_color = "black", 
         annotation_row = chromatin, 
         cellwidth = 8, 
         cellheight = 12)



# Same as above, but using logratio data for each IPR vs each drug
ratios_eff_score <- episcreen_ratios %>%
  filter(drug %in% drugs100) %>%
  dplyr::select(IPR, replicate, drug, concentration, freqCut_norm ) %>%
  unique() %>%
  pivot_wider(values_from = freqCut_norm, names_from = drug)

eff.mat = ratios_eff_score %>%
  filter(concentration == 100, replicate == "E1504") %>%
  select_if(~all(!is.na(.))) %>%
  # remove_rownames %>%
  column_to_rownames(var="IPR") %>%
  select(-concentration, -replicate) %>%
  as.matrix(.)

paletteLength <- 400

myBreaks <- c(seq(min(eff.mat), 1, length.out=ceiling(paletteLength/2)),
              seq(1, max(eff.mat), length.out=floor(paletteLength/2)))[-201]

colors_filter = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(400)

colors_filter[between(myBreaks, .95, 1.05)] = "gray80"

pheatmap(eff.mat,
         color = colors_filter,
         breaks = myBreaks,
         annotation_col = target,
         cluster_rows = tree$tree_row,
         annotation_colors = annotation_colors_scr, 
         border_color = "black", 
         annotation_row = chromatin, 
         cellwidth = 8, 
         cellheight = 12)

```



## Bring dataframe to heatmap plotting format
```{r transform_1, echo = FALSE, warning = FALSE}
# Split up per concentration
indel.data.high <- indel.data %>% filter(concentration == "10")
indel.data.med <- indel.data %>% filter(concentration == "1")
indel.data.low <- indel.data %>% filter(concentration == "100")


# dplyr::select columns and transform to wide format - efficiency heatmap
## High conc
indel.data.high.eff <- indel.data.high %>% dplyr::select(IPR, drug, freqCut_norm_mean) %>% 
  unique() %>% dcast(IPR ~ drug, value.var = "freqCut_norm_mean") %>% 
  remove_rownames %>% column_to_rownames(var="IPR")

## Med conc
indel.data.med.eff <- indel.data.med %>% dplyr::select(IPR, drug, freqCut_norm_mean) %>% 
  unique() %>% dcast(IPR ~ drug, value.var = "freqCut_norm_mean") %>% 
  remove_rownames %>% column_to_rownames(var="IPR")

## Low conc
indel.data.low.eff <- indel.data.low %>% dplyr::select(IPR, drug, freqCut_norm_mean) %>% 
  unique() %>% dcast(IPR ~ drug, value.var = "freqCut_norm_mean") %>% 
  remove_rownames %>% column_to_rownames(var="IPR")



# Same as above, but using logratio data for each IPR vs each drug
indel.data.high.drug <- indel.data.high %>% dplyr::select(IPR, drug, MMEJ_zscore_mean) %>%
  unique() %>% dcast(IPR ~ drug, value.var="MMEJ_zscore_mean") %>% 
  remove_rownames %>% column_to_rownames(var="IPR")

indel.data.med.drug <- indel.data.med %>% dplyr::select(IPR, drug, MMEJ_zscore_mean) %>%
  unique() %>% dcast(IPR ~ drug, value.var="MMEJ_zscore_mean") %>% 
  remove_rownames %>% column_to_rownames(var="IPR")

indel.data.low.drug <- indel.data.low %>% dplyr::select(IPR, drug, MMEJ_zscore_mean) %>%
  unique() %>% dcast(IPR ~ drug, value.var="MMEJ_zscore_mean") %>% 
  remove_rownames %>% column_to_rownames(var="IPR")

```







Next, I want to create heatmaps to visualize the effect of each individual drug on each of the 18 barcodes.

\newpage
# Results
## logratio heatmap of each individual drug vs. barcode
```{r visualization each drug, out.width= "100%", fig.align= "center", echo=FALSE}
## Every drug
# Keeping the scale in the pheatmap function
myBreaks1 <- seq(-5,5,0.1)

# pheatmap function: logratio heatmap of each individual drug vs. barcode - 10uM drugs added
pheatmap(as.matrix(indel.data.high.drug),
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
         cluster_rows = chip_dendogram$tree_col, 
         labels_row = c("Integration 15","Integration 1","Integration 5","Integration 6",
                        "Integration 10","Integration 9","Integration 13","Integration 3",
                        "Integration 17","Integration 16","Integration 18", "Integration 4",
                        "Integration 11","Integration 7","Integration 12", "Integration 14",
                        "Integration 8","Integration 2"))
```
## This heatmap contains too much information -> We need to decrease the number of drugs
\newpage
## Only drugs with significant effects
```{r visualization essential drugs, out.width= "100%", fig.align= "center", echo=FALSE}
## Only drugs that change ratio
# pheatmap function: without DNA-PKi: logratio heatmap of eac a certain fold change
indel.data.high.drug[is.na(indel.data.high.drug)] <- 0
indel.data.high.drug.ess <- indel.data.high.drug[sapply(indel.data.high.drug, function(x) any(x > 3) | any(x < -6))]

# Keeping the scale in the pheatmap function
myBreaks3 <- c(seq(min(as.matrix(indel.data.high.drug.ess)), 0, 
                   length.out=ceiling(100/2) + 1), 
              seq(max(as.matrix(indel.data.high.drug.ess))/100, 
                  max(as.matrix(indel.data.high.drug.ess))/2, length.out=floor(100/2)))
myBreaks4 <- seq(-6, 6, 0.12)

pheatmap(as.matrix(indel.data.high.drug.ess),
         annotation_col = target,   
         annotation_row = barcode.annotation,
         color = colorRampPalette(brewer.pal(n = 7, name = "RdBu"))(100),
         cluster_rows = chip_dendogram$tree_col,
         annotation_colors = annotation_colors_scr, annotation_legend = F,
         breaks = myBreaks4,
         cellwidth = 14, cellheight = 14,
         border_color = "black",
         main = "MMEJ z-score change - 10uM of drugs added")


# pheatmap function: without DNA-PKi: logratio heatmap of each individual drug vs. barcode - 1uM drugs added- include only drugs that achieve a certain fold change
indel.data.med.drug[is.na(indel.data.med.drug)] <- 0
indel.data.med.drug.ess <- indel.data.med.drug[sapply(indel.data.med.drug, function(x) any(x > 3) | any(x < -3.5))]



myBreaks3 <- c(seq(min(as.matrix(indel.data.med.drug.ess)), 0, 
                   length.out=ceiling(100/2) + 1), 
              seq(max(as.matrix(indel.data.med.drug.ess))/100, 
                  max(as.matrix(indel.data.med.drug.ess))/2, length.out=floor(100/2)))


pheatmap(as.matrix(indel.data.med.drug.ess),
         annotation_col = target,   
         annotation_row = barcode.annotation,
         color = colorRampPalette(brewer.pal(n = 7, name = "RdBu"))(100),
         cluster_rows = chip_dendogram$tree_col,
         annotation_colors = annotation_colors_scr, annotation_legend = F,
         cellwidth = 14, cellheight = 14,
         breaks = myBreaks4,
         border_color = "black",
         main = "MMEJ z-score change - 1uM of drugs added")


# pheatmap function: without DNA-PKi: logratio heatmap of each individual drug vs. barcode - 100nM drugs added - include only drugs that achieve a certain fold change
indel.data.low.drug[is.na(indel.data.low.drug)] <- 0
indel.data.low.drug.ess <- indel.data.low.drug[sapply(indel.data.low.drug, function(x) any(x > 2) | any(x < -2))]

myBreaks4 <- c(seq(min(as.matrix(indel.data.low.drug.ess)), 0, 
                   length.out=ceiling(100/2) + 1), 
              seq(max(as.matrix(indel.data.low.drug.ess))/100, 
                  max(as.matrix(indel.data.low.drug.ess))/2, length.out=floor(100/2)))


pheatmap(as.matrix(indel.data.low.drug.ess),
         annotation_col = target,   
         annotation_row = barcode.annotation,
         color = colorRampPalette(brewer.pal(n = 7, name = "RdBu"))(100),
         cluster_rows = chip_dendogram$tree_col,
         annotation_colors = annotation_colors_scr, annotation_legend = F,
         cellwidth = 14, cellheight = 14,
         breaks = myBreaks4,
         border_color = "black",
         main = "MMEJ z-score change - 100nM of drugs added")

```

## Now plot the same for the efficiency
```{r visualization efficiency, out.width= "100%", fig.align= "center", echo=FALSE}
# Efficiency change heatmap - 10 uM
myBreaks5 <- seq(0.8, 1.2, 0.04)

pheatmap(as.matrix(indel.data.high.eff), fontsize_col = 8, fontsize_row = 8, cellheight = 8,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
         main = "efficiency change - 10uM of drugs added")


# Efficiency change heatmap - 10 uM - only essentials
indel.data.high.eff.ess <- indel.data.high.eff[, colSums(indel.data.high.eff > 1.1) >= 1 |
                            colSums(indel.data.high.eff < 0.9) >= 1]

myBreaks6 <- c(seq(min(as.matrix(indel.data.high.eff.ess))/1.5, 0, 
                   length.out=ceiling(100/2) + 1), 
              seq(max(as.matrix(indel.data.high.eff.ess))/100, 
                  max(as.matrix(indel.data.high.eff.ess))/1.5, length.out=floor(100/2)))

pheatmap(as.matrix(indel.data.high.eff.ess),
         annotation_col = target,   
         annotation_row = barcode.annotation,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
         cluster_rows = chip_dendogram$tree_col,
         annotation_colors = annotation_colors_scr, annotation_legend = F,
         cellwidth = 14, cellheight = 14,
         border_color = "black",
         labels_row = c("Integration 15","Integration 1","Integration 5","Integration 6",
                        "Integration 10","Integration 9","Integration 13","Integration 3",
                        "Integration 17","Integration 16","Integration 18", "Integration 4",
                        "Integration 11","Integration 7","Integration 12", "Integration 14",
                        "Integration 8","Integration 2"),
         main = "efficiency change - 10uM of drugs added")


# Efficiency change heatmap - 1 uM
indel.data.med.eff.ess <- indel.data.med.eff[, colSums(indel.data.med.eff > 1.1) >= 1 | 
                           colSums(indel.data.med.eff < 0.9) >= 1]

myBreaks7 <- c(seq(min(as.matrix(indel.data.med.eff.ess))/1.5, 0, 
                   length.out=ceiling(100/2) + 1), 
              seq(max(as.matrix(indel.data.med.eff.ess))/100, 
                  max(as.matrix(indel.data.med.eff.ess))/1.5, length.out=floor(100/2)))

pheatmap(as.matrix(indel.data.med.eff.ess), 
         annotation_col = target, 
         annotation_row = barcode.annotation,annotation_legend = F,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
         cluster_rows = chip_dendogram$tree_col,
         annotation_colors = annotation_colors_scr, 
         cellwidth = 14, cellheight = 14,
         border_color = "black",
         labels_row = c("Integration 15","Integration 1","Integration 5","Integration 6",
                        "Integration 10","Integration 9","Integration 13","Integration 3",
                        "Integration 17","Integration 16","Integration 18", "Integration 4",
                        "Integration 11","Integration 7","Integration 12", "Integration 14",
                        "Integration 8","Integration 2"),
         main = "efficiency change - 1uM of drugs added")


# Efficiency change heatmap - 100 nM
indel.data.low.eff.ess <- indel.data.low.eff[, colSums(indel.data.low.eff > 1.1) >= 1 | colSums(indel.data.low.eff < 0.9) >= 1]

myBreaks8 <- c(seq(min(as.matrix(indel.data.low.eff.ess))/1.5, 0, 
                   length.out=ceiling(100/2) + 1), 
              seq(max(as.matrix(indel.data.low.eff.ess))/100, 
                  max(as.matrix(indel.data.low.eff.ess))/1.5, length.out=floor(100/2)))

pheatmap(as.matrix(indel.data.low.eff.ess), 
         annotation_col = target,
         annotation_row = barcode.annotation, annotation_legend = F,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
         cluster_rows = chip_dendogram$tree_col,
         annotation_colors = annotation_colors_scr, 
         cellwidth = 14, cellheight = 14,
         border_color = "black",
         labels_row = c("Integration 15","Integration 1","Integration 5","Integration 6",
                        "Integration 10","Integration 9","Integration 13","Integration 3",
                        "Integration 17","Integration 16","Integration 18", "Integration 4",
                        "Integration 11","Integration 7","Integration 12", "Integration 14",
                        "Integration 8","Integration 2"),
         main = "efficiency change - 100nM of drugs added")
```


\newpage
## Heatmap for one certain target group
```{r}
# Annotate heatmaps with drug targets to display only certain drug target groups
## target.logratio.high
indel.data.high.drug2 <- rownames_to_column(indel.data.high.drug, "barcode") %>% 
  melt() %>% dcast(variable ~ barcode, value.var = "value")
targets <- unique(data.frame(indel.data %>% dplyr::select(target, drug))) %>% 
  setnames(old = "drug", new = "variable")
indel.data.high.drug2 <- merge(indel.data.high.drug2, targets) %>% 
  remove_rownames %>% column_to_rownames(var="variable")
target.logratio.high <- indel.data.high.drug2[-grep("Negative control|MRN|DNA-PK",indel.data.high.drug2$target),]

## target.logratio.med
indel.data.med.drug2 <- rownames_to_column(indel.data.med.drug, "barcode") %>% 
  melt() %>% dcast(variable ~ barcode, value.var = "value")
indel.data.med.drug2 <- merge(indel.data.med.drug2, targets) %>% 
  remove_rownames %>% column_to_rownames(var="variable")
target.logratio.med <- indel.data.med.drug2[-grep("Negative control|MRN|DNA-PK",indel.data.med.drug2$target),]

## target.logratio.low
indel.data.low.drug2 <- rownames_to_column(indel.data.low.drug, "barcode") %>% 
  melt() %>% dcast(variable ~ barcode, value.var = "value")
indel.data.low.drug2 <- merge(indel.data.low.drug2, targets) %>% 
  remove_rownames %>% column_to_rownames(var="variable")
target.logratio.low <- indel.data.low.drug2[-grep("Negative control|MRN|DNA-PK",indel.data.low.drug2$target),]

## target.efficiency.high
indel.data.high.eff2 <- rownames_to_column(indel.data.high.eff, "barcode") %>% 
  melt() %>% dcast(variable ~ barcode, value.var = "value")
indel.data.high.eff2 <- merge(indel.data.high.eff2, targets) %>% 
  remove_rownames %>% column_to_rownames(var="variable")
target.eff.high <- indel.data.high.eff2[-grep("Negative control|MRN|DNA-PK",indel.data.high.eff2$target),]

## target.efficiency.med
indel.data.med.eff2 <- rownames_to_column(indel.data.med.eff, "barcode") %>% 
  melt() %>% dcast(variable ~ barcode, value.var = "value")
indel.data.med.eff2 <- merge(indel.data.med.eff2, targets) %>% 
  remove_rownames %>% column_to_rownames(var="variable")
target.eff.med <- indel.data.med.eff2[-grep("Negative control|MRN|DNA-PK",indel.data.med.eff2$target),]

## target.efficiency.low
indel.data.low.eff2 <- rownames_to_column(indel.data.low.eff, "barcode") %>% 
  melt() %>% dcast(variable ~ barcode, value.var = "value")
indel.data.low.eff2 <- merge(indel.data.low.eff2, targets) %>% 
  remove_rownames %>% column_to_rownames(var="variable")
target.eff.low <- indel.data.low.eff2[-grep("Negative control|MRN|DNA-PK",indel.data.low.eff2$target),]


# Choose from the above dfs what you want to display

## Only dplyr::select HDACs
target.plot <- target.eff.med[target.eff.med$target=="HDAC",] %>% 
  dplyr::select(-target) %>% t()

# Generate pheatmap
# Use myBreaks5 for efficiency heatmap, myBreaks1 for logratio heatmap
pheatmap(as.matrix(target.plot), 
         annotation_col = target, 
         annotation_row = barcode.annotation,annotation_legend = F,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
         breaks = myBreaks5, cluster_rows = chip_dendogram$tree_col,
         annotation_colors = annotation_colors_scr, 
         cellwidth = 14, cellheight = 14,
         labels_row = c("Integration 15","Integration 1","Integration 5","Integration 6",
                        "Integration 10","Integration 9","Integration 13","Integration 3",
                        "Integration 17","Integration 16","Integration 18", "Integration 4",
                        "Integration 11","Integration 7","Integration 12", "Integration 14",
                        "Integration 8","Integration 2"),
         main = "logratio change - 1uM of drugs added - HDACs only")
```


\newpage
## Efficiency/logratio overlay
```{r visualization overlay efficiency logratio, out.width= "100%", fig.align= "center", echo=FALSE}
# Draw venn diagram to see overlaps between efficiency and logratio outliers
## Calculate the intersections
colnames.logr <- as.data.frame(colnames((indel.data.med.drug.ess)))
setnames(colnames.logr, "colnames((indel.data.med.drug.ess))", "drug")

colnames.eff <- as.data.frame(colnames((indel.data.med.eff.ess)))
setnames(colnames.eff, "colnames((indel.data.med.eff.ess))", "drug")

hdac <- targets[targets$target == "HDAC",]

colnames.logr <- unique(colnames.logr[colnames.logr$drug %in% hdac$variable,])
colnames.eff <- unique(colnames.eff[colnames.eff$drug %in% hdac$variable,])

z <- intersect(colnames.logr, colnames.eff)


# Draw the diagrams
## HDACs overlap
draw.pairwise.venn(length(colnames.logr), 
                   length(colnames.eff), 
                   length(z),
                   category = c("1uM HDACs with altered logratio", "1 uM HDACs with altered efficiency"), 
                   fill = c("blue", "red"), cat.pos = c(2,2))
```



Next step is to import the chromatin data to generate a correlation matrix between the logratio change of each drug and the chromatin data. A correlation is calculated by comparing logratio changes of drug A for each barcode with ChIP data of ChIP dataset A for each barcode etc.

## Correlation between ChIP data and logratio changes
```{r correlation chip logratio, out.width= "100%", fig.align= "center", echo=FALSE}
# Import chromatin data
mapping_mean_chip <- as.data.frame(mapping_mean) %>% rownames_to_column("ChIP")
chip_data <- melt(mapping_mean_chip, variable.name="barcode", value.name="mean") %>% 
  dcast(barcode ~ ChIP, value.var = "mean")
chip_data <- chip_data[chip_data$barcode != 
                         "ACCCCTAAAGGCGCTG" & chip_data$barcode != "CTCTTAATCGCTGCC", ]
chip_data2 <- chip_data %>% 
  remove_rownames %>% column_to_rownames(var="barcode")

## In case I want to include the mean.ratio
mean.ratio <- indel.data[indel.data$drug == "DMSO",] %>% dplyr::select(barcode, ratio) %>%
  mutate(ratio = ave(ratio, barcode, FUN = function(x) mean(x))) %>%
  unique()
chip_data <- merge(chip_data, mean.ratio)


## In case I want to include MMEJ delay 
delay.data <- delay.df[delay.df$clone %in% "5",] %>%
  mutate(replication_timing = ave(fold_difference, barcode, FUN= function(x) mean(x))) %>%
  dplyr::select(barcode, replication_timing) %>% unique()
delay.data <- delay.data[c(-1,-11),]
chip_data <- merge(chip_data, delay.data) %>% 
  remove_rownames %>% column_to_rownames(var="barcode")

## Ratio is influenced by which ChIP datasets?
mean.ratio2 <- mean.ratio %>% remove_rownames %>% column_to_rownames(var="barcode")

cor_ratio <- as.data.frame(t(cor(mean.ratio2, chip_data2))) %>% rownames_to_column("ChIP")
chip_data3 <- chip_data2[,14,drop = F] %>% cbind(chip_data2, mean.ratio2)
cor_ratio_test <- cor.test(chip_data3$LMNB1, chip_data3$ratio)


ggplot(cor_ratio, aes(x = reorder(ChIP,ratio, function(x) -x), y = ratio, fill=ratio)) +
  geom_bar(stat="identity") +
  xlab("ChIP Dataset") + ylab("Pearson Correlation") +
  scale_fill_gradient2(low = "#D67143", high = "#8EBF7A", 
name = "Pearson 
Correlation")+ theme_bw() +
   theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12))+
  labs(title = "Correlation Mean Ratio per Barcode vs. Each ChIP Dataset") 


## Scatterplot
# DNA methylation
dnameth.data <- as.data.frame(chip_data2) %>% rownames_to_column() %>% dplyr::select(DNAse, WGBS)
dnameth.data <- cbind(dnameth.data, mean.ratio2)

ggplot(dnameth.data, aes(x=WGBS, y=ratio))+
  geom_point()+
  geom_smooth(method = lm) +
  labs(title = "Correlation indel ratio vs. DNA methylation (WGBS)") +
  theme_bw()

# LMNB1
lmnb1.data <- as.data.frame(chip_data2) %>% rownames_to_column() %>% dplyr::select(LMNB1)
lmnb1.data <- cbind(lmnb1.data, mean.ratio2)

ggplot(lmnb1.data, aes(x=LMNB1, y=ratio))+
  geom_point()+
  geom_smooth(method = lm) +
  labs(title = "Correlation indel ratio vs. DNA methylation (WGBS)") +
  theme_bw()

# Calculate correlations
cor_chip_indel.high <- cor(chip_data,indel.data.high.drug)
cor_chip_indel.med <- cor(chip_data,indel.data.med.drug)
cor_chip_indel.low <- cor(chip_data,indel.data.low.drug)

# Calculate correlations for efficiency data
cor_chip_indel.high.eff <- cor(chip_data,indel.data.high.eff)
cor_chip_indel.med.eff <- cor(chip_data,indel.data.med.eff)
cor_chip_indel.low.eff <- cor(chip_data,indel.data.low.eff)

# Take only drugs that have correlation of absolute > 0.5 with at least one ChIP dataset
cor_chip_indel.high <-
  cor_chip_indel.high[,
                      colSums(cor_chip_indel.high > 0.7) >= 1 |
                        colSums(cor_chip_indel.high < -0.7) >= 1]

cor_chip_indel.med <-
  cor_chip_indel.med[,
                      colSums(cor_chip_indel.med > 0.7) >= 1 |
                        colSums(cor_chip_indel.med < -0.7) >= 1]

cor_chip_indel.low <-
  cor_chip_indel.low[,
                      colSums(cor_chip_indel.low > 0.7) >= 1 |
                        colSums(cor_chip_indel.low < -0.7) >= 1]

cor_chip_indel.high.eff <-
  cor_chip_indel.high.eff[,
                      colSums(cor_chip_indel.high.eff > 0.7) >= 1 |
                        colSums(cor_chip_indel.high.eff < -0.7) >= 1]

cor_chip_indel.med.eff <-
  cor_chip_indel.med.eff[,
                      colSums(cor_chip_indel.med.eff > 0.7) >= 1 |
                        colSums(cor_chip_indel.med.eff < -0.7) >= 1]

cor_chip_indel.low.eff <-
  cor_chip_indel.low.eff[,
                      colSums(cor_chip_indel.low.eff > 0.7) >= 1 |
                        colSums(cor_chip_indel.low.eff < -0.7) >= 1]

# plotting the correlations
cor.pheatmap <- 
  list(cor_chip_indel.high, cor_chip_indel.med, cor_chip_indel.low)
cor.pheatmap.eff <- 
  list(cor_chip_indel.high.eff, cor_chip_indel.med.eff, cor_chip_indel.low.eff)



for(i in 1:(length(cor.pheatmap))) {
  data <- cor.pheatmap[[i]]
  p <- pheatmap(data, 
         annotation_col = target,
         annotation_row = type,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
         annotation_colors = annotation_colors_scr, annotation_legend = F,
         main = paste(i,"correlation heatmap: ChiP data vs. logratio change per drug"))
  print(p)
}

for(i in 1:(length(cor.pheatmap.eff))) {
  data <- cor.pheatmap.eff[[i]]
p <- pheatmap(data, 
         annotation_col = target,
         annotation_row = type,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
         annotation_colors = annotation_colors_scr, annotation_legend = F,
         main = paste(i,"correlation heatmap: ChiP data vs. efficiency change per drug"))
print(p)
}

```
# There are some interesting drug-induced changes that can be explained by certain chromatin marks - this can be looked at in more detail


## Cluster-specific effects: now, instead of correlating each chromatin mark against drug-induced change, I try to correlate the drug-induced change against the chromatin clusters
```{r cluster_correlation, out.width= "100%", fig.align= "center", echo=FALSE}
# Assign each barcode to a certain cluster
clusters <- as.data.frame(unique(indel.data$barcode)) %>% mutate(cluster = "LAD")
clusters$cluster[clusters$`unique(indel.data$barcode)` == "AGAAAATAATATGACG" |
                   clusters$`unique(indel.data$barcode)` == "TTGAACGCGGGCTCGG"] <- "Active_P.E."
clusters$cluster[clusters$`unique(indel.data$barcode)` == "CCGGGGACGTATGCAC" |
                   clusters$`unique(indel.data$barcode)` == "GCTAACATCACGAATC"] <- "H3K9"
clusters$cluster[clusters$`unique(indel.data$barcode)` == "AGGGCGTAAAATATTT" |
                   clusters$`unique(indel.data$barcode)` == "ATACTATATTTAACGG"|
                   clusters$`unique(indel.data$barcode)` == "TATGGCTGTCGGGTAG"|
                   clusters$`unique(indel.data$barcode)` == "TGTCCCTTAGTACTTT"] <- "Active_G.B."
clusters$cluster[clusters$`unique(indel.data$barcode)` == "CATTTCTGATCAATAA" |
                   clusters$`unique(indel.data$barcode)` == "TGGCCAATATTTGTCT"] <- "No"
clusters$cluster[clusters$`unique(indel.data$barcode)` == "ACTGTCGAGTTGTCCG" |
                   clusters$`unique(indel.data$barcode)` == "GAGCGCGTCACCGGGT"|
                   clusters$`unique(indel.data$barcode)` == "CGGCCTGAAGGTCAGG"|
                   clusters$`unique(indel.data$barcode)` == "GCGCACCCTTTAATTG"] <- "H3K27"

# Change data structure to get a binary cluster classfication matrix
clusters2 <- dcast(clusters, `unique(indel.data$barcode)`~cluster) %>% 
  remove_rownames %>% column_to_rownames(var="unique(indel.data$barcode)")

clusters2[!is.na(clusters2)] <- 1
clusters2[is.na(clusters2)] <- 0
clusters2$Active_G.B. <- as.numeric(clusters2$Active_G.B.)
clusters2$Active_P.E. <- as.numeric(clusters2$Active_P.E.)
clusters2$H3K27 <- as.numeric(clusters2$H3K27)
clusters2$H3K9 <- as.numeric(clusters2$H3K9)
clusters2$LAD <- as.numeric(clusters2$LAD)
clusters2$No <- as.numeric(clusters2$No)

# Compute correlations for clusters
cor.clusters.high <- cor(clusters2, indel.data.high.drug)
cor.clusters.med <- cor(clusters2, indel.data.med.drug)
cor.clusters.low <- cor(clusters2, indel.data.low.drug)

cor.clusters.high.eff <- cor(clusters2, indel.data.high.eff)
cor.clusters.med.eff <- cor(clusters2, indel.data.med.eff)
cor.clusters.low.eff <- cor(clusters2, indel.data.low.eff)

# Take only drugs that have correlation of absolute > 0.5 with at least one ChIP dataset
cor.clusters.high <-
  cor.clusters.high[,
                      colSums(cor.clusters.high > 0.6) >= 1 |
                        colSums(cor.clusters.high < -0.6) >= 1]

cor.clusters.med <-
  cor.clusters.med[,
                      colSums(cor.clusters.med > 0.6) >= 1 |
                        colSums(cor.clusters.med < -0.6) >= 1]

cor.clusters.low <-
  cor.clusters.low[,
                      colSums(cor.clusters.low > 0.6) >= 1 |
                        colSums(cor.clusters.low < -0.6) >= 1]

cor.clusters.high.eff <-
  cor.clusters.high.eff[,
                      colSums(cor.clusters.high.eff > 0.6) >= 1 |
                        colSums(cor.clusters.high.eff < -0.6) >= 1]

cor.clusters.med.eff <-
  cor.clusters.med.eff[,
                      colSums(cor.clusters.med.eff > 0.6) >= 1 |
                        colSums(cor.clusters.med.eff < -0.6) >= 1]

cor.clusters.low.eff <-
  cor.clusters.low.eff[,
                      colSums(cor.clusters.low.eff > 0.6) >= 1 |
                        colSums(cor.clusters.low.eff < -0.6) >= 1]

# plotting the correlations
cor.pheatmap <- 
  list(cor.clusters.high, cor.clusters.med, cor.clusters.low)
cor.pheatmap.eff <- 
  list(cor.clusters.high.eff, cor.clusters.med.eff, cor.clusters.low.eff)



for(i in 1:(length(cor.pheatmap))) {
  data <- cor.pheatmap[[i]]
p <- pheatmap(data, 
         annotation_col = target,
         annotation_row = type,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
         annotation_colors = annotation_colors_scr, annotation_legend = T,
         main = paste(i,"correlation heatmap: ChiP data vs. logratio change per drug"))
print(p)
}

for(i in 1:(length(cor.pheatmap.eff))) {
  data <- cor.pheatmap.eff[[i]]
p <- pheatmap(data, 
         annotation_col = target,
         annotation_row = type,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
         annotation_colors = annotation_colors_scr, annotation_legend = T,
         main = paste(i,"correlation heatmap: ChiP data vs. efficiency change per drug"))
print(p)
}

# Boxplot
mean.ratio <- indel.data[indel.data$drug == "CTPB" & indel.data$conc == "10um",] %>%
  dplyr::select(barcode, logratio.platenorm) %>% 
  mutate(logratio.platenorm = ave(logratio.platenorm, barcode, FUN = function(x) mean(x))) %>% 
  unique() %>% remove_rownames %>% column_to_rownames(var="barcode")

# Combine dfs
clusters <- clusters %>% 
  remove_rownames %>% column_to_rownames(var="unique(indel.data$barcode)")
mean.ratio2 <- cbind(mean.ratio, clusters)


# Boxplot
ggplot(mean.ratio2, aes(x=cluster, y=logratio.platenorm, fill = cluster))+
  geom_boxplot()+
  scale_fill_brewer(palette = "Pastel2")+
  scale_y_continuous(breaks=c(-0.5,0,0.5))+ theme_classic2()
  
## Statistical analysis: are the groups significantly different?
mean.ratio <- indel.data[indel.data$drug == "AT9283" & indel.data$conc == "1um",] %>%
  dplyr::select(barcode, rep, logratio.platenorm) %>%
  mutate(logratie.platenorm = ave(logratio.platenorm, rep, barcode, FUN = function(x) mean(x))) %>% 
  unique()
clusters2 <- rownames_to_column(as.data.frame(clusters), "barcode")
mean.ratio <- merge(mean.ratio, clusters2)
t.test(mean.ratio$logratio.platenorm[mean.ratio$cluster == "Active_G.B."],
                                     mean.ratio$logratio.platenorm[mean.ratio$cluster == "Active_P.E."])$p.value


anova <- aov(logratio.platenorm ~ cluster, data = mean.ratio)
summary.aov(anova)
tukey <- TukeyHSD(anova)
```
# Again, some interesting stuff


## HDAC vs Integration 17
```{r HDAC vs Integration 17, out.width= "100%", fig.align= "center", echo=FALSE}
# dplyr::select HDAC data
hdac <- target.logratio.med[target.logratio.med$target == "HDAC",] %>%
  dplyr::select(-target)
hdac <- hdac[rowSums(hdac > 1) >= 1 | rowSums(hdac < -0.7) >= 1,] %>% t()

# calculate correlations
cor_hdac <- cor(hdac, chip_data)

pheatmap(cor_hdac,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100))
```
# H3K27me3 seems to correlate with the logratio change induced by HDACs


## Correlation plots individual drugs
```{r correlation_individual, out.width= "100%", fig.align= "center", echo=FALSE}
## In case I want to include the mean.ratio
drug <- "Decitabine"
mean.ratio <- indel.data[indel.data$drug == drug,] %>%
  dplyr::select(barcode, logratio.platenorm) %>%
  mutate(logratio.platenorm = ave(logratio.platenorm, barcode, FUN = function(x) mean(x))) %>%
  unique()

## Ratio is influenced by which ChIP datasets?
mean.ratio2 <- mean.ratio %>% 
  remove_rownames %>% column_to_rownames(var="barcode")
cor_ratio <- as.data.frame(t(cor(mean.ratio2, chip_data))) %>% rownames_to_column("ChIP")

ggplot(cor_ratio, aes(x = reorder(ChIP,logratio.platenorm, function(x) -x), 
                      y = logratio.platenorm, fill=logratio.platenorm)) +
  geom_bar(stat="identity") +
  xlab("ChIP Dataset") + ylab("Pearson Correlation") +
  scale_fill_gradient2(low = "#D67143", high = "#8EBF7A", name = "Pearson Correlation") + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12)) +
  labs(title = paste("Correlation ", drug, 
                     "-induced Logratio Change per Barcode vs. Each ChIP Dataset", sep = ""))

# Scatterplot
mean.ratio <- rownames_to_column(as.data.frame(mean.ratio2))
chip_data <- rownames_to_column(as.data.frame(chip_data))
hdac1.data <- chip_data %>% dplyr::select(DNAse, WGBS)
hdac.1.data <- cbind(hdac1.data, mean.ratio2)

ggplot(hdac.1.data, aes(x=WGBS, y=logratio.platenorm))+
  geom_point()+
  geom_smooth(method = lm) +
  theme_classic2()

# Statistical significance?
x <- cor.test(hdac.1.data$WGBS, hdac.1.data$logratio.platenorm)
```



## HDAC correlation
```{r HDAC_correlation, out.width= "100%", fig.align= "center", echo=FALSE}
## In case I want to include the mean.ratio
mean.ratio <- indel.data[indel.data$drug == "AR-42" | indel.data$drug == "Vorinostat (SAHA, MK0683)" |
                           indel.data$drug == "PCI-24781 (Abexinostat)" |
                           indel.data$drug == "Givinostat (ITF2357)" |
                           indel.data$drug == "Scriptaid" |
                           indel.data$drug == "DMSO" & indel.data$conc == "1um",] %>%
  dplyr::select(barcode, drug, logratio.platenorm) %>%
  mutate(logratio.platenorm = ave(logratio.platenorm, drug, barcode, FUN = function(x) mean(x))) %>%
  unique() %>% setnames("barcode", "Var2")

## Ratio is influenced by which ChIP datasets?
mean.ratio2 <- mean.ratio %>% dcast(Var2 ~ drug) %>% 
  remove_rownames %>% column_to_rownames(var="Var2")
mean.ratio2 <- hdac[,colSums(hdac > 1) >= 1 | colSums(hdac < -0.7) >= 1] 

chip_data <- chip_data %>% column_to_rownames("rowname")

cor_ratio <- as.data.frame(t(cor(mean.ratio2, chip_data))) %>% 
  rownames_to_column("ChIP") %>% melt()


ggplot(cor_ratio, aes(x = reorder(ChIP, value, function(x) -mean(x)), y = value)) +
  geom_boxplot() +
  geom_jitter(aes(color=variable))+
  xlab("ChIP Dataset") + ylab("Pearson Correlation") + theme_bw() +
   theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12))+
  labs(title = "Correlation HDACs Logratio Change per Barcode vs. Each ChIP Dataset")


# Scatterplot
mean.ratio <- rownames_to_column(as.data.frame(mean.ratio2))
h3k27.data <- chip_data %>% dplyr::select(H3K27me3)
h3k27.data <- cbind(h3k27.data, mean.ratio)
h3k27.data <- melt(h3k27.data, id.vars = c("rowname","H3K27me3"))



ggplot(h3k27.data, aes(x=H3K27me3, y=value, color = variable))+
  geom_point()+
  geom_smooth(method = lm) +
  scale_color_brewer(palette = "Set2")+
  theme_classic2()
```

\newpage
## MC-1293 HDAC1 correlation 
```{r HDAC1_correlation, out.width= "100%", fig.align= "center", echo=FALSE}
# Plot correlation of MC-1293 vs HDAC1 ChIP
mc1293.indel.data <- indel.data.med.drug %>% dplyr::select(`MC-1293`) %>%
  rownames_to_column("barcode")
barcode.order2 <- barcode.order %>% dplyr::select(-order)
mc1293.indel.data <- merge(mc1293.indel.data, barcode.order2) %>% 
  dplyr::select(-barcode)

chip_data <- chip_data %>%
  rownames_to_column("barcode")

chip_data2 <- chip_data %>% dplyr::select(barcode, HDAC1) 
chip_data2 <- merge(chip_data2, barcode.order2) %>% dplyr::select(-barcode)

mc1293.hdac1 <- merge(mc1293.indel.data, chip_data2) %>% melt()

ggplot(mc1293.hdac1, aes(x = reorder(integration, value), y = value, fill = variable, group = variable))+
  geom_bar(stat="identity", position = "dodge")+ theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 12))
```


\newpage
## drug dose response
```{r drug dose responses, out.width= "100%", fig.align= "center", echo=FALSE}
# dplyr::select all drugs that are changed (in either high, med, or low concentration)
names.high <- colnames(indel.data.high.drug.ess)
names.med <- colnames(indel.data.med.drug.ess)
names.low <- colnames(indel.data.low.drug.ess)
indel.data.dose <- indel.data[indel.data$drug %in% names.high |
                                indel.data$drug %in% names.med |
                                indel.data$drug %in% names.low, ]

# Plot drug dose response per drug for all barcodes
ggplot(data = indel.data.dose, aes(x = conc, y = logratio.mean, color = barcode)) +
  geom_point(alpha = 0.5) +
  labs(title = "dose response curve of effective drugs", x = "concentration", y = "log2(+1/-7 ratio) change") +
  stat_summary(fun.y=mean, aes(group=1), geom="line", colour="#993300", alpha = 0.5) +
  stat_summary(fun.y=mean, aes(group=1), geom="point", colour="#993300", size=3, shape=4, alpha = 0.5)+
  facet_wrap(~drug, nrow = 8, ncol = 8) + theme_bw()


# Look at individual drugs more carefully
## dplyr::select drug
drug <- "Quercetin"
for (i in drug) {
p <- ggplot(data = indel.data.dose[indel.data.dose$drug == drug,], aes(x = conc, y = logratio.mean, group = barcode, color = barcode)) + theme_bw() +
  geom_point(alpha = 0.5) + geom_line(alpha = 0.5, linetype = "dashed") +
  labs(title = paste("dose response curve of", i), x = "concentration", y = "log2(+1/-7 ratio) change")
print(p)
}


# Dose curves for ChIP correlations
## Compute all corralations
indel.data.cor <- indel.data[indel.data$drug %in% names.high |
                                indel.data$drug %in% names.med |
                                indel.data$drug %in% names.low, ] %>%
  mutate(mean.logratio.bc.drug = ave(logratio.platenorm, barcode, drug, conc, FUN = function(x) mean(x))) %>%
  dplyr::select(barcode, drug, mean.logratio.bc.drug, conc) %>% 
  unique() 

indel.data.cor.high <- indel.data.cor[indel.data.cor$conc %in% "10um",]
indel.data.cor.med <- indel.data.cor[indel.data.cor$conc %in% "1um",]
indel.data.cor.low <- indel.data.cor[indel.data.cor$conc %in% "100nm",]

indel.data.cor.high <- indel.data.cor.high %>% 
  dcast(barcode ~ drug, value.var="mean.logratio.bc.drug") %>%
  column_to_rownames("barcode")

indel.data.cor.med <- indel.data.cor.med %>% 
  dcast(barcode ~ drug, value.var="mean.logratio.bc.drug") %>%
  column_to_rownames("barcode")

indel.data.cor.low <- indel.data.cor.low %>% 
  dcast(barcode ~ drug, value.var="mean.logratio.bc.drug") %>%
  column_to_rownames("barcode")

chip_data <- chip_data %>%
  column_to_rownames("barcode")

# Calculate correlations
cor_chip_indel.high <- cor(chip_data,indel.data.cor.high)
cor_chip_indel.med <- cor(chip_data,indel.data.cor.med)
cor_chip_indel.low <- cor(chip_data,indel.data.cor.low)

## Convert dfs to long format
dose_chip_high <- rownames_to_column(as.data.frame(cor_chip_indel.high), "ChIP") %>%
  melt(variable.name = "drug", value.name = "cor")
dose_chip_high$conc <- "10um"

dose_chip_med <- rownames_to_column(as.data.frame(cor_chip_indel.med), "ChIP") %>%
  melt(variable.name = "drug", value.name = "cor")
dose_chip_med$conc <- "1um"

dose_chip_low <- rownames_to_column(as.data.frame(cor_chip_indel.low), "ChIP") %>%
  melt(variable.name = "drug", value.name = "cor")
dose_chip_low$conc <- "100nm"

## Combine all dfs to one
dose_chip <- rbind(dose_chip_high, dose_chip_med, dose_chip_low)

## Visualize the dose response of the correlations
dose_chip$conc <- factor(dose_chip$conc, levels=c("100nm", "1um", "10um"))
ggplot(data = dose_chip, aes(x = conc, y = cor, group = ChIP, color = ChIP)) +
  geom_point(alpha = 0.5) + geom_line(alpha = 0.5, linetype = "dashed")+
  labs(title = "correlation behavior per concentration", x = "concentration", y = "correlation ChIP vs logratio change") +
  facet_wrap(~drug, nrow = 7, ncol = 7) + theme_bw()

# Look at individual drugs more carefully
## dplyr::select drug
drug <- "Alisertib (MLN8237)"
for (i in drug) {
p <- ggplot(data = dose_chip[dose_chip$drug == drug,], aes(x = conc, y = cor, group = ChIP, color = ChIP)) +
  geom_point(alpha = 0.5) + geom_line(alpha = 0.5, linetype = "dashed") +
  labs(title = paste("dose response curve of", i), x = "concentration", y = "log2(+1/-7 ratio) change") +
  theme_bw()
print(p)
}
```



## Exporting potential data. 
```{r}
```

# Session Info
```{r}
paste("Run time: ",format(Sys.time()-StartTime))
getwd()
date()
sessionInfo()
```

