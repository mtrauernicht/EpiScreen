---
title: "Scratch validations Vorinostat and GSK126 TIF"
author: "Ruben Schep"
date: "2022-08-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Data import
```{r}
# Import data validation data
file = list.files(in.dir, pattern = "validation_ratios", full.names = T) %>% tail(n = 1)
indel.validation.data <- readRDS(file) # %>% filter(pathway_bal_filter == TRUE & viab_reproducibility == TRUE)

# List chromatin name columns from this table
chromatin_cols = colnames(indel.validation.data)[42:75]
# Import data from DSB TRIP paper
RSTP2_IndelRatios_Chromatin_2kb <- readRDS("/DATA/usr/r.schep/DSBrepair/data/R/rs20210311/RSTP2_IndelRatios_Chromatin_2kb.RDS") %>% 
  filter(replicate == "mean" & drug %in% c("DMSO_GSK", "GSK126") & plasmid == "LBR2") %>%
  dplyr::select(barcode, drug, MMEJ, NHEJ, efficiency, all_of(chromatin_cols)) %>%
  distinct() %>%
  mutate(MMEJ_NHEJ = MMEJ/NHEJ) %>%
  dplyr::select(-NHEJ, -MMEJ)
```


### Process Vorinostat & GSK126 validations
```{r}
vorinostat_validation = indel.validation.data %>% 
  filter(replicate == "mean" & plasmid == "LBR2", drug %in% c("DMSO", "Vorinostat"), sum_bc_reads > 1000)%>% 
  dplyr::select(barcode, drug, MMEJ_NHEJ, efficiency, all_of(chromatin_cols)) %>%
  distinct() 

barcde_all_reps_vorino = vorinostat_validation %>% 
  distinct(barcode, drug) %>% 
  group_by(barcode) %>%
  summarise(bccount = n()) %>% 
  filter(bccount == 2) %>%
  pull(barcode)

vorinostat_ratios = vorinostat_validation  %>% 
  filter(barcode %in% barcde_all_reps_vorino) %>%
  pivot_wider(names_from = drug, values_from = c(efficiency, MMEJ_NHEJ)) %>%
  mutate(diff_TIF = efficiency_Vorinostat - efficiency_DMSO,
         ratio_TIF = efficiency_Vorinostat/efficiency_DMSO,
         log2_FC_TIF = log2(ratio_TIF),
         diff_MMEJ_NHEJ = MMEJ_NHEJ_Vorinostat - MMEJ_NHEJ_DMSO,
         ratio_MMEJ_NHEJ = MMEJ_NHEJ_Vorinostat/MMEJ_NHEJ_DMSO,
         log2_FC_MMEJ_NHEJ = log2(ratio_MMEJ_NHEJ),
         drug = "Vorinostat") 

barcde_all_reps_gsk = RSTP2_IndelRatios_Chromatin_2kb %>% 
  distinct(barcode, drug) %>% 
  group_by(barcode) %>%
  summarise(bccount = n()) %>% 
  filter(bccount == 2) %>%
  pull(barcode)

GSK_ratios = RSTP2_IndelRatios_Chromatin_2kb %>% 
  filter(barcode %in% barcde_all_reps_gsk) %>%
  # distinct(barcode, drug, MMEJ_NHEJ , efficiency) %>% 
  pivot_wider(names_from = drug, values_from = c(efficiency, MMEJ_NHEJ)) %>%
  mutate(diff_TIF = efficiency_GSK126 - efficiency_DMSO_GSK,
         ratio_TIF = efficiency_GSK126/efficiency_DMSO_GSK,
         log2_FC_TIF = log2(ratio_TIF),
         diff_MMEJ_NHEJ = MMEJ_NHEJ_GSK126 - MMEJ_NHEJ_DMSO_GSK,
         ratio_MMEJ_NHEJ = MMEJ_NHEJ_GSK126/MMEJ_NHEJ_DMSO_GSK,
         log2_FC_MMEJ_NHEJ = log2(ratio_MMEJ_NHEJ),
         drug = "GSK-126")

vorinostat_ctrl <- vorinostat_ratios %>%
  distinct(efficiency_DMSO, barcode)


## Compare controls, just to check
GSK_ratios2 <- GSK_ratios %>%
  distinct(efficiency_DMSO_GSK, barcode)

ctrl_compare <- merge(vorinostat_ctrl, GSK_ratios2, by = "barcode")

# Spearman correlation
cor(ctrl_compare$efficiency_DMSO, ctrl_compare$efficiency_DMSO_GSK, method = "spearman")

# ggplot(ctrl_compare,
#        aes(x = efficiency_DMSO, y = efficiency_DMSO_GSK)) +
#   geom_point() +
#   geom_smooth(method = "lm")

pool_validation_ratios = bind_rows(vorinostat_ratios, GSK_ratios) %>% 
  dplyr::select(-efficiency_Vorinostat, -efficiency_DMSO, -MMEJ_NHEJ_DMSO, 
                -MMEJ_NHEJ_Vorinostat, -MMEJ_NHEJ_DMSO_GSK, -efficiency_DMSO_GSK, 
                -MMEJ_NHEJ_DMSO_GSK, -MMEJ_NHEJ_GSK126, -efficiency_GSK126)
```

# Calculating the Chromatin Context Dependency (CCD)
## Extract slopes for all features
```{r}
chromatin.features.short = chromatin_cols[1:24]

slope.protein.features <- tibble(drug = NA, feature = NA,  term = NA, 
                                 indelrate = NA, p.value.indelrate = NA, 
                                 ratio = NA, p.value.ratio = NA)

for (i in unique(pool_validation_ratios$drug)) {
  for (j in chromatin.features.short) {
    model_tib <- pool_validation_ratios %>% filter(drug == i) 
    
    # Indel rates
    model.indelrate.log2 <- lm(formula = log2_FC_TIF ~ unlist(model_tib[j]), 
                               data = model_tib) %>% 
      tidy()
    
    # Pathway balance
    model.ratio.log2 <- lm(formula = log2_FC_MMEJ_NHEJ ~ unlist(model_tib[j]), 
                           data = model_tib) %>% 
      tidy()
    
    slope.protein.features <- slope.protein.features %>% 
      add_row(drug = i, 
              feature = j, 
              term = model.indelrate.log2 %>%
                pull(term),
              indelrate = model.indelrate.log2 %>% 
                pull(estimate), 
              p.value.indelrate = model.indelrate.log2 %>% 
                pull(p.value),
              ratio = model.ratio.log2 %>% 
                pull(estimate), 
              p.value.ratio = model.ratio.log2 %>% 
                pull(p.value))
  }
}

# Remove the 1st NA column
slope.protein.features %<>% 
  filter(!is.na(feature)) %>%
  mutate(term = ifelse(term == "(Intercept)", "intercept", "slope"))
```


### Calculating the Principle Component Regression (PCR)
```{r}
CCD_tib = pool_validation_ratios %>% dplyr::select(barcode, drug, log2_FC_TIF, log2_FC_MMEJ_NHEJ, all_of(chromatin.features.short)) %>% ungroup()

#Create an empty dt with CCDs of DDR proteins
pool_CCDs_dt <- tibble(var = NA, drug = NA, num_comp = NA, r.squared = NA, adj.r.squared = NA,p.value = NA)
# chrom_formula = as.formula(paste("y ~ ", paste(chromatin.features, collapse= "+")))

for (i in unique(CCD_tib$drug)){
  for (j in c("log2_FC_TIF", "log2_FC_MMEJ_NHEJ")) {
    pool_dt <- filter(CCD_tib, drug == i)
    # Run a model per drug
    set.seed(1)
    chrom_formula = reformulate(chromatin.features.short, response = j)
    PCR_model_DDR_test <- pcr(chrom_formula,
                              data=pool_dt , 
                              validation="CV")
    
    pcr_pred <- predict(PCR_model_DDR_test, 
                        pool_dt, ncomp = 3)
    
    combined.dt <- tibble(measured = pool_dt %>% pull(j), 
                          predicted = as.numeric(pcr_pred))
    
    pred_vs_estim <- lm(formula = measured ~ predicted, 
                        data = combined.dt) %>% 
      glance()
    
    pool_CCDs_dt <- pool_CCDs_dt %>% 
      add_row(var = j,
              drug = i, 
              r.squared = pred_vs_estim %>% 
                pull(r.squared), 
              adj.r.squared = pred_vs_estim %>% 
                pull(adj.r.squared), 
              p.value = pred_vs_estim %>% 
                pull(p.value))
  }
}

#Correct model to adjust for multiple testing correction
adj_p.value_KO_model <- pool_CCDs_dt %>% 
  dplyr::select(var, num_comp, p.value, drug) %>% 
  group_by(var) %>%
  mutate(p.adj = p.adjust(p.value, method = "BH")) %>% 
  dplyr::select(var, drug,p.value,p.adj)

signif_hits = adj_p.value_KO_model %>% filter(p.adj < 0.01) %>% 
  distinct(drug, var) %>% 
  ungroup() %>% 
  mutate(val = TRUE,
         var = gsub("log2.fc", "signif", var)) %>%
  pivot_wider(names_from = var, 
              values_from = val, 
              values_fill = FALSE) 
```

### Filtering the epistasis
```{r epistasis filtering}
# Calculate postition where the linear model crosses y = 0, we do this by -intercept / slope
epistasis_tib = slope.protein.features %>% 
  mutate(indelrate = ifelse(p.value.indelrate < 0.05, indelrate, 0),
         ratio = ifelse(p.value.ratio < 0.05, ratio, 0)) %>%
  distinct(drug, term, feature, indelrate, ratio) %>% 
  pivot_wider(., names_from = term, values_from = c(indelrate, ratio)) %>%
  mutate(feature = gsub(".zscore", "", feature),
         x_intercept_indelrate = -indelrate_intercept / indelrate_slope,
         x_intercept_ratio = -ratio_intercept / ratio_slope)

effect_compounds = pool_validation_ratios %>%
  group_by(drug)  %>% 
  #
  mutate(indelrate_pos = sum(log2_FC_TIF > 0),
         #
         indelrate_effect = ifelse(indelrate_pos >= 17, "indel_rate_increase", 
                                   ifelse(indelrate_pos <= 1, "indel_rate_decrease", "mixed")),
         #
         ratio_pos = sum(log2_FC_MMEJ_NHEJ > 0),
         #
         ratio_effect = ifelse(ratio_pos >= 17, "NHEJ_increase", 
                               ifelse(ratio_pos <= 1, "MMEJ_increase", "mixed"))) %>%
  distinct(drug, indelrate_effect, ratio_effect)


epistasis_tib %<>% 
  left_join(effect_compounds)  %>% 
  left_join(signif_hits) %>%
  mutate(
    # x_intercept_indelrate = ifelse(p.value.indelrate < 0.05,
    #                                x_intercept_indelrate, NA),
    # x_intercept_ratio = ifelse(p.value.ratio < 0.05,
    #                            x_intercept_ratio, NA),
    indelrate_slope_plot = ifelse(x_intercept_indelrate < 1, indelrate_slope, NA),
    ratio_slope_plot = ifelse(x_intercept_ratio < 1, ratio_slope, NA)) %>%
  distinct(drug, feature, indelrate_slope_plot, ratio_slope_plot) 

validation_epistasis_TIF = epistasis_tib %>%
  dplyr::select(drug, indelrate_slope_plot, feature) %>%
  reshape2::dcast(drug ~ feature, value.var = "indelrate_slope_plot", fill = 0) %>% 
  column_to_rownames(var = "drug")

validation_epistasis_bal = epistasis_tib %>%
  dplyr::select(drug, ratio_slope_plot, feature) %>%
  reshape2::dcast(drug ~ feature, value.var = "ratio_slope_plot", fill = 0) %>% 
  column_to_rownames(var = "drug")
```


# Code for figures
Some code that shows we cannot use the validation experiments to compare the TIF. 
### Process Vorinostat & GSK126 validations
```{r}
vorinostat_validation = indel.validation.data %>% 
  filter(replicate == "mean" & plasmid == "LBR2", drug %in% c("DMSO", "Vorinostat"), sum_bc_reads > 1000)%>% 
  dplyr::select(barcode, drug, MMEJ_NHEJ, efficiency, all_of(chromatin_cols)) %>%
  distinct() 

barcde_all_reps_vorino = vorinostat_validation %>% 
  distinct(barcode, drug) %>% 
  group_by(barcode) %>%
  summarise(bccount = n()) %>% 
  filter(bccount == 2) %>%
  pull(barcode)

vorinostat_ratios = vorinostat_validation  %>% 
  filter(barcode %in% barcde_all_reps_vorino) %>%
  pivot_wider(names_from = drug, values_from = c(efficiency, MMEJ_NHEJ)) %>%
  mutate(diff_TIF = efficiency_Vorinostat - efficiency_DMSO,
         ratio_TIF = efficiency_Vorinostat/efficiency_DMSO,
         log2_FC_TIF = log2(ratio_TIF),
         diff_MMEJ_NHEJ = MMEJ_NHEJ_Vorinostat - MMEJ_NHEJ_DMSO,
         ratio_MMEJ_NHEJ = MMEJ_NHEJ_Vorinostat/MMEJ_NHEJ_DMSO,
         log2_FC_MMEJ_NHEJ = log2(ratio_MMEJ_NHEJ),
         drug = "Vorinostat") 

barcde_all_reps_gsk = RSTP2_IndelRatios_Chromatin_2kb %>% 
  distinct(barcode, drug) %>% 
  group_by(barcode) %>%
  summarise(bccount = n()) %>% 
  filter(bccount == 2) %>%
  pull(barcode)

GSK_ratios = RSTP2_IndelRatios_Chromatin_2kb %>% 
  filter(barcode %in% barcde_all_reps_gsk) %>%
  # distinct(barcode, drug, MMEJ_NHEJ , efficiency) %>% 
  pivot_wider(names_from = drug, values_from = c(efficiency, MMEJ_NHEJ)) %>%
  mutate(diff_TIF = efficiency_GSK126 - efficiency_DMSO_GSK,
         ratio_TIF = efficiency_GSK126/efficiency_DMSO_GSK,
         log2_FC_TIF = log2(ratio_TIF),
         diff_MMEJ_NHEJ = MMEJ_NHEJ_GSK126 - MMEJ_NHEJ_DMSO_GSK,
         ratio_MMEJ_NHEJ = MMEJ_NHEJ_GSK126/MMEJ_NHEJ_DMSO_GSK,
         log2_FC_MMEJ_NHEJ = log2(ratio_MMEJ_NHEJ),
         drug = "GSK-126")

vorinostat_ctrl <- vorinostat_ratios %>%
  distinct(efficiency_DMSO, barcode)


## Compare controls, just to check
GSK_ratios2 <- GSK_ratios %>%
  distinct(efficiency_DMSO_GSK, barcode)

ctrl_compare <- merge(vorinostat_ctrl, GSK_ratios2, by = "barcode")

# Spearman correlation
cor(ctrl_compare$efficiency_DMSO, ctrl_compare$efficiency_DMSO_GSK, method = "spearman")

# ggplot(ctrl_compare,
#        aes(x = efficiency_DMSO, y = efficiency_DMSO_GSK)) +
#   geom_point() +
#   geom_smooth(method = "lm")

vorino_bc_85 = vorinostat_ratios %>% filter(efficiency_DMSO < 0.85) %>% pull(barcode)
gsk_bc_85 = GSK_ratios %>% filter(efficiency_DMSO_GSK < 0.85)

pool_validation_ratios = bind_rows(
  vorinostat_ratios, # %>% filter(efficiency_DMSO < 0.85),  
  GSK_ratios #%>% filter(efficiency_DMSO_GSK < 0.85)
  ) %>% 
  dplyr::select(-efficiency_Vorinostat, -efficiency_DMSO, -MMEJ_NHEJ_DMSO, 
                -MMEJ_NHEJ_Vorinostat, -MMEJ_NHEJ_DMSO_GSK, -efficiency_DMSO_GSK, 
                -MMEJ_NHEJ_DMSO_GSK, -MMEJ_NHEJ_GSK126, -efficiency_GSK126)

valid_ratios_long = pool_validation_ratios %>% 
  dplyr::select(barcode, drug, all_of(chromatin.features.short), log2_FC_TIF, log2_FC_MMEJ_NHEJ) %>% 
  distinct() %>%
  pivot_longer(cols = chromatin.features.short, names_to = "feature", values_to = "zscore")
```



## 2EF Upset plots pool
```{r Upset prep}
domain_levels = c('late_replicating', 'LAD', 'H3K9me2', 'H3K27me3')
domains = paste0(domain_levels, '_domain')
opt_df = get_combinations(domain_levels)

# Prepare Vorinostat table 
vorino.dt = vorinostat_ratios %>%
  filter(!is.na(diff_TIF)) %>%
  dplyr::select(barcode, diff_TIF, log2_FC_TIF, domains) %>%
  distinct(barcode, .keep_all = TRUE) %>%
  data.table()

vorino.dt[vorino.dt=='iDomain'] <- 0
vorino.dt[vorino.dt=='Domain'] <- 1
vorino.dt[vorino.dt=='DHS'] <- 1

vorino.dt[is.na(LAD_domain), LAD_domain:=0]

vorino.dt[, (domains) := lapply(.SD, as.numeric), .SDcols = domains]
colnames(vorino.dt) = gsub('_domain', '', colnames(vorino.dt))


# Prepare GSK table 
GSK.dt = GSK_ratios %>%
  filter(!is.na(diff_TIF)) %>%
  dplyr::select(barcode, diff_TIF, log2_FC_TIF, 
                efficiency_GSK126, efficiency_DMSO_GSK, domains) %>%
  distinct(barcode, .keep_all = TRUE) %>%
  data.table()

GSK.dt[GSK.dt=='iDomain'] <- 0
GSK.dt[GSK.dt=='Domain'] <- 1
GSK.dt[GSK.dt=='DHS'] <- 1
GSK.dt[is.na(LAD_domain), LAD_domain:=0]

GSK.dt[, (domains) := lapply(.SD, as.numeric), .SDcols = domains]
colnames(GSK.dt) = gsub('_domain', '', colnames(GSK.dt))
```

```{r 2EF Upset plots pool TIF FC, fig.width= 14, fig.height= 6}
p1 = plot_comb_grid_beeswarm(vorino.dt, opt_df,
                             domain_levels, 'diff_TIF', min_count = 10, y_plabel=c(-0.15, 0.15))
p2 = plot_comb_grid_beeswarm(GSK.dt, opt_df,
                             domain_levels, 'diff_TIF', min_count = 10, y_plabel=c(-0.15, 0.15))
plot_grid(p1, p2, labels = c("TIF FC HDACi", "TIF FC EZH2i"))
```

```{r all scatterplots pool, eval = FALSE}
pdf("/DATA/projects/DSBrepair/git/EpiScreen/figures/rs20220824_CCD_pool.pdf", height = 20, width = 20)

ggplot(valid_ratios_long %>% filter(drug == "Vorinostat"), aes(zscore, log2_FC_TIF)) + 
  geom_point_rast() +
  geom_smooth(method = "lm", se = F) +
  stat_cor(method = "pearson") +
  ggtitle("TIF Vorinostat") +
  stat_poly_eq(aes(label = paste(after_stat(eq.label),
                                 after_stat(rr.label), sep = "*\", \"*")),
               label.x = "left", label.y = "bottom") +
  facet_wrap(. ~ feature) +
  theme_bw(base_size = 16)

ggplot(valid_ratios_long%>% filter(drug == "Vorinostat"), aes(zscore, log2_FC_MMEJ_NHEJ)) + 
  geom_point_rast() +
  geom_smooth(method = "lm", se = F) +
  stat_cor(method = "pearson") +
  ggtitle("Bal Vorinostat") +
  stat_poly_eq(aes(label = paste(after_stat(eq.label),
                                 after_stat(rr.label), sep = "*\", \"*")),
               label.x = "left", label.y = "bottom") +
  facet_wrap(. ~ feature) +
  theme_bw(base_size = 16)

ggplot(valid_ratios_long%>% filter(drug == "GSK-126"), aes(zscore, log2_FC_TIF)) + 
  geom_point_rast() +
  geom_smooth(method = "lm", se = F) +
  stat_cor(method = "pearson") +
  ggtitle("TIF GSK-126") +
  stat_poly_eq(aes(label = paste(after_stat(eq.label),
                                 after_stat(rr.label), sep = "*\", \"*")),
               label.x = "left", label.y = "bottom") +
  facet_wrap(. ~ feature) +
  theme_bw(base_size = 16)

ggplot(valid_ratios_long%>% filter(drug == "GSK-126"), aes(zscore, log2_FC_MMEJ_NHEJ)) + 
  geom_point_rast() +
  geom_smooth(method = "lm", se = F) +
  stat_cor(method = "pearson") +
  ggtitle("Bal GSK-126") +
  stat_poly_eq(aes(label = paste(after_stat(eq.label),
                                 after_stat(rr.label), sep = "*\", \"*")),
               label.x = "left", label.y = "bottom") +
  facet_wrap(. ~ feature) +
  theme_bw(base_size = 16)

dev.off

## Scatterplot Vorino & GSK
```{r}
vorino_screen_K27 = indel.data %>% 
  filter((grepl("Vorinostat", drug) & conc_char == "1 µM") | 
           (grepl("EPZ-64", drug) & conc_char == "10 µM")) %>% 
  distinct(drug, barcode, replicate, tech, freqCut_norm_mean, 
           H3K27me3,LMNB1, MMEJ_FC) %>%
  group_by(barcode, drug) %>% 
  summarise(log2_FC_TIF = log2(mean(freqCut_norm_mean)),
            log2_FC_MMEJ_NHEJ = log2(mean(MMEJ_FC, na.rm = TRUE)),
            H3K27me3 = mean(H3K27me3),
            LMNB1 = mean(LMNB1),
            source = "screen") %>%
  pivot_longer(cols = c("LMNB1", "H3K27me3"), names_to = "feature", values_to = "zscore") %>%
  mutate(drug = ifelse(grepl("Vorinostat", drug), "HDACi", "EZH2i"))

vorino_pool_K27 = valid_ratios_long%>% 
  filter(feature %in% c("H3K27me3" , "LMNB1"), 
         # barcode %in% barcode_set_match_clone
         barcode %in% c(vorino_bc_85, gsk_bc_85)
         ) %>%
  mutate(source = "pool",
         drug = ifelse(grepl("Vorinostat", drug), "HDACi", "EZH2i"))

vorino_pool_K27_cloneset = valid_ratios_long %>% 
  filter(feature %in% c("H3K27me3" , "LMNB1"), barcode %in% paste0(unique(indel.data$barcode), ".B")) %>%
  mutate(source = "pool_clone",
         drug = ifelse(grepl("Vorinostat", drug), "HDACi", "EZH2i"))


vorino_k27 = bind_rows(vorino_screen_K27, vorino_pool_K27, vorino_pool_K27_cloneset)

pdf("/DATA/projects/DSBrepair/git/EpiScreen/figures/rs20220824_validation_pool_clone_pool_max85.pdf", height = 10, width = 10)

ggplot(vorino_k27, aes(zscore, log2_FC_TIF, color = source)) + 
  geom_point() +
  geom_smooth(method = "lm", se = F) +
  stat_cor(method = "pearson") +
  ggtitle("log2 FC TIF") +
  stat_poly_eq(aes(label = paste(after_stat(eq.label),
                                 after_stat(rr.label), sep = "*\", \"*")),
               label.x = "left", label.y = "bottom") +
  facet_grid(drug ~ feature) +
  theme_bw(base_size = 16)

ggplot(vorino_k27, aes(zscore, log2_FC_MMEJ_NHEJ, color = source)) + 
  geom_point() +
  geom_smooth(method = "lm", se = F) +
  stat_cor(method = "pearson") +
  ggtitle("log2 FC Balance") +
  stat_poly_eq(aes(label = paste(after_stat(eq.label),
                                 after_stat(rr.label), sep = "*\", \"*")),
               label.x = "left", label.y = "bottom") +
  facet_grid(drug ~ feature) +
  theme_bw(base_size = 16)

dev.off()
```
```{r}
dmso_TIF = indel.data %>%
  filter(drug == "DMSO") %>%
  mutate(freqCut = ave(freqCut, IPR, replicate, well, tech, FUN = mean)) %>%
  distinct(IPR, freqCut, replicate, well, tech) %>%
  arrange(freqCut) %>%
  mutate(source = "screen",
         barcode = paste(IPR, replicate, well, tech, sep = "_")) %>% 
  dplyr::rename(efficiency_DMSO = freqCut) %>% 
  distinct(barcode, efficiency_DMSO, source)

dmso_freq_vorino = vorinostat_ratios %>% distinct(barcode, efficiency_DMSO) %>% 
  arrange(efficiency_DMSO) %>%
  mutate(source = "pool_vorino", 
         efficiency_DMSO = efficiency_DMSO)

dmso_freq_vorino_set = vorinostat_ratios %>% distinct(barcode, efficiency_DMSO) %>% 
  filter(barcode %in% barcode_set_match_clone) %>%
  arrange(efficiency_DMSO) %>%
  mutate(source = "pool_vorino_subset", 
         efficiency_DMSO = efficiency_DMSO)

dmso_freq_gsk_set = GSK_ratios %>% distinct(barcode, efficiency_DMSO_GSK) %>% 
  filter(barcode %in% barcode_set_match_clone) %>%
  arrange(efficiency_DMSO_GSK) %>%
  mutate(source = "pool_gsk_subset", 
         efficiency_DMSO = efficiency_DMSO_GSK)

dmso_freq_gsk = GSK_ratios %>% distinct(barcode, efficiency_DMSO_GSK) %>% 
  arrange(efficiency_DMSO_GSK) %>%
  mutate(source = "pool_gsk", 
         efficiency_DMSO = efficiency_DMSO_GSK) %>%
  distinct(barcode, efficiency_DMSO, source)

dmso_freq_gsk_cutoff = GSK_ratios %>% distinct(barcode, efficiency_DMSO_GSK) %>% 
  arrange(efficiency_DMSO_GSK) %>% 
  filter(efficiency_DMSO_GSK < 0.85) %>%
  mutate(source = "pool_gsk_max85", 
         efficiency_DMSO = efficiency_DMSO_GSK) %>%
  distinct(barcode, efficiency_DMSO, source)

ctrl_TIF = bind_rows(dmso_TIF, dmso_freq_vorino, dmso_freq_gsk, dmso_freq_gsk_cutoff, dmso_freq_vorino_set, dmso_freq_gsk_set)

# bind_rows(filter(vorinostat_ratios,efficiency_DMSO < .85),  filter(GSK_ratios, efficiency_DMSO_GSK < 0.85))



ggplot(ctrl_TIF, aes(x = efficiency_DMSO , fill=source))  + geom_histogram( position="identity", alpha=0.5 , bins = 100)

ctrl_TIF %>%
  mutate(bin = cut(efficiency_DMSO, breaks = 100))



require(ggplot2)
ggplot(ctrl_TIF, aes(x = efficiency_DMSO , fill=source))  + geom_histogram( position="identity", alpha=0.5 , bins = 100) + facet_wrap(. ~ source) + theme_bw(base_size =  16)

ctrl_TIF = ctrl_TIF %>%
  mutate(bin = cut(efficiency_DMSO, breaks = 100))


#Simple density estimators
p_density<- table(ctrl_TIF %>% filter(source == "pool") %>% pull(bin))/nrow(dmso_freq_vorino)
q_density<- table(ctrl_TIF %>% filter(source == "screen") %>% pull(bin))/nrow(dmso_TIF)

#Evaluate density of both distribution at each point of group 1 
p <- p_density[ctrl_TIF %>% filter(source == "pool") %>% pull(bin)]
q <- q_density[ctrl_TIF %>% filter(source == "pool") %>% pull(bin)]

sample_set <- dplyr::slice_sample(ctrl_TIF %>% filter(source == "pool"), n = 300, replace = FALSE, weight_by =  q/p )

barcode_set_match_clone = sample_set %>% pull(barcode)


var_cut <- cut(var,breaks = 100)

#Simple density estimators
p_density2 <- table(var_cut[label == "group1"])/length(group1)
q_density2 <- table(var_cut[label == "group2"])/length(group2)

#Evaluate density of both distribution at each point of group 1 
p2 <- p_density[var_cut[label == "group1"]]
q2 <- q_density[var_cut[label=="group1"]]

matching_idx <- sample(which(label == "group1"), sum(label=="group2"), FALSE, q/p )

#plot it
mydata$matching_vec <- rep(NA, nrow(mydata))
mydata$matching_vec[matching_idx] <- "group1 (matching)"
mydata$matching_vec[label == "group2"] <- "group2"
mydata$matching_vec <- factor(mydata$matching_vec)

ggplot(subset(mydata, !is.na(matching_vec))) +  aes(x = var , fill=matching_vec)  + geom_histogram( position="identity", alpha=0.5 , bins = 100 )
```

## 3E Pool CCD TIF
```{r 3E CCD in the pool}
quant_breaks <- quantile(validation_epistasis_TIF, c(.01,.99), na.rm = T)
palette_length <- 100
breaks.validation <- c(seq(quant_breaks[1], 0, length.out=ceiling(palette_length/2) + 1), 
            seq(quant_breaks[2]/palette_length, quant_breaks[2], length.out=floor(palette_length/2)))
colors.validations = colorRampPalette(slope.colors %>% pull(color))(length(breaks.validation))
colors.validations[which(quant_breaks == 0)-1] = "gray90"


order_chrom = TRIP_chrom_clust$labels
order_chrom = order_chrom[!grepl("H3K9me3", order_chrom)]


pheatmap(validation_epistasis_TIF[ , order_chrom],
             border_color = F,
             cellwidth = 8,
             cellheight = 8,
             breaks = breaks.validation,
             main = paste("Chromatin synergies - TIF"),
             color = colors.validations,
             annotation_legend = T)
```