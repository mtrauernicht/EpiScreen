---
title: "xv20211214_epistasis_code"
output: html_document
---


# Libraries
```{r libraries}
# libraries:
library(tidyverse)
library(data.table)
library(parallel)
library(gtools)
library(pheatmap)
library(ggbeeswarm)
library(reshape2)
library(gridExtra)
library(broom)
library(ggrepel)
library(dendextend)
library(Hmisc)
library(RColorBrewer)
library(magrittr)
library(ggpubr)
```

# Load libraries (Just need a data table with all the data and )
```{r}
#Chromatin data (it needs a barcode column)
indel.data <- readRDS("/DATA/projects/DSBrepair/data/R/rs20220128_episcreen/rs20220128_episcreen_ratios.RDS")
clone5_chrom_tib <- readRDS('/DATA/projects/DSBrepair/data/R/cl20201026_ChIP_zscore_selection.RDS')


chromatin.features <- colnames(indel.data)[grepl("[.]zscore", colnames(indel.data))]
chrom_data = indel.data %>% select(barcode, all_of(chromatin.features)) %>% distinct()
```

## Prepare data

```{r}
# Data table and compute log2_ratio (This line needs to be adjusted)
ratios_tib <- indel.data %>%
  filter(abs(mean_eff_zscore_global_comb) > 2.58 | abs(MMEJ_zscore_global_comb) > 2.58 | drug == "DMSO") %>%
  distinct(MMEJratio, freqCut, drug, conc_char, target, barcode) %>%
  mutate(MMEJratio = ave(MMEJratio, drug, conc_char, barcode, FUN = mean)) %>%
  mutate(MMEJratio.log2 = log2(MMEJratio)) %>%
  mutate(freqCut = (ave(freqCut, drug, conc_char, barcode, FUN = mean))) %>%
  mutate(freqCut.log2 = log2(freqCut)) %>%
  distinct()

dmso_ratios_tib <- indel.data %>%
  filter(drug == "DMSO") %>%
  distinct(MMEJratio, freqCut, barcode) %>%
  mutate(DMSO.ratio = ave(MMEJratio, barcode, FUN = mean)) %>%
  mutate(DMSO.ratio.log2 = log2(DMSO.ratio)) %>%
  mutate(DMSO.freqCut = ave(freqCut, barcode, FUN = mean)) %>%
  mutate(DMSO.freqCut.log2 = log2(DMSO.freqCut)) %>%
  dplyr::select(-MMEJratio, -freqCut) %>%
  distinct()
  
ratios_tib <- merge(ratios_tib, dmso_ratios_tib)
```

The log2 distance ratio in our case is positive if it promotes MMEJ and negative if it promotes NHEJ


# 2nd step check compute distances and plot them
```{r}
# Each replicate has a different value (compute differences by replicate)
ratios_tib <- ratios_tib %>% 
  dplyr::group_by(barcode, drug, conc_char) %>% 
  mutate(log2.dist.ratio = MMEJratio.log2 - DMSO.ratio.log2, 
         log2.dist.freqCut = freqCut.log2 - DMSO.freqCut.log2) %>%
  left_join(chrom_data)

#Plot slopes
ggplot(ratios_tib %>% 
         filter(drug %in% c("DMSO","DNA-PKi","PCI-24781 (Abexinostat)")),
       aes(H3K27me3.zscore,log2.dist.ratio, color = drug)) + 
  geom_point() + 
  stat_cor(method = "spearman") + 
  geom_smooth(method = "lm") + 
  theme_bw() +
  facet_wrap(. ~ conc_char)

ggplot(ratios_tib %>% 
         filter(drug %in% c("DMSO","DNA-PKi","PCI-24781 (Abexinostat)")),
       aes(HDAC1.zscore,log2.dist.freqCut, color = drug)) + 
  geom_point() +
  stat_cor(method = "spearman") + 
  geom_smooth(method = "lm") + 
  theme_bw() +
  facet_wrap(. ~ conc_char)

ggplot(ratios_tib %>% 
         filter(drug %in% c("Resveratrol 10 µM", "Belinostat (PXD101)")),
       aes(late_replicating.zscore
           ,log2.dist.ratio, color = drug)) + 
  geom_point() +
  stat_cor(method = "spearman") + 
  geom_smooth(method = "lm") + 
  theme_bw() +
  facet_wrap(. ~ conc_char)

```



# Extract slopes for all genes
```{r}
# Perform analysis across all features for three test genes
ratios_tib %<>% mutate(drug_conc = paste(drug, conc_char, sep = " "))


test.log2.dist <- ratios_tib %>% 
  dplyr::group_by(drug_conc) %>% 
  t_test(log2.dist.ratio ~ 0) %>% 
  mutate(p.adj = p.adjust(p, method = "fdr")) %>% 
  left_join(ratios_tib, by = "drug_conc")

slope.protein.features <- tibble(drug_conc = NA, feature = NA,  term = NA, 
                                 indelrate = NA, p.value.indelrate = NA, 
                                 ratio = NA, p.value.ratio = NA)

for (i in unique(ratios_tib$drug_conc)) {
  for (j in chromatin.features) {
<<<<<<< HEAD
    model.dt <- ratios_tib %>% filter(drug_conc == i & lin.dist.freqCut != Inf) 
    
    model.epistasis.log2 <- lm(formula = lin.dist.freqCut ~ unlist(model.dt[j]), 
                               data = model.dt) %>% 
=======
    model_tib <- ratios_tib %>% filter(drug_conc == i & log2.dist.freqCut != Inf)
    # Indel rates
    model.indelrate.log2 <- lm(formula = log2.dist.freqCut ~ unlist(model_tib[j]), 
                               data = model_tib) %>% 
      tidy()
    
    # Pathway balance
    model.ratio.log2 <- lm(formula = log2.dist.ratio ~ unlist(model_tib[j]), 
                               data = model_tib) %>% 
>>>>>>> 39dfcced5445753d02c03ee6d4ab01b80772c42e
      tidy()
    
    slope.protein.features <- slope.protein.features %>% 
      add_row(drug_conc = i, 
              feature = j, 
              term = model.indelrate.log2 %>%
                pull(term),
              indelrate = model.indelrate.log2 %>% 
                pull(estimate), 
              p.value.indelrate = model.indelrate.log2 %>% 
                pull(p.value),
              ratio = model.ratio.log2 %>% 
                pull(estimate), 
              p.value.ratio = model.ratio.log2 %>% 
                pull(p.value))
  }
}
# Remove the 1st NA column
slope.protein.features %<>% 
  filter(is.na(.)) %>%
  mutate(term = ifelse(term == "(Intercept)", "intercept", "slope"))

# Calculate postition where the linear model crosses y = 0, we do this by -intercept / slope
epistasis_tib = slope.protein.features %>% 
  distinct(drug_conc, term, feature, indelrate, ratio) %>% 
  pivot_wider(., names_from = term, values_from = c(indelrate, ratio)) %>%
  mutate(x_intercept_indelrate = -indelrate_intercept / indelrate_slope,
       x_intercept_ratio = -ratio_intercept / ratio_slope)

effect_compounts = ratios_tib %>%
  group_by(drug_conc)  %>% 
  mutate(indelrate_pos = sum(log2.dist.freqCut > 0),
         indelrate_effect = ifelse(indelrate_pos >= 17, "indel_rate_increase", 
                         ifelse(indelrate_pos <= 1, "indel_rate_decrease", "mixed")),
         ratio_pos = sum(log2.dist.ratio > 0),
         ratio_effect = ifelse(ratio_pos >= 17, "MMEJ_increase", 
                         ifelse(ratio_pos <= 1, "NHEJ_increase", "mixed"))) %>%
  distinct(drug_conc, indelrate_effect, ratio_effect)

p.vals = slope.protein.features %>% filter(term == "slope") %>% select(-term, -indelrate , -ratio) %>% distinct()

epistasis_tib %<>% left_join(effect_compounts)  %>% 
  left_join(p.vals) %>%
  mutate(x_intercept_indelrate = ifelse(indelrate_effect == "mixed" & p.value.indelrate < 0.05, 
                                        x_intercept_indelrate, NA),
         x_intercept_ratio = ifelse(ratio_effect == "mixed" & p.value.ratio < 0.05, 
                                    x_intercept_ratio, NA),
         orientation_indelrate = ifelse(indelrate_slope < 0 & indelrate_effect == "indel_rate_decrease" | 
                                         indelrate_slope > 0 & indelrate_effect == "indel_rate_increase", "divergent", 
                                        ifelse(indelrate_slope < 0 & indelrate_effect == "indel_rate_increase" | 
                                         indelrate_slope > 0 & indelrate_effect == "indel_rate_decrease", "convergent",
                                         "complex")),
         indelrate_slope_plot = ifelse(orientation_indelrate == "divergent", indelrate_slope, NA),
         orientation_ratio = ifelse(ratio_slope < 0 & ratio_effect == "NHEJ_increase" | 
                                         ratio_slope > 0 & ratio_effect == "MMEJ_increase", "divergent", 
                                        ifelse(ratio_slope < 0 & ratio_effect == "MMEJ_increase" | 
                                         ratio_slope > 0 & ratio_effect == "NHEJ_increase", "convergent",
                                         "complex")),
         ratio_slope_plot = ifelse(orientation_ratio == "divergent", ratio_slope, NA))  


###WIP###

epistasis_tib %>% distinct( drug_conc, indelrate_effect, ratio_effect, orientation_indelrate) %>% pivot_longer(., cols = c(indelrate_effect, ratio_effect, orientation_indelrate), names_to = "measure", values_to = "effect") %>% ggplot(., aes(measure)) + geom_bar(aes(fill = effect))

ggplot(ratios_tib %>% 
         filter(drug %in% c("DNA-PKi 10 µM", "Nexturastat A")),
       aes(H3K27me3.zscore
           ,log2.dist.ratio, color = drug)) + 
  geom_point() +
  stat_cor(method = "spearman") + 
  geom_smooth(method = "lm") + 
  theme_bw() +
  facet_wrap(. ~ conc_char)

epistasis_tib %>% 
  distinct(drug_conc, feature, indelrate_slope_plot) %>%
         filter(grepl("100 nM", drug_conc) & complete.cases(.)) %>%
ggplot() + 
  geom_tile(aes(drug_conc,feature, fill = indelrate_slope_plot)) + 
  scale_fill_gradient2() + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust =0.5))


mixed_indel_rate = effect_compounts %>% filter(indelrate_effect == "mixed")

mixed_ratio

# Plot matrix without scaling
# log2 space
ggplot(slope.protein.features %>% 
         filter(term != "(Intercept)" & 
                  complete.cases(.) & 
                  grepl("100 nM", drug_conc))) + 
  geom_tile(aes(drug_conc,feature, fill = slope.log2)) + 
  scale_fill_gradient2() + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust =0.5))

ggplot(slope.protein.features %>% 
         filter(term != "(Intercept)" & 
                  complete.cases(.) & 
                  grepl("1 µM", drug_conc))) + 
  geom_tile(aes(drug_conc,feature, fill = slope.log2)) + 
  scale_fill_gradient2() + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust =0.5))

ggplot(slope.protein.features %>% 
         filter(term != "(Intercept)" & 
                  complete.cases(.) & 
                  grepl("10 µM", drug_conc))) + 
  geom_tile(aes(drug_conc,feature, fill = slope.log2)) + 
  scale_fill_gradient2() + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust =0.5))

slope.protein.features2 = slope.protein.features


<<<<<<< HEAD
hits2 = slope.protein.features %>% filter(term == "unlist(model.dt[j])" & p.value < 0.01) %>% pull(drug_conc) %>% unique()

hits = slope.protein.features %>% filter(term == "unlist(model.dt[j])" & abs(slope.log2) > 0.02) %>% pull(drug_conc) %>% unique()

=======
>>>>>>> 39dfcced5445753d02c03ee6d4ab01b80772c42e
slope.prot.features.scale.dcast.list <- slope.protein.features %>% 
  filter(term == "unlist(model.dt[j])" & drug_conc %in% hits) %>% 
  separate(drug_conc, into = c("drug", "conc"), sep = "_") %>% 
  group_by(conc) %>%
  group_split(.keep = FALSE) 

slope.prot.features.scale.dcast.1um = slope.prot.features.scale.dcast.list[[1]] %>%
  reshape2::dcast(drug ~ feature, value.var = "slope.log2") %>% 
  column_to_rownames(var = "drug")


slope.prot.features.scale.dcast.10um = slope.prot.features.scale.dcast.list[[2]] %>%
  reshape2::dcast(drug ~ feature, value.var = "slope.log2") %>% 
  column_to_rownames(var = "drug")


slope.prot.features.scale.dcast.100nm = slope.prot.features.scale.dcast.list[[3]] %>%
  reshape2::dcast(drug ~ feature, value.var = "slope.log2") %>% 
  column_to_rownames(var = "drug")
 
# Set annotation for heatmap
# Row annotation: annotate drugs with the target group
target <- indel.data %>% 
  distinct(drug, target) %>% 
  column_to_rownames(var="drug")

# colors <- brewer.pal(length(unique(barcode.annotation$cluster)), "Pastel2")
# names(colors) <- unique(barcode.annotation$cluster)

annotation_colors_scr = list(
  target = c(HDAC="#60988D", HAT="#C6D0A8", Sirtuin="#8FCAAC",
             HMT="#FDCDAC", DNMT="#D69C81", `Histone Demethylase`="#FFF2AE",
             HIF="#E3DCD5", JAK="#C8D7E2", PIM="#9AB8C4", `Aurora Kinase`="#F4CAE4",
             PARP="#CB546F", `Epigenetic Reader Domain`= "#476D61", `DNA-PK`="#E07A43", `Negative Control` = "gray50", MRN = "black"
             ))


ordered_marks2 <- c("Negative Control", "MRN", "DNA-PK","Epigenetic Reader Domain", "HDAC",  "Sirtuin", "HAT", 
                    "Histone Demethylase", "HMT", "DNMT", 
                    "HIF", "JAK", "PIM",
                    "Aurora Kinase", "PARP")

annotation_colors_scr$target <- annotation_colors_scr$target[ordered_marks2]

breaks <- seq(-0.1, 0.1, 0.001)

pheatmap(t(slope.prot.features.scale.dcast.100nm),
         border_color = F,
         cellwidth = 8,
         cellheight = 8,
         breaks = breaks,
         annotation_col = target,
         main = "100 nM",
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(length(breaks)),
         annotation_colors = annotation_colors_scr, annotation_legend = T)

breaks <- seq(-0.1, 0.1, 0.001)

pheatmap(t(slope.prot.features.scale.dcast.1um),
         border_color = F,
         cellwidth = 8,
         cellheight = 8,
         breaks = breaks,
         annotation_col = target,
         main = "1 uM",
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(length(breaks)),
         annotation_colors = annotation_colors_scr, annotation_legend = T)

breaks <- seq(-0.2, 0.2, 0.001)

pheatmap(t(slope.prot.features.scale.dcast.10um),
         border_color = F,
         cellwidth = 8,
         cellheight = 8,
         breaks = breaks,
         annotation_col = target,
         main = "10 uM",
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(length(breaks)),
         annotation_colors = annotation_colors_scr, annotation_legend = T)


```



```{r}
slope.protein.features <- tibble(drug_conc = NA, feature = NA, slope.log2 = NA, term = NA, p.value = NA)

for (i in unique(ratios_tib$drug_conc)) {
  for (j in chromatin.features) {
    model.dt <- ratios_tib %>% filter(drug_conc == i & log2.dist.ratio != Inf) 
    
    model.epistasis.log2 <- lm(formula = log2.dist.ratio ~ unlist(model.dt[j]), 
                               data = model.dt) %>% 
      tidy()
    
    slope.protein.features <- slope.protein.features %>% 
      add_row(drug_conc = i, 
              feature = j, 
              slope.log2 = model.epistasis.log2 %>% 
                pull(estimate), 
              term = model.epistasis.log2 %>%
                pull(term),
              p.value = model.epistasis.log2 %>% 
                pull(p.value))
  }
}

# grouping the samples
ratios_tib %>% distinct(barcode, drug_conc, log2.dist.freqCut) %>% 
  group_by(drug_conc)  %>% 
  mutate(pos = sum(log2.dist.freqCut > 0),
         effect = ifelse(pos == 18, "MMEJ_increase", ifelse(pos == 0, "NHEJ_increase", "mixed")))

# Plot matrix without scaling
# log2 space
ggplot(slope.protein.features %>% 
         filter(term != "(Intercept)" & 
                  complete.cases(.) & 
                  grepl("100 nM", drug_conc))) + 
  geom_tile(aes(drug_conc,feature, fill = slope.log2)) + 
  scale_fill_gradient2() + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust =0.5))

ggplot(slope.protein.features %>% 
         filter(term != "(Intercept)" & 
                  complete.cases(.) & 
                  grepl("1 µM", drug_conc))) + 
  geom_tile(aes(drug_conc,feature, fill = slope.log2)) + 
  scale_fill_gradient2() + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust =0.5))

ggplot(slope.protein.features %>% 
         filter(term != "(Intercept)" & 
                  complete.cases(.) & 
                  grepl("10 µM", drug_conc))) + 
  geom_tile(aes(drug_conc,feature, fill = slope.log2)) + 
  scale_fill_gradient2() + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust =0.5))

slope.protein.features2 = slope.protein.features


hits2 = slope.protein.features %>% filter(term == "unlist(model.dt[j])" & p.value < 0.01) %>% pull(drug_conc) %>% unique()

hits = slope.protein.features %>% filter(term == "unlist(model.dt[j])" & abs(slope.log2) > 0.05) %>% pull(drug_conc) %>% unique()

slope.prot.features.scale.dcast.list <- slope.protein.features %>% 
  filter(term == "unlist(model.dt[j])" & drug_conc %in% hits) %>% 
  separate(drug_conc, into = c("drug", "conc"), sep = "_") %>% 
  group_by(conc) %>%
  group_split(.keep = FALSE) 

slope.prot.features.scale.dcast.1um = slope.prot.features.scale.dcast.list[[1]] %>%
  reshape2::dcast(drug ~ feature, value.var = "slope.log2") %>% 
  column_to_rownames(var = "drug")


slope.prot.features.scale.dcast.10um = slope.prot.features.scale.dcast.list[[2]] %>%
  reshape2::dcast(drug ~ feature, value.var = "slope.log2") %>% 
  column_to_rownames(var = "drug")


slope.prot.features.scale.dcast.100nm = slope.prot.features.scale.dcast.list[[3]] %>%
  reshape2::dcast(drug ~ feature, value.var = "slope.log2") %>% 
  column_to_rownames(var = "drug")
 


annotation_colors_scr$target <- annotation_colors_scr$target[ordered_marks2]

breaks <- seq(-0.1, 0.1, 0.001)

pheatmap(t(slope.prot.features.scale.dcast.100nm),
         border_color = F,
         cellwidth = 8,
         cellheight = 8,
         breaks = breaks,
         annotation_col = target,
         main = "100 nM",
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(length(breaks)),
         annotation_colors = annotation_colors_scr, annotation_legend = T)

breaks <- seq(-0.1, 0.1, 0.001)

pheatmap(t(slope.prot.features.scale.dcast.1um),
         border_color = F,
         cellwidth = 8,
         cellheight = 8,
         breaks = breaks,
         annotation_col = target,
         main = "1 uM",
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(length(breaks)),
         annotation_colors = annotation_colors_scr, annotation_legend = T)

breaks <- seq(-0.2, 0.2, 0.001)

pheatmap(t(slope.prot.features.scale.dcast.10um),
         border_color = F,
         cellwidth = 8,
         cellheight = 8,
         breaks = breaks,
         annotation_col = target,
         main = "10 uM",
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(length(breaks)),
         annotation_colors = annotation_colors_scr, annotation_legend = T)


```





# Figure 4B: Matrix for hits
```{r heatmap}
##genes to select
# tmp.hits <- slope.protein.features %>%
#   # filter(p.value < 0.05 & term == "unlist(model.dt[j])") %>% 
#   pull(drug_conc) %>%
# 
# # heatmap
# ggplot(slope.protein.features.all %>% filter(gene %in% tmp.gene.hits & abs(slope) > 0.05)) + 
#   geom_tile(aes(fct_relevel(gene,heatmap.gene.order.slope.diff.hits),fct_relevel(feature, heatmap.chromatin.order.slope.diff.hits), fill = slope)) +
#   scale_fill_gradient2( low = "#8c510a",mid = "#f5f5f5", high = "#01665e")  + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), axis.title = element_blank(), legend.position = "top") + coord_fixed(expand = F,ratio = 1)
# 
# # Dendrogram
# ggdendrogram(heatmap.slope.diff.hits$tree_row)
# 
# # Relative slope
# tmp.rel.slope <- slope.protein.features.all %>% filter(gene %in% tmp.gene.hits) %>% mutate(rel.epistasis = slope*6/mean.fc)
```

# Figure 4C: Epistasis per library
```{r}
# slope.library <- slope.protein.features.all %>% left_join(hits.both.screens %>% separate(ID_gene, into = "gene", remove = T) %>% select(gene,library,pathway) %>% distinct()) %>% filter(library %in% c("Chromatin","DNA_repair"))
# 
# # Plot per library(all)
# ggplot(slope.library) + geom_quasirandom(aes(library,abs(epistasis), color = library)) + theme_bw() + scale_color_manual(values = levels(as_factor(library.colors$color))) + theme(legend.position = "top")
# 
# #test
# chromatin.genes.slope <- slope.library %>% filter(library == "Chromatin") %>% pull(epistasis) %>% abs()
# dna_repair.genes.slope <- slope.library %>% filter(library == "DNA_repair") %>% pull(epistasis) %>% abs()
# 
# ks.test.library <- ks.test(chromatin.genes.slope,dna_repair.genes.slope)
```

#Figure 4D: Epistasis per pathway
```{r}
# # Plot per library 
# ggplot(slope.library %>% filter(pathway != "NA")) + geom_quasirandom(aes(pathway, abs(epistasis), color = pathway)) + theme_bw() + scale_color_manual(values = c("#EB2030","#2E358F")) + theme(legend.position = "top")
# 
# #test
# NHEJ.genes.slope <- slope.library %>% filter(pathway == "NHEJ") %>% pull(epistasis) %>% abs()
# eff.genes.slope <- slope.library %>% filter(pathway == "eff") %>% pull(epistasis) %>% abs()
# 
# ks.test.pathway <- ks.test(NHEJ.genes.slope,eff.genes.slope)
```


