---
title: "Clone identification"
author: "Ruben Schep"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output: 
  html_document:
    theme: journal #cerulean
    highlight: monochrome
    toc: true
    toc_float: true
    code_folding: show
  editor_options:
    chunk_output_type: console
---

# knitr document van Steensel lab

# TRIP Clone identification

# Introduction

## Description of Data
How to make a good rendering table: 
```{r table1, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
tabl <- "
| column1	|	column2	|	column3	|	
|----|----|----|
|1	|	2	|	3	|	
|a	|	b	|	c	|	
"
cat(tabl) # output the table in a format good for HTML/PDF/docx conversion
```

# Data processing
## Path, Libraries, Parameters and Useful Functions
```{r setup}
knitr::opts_chunk$set(echo = TRUE)
StartTime <-Sys.time()

# 8-digit Date tag:
Date <- substr(gsub("-","",Sys.time()),1,8) 
# libraries:
```

### Custom functions
Functions used thoughout this script.
```{r}
SetFileName <- function(filename, initials) {
  # Set filename with extension and initials to make filename with date integrated.
  filename <- substitute(filename)
  initials <- substitute(initials)
  filename <- paste0(initials, Date, filename)
  filename
}
```


## Data import
```{r Data Import}
setwd("~/mydata/EpiScreen/epigenetic-screening-on-trip-clone/Data/")

# Import data from preprocessing script
indel.data <- get(load("mt20190204_indel.data"))
t.outlier.df <- get(load("mt20190204_t.outlier.df"))
chi.outlier.df <- get(load("mt20190204_chi.outlier.df"))

# Load ChIP data
setwd("~/mydata/Mapping_Clone5_9/nearest_domains-1000-0.9")
file.list <- list.files(pattern = '*.txt')
ChIP.list <- lapply(file.list, read.table, header = TRUE)
ChIP.df <- as.data.frame(ChIP.list)

# Load Lmnb1 data
setwd("~/mydata/Mapping_Clone5_9")
lmn.df <- get(load("rs20190116_RSTP2.2000.Chromatin.RData"))

# Load clone 5 barcode data
clone5.bc <- read.delim("mt20190204_clone5_barcodes.txt")
```

## Pre-processing: Importing ChIP data
```{r}
# Remove not needed data
ChIP.df <- select(ChIP.df, ends_with("e"), contains("Distance"))

# Rename variables 
names(ChIP.df)[2:38] <- gsub(".*_.*_(.*?)_.*.txt", "\\1", file.list)

# Process lmn dataset
lmn.df <- lmn.df[,c(1,101)]
lmn.df <- lmn.df[!duplicated(lmn.df), ]
lmn.df <- merge(lmn.df, clone5.bc)
setnames(ChIP.df, old = "Barcode", new = "barcode")
ChIP.df <- merge(ChIP.df, clone5.bc)

# Combine the two chr. state dfs
ChIP.df <- merge(lmn.df, ChIP.df, all = TRUE)

# Change from distance to integration: yes (1) or no (0)
ChIP.df[,3:ncol(ChIP.df)] <- ifelse(ChIP.df[,3:ncol(ChIP.df)] > 0, 0, 1)
ChIP.df[,2] <- ifelse(ChIP.df[,2] == "AD", 1, 0)

# Remove .B from barcode
ChIP.df$barcode <- gsub(".B","",ChIP.df$barcode)
```


## Analysis
```{r Analysis}
# Import chromatin data
indel.data <- merge(indel.data, ChIP.df, all = TRUE)

# Make df more sexy
indel.data <- indel.data[,c(-2,-5,-8:-14,-16,-17,-22,-25,-32:-38)]

# Compute mean of logratio per barcode and drug
indel.data$mean.logratio.bc.drug <- ave(indel.data$logratio.platenorm, indel.data$barcode, indel.data$Drug, FUN = function(x) mean(x))

# Remove columns
indel.data <- indel.data[,c(1,4,19:57)]
indel.data <- indel.data[-grep("ACCCCTAAAGGCGCTG", indel.data$barcode),]

# Heatmap
# combine column 1&2, to row names, heatmap



# Find drugs that have effect on one chr.state but not on the other


```



## Visualisation
```{r Visualization}
```

# Results
```{r}
```

# Conclusions
```{r}
```

## Exporting potential data. 
```{r}
```

# Session Info
```{r}
paste("Run time: ",format(Sys.time()-StartTime))
getwd()
date()
sessionInfo()
```

