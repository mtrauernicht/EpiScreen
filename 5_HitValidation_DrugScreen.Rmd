---
title: "Clone identification"
author: "Ruben Schep"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  pdf_document:
    toc: yes
  html_document:
    code_folding: show
    highlight: monochrome
    theme: journal
    toc: yes
    toc_float: yes
  editor_options:
    chunk_output_type: console
---

# knitr document van Steensel lab

# TRIP Clone identification

# Introduction

## Description of Data
How to make a good rendering table: 
```{r table1, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
tabl <- "
| column1	|	column2	|	column3	|	
|----|----|----|
|1	|	2	|	3	|	
|a	|	b	|	c	|	
"
cat(tabl) # output the table in a format good for HTML/PDF/docx conversion
```

# Data processing
## Path, Libraries, Parameters and Useful Functions
```{r setup}
knitr::opts_chunk$set(echo = TRUE)
StartTime <-Sys.time()

# 8-digit Date tag:
Date <- substr(gsub("-","",Sys.time()),1,8) 
# libraries:
library(dplyr)
library(outliers)
library(ggplot2)
library(ggbeeswarm)
library(data.table)
library(ComplexHeatmap)
library(circlize)
library(pheatmap)
library(gridGraphics)
library(gridExtra)
```

### Custom functions
Functions used thoughout this script.
```{r}
SetFileName <- function(filename, initials) {
  # Set filename with extension and initials to make filename with date integrated.
  filename <- substitute(filename)
  initials <- substitute(initials)
  filename <- paste0(initials, Date, filename)
  filename
}
```


## Data import
```{r Data Import}
setwd("~/mydata/EpiScreen/epigenetic-screening-on-trip-clone/Data/")

# Import data from preprocessing script
indel.data <- get(load("mt20190204_indel.data"))
t.outlier.df <- get(load("mt20190204_t.outlier.df"))
chi.outlier.df <- get(load("mt20190204_chi.outlier.df"))

# Load ChIP data
setwd("~/mydata/Mapping_Clone5_9/nearest_domains-1000-0.9")
file.list <- list.files(pattern = '*.txt')
ChIP.list <- lapply(file.list, read.table, header = TRUE)
ChIP.df <- as.data.frame(ChIP.list)

# Load Lmnb1 data
setwd("~/mydata/Mapping_Clone5_9")
lmn.df <- get(load("rs20190116_RSTP2.2000.Chromatin.RData"))

# Load clone 5 barcode data
clone5.bc <- read.delim("mt20190204_clone5_barcodes.txt")
```

## Pre-processing: Importing ChIP data
```{r}
# Remove not needed data
ChIP.df <- select(ChIP.df, ends_with("e"), contains("Distance"))

# Rename variables 
names(ChIP.df)[2:38] <- gsub(".*_.*_(.*?)_.*.txt", "\\1", file.list)

# Process lmn dataset
lmn.df <- lmn.df[,c(1,101)]
lmn.df <- lmn.df[!duplicated(lmn.df), ]
lmn.df <- merge(lmn.df, clone5.bc)
setnames(ChIP.df, old = "Barcode", new = "barcode")
ChIP.df <- merge(ChIP.df, clone5.bc)

# Combine the two chr. state dfs
ChIP.df <- merge(lmn.df, ChIP.df, all = TRUE)

# Change from distance to integration: yes (1) or no (0)
ChIP.df[,3:ncol(ChIP.df)] <- ifelse(ChIP.df[,3:ncol(ChIP.df)] > 0, 0, 1)
ChIP.df[,2] <- ifelse(ChIP.df[,2] == "AD", 1, 0)

# Remove .B from barcode
ChIP.df$barcode <- gsub(".B","",ChIP.df$barcode)
```


## Import chromatin data
```{r import chromatin data}
# Import chromatin data
indel.data <- merge(indel.data, ChIP.df, all = TRUE)

# Make df more sexy
indel.data <- indel.data[,c(-2,-5,-8:-14,-16,-17,-22,-25,-32:-38)]
indel.data <- indel.data[-grep("ACCCCTAAAGGCGCTG", indel.data$barcode),]
```


## Generate heatmap
```{r generate heatmap}
# Split up per concentration
indel.data.high <- indel.data[grep("10um", indel.data$condition),]
indel.data.med <- indel.data[grep("1um", indel.data$condition),]
indel.data.low <- indel.data[grep("100nm", indel.data$condition),]

# Compute mean of logratio per barcode and drug/target
indel.data.high$mean.logratio.bc.drug <- ave(indel.data.high$logratio.platenorm, indel.data.high$barcode, indel.data.high$Drug, FUN = function(x) mean(x))
indel.data.med$mean.logratio.bc.drug <- ave(indel.data.med$logratio.platenorm, indel.data.med$barcode, indel.data.med$Drug, FUN = function(x) mean(x))
indel.data.low$mean.logratio.bc.drug <- ave(indel.data.low$logratio.platenorm, indel.data.low$barcode, indel.data.low$Drug, FUN = function(x) mean(x))

indel.data.high$mean.logratio.bc.target <- ave(indel.data.high$logratio.platenorm, indel.data.high$barcode, indel.data.high$Target, FUN = function(x) mean(x))
indel.data.med$mean.logratio.bc.target <- ave(indel.data.med$logratio.platenorm, indel.data.med$barcode, indel.data.med$Target, FUN = function(x) mean(x))
indel.data.low$mean.logratio.bc.target <- ave(indel.data.low$logratio.platenorm, indel.data.low$barcode, indel.data.low$Target, FUN = function(x) mean(x))

## Heatmap for each barcode vs each drug
# Remove columns
indel.data.high2 <- indel.data.high[,c(1,4,57)]
indel.data.med2 <- indel.data.med[,c(1,4,57)]
indel.data.low2 <- indel.data.low[,c(1,4,57)]
indel.data.high2 <- indel.data.high2[!duplicated(indel.data.high2), ]
indel.data.med2 <- indel.data.med2[!duplicated(indel.data.med2), ]
indel.data.low2 <- indel.data.low2[!duplicated(indel.data.low2), ]

# Transform to wide format for visualization purposes
indel.data.low2 <- dcast(indel.data.low2, Drug ~ barcode, value.var="mean.logratio.bc.drug")
indel.data.med2 <- dcast(indel.data.med2, Drug ~ barcode, value.var="mean.logratio.bc.drug")
indel.data.high2 <- dcast(indel.data.high2, Drug ~ barcode, value.var="mean.logratio.bc.drug")

# Color function for heatmap
col_fun = colorRamp2(c(-2, 0, 2), c("blue", "white", "red"))

# Create matrix and use heatmap function
row.names(indel.data.high2) <- indel.data.high2$Drug
indel.data.high2 <- indel.data.high2[,c(-1)]
heatmap.drug.high2 <- heatmap(as.matrix(indel.data.high2, cexRow=0.5))

row.names(indel.data.med2) <- indel.data.med2$Drug
indel.data.med2 <- indel.data.med2[,c(-1)]
heatmap.drug.med <- heatmap(as.matrix(indel.data.med2))

row.names(indel.data.low2) <- indel.data.low2$Drug
indel.data.low2 <- indel.data.low2[,c(-1)]
heatmap.drug.low <- heatmap(as.matrix(indel.data.low2))



## Heatmap for each barcode vs each target
# Remove columns
indel.data.high3 <- indel.data.high[,c(1,5,58)]
indel.data.med3 <- indel.data.med[,c(1,5,58)]
indel.data.low3 <- indel.data.low[,c(1,5,58)]
indel.data.high3 <- indel.data.high3[!duplicated(indel.data.high3), ]
indel.data.med3 <- indel.data.med3[!duplicated(indel.data.med3), ]
indel.data.low3 <- indel.data.low3[!duplicated(indel.data.low3), ]



# Transform to wide format for visualization purposes
indel.data.low3 <- dcast(indel.data.low3, Target ~ barcode, value.var="mean.logratio.bc.target")
indel.data.med3 <- dcast(indel.data.med3, Target ~ barcode, value.var="mean.logratio.bc.target")
indel.data.high3 <- dcast(indel.data.high3, Target ~ barcode, value.var="mean.logratio.bc.target")


# Create matrix and use heatmap function
row.names(indel.data.high3) <- indel.data.high3$Target
indel.data.high3 <- indel.data.high3[,c(-1)]
heatmap.target.high <- heatmap(as.matrix(indel.data.high3))

row.names(indel.data.med3) <- indel.data.med3$Target
indel.data.med3 <- indel.data.med3[,c(-1)]
heatmap.target.med <- heatmap(as.matrix(indel.data.med3))

row.names(indel.data.low3) <- indel.data.low3$Target
indel.data.low3 <- indel.data.low3[,c(-1)]
heatmap.target.low <- heatmap(as.matrix(indel.data.low3))

```

## Export figures
```{r}
# Visualize heatmaps
# Per target group
grid.newpage()
pushViewport(viewport(layout = grid.layout(nr = 2, nc = 2)))
pushViewport(viewport(layout.pos.row = 1, layout.pos.col = 1))
draw(Heatmap(as.matrix(indel.data.high3), col = col_fun, column_title = "10uM drugs administered", show_heatmap_legend = FALSE, row_names_gp = gpar(fontsize = 8), column_names_gp = gpar(fontsize = 10)), newpage = FALSE)
upViewport()

pushViewport(viewport(layout.pos.row = 1, layout.pos.col = 2))
draw(Heatmap(as.matrix(indel.data.med3), col = col_fun, column_title = "1uM drugs administered", row_names_gp = gpar(fontsize = 8), column_names_gp = gpar(fontsize = 10), show_heatmap_legend = FALSE), newpage = FALSE)
upViewport()

pushViewport(viewport(layout.pos.row = 2, layout.pos.col = 1))
draw(Heatmap(as.matrix(indel.data.low3), col = col_fun, column_title = "100nm drugs administered", row_names_gp = gpar(fontsize = 8), column_names_gp = gpar(fontsize = 10), show_heatmap_legend = FALSE), newpage = FALSE)
upViewport()

lgd = Legend(at = c(-2, -1, 0, 1, 2), col_fun = col_fun, title = "log2(+1/-7 indel ratio)", title_position = "topleft")

pushViewport(viewport(layout.pos.row = 2, layout.pos.col = 2))
grid.draw(lgd)
upViewport()

upViewport()

# p-heatmap
pheatmap(as.matrix(indel.data.high3))
pheatmap(as.matrix(indel.data.med3))
pheatmap(as.matrix(indel.data.low3))

# Without DNA-PKi
pheatmap(as.matrix(indel.data.high3[-2,]))
pheatmap(as.matrix(indel.data.med3[-2,]))
pheatmap(as.matrix(indel.data.low3[-2,]))


# Heatmap per barcode
grid.newpage()
pushViewport(viewport(layout = grid.layout(nr = 2, nc = 2)))
pushViewport(viewport(layout.pos.row = 1, layout.pos.col = 1))
draw(Heatmap(as.matrix(indel.data.high2), col = col_fun, column_title = "10uM drugs administered", show_heatmap_legend = FALSE, row_names_gp = gpar(fontsize = 2), column_names_gp = gpar(fontsize = 10)), newpage = FALSE)
upViewport()

pushViewport(viewport(layout.pos.row = 1, layout.pos.col = 2))
draw(Heatmap(as.matrix(indel.data.med2), col = col_fun, column_title = "1uM drugs administered", row_names_gp = gpar(fontsize = 2), column_names_gp = gpar(fontsize = 10), show_heatmap_legend = FALSE), newpage = FALSE)
upViewport()

pushViewport(viewport(layout.pos.row = 2, layout.pos.col = 1))
draw(Heatmap(as.matrix(indel.data.low2), col = col_fun, column_title = "100nm drugs administered", row_names_gp = gpar(fontsize = 2), column_names_gp = gpar(fontsize = 10), show_heatmap_legend = FALSE), newpage = FALSE)
upViewport()

lgd = Legend(at = c(-2, -1, 0, 1, 2), col_fun = col_fun, title = "log2(+1/-7 indel ratio)", title_position = "topleft")

pushViewport(viewport(layout.pos.row = 2, layout.pos.col = 2))
grid.draw(lgd)
upViewport()

upViewport()

# pheatmap
pheatmap(as.matrix(indel.data.high2), show_rownames = FALSE)
pheatmap(as.matrix(indel.data.med2), fontsize_row = 3)

tiff("test.tiff", units="in", width=5, height=5, res=300)
pheatmap(as.matrix(indel.data.low2), cellheight = 1.5, fontsize = 2)
dev.off()



# Barcode heatmap per target?


```





# Find drugs that have effect on one chr.state but not on the other



## The same for t.outlier.df
```{r}
# # Import chromatin data
# t.outlier.df <- merge(t.outlier.df, ChIP.df, all = TRUE)
# 
# # Make df more sexy
# t.outlier.df <- t.outlier.df[-grep("ACCCCTAAAGGCGCTG", t.outlier.df$barcode),]
# t.outlier.df <- t.outlier.df[-grep("CTCTTAATCGCTGCC", t.outlier.df$barcode),]
# 
# 
# # Check which drugs inhibit all barcodes
# for (i in unique(t.outlier.df$Drug)) {
#     print(i)
#     print(length(unique(t.outlier.df$barcode[t.outlier.df$Drug == i])))
#   }
# 
# # Make pan-inhibitor drug df and selective inhibitor df
# pan.inhibitor.df <- t.outlier.df[grep("GSK J4 HCl|AZD1480|AZ 960|MLN8054|AMG-900|BMN 673|Mirin|CYT387|DNA-PKi", t.outlier.df$Drug),]
# sel.inhibitor.df <- t.outlier.df[-grep("GSK J4 HCl|AZD1480|AZ 960|MLN8054|AMG-900|BMN 673|Mirin|CYT387|DNA-PKi", t.outlier.df$Drug),]
# sel.inhibitor.df <- sel.inhibitor.df[abs(sel.inhibitor.df$statistic) > 10,]
# 
# sel.inhibitor.df <- sel.inhibitor.df[-grep("Aurora Kinase", sel.inhibitor.df$Target),]
# sel.inhibitor.df <- sel.inhibitor.df[,c(1,2,6,7,23,27)]
# 
# indel.data$mean.logratio.drug.bc <- ave(indel.data$logratio.platenorm, indel.data$Drug, indel.data$barcode, FUN = function(x) mean(x))
# 
# # Make a nice plot to see effect of selective drugs
# for (i in unique(indel.data$Drug)) {
#   if( i %in% sel.inhibitor.df$Drug) {
#   data <- indel.data[indel.data$Drug == c(i,"DMSO"), ]
#   p <- ggplot(data = data) +
#     geom_point(mapping = aes(x = barcode, y = mean.logratio.drug.bc, colour = Drug))+
#     geom_point(data = filter(data, statistic > 10), size = 10, colour ="red")+
#     theme(axis.text.x = element_text(angle = 90, hjust = 1.0, vjust = 0))+ 
#     ylab("log2(+1/-7 ratio)") + xlab("Barcode") + labs(fill="titel")
#   print(p)
#   }
# }
# 
# colours = c("DMSO" = "#999999", i = "#FF9966")
# 
# 
# 
# 
# 
# 
# t.outlier.df <- t.outlier.df[,c(-2,-5,-8:-14,-16,-17,-22,-25)]
# 
# 
# # Compute mean of logratio per barcode and drug
# t.outlier.df$mean.logratio.bc.drug <- ave(t.outlier.df$logratio.platenorm, t.outlier.df$barcode, t.outlier.df$Drug, FUN = function(x) mean(x))
# 
# # Rename barcode column
# t.outlier.df$barcode<- with(t.outlier.df, paste0(barcode, Drug, collapse = "_"))
# 
# # Split up per concentration
# t.outlier.df.high <- t.outlier.df[grep("10um", t.outlier.df$condition),]
# t.outlier.df.med <- t.outlier.df[grep("1um", t.outlier.df$condition),]
# t.outlier.df.low <- t.outlier.df[grep("100nm", t.outlier.df$condition),]
# 
# # Remove columns
# t.outlier.df.high <- t.outlier.df.high[,c(1,19:56)]
# t.outlier.df.med <- t.outlier.df.med[,c(1,19:56)]
# t.outlier.df.low <- t.outlier.df.low[,c(1,19:56)]
# 
# logratio <- t.outlier.df[,c(1,57)]
# 
# t.outlier.df.high <- t.outlier.df.high[!duplicated(t.outlier.df.high), ]
# t.outlier.df.med <- t.outlier.df.med[!duplicated(t.outlier.df.med), ]
# t.outlier.df.low <- t.outlier.df.low[!duplicated(t.outlier.df.low), ]
# 
# 
# 
# t.outlier.df.high2 <- melt(t.outlier.df.high)
# t.outlier.df.high2 <- merge(t.outlier.df.high2, logratio)
# 
# 
# 
# for (i in t.outlier.df.high$Drug) {
#     p <- count_if(1, t.outlier.df.high$LAD_state[t.outlier.df.high$Drug == i])
#     print(i)
#     print(length(i))
#     print(p)
#   }

```

## Bind version
```{r}
# ChIP.df <- melt(ChIP.df)
# t.outlier.df2 <- merge(ChIP.df, t.outlier.df, all=TRUE)

```


## Visualisation
```{r Visualization}
```

# Results
```{r}
```

# Conclusions
```{r}
```

## Exporting potential data. 
```{r}
```

# Session Info
```{r}
paste("Run time: ",format(Sys.time()-StartTime))
getwd()
date()
sessionInfo()
```

