---
title: "Validating hits from the epigenetic screening"
author: "Max Trauernicht"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    code_folding: show
    highlight: monochrome
    theme: journal
    toc: yes
    toc_float: yes
  word_document:
    toc: yes
  pdf_document:
    toc: yes
  editor_options:
    chunk_output_type: inline
---

# knitr document van Steensel lab

# Epigenetic Screening

# Introduction
This script tries to find out which drugs are able to significantly alter indel pattern formation in RSTP2#5 cells in different chromatin contexts. In the end, the aim is to couple biological relevance to these changes.

## Description of Data
How to make a good rendering table: 
```{r table1, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
tabl <- "
| column1	|	column2	|	column3	|	
|----|----|----|
|1	|	2	|	3	|	
|a	|	b	|	c	|	
"
cat(tabl) # output the table in a format good for HTML/PDF/docx conversion
```

# Data processing
## Path, Libraries, Parameters and Useful Functions
```{r setup}
knitr::opts_chunk$set(echo = TRUE)
StartTime <-Sys.time()

# 8-digit Date tag:
Date <- substr(gsub("-","",Sys.time()),1,8) 
# libraries:
library(dplyr)
library(outliers)
library(ggplot2)
library(ggbeeswarm)
library(data.table)
library(ComplexHeatmap)
library(circlize)
library(pheatmap)
library(gridGraphics)
library(gridExtra)
library(RColorBrewer)
library(Pigengene)
library(tidyr)
library(VennDiagram)
library(ggforce)
```

### Custom functions
Functions used thoughout this script.
```{r}
SetFileName <- function(filename, initials) {
  # Set filename with extension and initials to make filename with date integrated.
  filename <- substitute(filename)
  initials <- substitute(initials)
  filename <- paste0(initials, Date, filename)
  filename
}
```


## Data import
```{r Data Import}
# Import data from 5_HitValidation_DrugScreen.Rmd
setwd("/DATA/usr/m.trauernicht/EpiScreen/epigenetic-screening-on-trip-clone/Data")
mapping_mean <- get(load("mt20190308_mapping_mean"))
mapping_integration <- get(load("mt20190308_mapping_integration"))
indel.data <- get(load("mt20190411_indel.data"))
mapping_integration_long <- get(load("mt20190308_mapping_integration_long"))
mapping_mean_long <- get(load("mt20190308_mapping_mean_long"))
chip_dendogram <- get(load("mt20190308_chip_dendogram"))
mapping_mean_all <- get(load("mt20190329_mapping_mean_all"))

setwd("/DATA/projects/DSBrepair/scratch/")
delay.df <- read.table("cl20190329_minus7_delay.tsv", header = T)
```


## Bring dataframe in suitable format for heatmap function
```{r generate heatmap}
# Split up per concentration
indel.data.high <- indel.data[grep("10um", indel.data$condition),]
indel.data.med <- indel.data[grep("1um", indel.data$condition),]
indel.data.low <- indel.data[grep("100nm", indel.data$condition),]

# Compute mean of logratio per barcode and drug
indel.data.high$mean.logratio.bc.drug <- 
  ave(indel.data.high$logratio.platenorm, 
      indel.data.high$barcode, indel.data.high$Drug, FUN = function(x) mean(x))
indel.data.med$mean.logratio.bc.drug <- 
  ave(indel.data.med$logratio.platenorm, 
      indel.data.med$barcode, indel.data.med$Drug, FUN = function(x) mean(x))
indel.data.low$mean.logratio.bc.drug <- 
  ave(indel.data.low$logratio.platenorm, 
      indel.data.low$barcode, indel.data.low$Drug, FUN = function(x) mean(x))

# Compute mean of logratio per barcode and target
indel.data.high$mean.logratio.bc.target <- 
  ave(indel.data.high$logratio.platenorm, 
      indel.data.high$barcode, indel.data.high$Target, FUN = function(x) mean(x))
indel.data.med$mean.logratio.bc.target <- 
  ave(indel.data.med$logratio.platenorm, 
      indel.data.med$barcode, indel.data.med$Target, FUN = function(x) mean(x))
indel.data.low$mean.logratio.bc.target <- 
  ave(indel.data.low$logratio.platenorm, 
      indel.data.low$barcode, indel.data.low$Target, FUN = function(x) mean(x))

# Compute mean of t-statistic per barcode and target
indel.data.high$mean.statistic.bc.target <- 
  ave(indel.data.high$statistic, 
      indel.data.high$barcode, indel.data.high$Target, FUN = function(x) mean(x))
indel.data.med$mean.statistic.bc.target <- 
  ave(indel.data.med$statistic, 
      indel.data.med$barcode, indel.data.med$Target, FUN = function(x) mean(x))
indel.data.low$mean.statistic.bc.target <- 
  ave(indel.data.low$statistic, 
      indel.data.low$barcode, indel.data.low$Target, FUN = function(x) mean(x))

# Compute mean of t-statistic per barcode and drug
indel.data.high$mean.statistic.bc.drug <- 
  ave(indel.data.high$statistic, 
      indel.data.high$barcode, indel.data.high$Drug, FUN = function(x) mean(x))
indel.data.med$mean.statistic.bc.drug <- 
  ave(indel.data.med$statistic, 
      indel.data.med$barcode, indel.data.med$Drug, FUN = function(x) mean(x))
indel.data.low$mean.statistic.bc.drug <- 
  ave(indel.data.low$statistic, 
      indel.data.low$barcode, indel.data.low$Drug, FUN = function(x) mean(x))

# Compute mean of efficiency per barcode and drug
indel.data.high$mean.eff.bc.drug <- 
  ave(indel.data.high$efficiency.platenorm, 
      indel.data.high$barcode, indel.data.high$Drug, FUN = function(x) mean(x))
indel.data.med$mean.eff.bc.drug <- 
  ave(indel.data.med$efficiency.platenorm, 
      indel.data.med$barcode, indel.data.med$Drug, FUN = function(x) mean(x))
indel.data.low$mean.eff.bc.drug <- 
  ave(indel.data.low$efficiency.platenorm, 
      indel.data.low$barcode, indel.data.low$Drug, FUN = function(x) mean(x))


# Compute mean and sd of barcode counts per barcode and drug
indel.data.high$mean.count.bc.drug <- 
  ave(indel.data.high$rel.counts, 
      indel.data.high$barcode, indel.data.high$Drug, FUN = function(x) mean(x))
indel.data.high$sd.count.bc.drug <- 
  ave(indel.data.high$rel.counts, 
      indel.data.high$barcode, indel.data.high$Drug, FUN = function(x) sd(x))
indel.data.med$mean.count.bc.drug <- 
  ave(indel.data.med$rel.counts, 
      indel.data.med$barcode, indel.data.med$Drug, FUN = function(x) mean(x))
indel.data.med$sd.count.bc.drug <- 
  ave(indel.data.med$rel.counts, 
      indel.data.med$barcode, indel.data.med$Drug, FUN = function(x) sd(x))
indel.data.low$mean.count.bc.drug <- 
  ave(indel.data.low$rel.counts, 
      indel.data.low$barcode, indel.data.low$Drug, FUN = function(x) mean(x))
indel.data.low$sd.count.bc.drug <- 
  ave(indel.data.low$rel.counts, 
      indel.data.low$barcode, indel.data.low$Drug, FUN = function(x) sd(x))
```





## Dataframe preprocessing efficiency difference
```{r}
# Remove columns
indel.data.high.eff <- indel.data.high[,c(1,6,42)]
indel.data.high.eff <- indel.data.high.eff[!duplicated(indel.data.high.eff), ]
indel.data.high.eff <- dcast(indel.data.high.eff, barcode ~ Drug, value.var = "mean.eff.bc.drug")

# Remove columns
indel.data.med.eff <- indel.data.med[,c(1,6,42)]
indel.data.med.eff <- indel.data.med.eff[!duplicated(indel.data.med.eff), ]
indel.data.med.eff <- dcast(indel.data.med.eff, barcode ~ Drug, value.var = "mean.eff.bc.drug")

# Remove columns
indel.data.low.eff <- indel.data.low[,c(1,6,42)]
indel.data.low.eff <- indel.data.low.eff[!duplicated(indel.data.low.eff), ]
indel.data.low.eff <- dcast(indel.data.low.eff, barcode ~ Drug, value.var = "mean.eff.bc.drug")
```


## Dataframe preprocessing relative barcode counts
```{r}
# Remove columns
indel.data.high.count <- indel.data.high[indel.data.high$sd.count.bc.drug < 1,]
indel.data.high.count <- indel.data.high.count[,c(1,6,43)]
indel.data.high.count <- indel.data.high.count[!duplicated(indel.data.high.count), ]
indel.data.high.count <- dcast(indel.data.high.count, barcode ~ Drug, value.var = "mean.count.bc.drug")
indel.data.high.count <- indel.data.high.count[,-118]

indel.data.med.count <- indel.data.med[indel.data.med$sd.count.bc.drug < 1,]
indel.data.med.count <- indel.data.med.count[,c(1,6,43)]
indel.data.med.count <- indel.data.med.count[!duplicated(indel.data.med.count), ]
indel.data.med.count <- dcast(indel.data.med.count, barcode ~ Drug, value.var = "mean.count.bc.drug")
indel.data.med.count <- indel.data.med.count[,-148]


indel.data.low.count <- indel.data.low[indel.data.low$sd.count.bc.drug < 1,]
indel.data.low.count <- indel.data.low.count[,c(1,6,43)]
indel.data.low.count <- indel.data.low.count[!duplicated(indel.data.low.count), ]
indel.data.low.count <- dcast(indel.data.low.count, barcode ~ Drug, value.var = "mean.count.bc.drug")
indel.data.low.count <- indel.data.low.count[,-158]


```



## Dataframe preprocessing t-statistic heatmap of barcode vs. drug
```{r}
# Remove columns
indel.data.high.drug.st <- indel.data.high[,c(1,6,41)]
indel.data.med.drug.st <- indel.data.med[,c(1,6,41)]
indel.data.low.drug.st <- indel.data.low[,c(1,6,41)]
indel.data.high.drug.st <- indel.data.high.drug.st[!duplicated(indel.data.high.drug.st), ]
indel.data.med.drug.st <- indel.data.med.drug.st[!duplicated(indel.data.med.drug.st), ]
indel.data.low.drug.st <- indel.data.low.drug.st[!duplicated(indel.data.low.drug.st), ]

# Transform to wide format for visualization purposes
indel.data.low.drug.st <- 
  dcast(indel.data.low.drug.st, barcode ~ Drug, value.var="mean.statistic.bc.drug")
indel.data.med.drug.st <- 
  dcast(indel.data.med.drug.st, barcode ~ Drug, value.var="mean.statistic.bc.drug")
indel.data.high.drug.st <- 
  dcast(indel.data.high.drug.st, barcode ~ Drug, value.var="mean.statistic.bc.drug")
```



## Dataframe preprocessing logratio heatmap of barcode vs. drug
```{r}
# Remove columns
indel.data.high.drug <- indel.data.high[,c(1,6,38)]
indel.data.med.drug <- indel.data.med[,c(1,6,38)]
indel.data.low.drug <- indel.data.low[,c(1,6,38)]
indel.data.high.drug <- 
  indel.data.high.drug[!duplicated(indel.data.high.drug), ]
indel.data.med.drug <- 
  indel.data.med.drug[!duplicated(indel.data.med.drug), ]
indel.data.low.drug <- 
  indel.data.low.drug[!duplicated(indel.data.low.drug), ]

# Transform to wide format for visualization purposes
indel.data.low.drug <- 
  dcast(indel.data.low.drug, 
        barcode ~ Drug, value.var="mean.logratio.bc.drug")
indel.data.med.drug <- 
  dcast(indel.data.med.drug, 
        barcode ~ Drug, value.var="mean.logratio.bc.drug")
indel.data.high.drug <- 
  dcast(indel.data.high.drug, 
        barcode ~ Drug, value.var="mean.logratio.bc.drug")
```


## Prepare t-statistic heatmaps of barcode vs. drug
```{r}
# Create matrix and use heatmap function
row.names(indel.data.high.drug.st) <- indel.data.high.drug.st$barcode
indel.data.high.drug.st <- indel.data.high.drug.st[,c(-1)]

row.names(indel.data.med.drug.st) <- indel.data.med.drug.st$barcode
indel.data.med.drug.st <- indel.data.med.drug.st[,c(-1)]

row.names(indel.data.low.drug.st) <- indel.data.low.drug.st$barcode
indel.data.low.drug.st <- indel.data.low.drug.st[,c(-1)]

```

## Prepare counts heatmaps of barcode vs. drug
```{r}
# Create matrix and use heatmap function
row.names(indel.data.high.count) <- indel.data.high.count$barcode
indel.data.high.count <- indel.data.high.count[,c(-1)]

row.names(indel.data.med.count) <- indel.data.med.count$barcode
indel.data.med.count <- indel.data.med.count[,c(-1)]

row.names(indel.data.low.count) <- indel.data.low.count$barcode
indel.data.low.count <- indel.data.low.count[,c(-1)]

```



## Generating heatmaps per barcode
```{r}
# Loop for each target: high concentration
target.high <- indel.data.high[,c(6,7)]
target.high <- target.high[!duplicated(target.high), ]
indel.data.high.drug2 <- melt(indel.data.high.drug)
indel.data.high.drug2 <- dcast(indel.data.high.drug2, variable ~ barcode, value.var = "value")
setnames(target.high, old = "Drug", new = "variable")
indel.data.high.drug2 <- merge(indel.data.high.drug2, target.high)
row.names(indel.data.high.drug2) <- indel.data.high.drug2$variable
indel.data.high.drug2 <- indel.data.high.drug2[,-1]
data2 <- indel.data.high.drug2[-grep("Negative control|MRN|DNA-PK",indel.data.high.drug2$Target),]

# Loop for each target: med concentration
target.med <- indel.data.med[,c(6,7)]
target.med <- target.med[!duplicated(target.med), ]
indel.data.med.drug2 <- melt(indel.data.med.drug)
indel.data.med.drug2 <- dcast(indel.data.med.drug2, variable ~ barcode, value.var = "value")
setnames(target.med, old = "Drug", new = "variable")
indel.data.med.drug2 <- merge(indel.data.med.drug2, target.med)
row.names(indel.data.med.drug2) <- indel.data.med.drug2$variable
indel.data.med.drug2 <- indel.data.med.drug2[,-1]
data3 <- indel.data.med.drug2[-grep("Negative control|MRN|DNA-PK",indel.data.med.drug2$Target),]

# Loop for each target: low concentration
target.low <- indel.data.low[,c(6,7)]
target.low <- target.low[!duplicated(target.low), ]
indel.data.low.drug2 <- melt(indel.data.low.drug)
indel.data.low.drug2 <- dcast(indel.data.low.drug2, variable ~ barcode, value.var = "value")
setnames(target.low, old = "Drug", new = "variable")
indel.data.low.drug2 <- merge(indel.data.low.drug2, target.low)
row.names(indel.data.low.drug2) <- indel.data.low.drug2$variable
indel.data.low.drug2 <- indel.data.low.drug2[,-1]
data4 <- indel.data.low.drug2[-grep("Negative control|MRN|DNA-PK",indel.data.low.drug2$Target),]


# Loop for each target: high concentration
target.high.eff <- indel.data.high[,c(6,7)]
target.high.eff <- target.high.eff[!duplicated(target.high.eff), ]
indel.data.high.drug2 <- melt(indel.data.high.eff)
indel.data.high.drug2 <- dcast(indel.data.high.drug2, variable ~ barcode, value.var = "value")
setnames(target.high.eff, old = "Drug", new = "variable")
indel.data.high.drug2 <- merge(indel.data.high.drug2, target.high.eff)
row.names(indel.data.high.drug2) <- indel.data.high.drug2$variable
indel.data.high.drug2 <- indel.data.high.drug2[,-1]
data5 <- indel.data.high.drug2[-grep("Negative control|MRN|DNA-PK",indel.data.high.drug2$Target),]

# Loop for each target: med concentration
target.med.eff <- indel.data.med[,c(6,7)]
target.med.eff <- target.med.eff[!duplicated(target.med.eff), ]
indel.data.med.drug2 <- melt(indel.data.med.eff)
indel.data.med.drug2 <- dcast(indel.data.med.drug2, variable ~ barcode, value.var = "value")
setnames(target.med.eff, old = "Drug", new = "variable")
indel.data.med.drug2 <- merge(indel.data.med.drug2, target.med.eff)
row.names(indel.data.med.drug2) <- indel.data.med.drug2$variable
indel.data.med.drug2 <- indel.data.med.drug2[,-1]
data6 <- indel.data.med.drug2[-grep("Negative control|MRN|DNA-PK",indel.data.med.drug2$Target),]

# Loop for each target: high concentration
target.low.eff <- indel.data.low[,c(6,7)]
target.low.eff <- target.low.eff[!duplicated(target.low.eff), ]
indel.data.low.drug2 <- melt(indel.data.low.eff)
indel.data.low.drug2 <- dcast(indel.data.low.drug2, variable ~ barcode, value.var = "value")
setnames(target.low.eff, old = "Drug", new = "variable")
indel.data.low.drug2 <- merge(indel.data.low.drug2, target.low.eff)
row.names(indel.data.low.drug2) <- indel.data.low.drug2$variable
indel.data.low.drug2 <- indel.data.low.drug2[,-1]
data7 <- indel.data.low.drug2[-grep("Negative control|MRN|DNA-PK",indel.data.low.drug2$Target),]





# Heatmap per barcode
row.names(indel.data.high.drug) <- indel.data.high.drug$barcode
indel.data.high.drug <- indel.data.high.drug[,c(-1)]

row.names(indel.data.med.drug) <- indel.data.med.drug$barcode
indel.data.med.drug <- indel.data.med.drug[,c(-1)]

row.names(indel.data.low.drug) <- indel.data.low.drug$barcode
indel.data.low.drug <- indel.data.low.drug[,c(-1)]

rownames(indel.data.high.eff) <- indel.data.high.eff$barcode
indel.data.high.eff <- indel.data.high.eff[,-1]

rownames(indel.data.med.eff) <- indel.data.med.eff$barcode
indel.data.med.eff <- indel.data.med.eff[,-1]

rownames(indel.data.low.eff) <- indel.data.low.eff$barcode
indel.data.low.eff <- indel.data.low.eff[,-1]

# Row annotation: annotate drugs with the target group
target <- indel.data[,c(6,7)]
target <- target[!duplicated(target), ]
target$random <- c(1:164)
row.names(target) <- target$Drug
target2 <- target
target <- target[,c(-1,-3)]
target <- as.data.frame(target)
row.names(target) <- target2$Drug


# Add type of chr. mark (repressive or active)
type <- mapping_mean_long[,c(2,4)]
type <- type[!duplicated(type), ]
type$random <- c(1:13)
row.names(type) <- type$variable
type2 <- type
type <- type[,c(-1,-3)]
type <- as.data.frame(type)
row.names(type) <- type2$variable

# Change colors of annotations
annotation_colors_scr = list(
  LMNB1 = colorRampPalette(rev(brewer.pal(n = 7, name = "PiYG")))(100),
  H3K27me3 = colorRampPalette(rev(brewer.pal(n = 7, name = "PiYG")))(100),
  H3K36me3 = colorRampPalette(rev(brewer.pal(n = 7, name = "PiYG")))(100),
  POL2 = colorRampPalette(rev(brewer.pal(n = 7, name = "PiYG")))(100),
  H3K27ac = colorRampPalette(rev(brewer.pal(n = 7, name = "PiYG")))(100),
  mean_ratio = colorRampPalette(rev(brewer.pal(n = 7, name = "PiYG")))(100),
  type = c(Active="#669966", Repressive="grey90"),
  target = c("Sirtuin" = '#e6194b', "HDAC" = '#3cb44b', "PARP" = '#ffe119', "Negative control" = '#4363d8', "Epigenetic Reader Domain" = '#f58231', "MRN" = '#911eb4', "DNMT" = '#46f0f0', "HMT" = '#f032e6', "Aurora Kinase" = '#bcf60c', "JAK" = '#fabebe', "Histone demethylase" = '#008080', "HAT" = '#e6beff', "DNA-PK" = '#9a6324', "HIF" = '#fffac8', "PIM" = '#800000'))

```

I want to create heatmaps for each drug within the 17 different target groups. This will give more information about the effect of individual drugs (and maybe clustering within groups -> subgroups because of different targets etc.).


\newpage
# Results
\newpage
## logratio heatmap of each individual drug vs. barcode
```{r visualization each drug, out.width= "100%", fig.align= "center", echo=FALSE}

## Every drug
# Keeping the scale in the pheatmap function
myBreaks5 <- c(seq(min(as.matrix(indel.data.high.drug)), 0, 
                   length.out=ceiling(100/2) + 1), 
              seq(max(as.matrix(indel.data.high.drug))/100, 
                  max(as.matrix(indel.data.high.drug)), length.out=floor(100/2)))

# pheatmap function: logratio heatmap of each individual drug vs. barcode - 10uM drugs added
pheatmap(as.matrix(indel.data.high.drug),
         annotation_col = target, 
         annotation_row = annotate.bc,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdGy")))(100),
         breaks = myBreaks5, cluster_rows = chip_dendogram$tree_col,
         annotation_colors = annotation_colors_scr, 
         main = "log2(+1/-7 indel ratio) change - 10uM of drugs added")
```

```{r visualization essential drugs, out.width= "100%", fig.align= "center", echo=FALSE}
## Only drugs that change ratio
# pheatmap function: without DNA-PKi: logratio heatmap of eac a certain fold change
indel.data.high.drug.ess <- indel.data.high.drug[,c(-49,-99)]
indel.data.high.drug.ess[is.na(indel.data.high.drug.ess)] <- 0
indel.data.high.drug.ess <- 
  indel.data.high.drug.ess[, 
                          colSums(indel.data.high.drug.ess > 1) >= 1 |
                            colSums(indel.data.high.drug.ess < -0.5) >= 1]
# Keeping the scale in the pheatmap function
myBreaks6 <- c(seq(min(as.matrix(indel.data.high.drug.ess)), 0, 
                   length.out=ceiling(100/2) + 1), 
              seq(max(as.matrix(indel.data.high.drug.ess))/100, 
                  max(as.matrix(indel.data.high.drug.ess))/2, length.out=floor(100/2)))

pheatmap(as.matrix(indel.data.high.drug.ess),
         annotation_col = target, border_color = "grey60",
         annotation_row = annotate.bc, annotation_legend = F,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
         breaks = myBreaks6, # cluster_rows = chip_dendogram$tree_col,
         annotation_colors = annotation_colors_scr, 
         main = "log2(+1/-7 indel ratio) change - 10uM of drugs added")


# pheatmap function: without DNA-PKi: logratio heatmap of each individual drug vs. barcode - 1uM drugs added- include only drugs that achieve a certain fold change
indel.data.med.drug.ess <- indel.data.med.drug[,-43]
indel.data.med.drug.ess <- 
  indel.data.med.drug.ess[, 
                          colSums(indel.data.med.drug.ess > 1) >= 1 |
                            colSums(indel.data.med.drug.ess < -0.5) >= 1] 

myBreaks7 <- c(seq(min(as.matrix(indel.data.med.drug.ess)), 0, 
                   length.out=ceiling(100/2) + 1), 
              seq(max(as.matrix(indel.data.med.drug.ess))/100, 
                  max(as.matrix(indel.data.med.drug.ess))/2, length.out=floor(100/2)))

pheatmap(as.matrix(indel.data.med.drug.ess), 
         annotation_col = target,
         annotation_row = annotate.bc,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
         breaks = myBreaks7, cluster_rows = chip_dendogram$tree_col,
         annotation_colors = annotation_colors_scr, annotation_legend = F,
         main = "log2(+1/-7 indel ratio) change - 1uM of drugs added")


# pheatmap function: without DNA-PKi: logratio heatmap of each individual drug vs. barcode - 100nM drugs added - include only drugs that achieve a certain fold change
indel.data.low.drug.ess <- indel.data.low.drug[,-47]
indel.data.low.drug.ess <- 
  indel.data.low.drug.ess[, 
                          colSums(indel.data.low.drug.ess > 0.75) >= 1 |
                            colSums(indel.data.low.drug.ess < -0.5) >= 1]

myBreaks8 <- c(seq(min(as.matrix(indel.data.low.drug.ess)), 0, 
                   length.out=ceiling(100/2) + 1), 
              seq(max(as.matrix(indel.data.low.drug.ess))/100, 
                  max(as.matrix(indel.data.low.drug.ess))/2, length.out=floor(100/2)))

pheatmap(as.matrix(indel.data.low.drug.ess), 
         annotation_col = target, 
         annotation_row = annotate.bc,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
         breaks = myBreaks8, cluster_rows = chip_dendogram$tree_col,
         annotation_colors = annotation_colors_scr, annotation_legend = F,
         main = "log2(+1/-7 indel ratio) change - 100nM of drugs added")
```


```{r visualization efficiency, out.width= "100%", fig.align= "center", echo=FALSE}
# Efficiency change heatmap - 10 uM
myBreaks8.5 <- c(seq(min(as.matrix(indel.data.high.eff)), 0, 
                   length.out=ceiling(100/2) + 1), 
              seq(max(as.matrix(indel.data.high.eff))/100, 
                  max(as.matrix(indel.data.high.eff)), length.out=floor(100/2)))


pheatmap(as.matrix(indel.data.high.eff[,-36]), fontsize_col = 8, fontsize_row = 8, 
         annotation_col = target, cellheight = 8,
         annotation_row = annotate.bc,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdGy")))(100),
         breaks = myBreaks8.5, cluster_rows = chip_dendogram$tree_col,
         annotation_colors = annotation_colors_scr, 
         main = "efficiency change - 10uM of drugs added")


# Efficiency change heatmap - 10 uM - only essentials
indel.data.high.eff.ess <- indel.data.high.eff[,-36]
indel.data.high.eff.ess <- 
  indel.data.high.eff.ess[, 
                          colSums(indel.data.high.eff.ess > 0.0666) >= 1 |
                            colSums(indel.data.high.eff.ess < -0.1333) >= 1]

myBreaks8.51 <- c(seq(min(as.matrix(indel.data.high.eff.ess))/1.5, 0, 
                   length.out=ceiling(100/2) + 1), 
              seq(max(as.matrix(indel.data.high.eff.ess))/100, 
                  max(as.matrix(indel.data.high.eff.ess))/1.5, length.out=floor(100/2)))

pheatmap(as.matrix(indel.data.high.eff.ess),
         annotation_col = target,   
         annotation_row = annotate.bc,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
         breaks = myBreaks8.51, cluster_rows = chip_dendogram$tree_col,
         annotation_colors = annotation_colors_scr, annotation_legend = F,
         main = "efficiency change - 10uM of drugs added")


# Efficiency change heatmap - 1 uM
indel.data.med.eff.ess <- indel.data.med.eff[,-43]
indel.data.med.eff.ess <- 
  indel.data.med.eff.ess[, 
                         colSums(indel.data.med.eff.ess > 0.0666) >= 1 | 
                           colSums(indel.data.med.eff.ess < -0.1333) >= 1]

myBreaks9.5 <- c(seq(min(as.matrix(indel.data.med.eff.ess))/1.5, 0, 
                   length.out=ceiling(100/2) + 1), 
              seq(max(as.matrix(indel.data.med.eff.ess))/100, 
                  max(as.matrix(indel.data.med.eff.ess))/1.5, length.out=floor(100/2)))

pheatmap(as.matrix(indel.data.med.eff.ess), 
         annotation_col = target, 
         annotation_row = annotate.bc,annotation_legend = F,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
         breaks = myBreaks9.5, cluster_rows = chip_dendogram$tree_col,
         annotation_colors = annotation_colors_scr, 
         main = "efficiency change - 1uM of drugs added")


# Efficiency change heatmap - 100 nM
indel.data.low.eff.ess <- indel.data.low.eff[,-47]
indel.data.low.eff.ess <- 
  indel.data.low.eff.ess[, 
                         colSums(indel.data.low.eff.ess > 0.0666) >= 1 |
                           colSums(indel.data.low.eff.ess < -0.1333) >= 1]

myBreaks10.5 <- c(seq(min(as.matrix(indel.data.low.eff.ess))/1.5, 0, 
                   length.out=ceiling(100/2) + 1), 
              seq(max(as.matrix(indel.data.low.eff.ess))/100, 
                  max(as.matrix(indel.data.low.eff.ess))/1.5, length.out=floor(100/2)))

pheatmap(as.matrix(indel.data.low.eff.ess), 
         annotation_col = target,
         annotation_row = annotate.bc, annotation_legend = F,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
         breaks = myBreaks10.5, cluster_rows = chip_dendogram$tree_col,
         annotation_colors = annotation_colors_scr, 
         main = "efficiency change - 100nM of drugs added")
```
\newpage
## Read count heatmap
```{r visualization essential drugs, out.width= "100%", fig.align= "center", echo=FALSE}
## Only drugs that change ratio
# pheatmap function: count heatmap, selecting only 
indel.data.high.count <- na.omit(indel.data.high.count)
indel.data.high.count.ess <- 
  indel.data.high.count[, 
                         colSums(indel.data.high.count > 1.666) >= 1 |
                           colSums(indel.data.high.count < 0.666) >= 1]



# Keeping the scale in the pheatmap function
myBreaks22 <- c(seq(min(as.matrix(indel.data.high.count.ess)), 1, 
                length.out=ceiling(100/2) + 1), 
              seq(1.001, max(as.matrix(indel.data.high.count.ess)), 
                  length.out=floor(100/2)))

pheatmap(as.matrix(indel.data.high.count.ess),
         annotation_col = target, border_color = "grey60",
         annotation_row = annotate.bc, annotation_legend = F,
         color = colorRampPalette(brewer.pal(n = 7, name = "YlOrRd"))(100),
         breaks = myBreaks22, # cluster_rows = chip_dendogram$tree_col,
         annotation_colors = annotation_colors_scr, 
         main = "barcode count relative to DMSO - 10uM of drugs added")


# pheatmap function: count heatmap, selecting only 
indel.data.med.count <- na.omit(indel.data.med.count)
indel.data.med.count.ess <- 
  indel.data.med.count[, 
                         colSums(indel.data.med.count > 1.666) >= 1 |
                           colSums(indel.data.med.count < 0.666) >= 1]



# Keeping the scale in the pheatmap function
myBreaks23 <- c(seq(min(as.matrix(indel.data.med.count.ess)), 1, 
                length.out=ceiling(100/2) + 1), 
              seq(1.001, max(as.matrix(indel.data.med.count.ess)), 
                  length.out=floor(100/2)))

pheatmap(as.matrix(indel.data.med.count.ess),
         annotation_col = target, border_color = "grey60",
         annotation_row = annotate.bc, annotation_legend = F,
         color = colorRampPalette(brewer.pal(n = 7, name = "YlOrRd"))(100),
         breaks = myBreaks23, # cluster_rows = chip_dendogram$tree_col,
         annotation_colors = annotation_colors_scr, 
         main = "barcode count relative to DMSO - 1uM of drugs added")

# pheatmap function: count heatmap, selecting only 
indel.data.low.count <- na.omit(indel.data.low.count)
indel.data.low.count.ess <- 
  indel.data.low.count[, 
                         colSums(indel.data.low.count > 1.666) >= 1 |
                           colSums(indel.data.low.count < 0.666) >= 1]



# Keeping the scale in the pheatmap function
myBreaks24 <- c(seq(min(as.matrix(indel.data.low.count.ess)), 1, 
                length.out=ceiling(100/2) + 1), 
              seq(1.001, max(as.matrix(indel.data.low.count.ess)), 
                  length.out=floor(100/2)))

pheatmap(as.matrix(indel.data.low.count.ess),
         annotation_col = target, border_color = "grey60",
         annotation_row = annotate.bc, annotation_legend = F,
         color = colorRampPalette(brewer.pal(n = 7, name = "YlOrRd"))(100),
         breaks = myBreaks24, # cluster_rows = chip_dendogram$tree_col,
         annotation_colors = annotation_colors_scr, 
         main = "barcode count relative to DMSO - 100nM of drugs added")
```


\newpage
## Efficiency/logratio overlay
```{r visualization overlay efficiency logratio, out.width= "100%", fig.align= "center", echo=FALSE}
# Draw venn diagram to see overlaps between efficiency and logratio outliers
## Calculate the intersections
colnames.logr.high <- colnames((indel.data.high.drug.ess))
colnames.eff.high <- colnames((indel.data.high.eff.ess))
x <- intersect(colnames.logr.high, colnames.eff.high)

colnames.logr.med <- colnames((indel.data.med.drug.ess))
colnames.eff.med <- colnames((indel.data.med.eff.ess))
y <- intersect(colnames.logr.med, colnames.eff.med)

colnames.logr.low <- colnames((indel.data.low.drug.ess))
colnames.eff.low <- colnames((indel.data.low.eff.ess))
z <- intersect(colnames.logr.low, colnames.eff.low)


# Draw the diagrams
## High
draw.pairwise.venn(length(colnames.logr.high), 
                   length(colnames.eff.high), 
                   length(x),
                   category = c("Drugs with altered logratio", "Drugs with alterd efficiency"), 
                   fill = c("blue", "red"), cat.pos = c(2,2))

## Med
draw.pairwise.venn(length(colnames.logr.med), 
                   length(colnames.eff.med), 
                   length(y),
                   category = c("Drugs with altered logratio", "Drugs with alterd efficiency"), 
                   fill = c("blue", "red"), cat.pos = c(2,2))

## Low
draw.pairwise.venn(length(colnames.logr.low), 
                   length(colnames.eff.low), 
                   length(z),
                   category = c("Drugs with altered logratio", "Drugs with alterd efficiency"), 
                   fill = c("blue", "red"), cat.pos = c(2,2))


```






\newpage
## Heatmap efficiency/logratio overlay computation
```{r computation overlay efficiency logratio, out.width= "100%", fig.align= "center", echo=FALSE}
indel.data.high$logratio.platenorm.rel <- ave(indel.data.high$logratio.platenorm, FUN = function (x) 2^x)
indel.data.high$logratio.platenorm.rel <- ave(indel.data.high$logratio.platenorm.rel, FUN = function (x) x/max(x))
indel.data.high$efficiency.platenorm.rel <- ave(indel.data.high$efficiency.platenorm, FUN = function(x) 2^x)
indel.data.high$efficiency.platenorm.rel <- ave(indel.data.high$efficiency.platenorm.rel, FUN = function(x) x/max(x))
indel.data.high$overlay <- abs(indel.data.high$logratio.platenorm.rel - indel.data.high$efficiency.platenorm.rel)
indel.data.high$overlay.drug <- ave(indel.data.high$overlay, indel.data.high$Drug, indel.data.high$barcode, FUN = function(x) mean(x))


indel.data.overlay.high <- indel.data.high[,c(1,6,47)]
indel.data.overlay.high <- 
  indel.data.overlay.high[!duplicated(indel.data.overlay.high), ]
indel.data.overlay.high <- dcast(indel.data.overlay.high, barcode ~ Drug, value.var = "overlay.drug")
rownames(indel.data.overlay.high) <- indel.data.overlay.high[,1]
indel.data.overlay.high <- indel.data.overlay.high[,-1]

myBreaks12.5 <- c(seq(min(as.matrix(indel.data.overlay.high)), 0, 
                   length.out=ceiling(100/2) + 1), 
              seq(max(as.matrix(indel.data.overlay.high))/100, 
                  max(as.matrix(indel.data.overlay.high)), length.out=floor(100/2)))

# pheatmap 
indel.data.overlay.high <- 
  indel.data.overlay.high[, 
                         colSums(indel.data.overlay.high > 0.875) >= 1 | colSums(indel.data.overlay.high < 0.6) >= 1]


pheatmap(as.matrix(indel.data.overlay.high))
```



# Conclusions
This already reveals some useful information, more in-depth studies of individual drugs is needed, especially because the grouping of drugs into categories can be faulty and misleading (inhibitors can be either pan, or selective for a sub-group, which means that they probably affect different locations/barcodes)

Next step is to import the chromatin data to generate a correlation matrix between the logratio change of each drug and the chromatin data. A correlation is calculated by comparing logratio changes of drug A for each barcode with ChIP data of ChIP dataset A for each barcode etc.

## Correlation between ChIP data and logratio changes
```{r correlation chip logratio, out.width= "100%", fig.align= "center", echo=FALSE}
# Import chromatin data
mapping_mean_chip <- mapping_mean_all
chip_data <- melt(mapping_mean_chip, variable.name="barcode", value.name="mean")
chip_data <- dcast(chip_data, barcode ~ variable, value.var = "mean")
chip_data <- chip_data[chip_data$barcode != 
                         "ACCCCTAAAGGCGCTG" & chip_data$barcode != "CTCTTAATCGCTGCC", ]
## In case I want to include the mean.ratio
# chip_data <- merge(chip_data, ratio.bc) 
row.names(chip_data) <- chip_data$barcode
chip_data <- chip_data[,-1]


# Calculate correlations
cor_chip_indel.high <- cor(chip_data,indel.data.high.drug.ess)
cor_chip_indel.med <- cor(chip_data,indel.data.med.drug.ess)
cor_chip_indel.low <- cor(chip_data,indel.data.low.drug.ess)

# Calculate correlations for efficiency data
cor_chip_indel.high.eff <- cor(chip_data,indel.data.high.eff.ess)
cor_chip_indel.med.eff <- cor(chip_data,indel.data.med.eff.ess)
cor_chip_indel.low.eff <- cor(chip_data,indel.data.low.eff.ess)

# Take only drugs that have correlation of absolute > 0.5 with at least one ChIP dataset
# cor_chip_indel.high <- 
#   cor_chip_indel.high[, 
#                       colSums(cor_chip_indel.high > 0.7) >= 1 | 
#                         colSums(cor_chip_indel.high < -0.7) >= 1]
# 
# cor_chip_indel.med <- 
#   cor_chip_indel.med[, 
#                       colSums(cor_chip_indel.med > 0.666) >= 1 | 
#                         colSums(cor_chip_indel.med < -0.666) >= 1]
# 
# cor_chip_indel.low <- 
#   cor_chip_indel.low[, 
#                       colSums(cor_chip_indel.low > 0.666) >= 1 | 
#                         colSums(cor_chip_indel.low < -0.666) >= 1]
# 
# cor_chip_indel.high.eff <- 
#   cor_chip_indel.high.eff[, 
#                       colSums(cor_chip_indel.high.eff > 0.7) >= 1 | 
#                         colSums(cor_chip_indel.high.eff < -0.7) >= 1]
# 
# cor_chip_indel.med.eff <- 
#   cor_chip_indel.med.eff[, 
#                       colSums(cor_chip_indel.med.eff > 0.7) >= 1 | 
#                         colSums(cor_chip_indel.med.eff < -0.7) >= 1]
# 
# cor_chip_indel.low.eff <- 
#   cor_chip_indel.low.eff[, 
#                       colSums(cor_chip_indel.low.eff > 0.7) >= 1 | 
#                         colSums(cor_chip_indel.low.eff < -0.7) >= 1]

# plotting the correlations
cor.pheatmap <- 
  list(cor_chip_indel.high, cor_chip_indel.med, cor_chip_indel.low)
cor.pheatmap.eff <- 
  list(cor_chip_indel.high.eff, cor_chip_indel.med.eff, cor_chip_indel.low.eff)



for(i in 1:(length(cor.pheatmap))) {
  data <- cor.pheatmap[[i]]
p <- pheatmap(data, 
         annotation_col = target,
         annotation_row = type,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
         annotation_colors = annotation_colors_scr, annotation_legend = F,
         main = paste(i,"correlation heatmap: ChiP data vs. logratio change per drug"))
print(p)
}

for(i in 1:(length(cor.pheatmap.eff))) {
  data <- cor.pheatmap.eff[[i]]
p <- pheatmap(data, 
         annotation_col = target,
         annotation_row = type,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
         annotation_colors = annotation_colors_scr, annotation_legend = F,
         main = paste(i,"correlation heatmap: ChiP data vs. efficiency change per drug"))
print(p)
}

```


\newpage
## Drug dose response
```{r drug dose responses, out.width= "100%", fig.align= "center", echo=FALSE}
# Select all drugs that are changed (in either high, med, or low concentration)
names.high <- colnames(indel.data.high.drug.ess)
names.med <- colnames(indel.data.med.drug.ess)
names.low <- colnames(indel.data.low.drug.ess)
indel.data.dose <- indel.data[indel.data$Drug %in% names.high |
                                indel.data$Drug %in% names.med |
                                indel.data$Drug %in% names.low, ]

# Plot drug dose response per drug for all barcodes
indel.data.dose$conc <- factor(indel.data.dose$conc, levels=c("100nm", "1um", "10um"))
for (i in c(1:6)){
p<- ggplot(data = indel.data.dose, aes(x = conc, y = logratio.mean, color = barcode)) +
  geom_point(alpha = 0.5) + 
  labs(title = "dose response curve of effective drugs", x = "concentration", y = "log2(+1/-7 ratio) change") +
  stat_summary(fun.y=mean, aes(group=1), geom="line", colour="#993300", alpha = 0.5) +
  stat_summary(fun.y=mean, aes(group=1), geom="point", colour="#993300", size=3, shape=4, alpha = 0.5)+
  facet_wrap_paginate(~Drug, nrow = 4, ncol = 4, page = i)
print(p)
}

# Or directly in one plot
ggplot(data = indel.data.dose, aes(x = conc, y = logratio.mean, color = barcode)) +
  geom_point(alpha = 0.5) + 
  labs(title = "dose response curve of effective drugs", x = "concentration", y = "log2(+1/-7 ratio) change") +
  stat_summary(fun.y=mean, aes(group=1), geom="line", colour="#993300", alpha = 0.5) +
  stat_summary(fun.y=mean, aes(group=1), geom="point", colour="#993300", size=3, shape=4, alpha = 0.5)+
  facet_wrap(~Drug, nrow = 8, ncol = 8)



# Look at individual drugs more carefully
## Select drug
Drug <- "Resveratrol"
for (i in Drug) {
p <- ggplot(data = indel.data.dose[indel.data.dose$Drug == Drug,], aes(x = conc, y = logratio.mean, group = barcode, color = barcode)) +
  geom_point(alpha = 0.5) + geom_line(alpha = 0.5, linetype = "dashed") +
  labs(title = paste("dose response curve of", i), x = "concentration", y = "log2(+1/-7 ratio) change")
print(p)
}


# Dose curves for ChIP correlations
## Compute all corralations
indel.data.cor <- indel.data[indel.data$Drug %in% names.high |
                                indel.data$Drug %in% names.med |
                                indel.data$Drug %in% names.low, ]
indel.data.cor$mean.logratio.bc.drug <- ave(indel.data.cor$logratio.platenorm, 
                                            indel.data.cor$barcode, 
                                            indel.data.cor$Drug, 
                                            indel.data.cor$conc,
                                            FUN = function(x) mean(x))
indel.data.cor.high <- indel.data.cor[indel.data.cor$conc %in% "10um",]
indel.data.cor.med <- indel.data.cor[indel.data.cor$conc %in% "1um",]
indel.data.cor.low <- indel.data.cor[indel.data.cor$conc %in% "100nm",]
indel.data.cor.high <- indel.data.cor.high[,c(1,6,37)]
indel.data.cor.med <- indel.data.cor.med[,c(1,6,37)]
indel.data.cor.low <- indel.data.cor.low[,c(1,6,37)]
indel.data.cor.high <- indel.data.cor.high[!duplicated(indel.data.cor.high), ]
indel.data.cor.med <- indel.data.cor.med[!duplicated(indel.data.cor.med), ]
indel.data.cor.low <- indel.data.cor.low[!duplicated(indel.data.cor.low), ]
indel.data.cor.high <- dcast(indel.data.cor.high, barcode ~ Drug, value.var="mean.ratio.bc")
indel.data.cor.med <- dcast(indel.data.cor.med, barcode ~ Drug, value.var="mean.ratio.bc")
indel.data.cor.low <- dcast(indel.data.cor.low, barcode ~ Drug, value.var="mean.ratio.bc")
row.names(indel.data.cor.high) <- indel.data.cor.high$barcode
indel.data.cor.high <- indel.data.cor.high[,-1]
row.names(indel.data.cor.med) <- indel.data.cor.med$barcode
indel.data.cor.med <- indel.data.cor.med[,-1]
row.names(indel.data.cor.low) <- indel.data.cor.low$barcode
indel.data.cor.low <- indel.data.cor.low[,-1]

# Calculate correlations
cor_chip_indel.high <- cor(chip_data,indel.data.cor.high)
cor_chip_indel.med <- cor(chip_data,indel.data.cor.med)
cor_chip_indel.low <- cor(chip_data,indel.data.cor.low)

## Convert dfs to long format
dose_chip_high <- tibble::rownames_to_column(as.data.frame(cor_chip_indel.high), "ChIP")
dose_chip_high <- melt(dose_chip_high, variable.name = "Drug", value.name = "cor")
dose_chip_high$conc <- "10um"

dose_chip_med <- tibble::rownames_to_column(as.data.frame(cor_chip_indel.med), "ChIP")
dose_chip_med <- melt(dose_chip_med, variable.name = "Drug", value.name = "cor")
dose_chip_med$conc <- "1um"

dose_chip_low <- tibble::rownames_to_column(as.data.frame(cor_chip_indel.low), "ChIP")
dose_chip_low <- melt(dose_chip_low, variable.name = "Drug", value.name = "cor")
dose_chip_low$conc <- "100nm"

## Combine all dfs to one
dose_chip <- rbind(dose_chip_high, dose_chip_med, dose_chip_low)

## Visualize the dose response of the correlations
dose_chip$conc <- factor(dose_chip$conc, levels=c("100nm", "1um", "10um"))
ggplot(data = dose_chip, aes(x = conc, y = cor, group = ChIP, color = ChIP)) +
  geom_point(alpha = 0.5) + geom_line(alpha = 0.5, linetype = "dashed")+
  labs(title = "correlation behavior per concentration", x = "concentration", y = "correlation ChIP vs logratio change") +
  facet_wrap(~Drug, nrow = 7, ncol = 7)

# Look at individual drugs more carefully
## Select drug
Drug <- "Resveratrol"
for (i in Drug) {
p <- ggplot(data = dose_chip[dose_chip$Drug == Drug,], aes(x = conc, y = logratio.mean, group = barcode, color = barcode)) +
  geom_point(alpha = 0.5) + geom_line(alpha = 0.5, linetype = "dashed") +
  labs(title = paste("dose response curve of", i), x = "concentration", y = "log2(+1/-7 ratio) change")
print(p)
}


```


## Correlation -7 delay vs. -7 decay
```{r}
# narrow down df to only select needed data
delay.df <- delay.df[delay.df$clone %in% "5",]
delay.df$dif.mean <- ave(delay.df$difference, delay.df$barcode, FUN= function(x) mean(x))
delay.df$fold_dif.mean <- ave(delay.df$fold_difference, delay.df$barcode, FUN= function(x) mean(x))
delay.df <- delay.df[,c(1,7,8)]
delay.df <- delay.df[!duplicated(delay.df),]

# combine with indel.data
delay.data <- merge(indel.data, delay.df)
delay.data$mmej.ratio <- delay.data$X.7 / delay.data$read.count
delay.data$mmej.ratio <- ave(delay.data$mmej.ratio, delay.data$barcode, 
                             delay.data$Drug, delay.data$conc, FUN = function(x) mean(x))
delay.data.high <- delay.data[delay.data$conc == "10um",]
delay.data.med <- delay.data[delay.data$conc == "1um",]
delay.data.low <- delay.data[delay.data$conc == "100nm",]


delay.data.high.decay <- delay.data.high[,c(1,6,39)]
delay.data.high.decay <- delay.data.high.decay[!duplicated(delay.data.high.decay),]
delay.data.high.delay <- delay.data.high[,c(1,6,38)]
delay.data.high.delay <- delay.data.high.delay[!duplicated(delay.data.high.delay),]
delay.data.high.delay <- dcast(delay.data.high.delay, Drug ~ barcode, value.var = "dif.mean")
row.names(delay.data.high.decay) <- delay.data.high.decay$barcode
delay.data.high.decay <- delay.data.high.decay[,-1]
row.names(delay.data.high.delay) <- delay.data.high.delay$Drug
delay.data.high.delay <- delay.data.high.delay[,-1]

cor.delay_decay.high <- cor(delay.data.high.decay, delay.data.high.delay)



# correlation plot
correlation.plot <- delay.data[,c(1,6,38,39)]
correlation.plot <- dcast(correlation.plot, barcode~Drug)
boundaries <- seq(from = 0.8, by = 0.01, length.out = 4)
plt <- ggpairs(correlation.plot,
               upper = list(continuous = corColor),
               lower = list(continuous = function(data, mapping, ...) {
                   ggally_points(data = data[n, ], mapping = mapping, alpha = 0.1, size = 0.5) +
                   geom_abline(slope = 1, lty = "dashed", col = "red") +
                   theme_bw()}),
               diag = list(continuous = function(data, mapping, ...) {
                   ggally_densityDiag(data = data, mapping = mapping, alpha = 0.3, fill = "red") +
                   theme_bw()})) +
  ggtitle("correlation of the three replicates") +
  theme(text = element_text(size = 20))+
  xlab("logratio") +
  ylab("logratio") 
  # theme_bw()

print(plt)
```



## Exporting potential data. 
```{r}
```

# Session Info
```{r}
paste("Run time: ",format(Sys.time()-StartTime))
getwd()
date()
sessionInfo()
```

