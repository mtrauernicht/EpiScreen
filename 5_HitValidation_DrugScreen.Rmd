---
title: "Validating hits from the epigenetic screening"
author: "Max Trauernicht"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  pdf_document:
    toc: yes
  word_document:
    toc: yes
  html_document:
    code_folding: show
    highlight: monochrome
    theme: journal
    toc: yes
    toc_float: yes
  editor_options:
    chunk_output_type: console
---

# knitr document van Steensel lab

# Epigenetic Screening

# Introduction
This script tries to find out which drugs are able to significantly alter indel pattern formation in RSTP2#5 cells in different chromatin contexts. In the end, the aim is to couple biological relevance to these changes.

## Description of Data
How to make a good rendering table: 
```{r table1, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
tabl <- "
| column1	|	column2	|	column3	|	
|----|----|----|
|1	|	2	|	3	|	
|a	|	b	|	c	|	
"
cat(tabl) # output the table in a format good for HTML/PDF/docx conversion
```

# Data processing
## Path, Libraries, Parameters and Useful Functions
```{r setup}
knitr::opts_chunk$set(echo = TRUE)
StartTime <-Sys.time()

# 8-digit Date tag:
Date <- substr(gsub("-","",Sys.time()),1,8) 
# libraries:
library(dplyr)
library(outliers)
library(ggplot2)
library(ggbeeswarm)
library(data.table)
library(ComplexHeatmap)
library(circlize)
library(pheatmap)
library(gridGraphics)
library(gridExtra)
library(RColorBrewer)
library(Pigengene)
```

### Custom functions
Functions used thoughout this script.
```{r}
SetFileName <- function(filename, initials) {
  # Set filename with extension and initials to make filename with date integrated.
  filename <- substitute(filename)
  initials <- substitute(initials)
  filename <- paste0(initials, Date, filename)
  filename
}
```


## Data import
```{r Data Import}
# Import data from 5_HitValidation_DrugScreen.Rmd
setwd("/DATA/usr/m.trauernicht/EpiScreen/epigenetic-screening-on-trip-clone/Data")
mapping_mean <- get(load("mt20190215_mapping_mean"))
mapping_integration <- get(load("mt20190215_mapping_integration"))
indel.data <- get(load("mt20190215_indel.data"))
mapping_integration_long <- get(load("mt20190215_mapping_integration_long"))
mapping_mean_long <- get(load("mt20190215_mapping_mean_long"))
```


## Bring dataframe in suitable format for heatmap function
```{r generate heatmap}
# Split up per concentration
indel.data.high <- indel.data[grep("10um", indel.data$condition),]
indel.data.med <- indel.data[grep("1um", indel.data$condition),]
indel.data.low <- indel.data[grep("100nm", indel.data$condition),]

# Compute mean of logratio per barcode and drug
indel.data.high$mean.logratio.bc.drug <- 
  ave(indel.data.high$logratio.platenorm, 
      indel.data.high$barcode, indel.data.high$Drug, FUN = function(x) mean(x))
indel.data.med$mean.logratio.bc.drug <- 
  ave(indel.data.med$logratio.platenorm, 
      indel.data.med$barcode, indel.data.med$Drug, FUN = function(x) mean(x))
indel.data.low$mean.logratio.bc.drug <- 
  ave(indel.data.low$logratio.platenorm, 
      indel.data.low$barcode, indel.data.low$Drug, FUN = function(x) mean(x))

# Compute mean of logratio per barcode and target
indel.data.high$mean.logratio.bc.target <- 
  ave(indel.data.high$logratio.platenorm, 
      indel.data.high$barcode, indel.data.high$Target, FUN = function(x) mean(x))
indel.data.med$mean.logratio.bc.target <- 
  ave(indel.data.med$logratio.platenorm, 
      indel.data.med$barcode, indel.data.med$Target, FUN = function(x) mean(x))
indel.data.low$mean.logratio.bc.target <- 
  ave(indel.data.low$logratio.platenorm, 
      indel.data.low$barcode, indel.data.low$Target, FUN = function(x) mean(x))

# Compute mean of t-statistic per barcode and target
indel.data.high$mean.statistic.bc.target <- 
  ave(indel.data.high$statistic, 
      indel.data.high$barcode, indel.data.high$Target, FUN = function(x) mean(x))
indel.data.med$mean.statistic.bc.target <- 
  ave(indel.data.med$statistic, 
      indel.data.med$barcode, indel.data.med$Target, FUN = function(x) mean(x))
indel.data.low$mean.statistic.bc.target <- 
  ave(indel.data.low$statistic, 
      indel.data.low$barcode, indel.data.low$Target, FUN = function(x) mean(x))

# Compute mean of t-statistic per barcode and drug
indel.data.high$mean.statistic.bc.drug <- 
  ave(indel.data.high$statistic, 
      indel.data.high$barcode, indel.data.high$Drug, FUN = function(x) mean(x))
indel.data.med$mean.statistic.bc.drug <- 
  ave(indel.data.med$statistic, 
      indel.data.med$barcode, indel.data.med$Drug, FUN = function(x) mean(x))
indel.data.low$mean.statistic.bc.drug <- 
  ave(indel.data.low$statistic, 
      indel.data.low$barcode, indel.data.low$Drug, FUN = function(x) mean(x))



```


## Dataframe preprocessing t-statistic heatmap of barcode vs. drug
```{r}
# Remove columns
indel.data.high.drug.st <- indel.data.high[,c(1,6,38)]
indel.data.med.drug.st <- indel.data.med[,c(1,6,38)]
indel.data.low.drug.st <- indel.data.low[,c(1,6,38)]
indel.data.high.drug.st <- indel.data.high.drug.st[!duplicated(indel.data.high.drug.st), ]
indel.data.med.drug.st <- indel.data.med.drug.st[!duplicated(indel.data.med.drug.st), ]
indel.data.low.drug.st <- indel.data.low.drug.st[!duplicated(indel.data.low.drug.st), ]

# Transform to wide format for visualization purposes
indel.data.low.drug.st <- 
  dcast(indel.data.low.drug.st, barcode ~ Drug, value.var="mean.statistic.bc.drug")
indel.data.med.drug.st <- 
  dcast(indel.data.med.drug.st, barcode ~ Drug, value.var="mean.statistic.bc.drug")
indel.data.high.drug.st <- 
  dcast(indel.data.high.drug.st, barcode ~ Drug, value.var="mean.statistic.bc.drug")
```


## Dataframe preprocessing t-statistic heatmap of barcode vs. target
```{r}
# Remove columns
indel.data.high.target.st <- indel.data.high[,c(1,7,37)]
indel.data.med.target.st <- indel.data.med[,c(1,7,37)]
indel.data.low.target.st <- indel.data.low[,c(1,7,37)]
indel.data.high.target.st <- indel.data.high.target.st[!duplicated(indel.data.high.target.st), ]
indel.data.med.target.st <- indel.data.med.target.st[!duplicated(indel.data.med.target.st), ]
indel.data.low.target.st <- indel.data.low.target.st[!duplicated(indel.data.low.target.st), ]

# Transform to wide format for visualization purposes
indel.data.low.target.st <- 
  dcast(indel.data.low.target.st, Target ~ barcode, value.var="mean.statistic.bc.target")
indel.data.med.target.st <- 
  dcast(indel.data.med.target.st, Target ~ barcode, value.var="mean.statistic.bc.target")
indel.data.high.target.st <- 
  dcast(indel.data.high.target.st, Target ~ barcode, value.var="mean.statistic.bc.target")
```

## Dataframe preprocessing logratio heatmap of barcode vs. drug
```{r}
# Remove columns
indel.data.high.drug <- indel.data.high[,c(1,6,35)]
indel.data.med.drug <- indel.data.med[,c(1,6,35)]
indel.data.low.drug <- indel.data.low[,c(1,6,35)]
indel.data.high.drug <- 
  indel.data.high.drug[!duplicated(indel.data.high.drug), ]
indel.data.med.drug <- 
  indel.data.med.drug[!duplicated(indel.data.med.drug), ]
indel.data.low.drug <- 
  indel.data.low.drug[!duplicated(indel.data.low.drug), ]

# Transform to wide format for visualization purposes
indel.data.low.drug <- 
  dcast(indel.data.low.drug, 
        barcode ~ Drug, value.var="mean.logratio.bc.drug")
indel.data.med.drug <- 
  dcast(indel.data.med.drug, 
        barcode ~ Drug, value.var="mean.logratio.bc.drug")
indel.data.high.drug <- 
  dcast(indel.data.high.drug, 
        barcode ~ Drug, value.var="mean.logratio.bc.drug")
```

## Dataframe preprocessing logratio heatmap of barcode vs. target
```{r}
## Heatmap for each barcode vs each target
# Remove columns
indel.data.high.target <- indel.data.high[,c(1,7,36)]
indel.data.med.target <- indel.data.med[,c(1,7,36)]
indel.data.low.target <- indel.data.low[,c(1,7,36)]
indel.data.high.target <- 
  indel.data.high.target[!duplicated(indel.data.high.target), ]
indel.data.med.target <- 
  indel.data.med.target[!duplicated(indel.data.med.target), ]
indel.data.low.target <- 
  indel.data.low.target[!duplicated(indel.data.low.target), ]



# Transform to wide format for visualization purposes
indel.data.low.target <- 
  dcast(indel.data.low.target, Target ~ barcode, 
        value.var="mean.logratio.bc.target")
indel.data.med.target <- 
  dcast(indel.data.med.target, Target ~ barcode, 
     value.var="mean.logratio.bc.target")
indel.data.high.target <- 
  dcast(indel.data.high.target, Target ~ barcode, 
        value.var="mean.logratio.bc.target")
```


## Prepare t-statistic heatmaps of barcode vs. drug
```{r}
# Create matrix and use heatmap function
row.names(indel.data.high.drug.st) <- indel.data.high.drug.st$barcode
indel.data.high.drug.st <- indel.data.high.drug.st[,c(-1)]

row.names(indel.data.med.drug.st) <- indel.data.med.drug.st$barcode
indel.data.med.drug.st <- indel.data.med.drug.st[,c(-1)]

row.names(indel.data.low.drug.st) <- indel.data.low.drug.st$barcode
indel.data.low.drug.st <- indel.data.low.drug.st[,c(-1)]

```


## Prepare t-statistic heatmaps of barcode vs. target group
```{r}
# Create matrix and use heatmap function
row.names(indel.data.high.target.st) <- indel.data.high.target.st$Target
indel.data.high.target.st <- indel.data.high.target.st[,c(-1)]

row.names(indel.data.med.target.st) <- indel.data.med.target.st$Target
indel.data.med.target.st <- indel.data.med.target.st[,c(-1)]

row.names(indel.data.low.target.st) <- indel.data.low.target.st$Target
indel.data.low.target.st <- indel.data.low.target.st[,c(-1)]
```

## Generate heatmap for logratio barcode vs. target group
```{r}
# Per target group
# Create matrix and use heatmap function
row.names(indel.data.high.target) <- indel.data.high.target$Target
indel.data.high.target <- indel.data.high.target[,c(-1)]

row.names(indel.data.med.target) <- indel.data.med.target$Target
indel.data.med.target <- indel.data.med.target[,c(-1)]

row.names(indel.data.low.target) <- indel.data.low.target$Target
indel.data.low.target <- indel.data.low.target[,c(-1)]

## Using the Heatmap function, plotting in a grid format
# col_fun = colorRamp2(c(-2, 0, 2), c("blue", "white", "red"))
# grid.newpage()
# pushViewport(viewport(layout = grid.layout(nr = 2, nc = 2)))
# pushViewport(viewport(layout.pos.row = 1, layout.pos.col = 1))
# draw(Heatmap(as.matrix(indel.data.high.target), col = col_fun, column_title = "10uM drugs administered", show_heatmap_legend = FALSE, row_names_gp = gpar(fontsize = 8), column_names_gp = gpar(fontsize = 10)), newpage = FALSE)
# upViewport()
# 
# pushViewport(viewport(layout.pos.row = 1, layout.pos.col = 2))
# draw(Heatmap(as.matrix(indel.data.med.target), col = col_fun, column_title = "1uM drugs administered", row_names_gp = gpar(fontsize = 8), column_names_gp = gpar(fontsize = 10), show_heatmap_legend = FALSE), newpage = FALSE)
# upViewport()
# 
# pushViewport(viewport(layout.pos.row = 2, layout.pos.col = 1))
# draw(Heatmap(as.matrix(indel.data.low.target), col = col_fun, column_title = "100nm drugs administered", row_names_gp = gpar(fontsize = 8), column_names_gp = gpar(fontsize = 10), show_heatmap_legend = FALSE), newpage = FALSE)
# upViewport()
# 
# lgd = Legend(at = c(-2, -1, 0, 1, 2), col_fun = col_fun, title = "log2(+1/-7 indel ratio)", title_position = "topleft")
# 
# pushViewport(viewport(layout.pos.row = 2, layout.pos.col = 2))
# grid.draw(lgd)
# upViewport()
# 
# upViewport()


# Annotate barcodes
annotate.bc <-
  mapping_mean_long[grep("H3K27me3|LMNB1|H3K4me1|H3K27ac",mapping_mean_long$variable),]

annotate.bc <- dcast(annotate.bc, barcode ~ variable, value.var = "mean")
annotate.bc[,2:5] <- 2^(annotate.bc[,2:5])
row.names(annotate.bc) <- annotate.bc$barcode
annotate.bc <- annotate.bc[,-1]

# Change colors of annotations
annotation_colors = list(
  LMNB1 = colorRampPalette(brewer.pal(n = 7, name = "PuBu"))(100),
  H3K27me3 = colorRampPalette(brewer.pal(n = 7, name = "PuBu"))(100),
  H3K4me1 = colorRampPalette(brewer.pal(n = 7, name = "PuBu"))(100),
  H3K27ac = colorRampPalette(brewer.pal(n = 7, name = "PuBu"))(100))



```



## Generating heatmaps per barcode
```{r}
# Loop for each target
target.high <- indel.data.high[,c(6,7)]
target.high <- target.high[!duplicated(target.high), ]
indel.data.high.drug2 <- melt(indel.data.high.drug)
indel.data.high.drug2 <- dcast(indel.data.high.drug2, variable ~ barcode, value.var = "value")
setnames(target.high, old = "Drug", new = "variable")
indel.data.high.drug2 <- merge(indel.data.high.drug2, target.high)
row.names(indel.data.high.drug2) <- indel.data.high.drug2$variable
indel.data.high.drug2 <- indel.data.high.drug2[,-1]

data2 <- indel.data.high.drug2[-grep("(activator)|Negative control|MRN|DNA-PK",indel.data.high.drug2$Target),]


# Heatmap per barcode
row.names(indel.data.high.drug) <- indel.data.high.drug$barcode
indel.data.high.drug <- indel.data.high.drug[,c(-1)]

row.names(indel.data.med.drug) <- indel.data.med.drug$barcode
indel.data.med.drug <- indel.data.med.drug[,c(-1)]

row.names(indel.data.low.drug) <- indel.data.low.drug$barcode
indel.data.low.drug <- indel.data.low.drug[,c(-1)]


# Row annotation: annotate drugs with the target group
target <- indel.data[,c(6,7)]
target <- target[!duplicated(target), ]
target$random <- c(1:158)
row.names(target) <- target$Drug
target2 <- target
target <- target[,c(-1,-3)]
target <- as.data.frame(target)
row.names(target) <- target2$Drug
```

I want to create heatmaps for each drug within the 17 different target groups. This will give more information about the effect of individual drugs (and maybe clustering within groups -> subgroups because of different targets etc.).





Next step is to import the chromatin data to generate a correlation matrix between the effect of target groups/drugs on the logration and chromatin data.

## Import chromatin data
```{r import chromatin data}
# # Import chromatin data
# indel.data <- merge(indel.data, ChIP.df, all = TRUE)
# 
# # Make df more sexy
# indel.data <- indel.data[,c(-2,-5,-8:-14,-16,-17,-22,-25,-32:-38)]
# indel.data <- indel.data[-grep("ACCCCTAAAGGCGCTG", indel.data$barcode),]
```




## The same for t.outlier.df
```{r}
# # Import chromatin data
# t.outlier.df <- merge(t.outlier.df, ChIP.df, all = TRUE)
# 
# # Make df more sexy
# t.outlier.df <- t.outlier.df[-grep("ACCCCTAAAGGCGCTG", t.outlier.df$barcode),]
# t.outlier.df <- t.outlier.df[-grep("CTCTTAATCGCTGCC", t.outlier.df$barcode),]
# 
# 
# # Check which drugs inhibit all barcodes
# for (i in unique(t.outlier.df$Drug)) {
#     print(i)
#     print(length(unique(t.outlier.df$barcode[t.outlier.df$Drug == i])))
#   }
# 
# # Make pan-inhibitor drug df and selective inhibitor df
# pan.inhibitor.df <- t.outlier.df[grep("GSK J4 HCl|AZD1480|AZ 960|MLN8054|AMG-900|BMN 673|Mirin|CYT387|DNA-PKi", t.outlier.df$Drug),]
# sel.inhibitor.df <- t.outlier.df[-grep("GSK J4 HCl|AZD1480|AZ 960|MLN8054|AMG-900|BMN 673|Mirin|CYT387|DNA-PKi", t.outlier.df$Drug),]
# sel.inhibitor.df <- sel.inhibitor.df[abs(sel.inhibitor.df$statistic) > 10,]
# 
# sel.inhibitor.df <- sel.inhibitor.df[-grep("Aurora Kinase", sel.inhibitor.df$Target),]
# sel.inhibitor.df <- sel.inhibitor.df[,c(1,2,6,7,23,27)]
# 
# indel.data$mean.logratio.drug.bc <- ave(indel.data$logratio.platenorm, indel.data$Drug, indel.data$barcode, FUN = function(x) mean(x))
# 
# # Make a nice plot to see effect of selective drugs
# for (i in unique(indel.data$Drug)) {
#   if( i %in% sel.inhibitor.df$Drug) {
#   data <- indel.data[indel.data$Drug == c(i,"DMSO"), ]
#   p <- ggplot(data = data) +
#     geom_point(mapping = aes(x = barcode, y = mean.logratio.drug.bc, colour = Drug))+
#     geom_point(data = filter(data, statistic > 10), size = 10, colour ="red")+
#     theme(axis.text.x = element_text(angle = 90, hjust = 1.0, vjust = 0))+ 
#     ylab("log2(+1/-7 ratio)") + xlab("Barcode") + labs(fill="titel")
#   print(p)
#   }
# }
# 
# colours = c("DMSO" = "#999999", i = "#FF9966")
# 
# 
# 
# 
# 
# 
# t.outlier.df <- t.outlier.df[,c(-2,-5,-8:-14,-16,-17,-22,-25)]
# 
# 
# # Compute mean of logratio per barcode and drug
# t.outlier.df$mean.logratio.bc.drug <- ave(t.outlier.df$logratio.platenorm, 
# t.outlier.df$barcode, t.outlier.df$Drug, FUN = function(x) mean(x))
# 
# # Rename barcode column
# t.outlier.df$barcode<- with(t.outlier.df, paste0(barcode, Drug, collapse = "_"))
# 
# # Split up per concentration
# t.outlier.df.high <- t.outlier.df[grep("10um", t.outlier.df$condition),]
# t.outlier.df.med <- t.outlier.df[grep("1um", t.outlier.df$condition),]
# t.outlier.df.low <- t.outlier.df[grep("100nm", t.outlier.df$condition),]
# 
# # Remove columns
# t.outlier.df.high <- t.outlier.df.high[,c(1,19:56)]
# t.outlier.df.med <- t.outlier.df.med[,c(1,19:56)]
# t.outlier.df.low <- t.outlier.df.low[,c(1,19:56)]
# 
# logratio <- t.outlier.df[,c(1,57)]
# 
# t.outlier.df.high <- t.outlier.df.high[!duplicated(t.outlier.df.high), ]
# t.outlier.df.med <- t.outlier.df.med[!duplicated(t.outlier.df.med), ]
# t.outlier.df.low <- t.outlier.df.low[!duplicated(t.outlier.df.low), ]
# 
# 
# 
# t.outlier.df.high.drug <- melt(t.outlier.df.high)
# t.outlier.df.high.drug <- merge(t.outlier.df.high.drug, logratio)
# 
# 
# 
# for (i in t.outlier.df.high$Drug) {
#     p <- count_if(1, t.outlier.df.high$LAD_state[t.outlier.df.high$Drug == i])
#     print(i)
#     print(length(i))
#     print(p)
#   }

```

## Bind version
```{r}
# ChIP.df <- melt(ChIP.df)
# t.outlier.df2 <- merge(ChIP.df, t.outlier.df, all=TRUE)

```


\newpage
# Results
## t-statistic pheatmap: barcode vs. target group
```{r}
# Make color scale for t-statistic
breaksList3 <- seq(-26,24,4)

# t-statistic pheatmap: barcode vs. target group - 10uM with DNA-PKi
pheatmap(as.matrix(indel.data.high.target.st), annotation_col = annotate.bc, fontsize_row = 6, 
         annotation_colors = annotation_colors, 
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "PRGn")))(length(breaksList3)), 
         breaks = breaksList3, annotation_legend = F, cellheight = 6,
         main = "log2(+1/-7 indel ratio), 
         10uM of drugs added")

# t-statistic pheatmap: barcode vs. target group - 10uM without DNA-PKi
pheatmap(as.matrix(indel.data.high.target.st[-2,]), annotation_col = annotate.bc, fontsize_row = 6, 
         annotation_colors = annotation_colors, 
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "PRGn")))(length(breaksList3)), 
         breaks = breaksList3, annotation_legend = F,cellheight = 6,
         main = "log2(+1/-7 indel ratio), 
         10uM of drugs added")

# t-statistic pheatmap: barcode vs. target group - 1uM without DNA-PKi
pheatmap(as.matrix(indel.data.med.target.st[-2,]), annotation_col = annotate.bc, fontsize_row = 6, 
         annotation_colors = annotation_colors, 
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "PRGn")))(length(breaksList3)), 
         breaks = breaksList3, annotation_legend = F,cellheight = 6,
         main = "log2(+1/-7 indel ratio), 
         1uM of drugs added")

# t-statistic pheatmap: barcode vs. target group - 100nM without DNA-PKi
pheatmap(as.matrix(indel.data.low.target.st[-2,]), annotation_col = annotate.bc, fontsize_row = 6, 
         annotation_colors = annotation_colors, 
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "PRGn")))(length(breaksList3)), 
         breaks = breaksList3, annotation_legend = F,cellheight = 6,
         main = "log2(+1/-7 indel ratio), 
         100nM of drugs added")
```


\newpage
## logratio heatmap of target group vs. barcode
```{r}
# Keeping the scale in the pheatmap function
breaksList <- seq(-2.2,2,0.1)

# pheatmap function: logratio heatmap of target group vs. barcode - 10uM drugs added 
pheatmap(as.matrix(indel.data.high.target), annotation_col = annotate.bc, fontsize_row = 6, 
         annotation_colors = annotation_colors, 
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdGy")))(length(breaksList)), 
         breaks = breaksList, annotation_legend = F,cellheight = 6,
         main = "log2(+1/-7 indel ratio), 
         10uM of drugs added")

# pheatmap function: logratio heatmap of target group vs. barcode - 10uM drugs added - no DNA-PKi
pheatmap(as.matrix(indel.data.high.target[-2,]), annotation_col = annotate.bc, fontsize_row = 10,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdGy")))(length(breaksList)), 
         breaks = breaksList, annotation_legend = F,cellheight = 10,
         annotation_colors = annotation_colors, main = "log2(+1/-7 indel ratio) -
         10uM of drugs added - no DNA-PKi")

# pheatmap function: logratio heatmap of target group vs. barcode - 1uM drugs added - no DNA-PKi
pheatmap(as.matrix(indel.data.med.target[-2,]), annotation_col = annotate.bc, fontsize_row = 10,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdGy")))(length(breaksList)),
         breaks = breaksList, annotation_legend = F,cellheight = 10,
         annotation_colors = annotation_colors, main = "log2(+1/-7 indel ratio) - 
         1uM of drugs added - no DNA-PKi")

# pheatmap function: logratio heatmap of target group vs. barcode - 100nM drugs added - no DNA-PKi
pheatmap(as.matrix(indel.data.low.target[-2,]), annotation_col = annotate.bc, fontsize_row = 10,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdGy")))(length(breaksList)),
         breaks = breaksList, annotation_legend = F,cellheight = 10,
         annotation_colors = annotation_colors, main = "log2(+1/-7 indel ratio) - 
         100nM of drugs added - no DNA-PKi")

```

## Conclusion from these heatmaps:
- DNA-PKi has by far the biggest effect, no other drug category can reach out to a change of that magnitude
- We need to look at the heatmaps without DNA-PKi to catch more details
- Aurora kinase inhibitors and DNMT inhibitors seem to consistently elevate +1/-7 indel ratios, even more drastically than Mirin
- Some barcodes seem more susceptible to DNMT and aurora kinase inhibitors (some overlay with H3K27me3)
- Many drug categories do not seem to change indel patterns (HDAC activator, HIF, HAT, Other, Sirtuin)
- HDM, ERD are comparable to MRN
- HMT, HDAC, PARP also seem to elevate +1/-7 ratio
- No drug categories reduce the +1/-7 ratio (maybe HDAC activators at some barcodes to a very small extent)
- hard to say something about clustering of barcodes
- most left barcode (CGGC...) responds to many drug categories more than other barcodes (explanation? H3K27me3?)
\newpage
## logratio heatmap of each individual drug vs. barcode
```{r}

# Keeping the scale in the pheatmap function
breaksList2 <- seq(-1.7,1.5,0.01)

# pheatmap function: logratio heatmap of each individual drug vs. barcode - 10uM drugs added
pheatmap(as.matrix(indel.data.high.drug), fontsize_col = 7, fontsize_row = 7, annotation_col = target, cellheight = 8,
         annotation_row = annotate.bc,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdGy")))(length(breaksList2)),
         breaks = breaksList2, annotation_legend = F,
         annotation_colors = annotation_colors, , legend = F, main = "log2(+1/-7 indel ratio) - 10uM of drugs added")



```

\newpage

## logratio heatmap of each individual drug vs. barcode (plot for each inidividual target group)
```{r}
breaksList4 <- seq(-3.7,3.5,0.01)

for (i in unique(data2$Target)) {
  data <- data2[data2$Target == i,]
  p <- pheatmap(as.matrix(data[,1:18]), annotation_col = annotate.bc, 
         color = colorRampPalette(brewer.pal(n = 7, name = "Reds"))(100), 
         annotation_legend = F, cluster_cols = x$tree_col,
         annotation_colors = annotation_colors, main = print(i))
  print(p)
}
```


\newpage
## t-statistic heatmap of each individual drug vs. barcode
```{r fig.height=50}
# pheatmap function: t-statistic heatmap of each individual drug vs. barcode - 10uM drugs added
pheatmap(as.matrix(indel.data.high.drug.st), fontsize_col = 6, fontsize_row = 5, annotation_col = target, cellheight = 8,
         annotation_row = annotate.bc,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdGy")))(length(breaksList3)),
         breaks = breaksList3, treeheight_col = 100,
         annotation_colors = annotation_colors, , annotation_legend = F, main = "log2(+1/-7 indel ratio) - 10uM of drugs added")



```



# Conclusions
This already reveals some useful information, more in-depth studies of individual drugs is needed, especially because the grouping of drugs into categories can be faulty and misleading (inhibitors can be either pan, or selective for a sub-group, which means that they probably affect different locations/barcodes)

I want to create heatmaps for each drug within the 17 different target groups. This will give more information about the effect of individual drugs (and maybe clustering within groups -> subgroups because of different targets etc.).

Next step is to import the chromatin data to generate a correlation matrix between the effect of target groups/drugs on the logration and chromatin data.


## Exporting potential data. 
```{r}
```

# Session Info
```{r}
paste("Run time: ",format(Sys.time()-StartTime))
getwd()
date()
sessionInfo()
```

