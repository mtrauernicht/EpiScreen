---
title: "Validating hits from the epigenetic screening"
author: "Max Trauernicht"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    code_folding: show
    highlight: monochrome
    theme: journal
    toc: yes
    toc_float: yes
  word_document:
    toc: yes
  pdf_document:
    toc: yes
  editor_options:
    chunk_output_type: inline
---

# knitr document van Steensel lab

# Epigenetic Screening

# Introduction
This script tries to find out which drugs are able to significantly alter indel pattern formation in RSTP2#5 cells in different chromatin contexts. In the end, the aim is to couple biological relevance to these changes.

## Description of Data
How to make a good rendering table: 
```{r table1, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
tabl <- "
| column1	|	column2	|	column3	|	
|----|----|----|
|1	|	2	|	3	|	
|a	|	b	|	c	|	
"
cat(tabl) # output the table in a format good for HTML/PDF/docx conversion
```

# Data processing
## Path, Libraries, Parameters and Useful Functions
```{r setup}
knitr::opts_chunk$set(echo = TRUE)
StartTime <-Sys.time()

# 8-digit Date tag:
Date <- substr(gsub("-","",Sys.time()),1,8) 
# libraries:
library(dplyr)
library(outliers)
library(ggplot2)
library(ggbeeswarm)
library(data.table)
library(ComplexHeatmap)
library(circlize)
library(pheatmap)
library(gridGraphics)
library(gridExtra)
library(RColorBrewer)
library(Pigengene)
```

### Custom functions
Functions used thoughout this script.
```{r}
SetFileName <- function(filename, initials) {
  # Set filename with extension and initials to make filename with date integrated.
  filename <- substitute(filename)
  initials <- substitute(initials)
  filename <- paste0(initials, Date, filename)
  filename
}
```


## Data import
```{r Data Import}
# Import data from 5_HitValidation_DrugScreen.Rmd
setwd("/DATA/usr/m.trauernicht/EpiScreen/epigenetic-screening-on-trip-clone/Data")
mapping_mean <- get(load("mt20190305_mapping_mean"))
mapping_integration <- get(load("mt20190305_mapping_integration"))
indel.data <- get(load("mt20190305_indel.data"))
mapping_integration_long <- get(load("mt20190305_mapping_integration_long"))
mapping_mean_long <- get(load("mt20190305_mapping_mean_long"))
chip_dendogram <- get(load("mt20190305_chip_dendogram"))
```


## Bring dataframe in suitable format for heatmap function
```{r generate heatmap}
# Split up per concentration
indel.data.high <- indel.data[grep("10um", indel.data$condition),]
indel.data.med <- indel.data[grep("1um", indel.data$condition),]
indel.data.low <- indel.data[grep("100nm", indel.data$condition),]

# Compute mean of logratio per barcode and drug
indel.data.high$mean.logratio.bc.drug <- 
  ave(indel.data.high$logratio.platenorm, 
      indel.data.high$barcode, indel.data.high$Drug, FUN = function(x) mean(x))
indel.data.med$mean.logratio.bc.drug <- 
  ave(indel.data.med$logratio.platenorm, 
      indel.data.med$barcode, indel.data.med$Drug, FUN = function(x) mean(x))
indel.data.low$mean.logratio.bc.drug <- 
  ave(indel.data.low$logratio.platenorm, 
      indel.data.low$barcode, indel.data.low$Drug, FUN = function(x) mean(x))

# Compute mean of logratio per barcode and target
indel.data.high$mean.logratio.bc.target <- 
  ave(indel.data.high$logratio.platenorm, 
      indel.data.high$barcode, indel.data.high$Target, FUN = function(x) mean(x))
indel.data.med$mean.logratio.bc.target <- 
  ave(indel.data.med$logratio.platenorm, 
      indel.data.med$barcode, indel.data.med$Target, FUN = function(x) mean(x))
indel.data.low$mean.logratio.bc.target <- 
  ave(indel.data.low$logratio.platenorm, 
      indel.data.low$barcode, indel.data.low$Target, FUN = function(x) mean(x))

# Compute mean of t-statistic per barcode and target
indel.data.high$mean.statistic.bc.target <- 
  ave(indel.data.high$statistic, 
      indel.data.high$barcode, indel.data.high$Target, FUN = function(x) mean(x))
indel.data.med$mean.statistic.bc.target <- 
  ave(indel.data.med$statistic, 
      indel.data.med$barcode, indel.data.med$Target, FUN = function(x) mean(x))
indel.data.low$mean.statistic.bc.target <- 
  ave(indel.data.low$statistic, 
      indel.data.low$barcode, indel.data.low$Target, FUN = function(x) mean(x))

# Compute mean of t-statistic per barcode and drug
indel.data.high$mean.statistic.bc.drug <- 
  ave(indel.data.high$statistic, 
      indel.data.high$barcode, indel.data.high$Drug, FUN = function(x) mean(x))
indel.data.med$mean.statistic.bc.drug <- 
  ave(indel.data.med$statistic, 
      indel.data.med$barcode, indel.data.med$Drug, FUN = function(x) mean(x))
indel.data.low$mean.statistic.bc.drug <- 
  ave(indel.data.low$statistic, 
      indel.data.low$barcode, indel.data.low$Drug, FUN = function(x) mean(x))

# Compute mean of efficiency per barcode and drug
indel.data.high$mean.eff.bc.drug <- 
  ave(indel.data.high$efficiency.platenorm, 
      indel.data.high$barcode, indel.data.high$Drug, FUN = function(x) mean(x))
indel.data.med$mean.eff.bc.drug <- 
  ave(indel.data.med$efficiency.platenorm, 
      indel.data.med$barcode, indel.data.med$Drug, FUN = function(x) mean(x))
indel.data.low$mean.eff.bc.drug <- 
  ave(indel.data.low$efficiency.platenorm, 
      indel.data.low$barcode, indel.data.low$Drug, FUN = function(x) mean(x))
```





## Dataframe preprocessing efficiency difference
```{r}
# Remove columns
indel.data.high.eff <- indel.data.high[,c(1,6,43)]
indel.data.high.eff <- indel.data.high.eff[!duplicated(indel.data.high.eff), ]
indel.data.high.eff <- dcast(indel.data.high.eff, barcode ~ Drug, value.var = "mean.eff.bc.drug")

# Remove columns
indel.data.med.eff <- indel.data.med[,c(1,6,43)]
indel.data.med.eff <- indel.data.med.eff[!duplicated(indel.data.med.eff), ]
indel.data.med.eff <- dcast(indel.data.med.eff, barcode ~ Drug, value.var = "mean.eff.bc.drug")

# Remove columns
indel.data.low.eff <- indel.data.low[,c(1,6,43)]
indel.data.low.eff <- indel.data.low.eff[!duplicated(indel.data.low.eff), ]
indel.data.low.eff <- dcast(indel.data.low.eff, barcode ~ Drug, value.var = "mean.eff.bc.drug")
```





## Dataframe preprocessing t-statistic heatmap of barcode vs. drug
```{r}
# Remove columns
indel.data.high.drug.st <- indel.data.high[,c(1,6,42)]
indel.data.med.drug.st <- indel.data.med[,c(1,6,42)]
indel.data.low.drug.st <- indel.data.low[,c(1,6,42)]
indel.data.high.drug.st <- indel.data.high.drug.st[!duplicated(indel.data.high.drug.st), ]
indel.data.med.drug.st <- indel.data.med.drug.st[!duplicated(indel.data.med.drug.st), ]
indel.data.low.drug.st <- indel.data.low.drug.st[!duplicated(indel.data.low.drug.st), ]

# Transform to wide format for visualization purposes
indel.data.low.drug.st <- 
  dcast(indel.data.low.drug.st, barcode ~ Drug, value.var="mean.statistic.bc.drug")
indel.data.med.drug.st <- 
  dcast(indel.data.med.drug.st, barcode ~ Drug, value.var="mean.statistic.bc.drug")
indel.data.high.drug.st <- 
  dcast(indel.data.high.drug.st, barcode ~ Drug, value.var="mean.statistic.bc.drug")
```


## Dataframe preprocessing t-statistic heatmap of barcode vs. target
```{r}
# Remove columns
indel.data.high.target.st <- indel.data.high[,c(1,7,41)]
indel.data.med.target.st <- indel.data.med[,c(1,7,41)]
indel.data.low.target.st <- indel.data.low[,c(1,7,41)]
indel.data.high.target.st <- indel.data.high.target.st[!duplicated(indel.data.high.target.st), ]
indel.data.med.target.st <- indel.data.med.target.st[!duplicated(indel.data.med.target.st), ]
indel.data.low.target.st <- indel.data.low.target.st[!duplicated(indel.data.low.target.st), ]

# Transform to wide format for visualization purposes
indel.data.low.target.st <- 
  dcast(indel.data.low.target.st, Target ~ barcode, value.var="mean.statistic.bc.target")
indel.data.med.target.st <- 
  dcast(indel.data.med.target.st, Target ~ barcode, value.var="mean.statistic.bc.target")
indel.data.high.target.st <- 
  dcast(indel.data.high.target.st, Target ~ barcode, value.var="mean.statistic.bc.target")
```

## Dataframe preprocessing logratio heatmap of barcode vs. drug
```{r}
# Remove columns
indel.data.high.drug <- indel.data.high[,c(1,6,39)]
indel.data.med.drug <- indel.data.med[,c(1,6,39)]
indel.data.low.drug <- indel.data.low[,c(1,6,39)]
indel.data.high.drug <- 
  indel.data.high.drug[!duplicated(indel.data.high.drug), ]
indel.data.med.drug <- 
  indel.data.med.drug[!duplicated(indel.data.med.drug), ]
indel.data.low.drug <- 
  indel.data.low.drug[!duplicated(indel.data.low.drug), ]

# Transform to wide format for visualization purposes
indel.data.low.drug <- 
  dcast(indel.data.low.drug, 
        barcode ~ Drug, value.var="mean.logratio.bc.drug")
indel.data.med.drug <- 
  dcast(indel.data.med.drug, 
        barcode ~ Drug, value.var="mean.logratio.bc.drug")
indel.data.high.drug <- 
  dcast(indel.data.high.drug, 
        barcode ~ Drug, value.var="mean.logratio.bc.drug")
```

## Dataframe preprocessing logratio heatmap of barcode vs. target
```{r}
## Heatmap for each barcode vs each target
# Remove columns
indel.data.high.target <- indel.data.high[,c(1,7,40)]
indel.data.med.target <- indel.data.med[,c(1,7,40)]
indel.data.low.target <- indel.data.low[,c(1,7,40)]
indel.data.high.target <- 
  indel.data.high.target[!duplicated(indel.data.high.target), ]
indel.data.med.target <- 
  indel.data.med.target[!duplicated(indel.data.med.target), ]
indel.data.low.target <- 
  indel.data.low.target[!duplicated(indel.data.low.target), ]



# Transform to wide format for visualization purposes
indel.data.low.target <- 
  dcast(indel.data.low.target, Target ~ barcode, 
        value.var="mean.logratio.bc.target")
indel.data.med.target <- 
  dcast(indel.data.med.target, Target ~ barcode, 
     value.var="mean.logratio.bc.target")
indel.data.high.target <- 
  dcast(indel.data.high.target, Target ~ barcode, 
        value.var="mean.logratio.bc.target")
```


## Prepare t-statistic heatmaps of barcode vs. drug
```{r}
# Create matrix and use heatmap function
row.names(indel.data.high.drug.st) <- indel.data.high.drug.st$barcode
indel.data.high.drug.st <- indel.data.high.drug.st[,c(-1)]

row.names(indel.data.med.drug.st) <- indel.data.med.drug.st$barcode
indel.data.med.drug.st <- indel.data.med.drug.st[,c(-1)]

row.names(indel.data.low.drug.st) <- indel.data.low.drug.st$barcode
indel.data.low.drug.st <- indel.data.low.drug.st[,c(-1)]

```


## Prepare t-statistic heatmaps of barcode vs. target group
```{r}
# Create matrix and use heatmap function
row.names(indel.data.high.target.st) <- indel.data.high.target.st$Target
indel.data.high.target.st <- indel.data.high.target.st[,c(-1)]

row.names(indel.data.med.target.st) <- indel.data.med.target.st$Target
indel.data.med.target.st <- indel.data.med.target.st[,c(-1)]

row.names(indel.data.low.target.st) <- indel.data.low.target.st$Target
indel.data.low.target.st <- indel.data.low.target.st[,c(-1)]
```

## Generate heatmap for logratio barcode vs. target group
```{r}
# Per target group
# Create matrix and use heatmap function
row.names(indel.data.high.target) <- indel.data.high.target$Target
indel.data.high.target <- indel.data.high.target[,c(-1)]

row.names(indel.data.med.target) <- indel.data.med.target$Target
indel.data.med.target <- indel.data.med.target[,c(-1)]

row.names(indel.data.low.target) <- indel.data.low.target$Target
indel.data.low.target <- indel.data.low.target[,c(-1)]

# Annotate barcodes
annotate.bc <-
  mapping_mean_long[grep("H3K27me3|LMNB1|H3K36me3|H3K27ac|POL2",mapping_mean_long$variable),]
annotate.bc <- dcast(annotate.bc, barcode ~ variable, value.var = "mean")
# annotate.bc[,2:5] <- 2^(annotate.bc[,2:5])
ratio.bc <- indel.data[,c(1,15)]
setnames(ratio.bc, old = "ratio", new = "mean_ratio")
ratio.bc$mean_ratio <- ave(ratio.bc$mean_ratio, ratio.bc$barcode, FUN= function(x) mean(x))
ratio.bc <- ratio.bc[!duplicated(ratio.bc), ]
annotate.bc <- merge(annotate.bc, ratio.bc, all = T)
row.names(annotate.bc) <- annotate.bc$barcode
annotate.bc <- annotate.bc[,-1]
```



## Generating heatmaps per barcode
```{r}
# Loop for each target: high concentration
target.high <- indel.data.high[,c(6,7)]
target.high <- target.high[!duplicated(target.high), ]
indel.data.high.drug2 <- melt(indel.data.high.drug)
indel.data.high.drug2 <- dcast(indel.data.high.drug2, variable ~ barcode, value.var = "value")
setnames(target.high, old = "Drug", new = "variable")
indel.data.high.drug2 <- merge(indel.data.high.drug2, target.high)
row.names(indel.data.high.drug2) <- indel.data.high.drug2$variable
indel.data.high.drug2 <- indel.data.high.drug2[,-1]
data2 <- indel.data.high.drug2[-grep("Negative control|MRN|DNA-PK",indel.data.high.drug2$Target),]

# Loop for each target: med concentration
target.med <- indel.data.med[,c(6,7)]
target.med <- target.med[!duplicated(target.med), ]
indel.data.med.drug2 <- melt(indel.data.med.drug)
indel.data.med.drug2 <- dcast(indel.data.med.drug2, variable ~ barcode, value.var = "value")
setnames(target.med, old = "Drug", new = "variable")
indel.data.med.drug2 <- merge(indel.data.med.drug2, target.med)
row.names(indel.data.med.drug2) <- indel.data.med.drug2$variable
indel.data.med.drug2 <- indel.data.med.drug2[,-1]
data3 <- indel.data.med.drug2[-grep("Negative control|MRN|DNA-PK",indel.data.med.drug2$Target),]

# Loop for each target: low concentration
target.low <- indel.data.low[,c(6,7)]
target.low <- target.low[!duplicated(target.low), ]
indel.data.low.drug2 <- melt(indel.data.low.drug)
indel.data.low.drug2 <- dcast(indel.data.low.drug2, variable ~ barcode, value.var = "value")
setnames(target.low, old = "Drug", new = "variable")
indel.data.low.drug2 <- merge(indel.data.low.drug2, target.low)
row.names(indel.data.low.drug2) <- indel.data.low.drug2$variable
indel.data.low.drug2 <- indel.data.low.drug2[,-1]
data4 <- indel.data.low.drug2[-grep("Negative control|MRN|DNA-PK",indel.data.low.drug2$Target),]


# Loop for each target: high concentration
target.high.eff <- indel.data.high[,c(6,7)]
target.high.eff <- target.high.eff[!duplicated(target.high.eff), ]
indel.data.high.drug2 <- melt(indel.data.high.eff)
indel.data.high.drug2 <- dcast(indel.data.high.drug2, variable ~ barcode, value.var = "value")
setnames(target.high.eff, old = "Drug", new = "variable")
indel.data.high.drug2 <- merge(indel.data.high.drug2, target.high.eff)
row.names(indel.data.high.drug2) <- indel.data.high.drug2$variable
indel.data.high.drug2 <- indel.data.high.drug2[,-1]
data5 <- indel.data.high.drug2[-grep("Negative control|MRN|DNA-PK",indel.data.high.drug2$Target),]

# Loop for each target: med concentration
target.med.eff <- indel.data.med[,c(6,7)]
target.med.eff <- target.med.eff[!duplicated(target.med.eff), ]
indel.data.med.drug2 <- melt(indel.data.med.eff)
indel.data.med.drug2 <- dcast(indel.data.med.drug2, variable ~ barcode, value.var = "value")
setnames(target.med.eff, old = "Drug", new = "variable")
indel.data.med.drug2 <- merge(indel.data.med.drug2, target.med.eff)
row.names(indel.data.med.drug2) <- indel.data.med.drug2$variable
indel.data.med.drug2 <- indel.data.med.drug2[,-1]
data6 <- indel.data.med.drug2[-grep("Negative control|MRN|DNA-PK",indel.data.med.drug2$Target),]

# Loop for each target: high concentration
target.low.eff <- indel.data.low[,c(6,7)]
target.low.eff <- target.low.eff[!duplicated(target.low.eff), ]
indel.data.low.drug2 <- melt(indel.data.low.eff)
indel.data.low.drug2 <- dcast(indel.data.low.drug2, variable ~ barcode, value.var = "value")
setnames(target.low.eff, old = "Drug", new = "variable")
indel.data.low.drug2 <- merge(indel.data.low.drug2, target.low.eff)
row.names(indel.data.low.drug2) <- indel.data.low.drug2$variable
indel.data.low.drug2 <- indel.data.low.drug2[,-1]
data7 <- indel.data.low.drug2[-grep("Negative control|MRN|DNA-PK",indel.data.low.drug2$Target),]





# Heatmap per barcode
row.names(indel.data.high.drug) <- indel.data.high.drug$barcode
indel.data.high.drug <- indel.data.high.drug[,c(-1)]

row.names(indel.data.med.drug) <- indel.data.med.drug$barcode
indel.data.med.drug <- indel.data.med.drug[,c(-1)]

row.names(indel.data.low.drug) <- indel.data.low.drug$barcode
indel.data.low.drug <- indel.data.low.drug[,c(-1)]

rownames(indel.data.high.eff) <- indel.data.high.eff$barcode
indel.data.high.eff <- indel.data.high.eff[,-1]

rownames(indel.data.med.eff) <- indel.data.med.eff$barcode
indel.data.med.eff <- indel.data.med.eff[,-1]

rownames(indel.data.low.eff) <- indel.data.low.eff$barcode
indel.data.low.eff <- indel.data.low.eff[,-1]

# Row annotation: annotate drugs with the target group
target <- indel.data[,c(6,7)]
target <- target[!duplicated(target), ]
target$random <- c(1:158)
row.names(target) <- target$Drug
target2 <- target
target <- target[,c(-1,-3)]
target <- as.data.frame(target)
row.names(target) <- target2$Drug



cool = rainbow(50, start=rgb2hsv(col2rgb("#F5867D"))[1], end=rgb2hsv(col2rgb("#D8B34D"))[1])
warm = rainbow(50, start=rgb2hsv(col2rgb("#74904D"))[1], end=rgb2hsv(col2rgb("#1A7243"))[1])
cols = c(rev(cool), rev(warm))
mypalette <- colorRampPalette(cols)(255)


# Change colors of annotations
annotation_colors_scr = list(
  LMNB1 = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
  H3K27me3 = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
  H3K36me3 = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
  POL2 = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
  H3K27ac = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
  mean_ratio = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
  target = c("Sirtuin" = '#e6194b', "HDAC" = '#3cb44b', "PARP" = '#ffe119', "Negative control" = '#4363d8', "Epigenetic Reader Domain" = '#f58231', "MRN" = '#911eb4', "DNMT" = '#46f0f0', "HMT" = '#f032e6', "Aurora Kinase" = '#bcf60c', "JAK" = '#fabebe', "Histone demethylase" = '#008080', "HAT" = '#e6beff', "DNA-PK" = '#9a6324', "HIF" = '#fffac8', "PIM" = '#800000'))

```

I want to create heatmaps for each drug within the 17 different target groups. This will give more information about the effect of individual drugs (and maybe clustering within groups -> subgroups because of different targets etc.).


\newpage
# Results
\newpage
## logratio heatmap of each individual drug vs. barcode
```{r out.width= "100%", fig.align= "center", echo=FALSE}

## Every drug
# Keeping the scale in the pheatmap function
myBreaks5 <- c(seq(min(as.matrix(indel.data.high.drug)), 0, 
                   length.out=ceiling(100/2) + 1), 
              seq(max(as.matrix(indel.data.high.drug))/100, 
                  max(as.matrix(indel.data.high.drug)), length.out=floor(100/2)))

# pheatmap function: logratio heatmap of each individual drug vs. barcode - 10uM drugs added
pheatmap(as.matrix(indel.data.high.drug),
         annotation_col = target, 
         annotation_row = annotate.bc,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdGy")))(100),
         breaks = myBreaks5, cluster_rows = chip_dendogram$tree_col,
         annotation_colors = annotation_colors_scr, 
         main = "log2(+1/-7 indel ratio) change - 10uM of drugs added")


## Only drugs that change ratio
# Keeping the scale in the pheatmap function
myBreaks6 <- c(seq(min(as.matrix(indel.data.high.drug.ess)), 0, 
                   length.out=ceiling(100/2) + 1), 
              seq(max(as.matrix(indel.data.high.drug.ess))/100, 
                  max(as.matrix(indel.data.high.drug.ess))/2, length.out=floor(100/2)))

# pheatmap function: without DNA-PKi: logratio heatmap of eac a certain fold change
indel.data.high.drug.ess <- indel.data.high.drug[,-42]
indel.data.high.drug.ess <- 
  indel.data.high.drug.ess[, 
                           colSums(indel.data.high.drug.ess > 1) >= 1 | 
                             colSums(indel.data.high.drug.ess < -0.5) >= 1] 

pheatmap(as.matrix(indel.data.high.drug.ess),
         annotation_col = target, border_color = "grey60",
         annotation_row = annotate.bc, annotation_legend = F,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
         breaks = myBreaks6, cluster_rows = chip_dendogram$tree_col,
         annotation_colors = annotation_colors_scr, 
         main = "log2(+1/-7 indel ratio) change - 10uM of drugs added")



# Keeping the scale in the pheatmap function
myBreaks7 <- c(seq(min(as.matrix(indel.data.med.drug.ess)), 0, 
                   length.out=ceiling(100/2) + 1), 
              seq(max(as.matrix(indel.data.med.drug.ess))/100, 
                  max(as.matrix(indel.data.med.drug.ess))/2, length.out=floor(100/2)))


# pheatmap function: without DNA-PKi: logratio heatmap of each individual drug vs. barcode - 1uM drugs added- include only drugs that achieve a certain fold change
indel.data.med.drug.ess <- indel.data.med.drug[,-44]
indel.data.med.drug.ess <- 
  indel.data.med.drug.ess[, 
                          colSums(indel.data.med.drug.ess > 1) >= 1 |
                            colSums(indel.data.med.drug.ess < -0.5) >= 1] 

pheatmap(as.matrix(indel.data.med.drug.ess), 
         annotation_col = target,
         annotation_row = annotate.bc,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
         breaks = myBreaks7, cluster_rows = chip_dendogram$tree_col,
         annotation_colors = annotation_colors_scr, annotation_legend = F,
         main = "log2(+1/-7 indel ratio) change - 1uM of drugs added")


# Keeping the scale in the pheatmap function
myBreaks8 <- c(seq(min(as.matrix(indel.data.low.drug.ess)), 0, 
                   length.out=ceiling(100/2) + 1), 
              seq(max(as.matrix(indel.data.low.drug.ess))/100, 
                  max(as.matrix(indel.data.low.drug.ess))/2, length.out=floor(100/2)))

# pheatmap function: without DNA-PKi: logratio heatmap of each individual drug vs. barcode - 100nM drugs added - include only drugs that achieve a certain fold change
indel.data.low.drug.ess <- indel.data.low.drug[,-48]
indel.data.low.drug.ess <- 
  indel.data.low.drug.ess[, 
                          colSums(indel.data.low.drug.ess > 0.75) >= 1 |
                            colSums(indel.data.low.drug.ess < -0.5) >= 1]

pheatmap(as.matrix(indel.data.low.drug.ess), 
         annotation_col = target, 
         annotation_row = annotate.bc,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
         breaks = myBreaks8, cluster_rows = chip_dendogram$tree_col,
         annotation_colors = annotation_colors_scr, annotation_legend = F,
         main = "log2(+1/-7 indel ratio) change - 100nM of drugs added")



# Keeping the scale in the pheatmap function
myBreaks8.5 <- c(seq(min(as.matrix(indel.data.high.eff)), 0, 
                   length.out=ceiling(100/2) + 1), 
              seq(max(as.matrix(indel.data.high.eff))/100, 
                  max(as.matrix(indel.data.high.eff)), length.out=floor(100/2)))

# Efficiency change heatmap - 10 uM
pheatmap(as.matrix(indel.data.high.eff[,-42]), fontsize_col = 8, fontsize_row = 8, 
         annotation_col = target, cellheight = 8,
         annotation_row = annotate.bc,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdGy")))(100),
         breaks = myBreaks8.5, cluster_rows = chip_dendogram$tree_col,
         annotation_colors = annotation_colors_scr, 
         main = "log2(efficiency) change - 10uM of drugs added")

# Keeping the scale in the pheatmap function
myBreaks8.51 <- c(seq(min(as.matrix(indel.data.high.eff.ess))/1.5, 0, 
                   length.out=ceiling(100/2) + 1), 
              seq(max(as.matrix(indel.data.high.eff.ess))/100, 
                  max(as.matrix(indel.data.high.eff.ess))/1.5, length.out=floor(100/2)))

# Efficiency change heatmap - 10 uM
indel.data.high.eff.ess <- indel.data.high.eff[,-42]
indel.data.high.eff.ess <- 
  indel.data.high.eff.ess[, 
                          colSums(indel.data.high.eff.ess > 0.1) >= 1 |
                            colSums(indel.data.high.eff.ess < -0.2) >= 1]

pheatmap(as.matrix(indel.data.high.eff.ess),
         annotation_col = target,   
         annotation_row = annotate.bc,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
         breaks = myBreaks8.51, cluster_rows = chip_dendogram$tree_col,
         annotation_colors = annotation_colors_scr, annotation_legend = F,
         main = "efficiency change - 10uM of drugs added")





# Keeping the scale in the pheatmap function
myBreaks9.5 <- c(seq(min(as.matrix(indel.data.med.eff.ess))/1.5, 0, 
                   length.out=ceiling(100/2) + 1), 
              seq(max(as.matrix(indel.data.med.eff.ess))/100, 
                  max(as.matrix(indel.data.med.eff.ess))/1.5, length.out=floor(100/2)))

# Efficiency change heatmap - 1 uM
indel.data.med.eff.ess <- indel.data.med.eff[,-44]
indel.data.med.eff.ess <- 
  indel.data.med.eff.ess[, 
                         colSums(indel.data.med.eff.ess > 0.1) >= 1 | 
                           colSums(indel.data.med.eff.ess < -0.15) >= 1]

pheatmap(as.matrix(indel.data.med.eff.ess), 
         annotation_col = target, 
         annotation_row = annotate.bc,annotation_legend = F,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
         breaks = myBreaks9.5, cluster_rows = chip_dendogram$tree_col,
         annotation_colors = annotation_colors_scr, 
         main = "efficiency change - 1uM of drugs added")


# Keeping the scale in the pheatmap function
myBreaks10.5 <- c(seq(min(as.matrix(indel.data.low.eff.ess))/1.5, 0, 
                   length.out=ceiling(100/2) + 1), 
              seq(max(as.matrix(indel.data.low.eff.ess))/100, 
                  max(as.matrix(indel.data.low.eff.ess))/1.5, length.out=floor(100/2)))

# Efficiency change heatmap - 100 nM
indel.data.low.eff.ess <- indel.data.low.eff[,-48]
indel.data.low.eff.ess <- 
  indel.data.low.eff.ess[, 
                         colSums(indel.data.low.eff.ess > 0.1) >= 1 |
                           colSums(indel.data.low.eff.ess < -0.15) >= 1]

pheatmap(as.matrix(indel.data.low.eff.ess), 
         annotation_col = target,
         annotation_row = annotate.bc, annotation_legend = F,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdBu")))(100),
         breaks = myBreaks10.5, cluster_rows = chip_dendogram$tree_col,
         annotation_colors = annotation_colors_scr, 
         main = "efficiency change - 100nM of drugs added")
```

\newpage

## logratio heatmap of each individual drug vs. barcode (plot for each inidividual target group)
```{r visualiztion of logratio of drugs per target, out.width= "100%", fig.align= "center", echo=FALSE}

# High concentration
for (i in unique(data2$Target)) {
  data <- data2[data2$Target == i,]
  myBreaks9 <- c(seq(min(as.matrix(data[,1:18])), 0, length.out=ceiling(100/2) + 1), 
              seq(max(as.matrix(data[,1:18]))/100, max(as.matrix(data[,1:18])), 
                  length.out=floor(100/2)))
  p <- pheatmap(as.matrix(data[,1:18]), annotation_col = annotate.bc, 
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdGy")))(100), 
         breaks = myBreaks9,
         annotation_legend = T,cluster_cols = chip_dendogram$tree_col,
         annotation_colors = annotation_colors_scr, main = 
           paste("logratio change (10uM drugs added) - target group:",i))
  print(p)
}

# Medium concentration
for (i in unique(data3$Target)) {
  data <- data3[data3$Target == i,]
  myBreaks10 <- c(seq(min(as.matrix(data[,1:18])), 0, length.out=ceiling(100/2) + 1), 
              seq(max(as.matrix(data[,1:18]))/100, max(as.matrix(data[,1:18])), 
                  length.out=floor(100/2)))
  p <- pheatmap(as.matrix(data[,1:18]), annotation_col = annotate.bc, 
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdGy")))(100), 
         breaks = myBreaks10,
         annotation_legend = T,cluster_cols = chip_dendogram$tree_col,
         annotation_colors = annotation_colors_scr, main = 
           paste("logratio change (1uM drugs added) - 
                 target group:",i))
  print(p)
}

# Low concentration
for (i in unique(data4$Target)) {
  data <- data4[data4$Target == i,]
  myBreaks11 <- c(seq(min(as.matrix(data[,1:18])), 0, length.out=ceiling(100/2) + 1), 
              seq(max(as.matrix(data[,1:18]))/100, max(as.matrix(data[,1:18])), 
                  length.out=floor(100/2)))
  p <- pheatmap(as.matrix(data[,1:18]), annotation_col = annotate.bc, 
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdGy")))(100), 
         breaks = myBreaks11,
         annotation_legend = T,cluster_cols = chip_dendogram$tree_col,
         annotation_colors = annotation_colors_scr, main = 
           paste("logratio change (100nM drugs added) - target group:",i))
  print(p)
}

##TGT... barcode seems to be susceptible to a lot of drugs especially in low conc. situation -> why?


```

```{r visualization of efficiency per drug, out.width= "100%", fig.align= "center", echo=FALSE}
# Efficiency change - 10 um
for (i in unique(data5$Target)) {
  data <- data5[data5$Target == i,]
  myBreaks9 <- c(seq(min(as.matrix(data[,1:18])), 0, length.out=ceiling(100/2) + 1), 
              seq(max(as.matrix(data[,1:18]))/100, max(as.matrix(data[,1:18])), 
                  length.out=floor(100/2)))
  p <- pheatmap(as.matrix(data[,1:18]), annotation_col = annotate.bc, 
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdGy")))(100), 
         breaks = myBreaks9,
         annotation_legend = T,cluster_cols = chip_dendogram$tree_col,
         annotation_colors = annotation_colors_scr, main = 
           paste("efficiency change (10uM drugs added) - target group:",i))
  print(p)
}

# Efficiency change - 1 um
for (i in unique(data7$Target)) {
  data <- data7[data7$Target == i,]
  myBreaks9 <- c(seq(min(as.matrix(data[,1:18])), 0, length.out=ceiling(100/2) + 1), 
              seq(max(as.matrix(data[,1:18]))/100, max(as.matrix(data[,1:18])), 
                  length.out=floor(100/2)))
  p <- pheatmap(as.matrix(data[,1:18]), annotation_col = annotate.bc, 
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdGy")))(100), 
         breaks = myBreaks9,
         annotation_legend = T,cluster_cols = chip_dendogram$tree_col,
         annotation_colors = annotation_colors_scr, main = 
           paste("efficiency change (1uM drugs added) - target group:",i))
  print(p)
}

# Efficiency change - 100 nm
for (i in unique(data7$Target)) {
  data <- data7[data7$Target == i,]
  myBreaks9 <- c(seq(min(as.matrix(data[,1:18])), 0, length.out=ceiling(100/2) + 1), 
              seq(max(as.matrix(data[,1:18]))/100, max(as.matrix(data[,1:18])), 
                  length.out=floor(100/2)))
  p <- pheatmap(as.matrix(data[,1:18]), annotation_col = annotate.bc, 
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdGy")))(100), 
         breaks = myBreaks9,
         annotation_legend = T,cluster_cols = chip_dendogram$tree_col,
         annotation_colors = annotation_colors_scr, main = 
           paste("efficiency change (100nM drugs added) - target group:",i))
  print(p)
}

```


\newpage
## t-statistic heatmap of each individual drug vs. barcode
```{r out.width= "100%", fig.align= "center", echo=FALSE}

myBreaks12 <- c(seq(min(as.matrix(indel.data.high.drug.st)), 0, 
                   length.out=ceiling(100/2) + 1), 
              seq(max(as.matrix(indel.data.high.drug.st))/100, 
                  max(as.matrix(indel.data.high.drug.st)), length.out=floor(100/2)))

# pheatmap function: t-statistic heatmap of each individual drug vs. barcode - 10uM drugs added
pheatmap(as.matrix(indel.data.high.drug.st), fontsize_col = 8, fontsize_row = 5, annotation_col = target, cellheight = 8,
         annotation_row = annotate.bc,
         color = colorRampPalette(rev(brewer.pal(n = 7, name = "RdGy")))(100),
         breaks = myBreaks12, treeheight_col = 100,
         annotation_colors = annotation_colors_scr, , annotation_legend = F, main = "log2(+1/-7 indel ratio) - 10uM of drugs added")



```

## Heatmap efficiency/logratio overlay
```{r}
indel.data.high$logratio.platenorm.rel <- ave(indel.data.high$logratio.platenorm, FUN = function (x) 2^x)
indel.data.high$logratio.platenorm.rel <- ave(indel.data.high$logratio.platenorm.rel, FUN = function (x) x/max(x))
indel.data.high$efficiency.platenorm.rel <- ave(indel.data.high$efficiency.platenorm, FUN = function(x) 2^x)
indel.data.high$efficiency.platenorm.rel <- ave(indel.data.high$efficiency.platenorm.rel, FUN = function(x) x/max(x))
indel.data.high$overlay <- abs(indel.data.high$logratio.platenorm.rel - indel.data.high$efficiency.platenorm.rel)
indel.data.high$overlay.drug <- ave(indel.data.high$overlay, indel.data.high$Drug, indel.data.high$barcode, FUN = function(x) mean(x))


indel.data.overlay.high <- indel.data.high[,c(1,6,47)]
indel.data.overlay.high <- 
  indel.data.overlay.high[!duplicated(indel.data.overlay.high), ]
indel.data.overlay.high <- dcast(indel.data.overlay.high, barcode ~ Drug, value.var = "overlay.drug")
rownames(indel.data.overlay.high) <- indel.data.overlay.high[,1]
indel.data.overlay.high <- indel.data.overlay.high[,-1]

myBreaks12.5 <- c(seq(min(as.matrix(indel.data.overlay.high)), 0, 
                   length.out=ceiling(100/2) + 1), 
              seq(max(as.matrix(indel.data.overlay.high))/100, 
                  max(as.matrix(indel.data.overlay.high)), length.out=floor(100/2)))

# pheatmap 
indel.data.overlay.high <- 
  indel.data.overlay.high[, 
                         colSums(indel.data.overlay.high > 0.875) >= 1 | colSums(indel.data.overlay.high < 0.6) >= 1]


pheatmap(as.matrix(indel.data.overlay.high))
```



# Conclusions
This already reveals some useful information, more in-depth studies of individual drugs is needed, especially because the grouping of drugs into categories can be faulty and misleading (inhibitors can be either pan, or selective for a sub-group, which means that they probably affect different locations/barcodes)

I want to create heatmaps for each drug within the 17 different target groups. This will give more information about the effect of individual drugs (and maybe clustering within groups -> subgroups because of different targets etc.).

Next step is to import the chromatin data to generate a correlation matrix between the effect of target groups/drugs on the logration and chromatin data.



Next step is to import the chromatin data to generate a correlation matrix between the effect of target groups/drugs on the logration and chromatin data.

## Import chromatin data
```{r import chromatin data}
# Import chromatin data
mapping_mean_chip <- tibble::rownames_to_column(mapping_mean, "barcode")
chip_data <- melt(mapping_mean_chip)
chip_data <- dcast(chip_data, variable ~ barcode, value.var = "value")
setnames(chip_data, old = "variable", new = "barcode")

# Process indel data
indel.data.chip <- indel.data.high[,c(1,6,39)]
indel.data.chip <- indel.data.chip[!duplicated(indel.data.chip),]
indel.data.chip <- dcast(indel.data.chip, barcode ~ Drug, value.var = "mean.logratio.bc.drug")
chip_data <- merge(indel.data.chip, chip_data, all = TRUE)
chip_data <- chip_data[chip_data$barcode != c("ACCCCTAAAGGCGCTG", "CTCTTAATCGCTGCC"), ]
row.names(chip_data) <- chip_data$barcode
chip_data <- chip_data[,-1]

# Calculate correlations
cor_chip_indel <- cor(chip_data)
cor_chip_indel <- melt(cor_chip_indel)

# Visualize
ggplot(data = cor_chip_indel, aes(x=Var1, y=Var2, fill=value)) + 
  geom_tile()

```



## Exporting potential data. 
```{r}
```

# Session Info
```{r}
paste("Run time: ",format(Sys.time()-StartTime))
getwd()
date()
sessionInfo()
```

