---
title: "DSB epigenetic drug screen - Figure 5"
author: 
  - name: "Max Trauernicht & Ruben Schep"
    email: "m.trauernicht@nki.nl; r.schep@nki.nl"
    affiliation: "Netherlands Cancer Institute"
date: '`r format(Sys.time(), "%d/%m/%Y")`'
output: 
  html_document:
    theme: united
    highlight: pygments
    fig_caption: yes
    code_folding: hide
    df_print: kable
    toc: true
    toc_depth: 4
    toc_float:
      collapsed: false
---

*knitr document van Steensel lab*


# Introduction
Clone 5 with ~18 sgRNA target site IPRs was cut and treated with 160 epigenetic drugs. The repair outcomes of that experiment will be visualized here. I previously processed the raw sequencing data, and calculated the repair outcomes. In this script, the main results plots will be generated.


## Setup {.tabset}

<!-- little HTML script to do indentation of the table of contents -->
<script>
$(document).ready(function() {
$items = $('div#TOC li');
$items.each(function(idx) {
num_ul = $(this).parentsUntil('#TOC').length;
$(this).css({'text-indent': num_ul * 10, 'padding-left': 0});
});

});
</script>

```{css, echo = FALSE}
div.sourceCode {
overflow-x: hidden;
}
```
### Libraries

```{r load_packages, results = 'hide', warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE)
StartTime <-Sys.time()

# 8-digit Date tag:
Date <- substr(gsub("-","",Sys.time()),1,8) 
# libraries:
library(tidyverse)
library(outliers)
library(ggplot2)
library(ggbeeswarm)
library(data.table)
library(GGally)
library(MASS)
library(gghighlight)
library(ggrepel)
library(ggpubr)
library(pheatmap)
library(RColorBrewer)
library(broom)
library(rstatix)
library(colorspace)
library(analogue)
library(cowplot)
library(Hmisc)
library(ggstatsplot)
library(ggpmisc)
library(onewaytests)
library(magrittr)


## Select outdir
out.dir = paste0("./figures/", Date, "/")
dir.create(out.dir)
in.dir = list.dirs(path = "/DATA/projects/DSBrepair/data/R") %>% .[grepl("episcreen", .)] %>% tail(n = 1)
knitr::opts_chunk$set(dev=c('png', 'pdf'), fig.path = file.path(out.dir))

pdf.options(useDingbats = FALSE)
```

### Functions

```{r load_functions, echo = FALSE, warning = FALSE}
CorrelationDFMean <- function(data, feature_name, targets, p.value=0.001){
  hist.corr.list <- data %>% dplyr::select(all_of(feature_name), targets) %>% as.matrix() %>% rcorr(type = "spearman")
  
  histone.corr.df <- data.frame(rowname = names(hist.corr.list$r[1, -1]),
                                corr = hist.corr.list$r[1, -1],
                                pvalue = hist.corr.list$P[1, -1])
  
  return(histone.corr.df=histone.corr.df)
}



p.adjust <- function(p, method = p.adjust.methods, n = length(p))
{
  ## Methods 'Hommel', 'holm', 'BY' and speed improvements
  ## contributed by Gordon Smyth
  method <- match.arg(method)
  if(method == "fdr") method <- "BH"	# back compatibility
  nm <- names(p)
  p <- as.numeric(p)
  p0 <- setNames(p, nm)
  if(all(nna <- !is.na(p))) nna <- TRUE
  p <- p[nna]
  lp <- length(p)
  # stopifnot(n >= lp)
  if (n <= 1) return(p0)
  if (n == 2 && method == "hommel") method <- "hochberg"
  
  p0[nna] <-
    switch(method,
           bonferroni = pmin(1, n * p),
           holm = {
             i <- seq_len(lp)
             o <- order(p)
             ro <- order(o)
             pmin(1, cummax( (n - i + 1L) * p[o] ))[ro]
           },
           hommel = { ## needs n-1 >= 2 in for() below
             if(n > lp) p <- c(p, rep.int(1, n-lp))
             i <- seq_len(n)
             o <- order(p)
             p <- p[o]
             ro <- order(o)
             q <- pa <- rep.int( min(n*p/i), n)
             for (j in (n-1):2) {
               ij <- seq_len(n-j+1)
               i2 <- (n-j+2):n
               q1 <- min(j*p[i2]/(2:j))
               q[ij] <- pmin(j*p[ij], q1)
               q[i2] <- q[n-j+1]
               pa <- pmax(pa,q)
             }
             pmax(pa,p)[if(lp < n) ro[1:lp] else ro]
           },
           hochberg = {
             i <- lp:1L
             o <- order(p, decreasing = TRUE)
             ro <- order(o)
             pmin(1, cummin( (n - i + 1L) * p[o] ))[ro]
           },
           BH = {
             i <- lp:1L
             o <- order(p, decreasing = TRUE)
             ro <- order(o)
             pmin(1, cummin( n / i * p[o] ))[ro]
           },
           BY = {
             i <- lp:1L
             o <- order(p, decreasing = TRUE)
             ro <- order(o)
             q <- sum(1L/(1L:n))
             pmin(1, cummin(q * n / i * p[o]))[ro]
           },
           none = p)
  p0
}

CorrelationPlotMean <- function(data, feature_name, targets, title = "with treatment", p.value=0.01, alfa = c(0.5, 1)){
  cor.df = data.frame()
  for (i in feature_name){
    corr.list <- data %>% 
      dplyr::select(all_of(i), as.character(targets)) %>% 
      as.matrix() %>% 
      rcorr(type = "spearman")
    
    df <- data.frame(rowname = names(corr.list$r[1, -1]),
                     corr = corr.list$r[1, -1],
                     pvalue = corr.list$P[1, -1],
                     feature = i)
    cor.df <- rbind(cor.df, df) %>%
      transform(rowname = factor(rowname, levels = levels(targets)),
                corr = corr,
                pvalue = pvalue) %>% 
      mutate(p.adj = p.adjust(pvalue)) %>%
      add_significance("p.adj")
  }
  p <-  ggplot(cor.df, aes(x = rowname, y = corr, fill = p.adj.signif)) +
    geom_bar(stat = "identity", position = "dodge") +
    ylab(paste("Spearman correlation",title)) +
    xlab("Chromatin Feature") +
    # ggtitle(paste("Repair pathways correlation with chromatin features in", condition_name, "exps"))  +
    theme_classic2(base_size = 16) +
    scale_y_continuous(breaks=seq(-1,1, .1)) +
    scale_fill_manual(values = c("****" = "black", "***" = "gray20", "**" = "gray40", 
                                 "*" = "gray50", "ns" = "gray80")) +
    coord_flip()
  return(list(dataframe=cor.df, plot = p))
}


SetFileName <- function(filename, initials) {
  # Set filename with extension and initials to make filename with date integrated.
  filename <- substitute(filename)
  initials <- substitute(initials)
  filename <- paste0(initials, Date, filename)
  filename
}
plot_comb_grid_beeswarm <- function(dt, opt_df, domains, y_name, min_count=0,
                                    max_count=Inf, group_by=NULL, color=NULL, 
                                    y_plabel=c(-1.5, 1.5)){
  
  opt_melt = reshape2::melt(opt_df)
  colnames(opt_melt) = c('group', 'domain', 'is_in')
  
  opt_melt$is_in = ifelse(opt_melt$is_in, 'in', 'out')
  opt_melt$domain = factor(opt_melt$domain, levels=domains)
  
  
  group_list = lapply(rownames(opt_df), function(opt_name){
    opt = opt_df[opt_name, ]
    in_vec = domains[opt]
    out_vec = domains[!opt]
    
    in_sum = rowSums(dt[,..in_vec])
    out_sum = rowSums(dt[,..out_vec])
    if (length(in_vec)==0){
      in_group = which(out_sum == 0)
    } else if (length(out_vec) == 0){
      in_group = which(in_sum==length(in_vec))
    } else  {
      in_group = which(in_sum == length(in_vec) & out_sum==0)
    }
    return(in_group)
  })
  
  names(group_list) = rownames(opt_df)
  for (opt_name in names(group_list)){
    i_vec = group_list[[opt_name]]
    dt[i_vec, group := opt_name]
  }
  if (is.null(group_by)){
    group_count_df = data.frame(dt[,table(group)])
  } else {
    group_count_df = data.frame(dt[,table(group)/length(unique(get(group_by)))])
  }
  group_count_df = group_count_df[order(match(group_count_df$group, rownames(opt_df))),]
  # print(group_count_df)
  group_count_sel = group_count_df[group_count_df$Freq>=min_count,]
  group_count_sel = group_count_sel[group_count_sel$Freq<=max_count,]
  group_levels =  group_count_sel$group
  opt_sel = opt_melt[opt_melt$group %in% group_levels, ]
  
  opt_sel$group = factor(opt_sel$group, levels=group_levels)
  # print(opt_sel)
  
  indel_selection = dt[group%in%group_levels, ]
  indel_selection[,group:=factor(group, levels=group_levels)]
  
  # wilcox_list = lapply(group_levels[group_levels!='iDomain'],
  #                      function(g){
  #                          x = indel_selection[group==g, y_name, with=F]
  #                          y = indel_selection[group=='iDomain', y_name,
  #                                              with=F]
  #                          wilcox.test(unlist(x),unlist(y))
  #                      })
  
  group_count_sel$group = factor(group_count_sel$group, levels=group_levels)
  
  count_plot = ggplot(group_count_sel, aes(x=group,y=1, label=Freq)) +
    geom_label() +
    theme_void()
  
  
  
  dots = ggplot(opt_sel, aes(x=group, y=domain, color=is_in)) +
    geom_point(size=2) +
    geom_line(data=opt_sel[opt_sel$is_in=='in',], aes(group=group)) +
    theme_bw() +
    scale_color_manual(values=c('in'='black', 'out'='grey70')) +
    guides(color="none")  +
    geom_vline(xintercept=seq(1.5, length(unique(dt$group))-0.5, 1),
               lwd=0.5, colour="grey90") +
    theme(axis.title=element_blank(),
          axis.text=element_blank(),
          axis.ticks=element_blank(),
          panel.grid.major = element_blank())
  
  symnum = list(cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 1),
                symbols = c("****", "***", "**", "*", " "))
  
  
  if (is.null(group_by)){
    beeswarm = ggplot(indel_selection, aes_string(x='group', y=y_name)) +
      geom_quasirandom(width=0.3) +
      stat_summary(fun=median, fun.min = median,
                   fun.max = median,
                   geom="crossbar", width = 0.5,
                   color='red') +
      stat_compare_means(aes(label = ..p.signif..),
                         symnum.args = symnum,
                         method = 'wilcox.test',
                         ref.group='iDomain')
    
  } else {
    wilcox_dt = indel_selection[,test_wilcox(.SD, group_by, y_name),
                                by='group']
    wilcox_dt[,p_adj:=p.adjust(p_value, method = "BH")]
    wilcox_dt[,p_signif:=symnum(p_adj, cutpoints=symnum$cutpoints,
                                symbols=symnum$symbols)]
    
    
    beeswarm = ggplot(indel_selection,
                      aes_string(x='group', y=y_name, color=group_by)) +
      geom_quasirandom(dodge.width=1) +
      scale_color_manual(values=color) +
      stat_summary(aes_string(group=group_by), fun=median,
                   fun.min = median, fun.max = median,
                   geom="crossbar", width = 0.5,
                   color='red',
                   position= position_dodge(width =1)) +
      geom_text(data=wilcox_dt, aes(x=group, y=0.8, label=p_signif),
                inherit.aes=F)
    print(wilcox_dt)
  }
  beeswarm = beeswarm +
    theme_bw() +
    geom_vline(xintercept=seq(1.5, length(unique(dt$group))-0.5, 1),
               lwd=0.5, colour="grey90") +
    theme(axis.title=element_blank(),
          axis.text.x=element_blank(),
          panel.grid.major.x = element_blank(),
          axis.ticks.x=element_blank()) +
    ylim(y_plabel)
  
  count = data.frame(domain=gsub('_domain', '', domains),
                     count=colSums(dt[,..domains], na.rm=T))
  
  count$domain = factor(count$domain, levels=domain_levels)
  
  histogram = ggplot(count, aes(x=1, y=domain, label = count)) +
    geom_label() +
    theme_bw() +
    theme(plot.background = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.border = element_blank(),
          axis.title=element_blank(),
          axis.text.x=element_blank(),
          axis.ticks=element_blank())
  
  empty = ggplot(data=data.frame(1,1),aes(x=1,y=1)) +
    geom_point() +
    theme_void()
  
  count_beeswarm = plot_grid(beeswarm, count_plot, ncol=1, rel_heights=c(20,1),
                             align='v', axis='lr')
  return(plot_grid(empty, beeswarm, empty, count_plot,
                   histogram, dots, nrow=3,
                   rel_widths=c(1,10), rel_heights=c(15,1,5), align='vh',
                   axis='tlbr'))
}

get_combinations <- function(domain_vec){
  n_domain = length(domain_vec)
  get_ivec <-function (last_x, n_domain){
    if (last_x < n_domain){
      i_vec = c(0, c((last_x+1):n_domain))
    } else{
      i_vec = c(0)
    }
  }
  
  combine <- function(x_new, x_vec, n_domain){
    new_vec = c(x_vec, x_new)
    if (length(new_vec)==n_domain){
      return(new_vec)
    } else {
      i_vec = get_ivec(max(new_vec), n_domain)
      x_list = lapply(i_vec, combine, x_vec=new_vec,
                      n_domain=n_domain)
      return(do.call(rbind, x_list))
    }
  }
  
  comb_list = lapply(c(0:n_domain), combine, x_vec=c(), n_domain=n_domain)
  
  comb = do.call(rbind, comb_list)
  comb_df = unique(t(apply(comb, 1, function(x){x[order(x)]})))
  
  name_list = apply(comb_df, 1, function(x){
    name = paste(domain_vec[x], collapse='-')
    if (name == ''){
      name = 'iDomain'
    }
    return(name)
  })
  
  opt_list = lapply(domain_vec, function(d){
    apply(comb_df, 1, function(x){
      opt = domain_vec[x]
      return(d%in%opt)
    })
  })
  
  opt_df = do.call(cbind, opt_list)
  colnames(opt_df) = domain_vec
  rownames(opt_df) = name_list
  
  return(opt_df)
}

# From Fede:
# ggpairs custom functions
corColor <- function(data, mapping, color = I("black"), sizeRange = c(1, 3), ...) {
  
  x   <- eval_data_col(data, mapping$x)
  y   <- eval_data_col(data, mapping$y)
  r   <- cor(x, y)
  rt  <- format(r, digits = 3)
  tt  <- as.character(rt)
  cex <- max(sizeRange)
  
  # helper function to calculate a useable size
  percent_of_range <- function(percent, range) {
    percent * diff(range) + min(range, na.rm = TRUE)
  }
  
  # plot correlation coefficient
  p <- ggally_text(label = tt, mapping = aes(), xP = 0.5, yP = 0.5,
                   size = I(percent_of_range(cex * abs(r), sizeRange)), color = color, ...) +
    theme(panel.grid.minor=element_blank(),
          panel.grid.major=element_blank())
  
  corColors <- RColorBrewer::brewer.pal(n = 7, name = "RdYlBu")[2:6]
  
  if (r <= boundaries[1]) {
    corCol <- corColors[1]
  } else if (r <= boundaries[2]) {
    corCol <- corColors[2]
  } else if (r < boundaries[3]) {
    corCol <- corColors[3]
  } else if (r < boundaries[4]) {
    corCol <- corColors[4]
  } else {
    corCol <- corColors[5]
  }
  
  p <- p +
    theme(panel.background = element_rect(fill = corCol))
  
  return(p)
}


theme_classic_lines <- function() {
  theme_pubr(border = T, legend = "top") +
    theme(panel.grid.major = element_line(colour = "#adb5bd", size = 0.25),
          strip.background = element_rect(fill = "white", color = "white")
    )
}
theme_classic_lines_45 <- function() {
  theme_pubr(border = T, legend = "top", x.text.angle = 45) +
    theme(panel.grid.major = element_line(colour = "#adb5bd", size = 0.25),
          strip.background = element_rect(fill = "white", color = "white")
    )
}

theme_classic_lines_90 <- function() {
  theme_pubr(border = T, legend = "top", x.text.angle = 90) +
    theme(panel.grid.major = element_line(colour = "#adb5bd", size = 0.25),
          strip.background = element_rect(fill = "white", color = "white")
    )
}

theme_classic_lines_90_noborder <- function() {
  theme_pubr(border = F, legend = "top", x.text.angle = 90) +
    theme(strip.background = element_rect(fill = "white", color = "white")
    )
}

theme_set(theme_classic_lines())

colors_diverse <- c("#264653", "#9AC1AE", "#5D987B", "#f2cc8f", "#e76f51")
colors_drugs <- c("#FA8D62", "#65BFA4", "#8CA0C4", "#808184", "#F6D289", "#E5E5E5", "#ACACAC", "#737373")
#colors_diverse <- c("#264653", "#2a9d8f", "#e9c46a", "#f4a261", "#e76f51") 
colors_targets <-  c(HDAC="#60988D", HAT="#C6D0A8", Sirtuin="#8FCAAC",
                     HMT="#FDCDAC", DNMT="#D69C81", `Histone Demethylase`="#FFF2AE",
                     HIF="#E3DCD5", JAK="#C8D7E2", PIM="#9AB8C4", `Aurora Kinase`="#F4CAE4",
                     PARP="#CB546F", `Epigenetic Reader Domain`= "#476D61", `DNA-PK`="#779ed7")
colors_pathways = c("wt" = "#808184", "other" = "black", "NHEJ" = "#e1251b", "MMEJ" = "#26419a", "SSTR" = "#007A4C")
slope.colors <- tibble(color = c("#8c510a", "#f5f5f5","#01665e"),label = c("negative","none","positive"), feature = "epistasis")

conc_colors = c("100 nM" = colors_drugs[7], "1 µM" = colors_drugs[4], "10 µM" = "#000000")



ggplot_custom <- function(...) ggplot2::ggplot(...) + 
  scale_color_manual(values = colors_diverse) + 
  scale_fill_manual(values = colors_diverse)

sigFunc = function(x){
  if(x < 0.001){"***"} 
  else if(x < 0.01){"**"}
  else if(x < 0.05){"*"}
  else{NA}}

```


### Data import

```{r data import, echo = FALSE, warning = FALSE}
# # Import data from preprocessing script
# in.dir = list.dirs(path = "/DATA/projects/DSBrepair/data/R") %>% .[grepl("episcreen", .)] %>% tail(n = 1)
# file = list.files(in.dir, pattern = "episcreen_ratios", full.names = T) %>% tail(n = 1)
# indel.data <- readRDS(file) # %>% filter(pathway_bal_filter == TRUE & viab_reproducibility == TRUE)
#indel.data <- readRDS("data/episcreen_ratios_mt20220819.RDS") 
in.dir = list.dirs(path = "/DATA/projects/DSBrepair/data/R") %>% .[grepl("episcreen", .)] %>% tail(n = 1)
file = list.files(in.dir, pattern = "episcreen_ratios", full.names = T) %>% tail(n = 1)
indel.data <- readRDS(file) # %>% filter(pathway_bal_filter == TRUE & viab_reproducibility == TRUE)

# Import data from preprocessing validation script
file.validation = list.files(in.dir, pattern = "validation_ratio", full.names = T) %>% tail(n = 1)
indel.data.validation <- readRDS(file.validation)

chromatin.features <- colnames(indel.data)[grepl("[.]zscore", colnames(indel.data))]
chrom_data = indel.data %>% dplyr::select(barcode, all_of(chromatin.features)) %>% distinct()  %>%
  rename_with(., ~gsub(".zscore", "", .x))

chromatin.features.short = gsub(".zscore", "", chromatin.features)
chromatin.features.short.val = chromatin.features.short[!grepl("H3K9me3", chromatin.features.short)]

# List chromatin name columns from this table
chromatin_cols = colnames(indel.data.validation)[42:75]
# Import data from DSB TRIP paper
RSTP2_IndelRatios_Chromatin_2kb <- readRDS("/DATA/usr/r.schep/DSBrepair/data/R/rs20210311/RSTP2_IndelRatios_Chromatin_2kb.RDS") %>% 
  filter(replicate == "mean" & drug %in% c("DMSO_GSK", "GSK126") & plasmid == "LBR2") %>%
  dplyr::select(barcode, drug, MMEJ, NHEJ, efficiency, all_of(chromatin_cols)) %>%
  distinct() %>%
  mutate(MMEJ_NHEJ = MMEJ/NHEJ) %>%
  dplyr::select(-NHEJ, -MMEJ)
```

## Prepare heatmaps
```{r prepare data for heatmaps 1}
# Order IPRs by their starting freqCut value
dmso_freq <- indel.data %>%
  filter(drug == "DMSO") %>%
  distinct(IPR, MMEJratio) %>%
  mutate(MMEJratio = ave(MMEJratio, IPR, FUN = function(x) mean(x, na.rm = TRUE))) %>%
  dplyr::select('ctrl_MMEJratio' = MMEJratio, IPR) %>%
  distinct() %>%
  arrange(desc(ctrl_MMEJratio))

iprs <- dmso_freq$IPR
iprs <- as.character(iprs)

drug_conc_table = indel.data %>%
  distinct(drug, conc_char, target) %>%
  mutate(drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " "))

# Set annotation for heatmap
# viability
viab_drug = indel.data %>% filter(drug != "PAO") %>% 
  mutate(drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " ")) %>% 
  distinct(viab_mean, drug_conc, replicate) %>% 
  group_by(drug_conc) %>%
  summarise(viab = mean(viab_mean))

# Row annotation: annotate drugs with the target group
target_set_drugs <- indel.data %>% 
  filter(conc_char != "control") %>%
  mutate(drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " ")) %>%
  left_join(viab_drug) %>%
  distinct(drug, drug_conc, target, viab) %>% 
  column_to_rownames(var="drug_conc")

ctrl.vals <- indel.data %>%
  filter(drug == "DMSO") %>%
  distinct(IPR, freqCut, MMEJratio) %>%
  mutate(ctrl_TIF = ave(freqCut, IPR, FUN = function(x) mean(x, na.rm = TRUE))*100,
         ctrl_balance = ave(MMEJratio, IPR, FUN = function(x) mean(x, na.rm = TRUE))*100) %>%
  distinct(ctrl_TIF, 
           ctrl_balance,
           IPR)

clone5.matrix = indel.data %>% 
  dplyr::select(IPR, ends_with(".zscore")) %>% 
  distinct() %>% 
  rename_with(., ~gsub(".zscore", "", .x)) %>%
  # left_join(ctrl.vals) %>%
  column_to_rownames(var="IPR")

clone5_map_ipr = hclust(dist(clone5.matrix), method = "ward.D") %>% 
  # Rotate the middle node to math better the bal in CTRL conditions
  dendextend::rotate(c(1:6, 10:7, 11:18))

# Chromatin annotation
chromatin <- readRDS(
  "/DATA/usr/x.vergara/XV_ChIPIndels/XV20200902_DDR_RS_revision/XV20200902_DDR_RS_revision/data/xv20200915_DDR_data_CHIP.rds") %>% 
  distinct(barcode, chromatin) %>%
  left_join(distinct(indel.data, barcode, IPR)) %>%
  left_join(dmso_freq)

# chromatin$IPR[is.na(chromatin$IPR)] <- "IPR1"
chromatin <- chromatin %>%
  filter(IPR != "<NA>") %>% 
  dplyr::select(-barcode) %>%
  column_to_rownames(var="IPR")

## Chromatin groups
group_colors = c("Euchromatin" = "#f7941d",
                 "other-heterochromatin" = "#838687",
                 "Triple Heterochromatin" = "#662d91",
                 "H3K27me3" = "#d21f8a")


viab_colors = sequential_hcl(11, "Peach", rev = TRUE)
names(viab_colors) = seq(0, 1, by = 0.1)

annotation_colors_scr = list(
  chromatin = group_colors,
  target = c(HDAC="#60988D", HAT="#C6D0A8", Sirtuin="#8FCAAC",
             HMT="#FDCDAC", DNMT="#D69C81", `Histone Demethylase`="#FFF2AE",
             HIF="#E3DCD5", JAK="#C8D7E2", PIM="#9AB8C4", `Aurora Kinase`="#F4CAE4",
             PARP="#CB546F", `Epigenetic Reader Domain`= "#476D61", `DNA-PK`="#779ed7"),
  p.adj.Welch = c(n.s. = "#F9F9F9", `p < 0.01` = "#0066A5"),
  clusters_drugs = sequential_hcl(4, "YlGn"),
  # viab_rep1 = c('#ffeee9', '#ffdcd4', '#ffcbbe', '#ffb8a8', '#fda693', '#f9947e', '#f4826a', '#ef6f56', '#e95b43', '#e24530'),
  # viab_rep2 = c('#ffeee9', '#ffdcd4', '#ffcbbe', '#ffb8a8', '#fda693', '#f9947e', '#f4826a', '#ef6f56', '#e95b43', '#e24530'),
  viab = viab_colors,
  ctrl_MMEJratio = colorRampPalette(c("white", "black"))(10))

# Order the annotation legend
ordered_marks <- c("Euchromatin", 
                   "H3K27me3", 
                   "other-heterochromatin",  
                   "Triple Heterochromatin")

annotation_colors_scr$chromatin <- annotation_colors_scr$chromatin[ordered_marks]

# Order IPRs by their starting MMEJ_log2_FC value
dmso_bal <- indel.data %>%
  filter(drug == "DMSO") %>%
  distinct(IPR, MMEJ_log2_FC) %>%
  mutate(MMEJ_log2_FC = ave(MMEJ_log2_FC, IPR, FUN = function(x) mean(x, na.rm = TRUE))*100) %>%
  dplyr::select('dmso_bal' = MMEJ_log2_FC, IPR) %>%
  distinct() %>%
  arrange(desc(dmso_bal))

iprs <- dmso_bal$IPR
iprs <- as.character(iprs)
```

# Main Figure 5
## 5A: MMEJ ratio change heatmap
Aim: Give an overview of the most important MMEJ ratio fold-changes. 
```{r prepare data for heatmaps}
# Generate heatmap: select top drugs (highest change at any IPR) per concentration
balance.data.heatmap <- indel.data %>%
  mutate(drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " ")) %>%
  filter(sample == "Epigenetic Compound" & pathway_bal_filter) %>%
  distinct(conc_char, drug, drug_conc, target, IPR, zscore_bal_comb_rep, 
           MMEJ_log2_FC, replicate, tech, filter_zscore_bal_comb_rep) %>%
  group_by(drug_conc) %>%
  mutate(MMEJ_log2_FC_mean = ave(MMEJ_log2_FC, IPR, FUN = function(x) mean(x, na.rm = TRUE)),
         ## Select drugs that have a large effect size in at least one location 
         ## (some drugs might have a small global effect size, but large local)
         zscore_bal_comb_rep_temp = ifelse(filter_zscore_bal_comb_rep, zscore_bal_comb_rep, 0),
         p_value = 2*pnorm(q = abs(zscore_bal_comb_rep_temp), lower.tail = F)) %>%
  distinct(drug, target, conc_char, MMEJ_log2_FC_mean, IPR, zscore_bal_comb_rep_temp, p_value, drug_conc) %>%
  mutate(# Adjust p value for false discovery rate
         adj_pvalue = p.adjust(p_value, method = 'BH'),
         # Pick the smallest per compound & concentration
         min_score = min(adj_pvalue, na.rm = T)) %>%
  # filter for adjusted p.val < 0.01 so we keep compounds with at least one signif effect.
  filter(min_score < 0.01) %>%
  ungroup() %>%
  distinct(drug, target, conc_char, MMEJ_log2_FC_mean, IPR, min_score, drug_conc) 

# Store heatmap for clustering below
balance.clustering <- copy(balance.data.heatmap)


# List samples with significant effect in IPR to gray them out in the plot.
pvals_drug_conc = indel.data %>%
  mutate(drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " ")) %>%
  distinct(drug_conc, IPR, zscore_bal_comb_rep, filter_zscore_bal_comb_rep) %>%
   group_by(drug_conc) %>%
  mutate(zscore_bal_comb_rep_temp = ifelse(filter_zscore_bal_comb_rep, zscore_bal_comb_rep, 0),
         p_value = 2*pnorm(q = abs(zscore_bal_comb_rep_temp), lower.tail = F)) %>%
  filter(!is.na(zscore_bal_comb_rep)) %>%
  mutate(adj_pvalue = p.adjust(p_value, method = 'BH'),
         p_filter = ifelse(adj_pvalue < 0.01 & filter_zscore_bal_comb_rep, TRUE, FALSE)) %>%
  filter(filter_zscore_bal_comb_rep) %>%
  distinct(drug_conc, IPR, p_filter)

balance.data.heatmap %<>% left_join(pvals_drug_conc) %>%
  mutate(p_filter = replace_na(p_filter, FALSE),
         # This changes the samples that are not significant to 0.
         # MMEJ_log2_FC_mean = ifelse(p_filter, MMEJ_log2_FC_mean, 0)
         ) 

# Number of individual drugs (Same piece of code as above)
number_drugs = indel.data %>%
  mutate(drug_conc = paste(drug, conc_char, sep = " ")) %>%
  filter(sample == "Epigenetic Compound") %>%
  filter(pathway_bal_filter == TRUE) %>%
  distinct(conc_char, drug, drug_conc, target, IPR, zscore_bal_comb_rep, 
           MMEJ_log2_FC, replicate, tech, filter_zscore_bal_comb_rep) %>%
  group_by(drug_conc) %>%
  mutate(MMEJ_log2_FC_mean = ave(MMEJ_log2_FC, IPR, FUN = function(x) mean(x, na.rm = TRUE)),
         ## Select drugs that have a large effect size in at least one location 
         ## (some drugs might have a small global effect size, but large local)
         zscore_bal_comb_rep_temp = ifelse(filter_zscore_bal_comb_rep, zscore_bal_comb_rep, 0),
         p_value = 2*pnorm(q = abs(zscore_bal_comb_rep_temp), lower.tail = F),
         # Adjust p value for false discovery rate
         adj_pvalue = p.adjust(p_value, method = 'BH'))

MMEJboost = number_drugs %>% 
  # Add filtering for significant increases
  filter(adj_pvalue < 0.01 & zscore_bal_comb_rep_temp > 1) %>% 
  # unique the drugs
  distinct(drug) %>% 
  # count the rows
  nrow()

NHEJboost = number_drugs %>% 
  # Add filtering for significant increases
  filter(adj_pvalue < 0.01 & zscore_bal_comb_rep_temp < -1) %>% 
  # unique the drugs
  distinct(drug) %>% 
  # count the rows
  nrow()

# Statement
paste("Of the 160 epigenetic compounds significantly altering the MMEJ:NHEJ ratio in at least one IPR,", MMEJboost, "boosted the ratio and ", NHEJboost, " decreased the ratio.")


dmso_bal <- indel.data %>%
  filter(drug == "DMSO") %>%
  dplyr::select('dmso_bal' = MMEJ_log2_FC , IPR) %>%
  mutate(dmso_bal = ave(dmso_bal, IPR, FUN = function(x) mean(x, na.rm = TRUE))) %>%
  distinct()

top_50_hits = balance.data.heatmap %>% 
  distinct(drug_conc, MMEJ_log2_FC_mean) %>%
  arrange(desc(abs(MMEJ_log2_FC_mean))) %>%
  distinct(drug_conc) %>% dplyr::slice_head(n = 50)

balance.data.heatmap2 <- balance.data.heatmap %>% 
  filter(drug_conc %in% top_50_hits$drug_conc) %>%
  dplyr::select(-min_score, -p_filter) %>%
  spread(IPR, MMEJ_log2_FC_mean)


# Make clustering of samples with all the data: 
balance.clustering %<>% 
  filter(drug_conc %in% top_50_hits$drug_conc) %>%
  dplyr::select(-min_score, -drug, -conc_char, -target) %>%
  spread(IPR, MMEJ_log2_FC_mean) %>%
  column_to_rownames(var = "drug_conc")

balance.clustering =  dist(balance.clustering, method = "minkowski")


balance.data.heatmap2 <- balance.data.heatmap2[,c("drug", "target", "conc_char", iprs)]
balance.data.heatmap2$drug <- gsub(" [(].*[)]", "", balance.data.heatmap2$drug) #shorten name of drug

# change these numbers according to where you want to set the cutoff
breaks <- quantile(unlist(balance.data.heatmap2 %>% 
                            dplyr::select(contains('IPR'))), c(.01,.99), na.rm = T) 

palette_length <- 100

myBreaks <- c(seq(breaks[1], 0, length.out=ceiling(palette_length) + 1))

ordered_marks2 <- balance.data.heatmap2 %>% 
  dplyr::select(target) %>%
  distinct() %>%
  arrange(target)

ordered_marks2 <- ordered_marks2$target

annotation_colors_scr_set = annotation_colors_scr
annotation_colors_scr_set$target <- annotation_colors_scr$target[ordered_marks2]

# Add cluster annotation
balance.data.heatmap2.clusters <- balance.data.heatmap2 %>% 
  as_tibble() %>%
  mutate(drug_conc = paste(drug, conc_char, sep = " "))
```

## Welch's test for chromatin senstive drugs and fisher's test for the balance
```{r}
drug_concs = unique(balance.data.heatmap$drug_conc)

MMEJratio_tib = indel.data %>% 
  mutate(drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " ")) %>% 
  filter(drug_conc %in% drug_concs) %>%
  distinct(drug_conc, IPR, MMEJ_log2_FC, tech, replicate)

welch_tib = map_dfr(drug_concs, function(x) {
  tibble("drug_conc" = x,
         "welsh.p" = welch.test(MMEJ_log2_FC ~ IPR, data = filter(MMEJratio_tib, drug_conc == x), alpha = 0.001, verbose = F)$p.value)
         }
  )

welch_tib %<>%
  left_join(drug_conc_table) %>%
  mutate(p.adj = p.adjust(welsh.p, method = "BH"),
         p.adj.Welch = ifelse(p.adj < 0.01, "p < 0.01", "n.s."))

table(welch_tib$p.adj.Welch)

paste(nrow(welch_tib %>% filter(p.adj < 0.01)), 
      "out of", nrow(welch_tib), 
      "drug-concentration samples are significantly different between IPRs")
paste(welch_tib %>% filter(p.adj < 0.01) %>% distinct(drug) %>% nrow(), 
      "out of", 
      welch_tib %>% distinct(drug) %>% nrow(),
      "drugs are significantly different between IPRs")

# Add this information to the heatmap
target_all <- target_set_drugs %>% 
  rownames_to_column(var = "drug_conc") %>%
  left_join(welch_tib) %>%
  filter(drug_conc %in% balance.data.heatmap2.clusters$drug_conc) %>%
  column_to_rownames(var = "drug_conc") %>%
  dplyr::select(target, viab, p.adj.Welch)


# Check the control samples:
MMEJratio_ctrl_tib = indel.data %>% 
  mutate(drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " ")) %>% 
  filter(sample != "Epigenetic Compound" & !grepl("1 µM", drug_conc)) %>%
  distinct(drug_conc, IPR, MMEJ_log2_FC, tech, replicate)

ctrl_dc = unique(MMEJratio_ctrl_tib$drug_conc)

welch_ctrl_tib = map_dfr(ctrl_dc, function(x) {
  tibble("drug_conc" = x,
         "welsh.p" = welch.test(MMEJ_log2_FC ~ IPR, data = filter(MMEJratio_ctrl_tib, drug_conc == x), alpha = 0.001, verbose = F)$p.value)
         }
  )

welch_ctrl_tib %<>%
  mutate(p.adj = p.adjust(welsh.p, method = "BH")) %>%
  add_significance("p.adj") 

welch_ctrl_tib

MMEJratio_ctrl_tib %>% 
  ggplot(., aes(IPR, MMEJ_log2_FC)) +
  geom_quasirandom() +
  facet_grid(~ drug_conc)


MMEJratio_tib %>% filter(drug_conc == "M344 100 nM") %>%
  ggplot(., aes(IPR, MMEJ_log2_FC)) +
  geom_quasirandom()
```

```{r Fisher test welch results balance}
chrom_hits = welch_tib %>%
  filter(p.adj < 0.01) %>%
  group_by(target) %>%
  count() %>%
  rename(effect = n) %>%
  column_to_rownames(var = "target") %>%
  rbind("other" = c(0))

all_drugs = welch_tib %>% 
  mutate(target = case_when(target %in% rownames(chrom_hits) ~ target,
         T ~ "other")) %>%
  distinct(drug_conc, target) %>%
  group_by(target) %>%
  count() %>%
  rename(no_effect = n) %>%
  column_to_rownames(var = "target")

all_drugs = all_drugs-chrom_hits

cont_table = cbind(chrom_hits,all_drugs) %>% as.matrix()
rownames(cont_table) = c("AurK", "DNMT", "ERD", "HDAC", "HDM", "HMT", "JAK", "PARP", "other")

xtab_effect = as.table(cont_table)

dimnames(xtab_effect) <- list(
  Groups = rownames(xtab_effect),
  Effect = c("Yes", "No")
)

# Compare the proportion of males and females in each category
row_wise_fisher_test(xtab_effect, p.adjust.method = "BH")
```

```{r 5A MMEJ FC heatmap, warning = FALSE, fig.width = 10, fig.height = 16}
# pdf(paste0(figure_out, "rs20220623_indelfrequency_heatmap_allconc.pdf"), width=20, height=8)
balance.data.matrix = balance.data.heatmap2.clusters %>%
  arrange(target_all) %>%
  column_to_rownames('drug_conc') %>%
  dplyr::select(contains('IPR'))

plt1 = pheatmap(balance.data.matrix[hclust(balance.clustering, method = "ward.D2")$labels,
                                    clone5_map_ipr$labels],
                cluster_cols = clone5_map_ipr,
                border_color = F,
                cellwidth = 8,
                cellheight = 8,
                breaks = myBreaks,
                main = 'MMEJ ratio FC (log2), top 60',
                annotation_row = target_all,
                annotation_col = chromatin,
                color = colorRampPalette(c("#c0332b", "#f7f7f7"))(palette_length),
                annotation_colors = annotation_colors_scr_set, 
                annotation_legend = T)
```
*Conclusion Figure 5A: HDAC-rich cluster seems to show H3K27me3-specific MMEJ ratio decrease. No strong MMEJ ratio increases.*


---


## 5B: Highlighting the strongest MMEJ ratio reducers. 
Aim: Show which drugs and which target groups are responsible for the biggest global MMEJ ratio decrease.
```{r 5B Top bal boosting, fig.width = 4, fig.height = 4}
rank_dt = indel.data %>% 
  filter(conc_char != "control" & pathway_bal_filter & 
           viab_reproducibility  & 
           !is.na(zscore_bal_global_comb_rep)) %>%
  #filter(!target %in% c("Aurora Kinase", "JAK", "PARP", "PIM", "HIF")) %>%
  distinct(drug, conc_char, zscore_bal_global_comb_rep , target, viab_mean, filter_zscore_bal_global_comb_rep) %>% 
  arrange(desc(zscore_bal_global_comb_rep)) %>%
  mutate(viab_mean = ave(viab_mean, drug, conc_char, FUN = mean),
         p_val_bal = 2*pnorm(q = abs(zscore_bal_global_comb_rep), lower.tail = F),
         adj_pval_bal = p.adjust(p_val_bal, method = 'BH')) %>%
  distinct() %>%
  na.omit() %>%
  mutate(rank = seq(1:n()),
         drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " "))

colors_targets_black = c(colors_targets, black="gray30")
maxrank = nrow(rank_dt)

pos_zscore_signif = rank_dt %>% 
  filter(adj_pval_bal < 0.01 & zscore_bal_global_comb_rep > 0) %>% 
  tail(n = 1L) %>% 
  pull(zscore_bal_global_comb_rep) %>% 
  abs()
neg_zscore_signif = rank_dt %>% 
  filter(adj_pval_bal < 0.01 & zscore_bal_global_comb_rep < 0) %>% 
  head(n = 1L) %>% 
  pull(zscore_bal_global_comb_rep) %>%
  abs()
zscore_signif = min(pos_zscore_signif, neg_zscore_signif)

rank_dt %>% 
  # left_join(near_all_bal) %>%
  mutate(col = case_when(rank < 18 & 
                           filter_zscore_bal_global_comb_rep & 
                           adj_pval_bal < 0.01 ~ target,
                         filter_zscore_bal_global_comb_rep ~ "black",
                         T ~ "gray20")) %>%
  ggplot(., aes(rank, zscore_bal_global_comb_rep, 
                color = col)) +
  geom_point()  +
  scale_color_manual(values = colors_targets_black) +
  #geom_hline(linetype = "dashed", yintercept = 2.58) +
  #geom_hline(linetype = "dashed", yintercept = -2.58) +
  geom_label_repel(aes(label = ifelse(!col %in% c("gray20","black"), drug_conc,'')),
                   box.padding   = 1,
                   point.padding = 0.5,
                   max.overlaps = Inf,
                   segment.color = 'gray50') +
  scale_x_reverse() +
  #ylim(-75,15) +
  ylab("Global combined balance z-score") +
  geom_hline(linetype = "dashed", yintercept = zscore_signif) +
  geom_hline(linetype = "dashed", yintercept = -zscore_signif) +
  theme_classic2() + 
  theme(legend.position = "none") 

rank_dt %>% 
  filter(drug != "DNA-PKi") %>%
  # left_join(near_all_bal) %>%
  mutate(col = case_when(rank < 18 & 
                           filter_zscore_bal_global_comb_rep & 
                           adj_pval_bal < 0.01 ~ target,
                         filter_zscore_bal_global_comb_rep ~ "black",
                         T ~ "gray20")) %>%
  ggplot(., aes(rank, zscore_bal_global_comb_rep, 
                color = col)) +
  geom_point()  +
  scale_color_manual(values = colors_targets_black) +
  #geom_hline(linetype = "dashed", yintercept = 2.58) +
  #geom_hline(linetype = "dashed", yintercept = -2.58) +
  geom_label_repel(aes(label = ifelse(!col %in% c("gray20","black"), drug_conc,'')),
                   box.padding   = 1,
                   point.padding = 0.5,
                   max.overlaps = Inf,
                   segment.color = 'gray50') +
  scale_x_reverse() +
  geom_hline(linetype = "dashed", yintercept = zscore_signif) +
  geom_hline(linetype = "dashed", yintercept = -zscore_signif) +
  #ylim(-75,15) +
  ylab("Global combined balance z-score") +
  theme_classic2() + 
  theme(legend.position = "none") 


rank_dt %>% 
    filter(rank >= (maxrank-100)) %>%
  # left_join(near_all_bal) %>%
  mutate(col = case_when(rank > (maxrank-10) & 
                   filter_zscore_bal_global_comb_rep & 
                   adj_pval_bal < 0.01 ~ target,
                   filter_zscore_bal_global_comb_rep ~ "black",
                   T ~ "gray20")) %>%
  ggplot(., aes(rank, zscore_bal_global_comb_rep, 
                color = col)) +
  geom_point()  +
  scale_color_manual(values = colors_targets_black) +
  #geom_hline(linetype = "dashed", yintercept = 2.58) +
  #geom_hline(linetype = "dashed", yintercept = -2.58) +
  geom_label_repel(aes(label = ifelse(!col %in% c("gray20","black"), drug_conc,'')),
                   box.padding   = 1,
                   point.padding = 0.5,
                   max.overlaps = Inf,
                   segment.color = 'gray50') +
  scale_x_reverse() +
  #ylim(-75,15) +
  ylab("Global combined balance z-score") +
  theme_classic2() + 
  theme(legend.position = "none") 

top_hits = indel.data  %>% 
  filter(conc_char != "control" & pathway_bal_filter == T & viab_reproducibility == TRUE) %>% 
  distinct(drug, conc_char, zscore_bal_global_comb_rep , target) %>%
  arrange(desc(zscore_bal_global_comb_rep )) %>% slice_head(n = 10) %>% distinct(drug, conc_char, target, zscore_bal_global_comb_rep ) %>% 
  mutate(rank = seq(1:n()),
         drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " "))


# Number of individual drugs (Same piece of code as above)
number_drugs = indel.data %>%
  #filter(!target %in% c("Aurora Kinase", "JAK", "PARP", "PIM", "HIF")) %>%
  mutate(drug_conc = paste(drug, conc_char, sep = " ")) %>%
  filter(pathway_bal_filter == TRUE & conc_char != "control") %>%
  distinct(conc_char, drug, drug_conc, target, zscore_bal_global_comb_rep, 
           filter_zscore_bal_global_comb_rep) %>%
  group_by(drug_conc) %>%
  mutate(## Select drugs that have a large effect size in at least one location 
         ## (some drugs might have a small global effect size, but large local)
         zscore_bal_global_comb_rep_temp = ifelse(filter_zscore_bal_global_comb_rep, zscore_bal_global_comb_rep, 0),
         p_value = 2*pnorm(q = abs(zscore_bal_global_comb_rep_temp), lower.tail = F),
         # Adjust p value for false discovery rate
         adj_pvalue = p.adjust(p_value, method = 'BH'))

MMEJboost = number_drugs %>% 
  # Add filtering for significant increases
  filter(adj_pvalue < 0.01 & zscore_bal_global_comb_rep_temp > 1) %>% 
  # unique the drugs
  distinct(drug, adj_pvalue, zscore_bal_global_comb_rep_temp) %>% 
  # count the rows
  nrow()

NHEJboost = number_drugs %>% 
  # Add filtering for significant increases
  filter(adj_pvalue < 0.01 & zscore_bal_global_comb_rep_temp < -1) %>% 
  # unique the drugs
  distinct(drug, adj_pvalue, zscore_bal_global_comb_rep_temp) %>% 
  # count the rows
  nrow()

# Statement
paste("Of the 160 epigenetic compounds significantly altering the MMEJ:NHEJ ratio globally,", 
      MMEJboost, "boosted the ratio and", NHEJboost, "decreased the ratio.")
```
*Conclusion Figure 4C: Many AURKi are the most stron MMEJ ratio reducers. Also Decitabine and a HDAC inhibitor are amongst the strongest.*


```{r 5B HTS Decitabine + NU7441, fig.width = 12, fig.height = 10, eval = FALSE}
# plot pathway balance in both replicates
Dec_NU_tib = indel.data.validation %>% filter(grepl("DecNU_", replicate) & plasmid == "LBR2") %>% 
  distinct(barcode, drug, replicate, MMEJ_NHEJ, efficiency, time) %>%
  pivot_wider(names_from = c(replicate), values_from = c(MMEJ_NHEJ, efficiency))

bc_IPR = indel.data %>% distinct(barcode, IPR, chromatin)

ggplot(Dec_NU_tib,
            aes(x = MMEJ_NHEJ_DecNU_rep1, y = MMEJ_NHEJ_DecNU_rep2)) +
  geom_point() +
  geom_abline(lty = "twodash") +
  geom_smooth(method = "lm") +
  stat_cor(method = "pearson") +
  theme_classic2(base_size = 16) +
  xlab("MMEJ ratio rep 1") +
  ylab("MMEJ ratio rep 2")  +
  facet_wrap(time ~ drug, scales = "free")

ggplot(Dec_NU_tib,
            aes(x = efficiency_DecNU_rep1, y = efficiency_DecNU_rep2)) +
  geom_point() +
  geom_abline(lty = "twodash") +
  geom_smooth(method = "lm") +
  stat_cor(method = "pearson") +
  theme_classic2(base_size = 16) +
  xlab("TIF rep 1") +
  ylab("TIF rep 2")  +
  facet_grid(time ~ drug)

Dec_NU_tib = indel.data.validation %>% 
  filter(grepl("DecNU_", replicate) & plasmid == "LBR2" & drug == "DMSODN" | 
           grepl("mean", replicate) & plasmid == "LBR2" & drug %in% c("Decitabine-NU7441", "Decitabine", "NU7441")) %>% 
  distinct(barcode, drug, MMEJ_NHEJ, efficiency, time, sum_reads, sum_bc_reads, MMEJ, NHEJ) %>% 
  mutate(barcode = gsub(".B", "", barcode)) %>%
  right_join(bc_IPR) %>%
  mutate(sum_reads = ave(sum_bc_reads, drug, time, FUN = sum),
         relative_reads = sum_bc_reads / sum_reads,
         other = 1-MMEJ-NHEJ)

Dec_NU_tib %>% 
  ggplot(., aes(time, relative_reads, group = IPR, color = chromatin)) + 
  geom_point() + 
  geom_line() + 
  facet_grid(drug ~ .)
  
Dec_NU_tib %>% filter(drug == "NU7441", time %in% c(120, 144)) %>% group_by(barcode, chromatin) %>% dplyr::count()


Dec_NU_tib %>% 
  ggplot(., aes(time, MMEJ_NHEJ, group = IPR, color = chromatin)) + 
  geom_quasirandom() + 
  facet_wrap(. ~ drug)

Dec_NU_tib %>% 
  ggplot(., aes(time, efficiency, group = IPR, color = chromatin)) + 
  geom_quasirandom() + 
  facet_grid(. ~ drug)



Dec_NU_tib %>% 
  ggplot(., aes(time, MMEJ, group = IPR, color = chromatin)) + 
  geom_quasirandom() + 
  facet_wrap(. ~ drug)


Dec_NU_tib %>% 
  ggplot(., aes(time, NHEJ, group = IPR, color = chromatin)) + 
  geom_quasirandom() + 
  facet_wrap(. ~ drug)


Dec_NU_tib %>% 
  ggplot(., aes(time, other, group = IPR, color = chromatin)) + 
  geom_quasirandom() + 
  facet_wrap(. ~ drug)
```

## 5C: Decitabine combined with NU7441
```{r 5E Dec NU7441 combination TIDE, fig.width = 8, fig.height = 4}
decitabine_nu7441_all <- read_csv("/DATA/usr/m.trauernicht/projects/EpiScreen/data/decitabine_synergy_indels.csv") %>%
  filter(mutation %in% seq(-12, 2))  %>% 
  mutate(mutation = factor(mutation, levels = seq(-12, 2)),
         pathway = case_when(mutation == -7 ~ "MMEJ",
                                       mutation == 1 ~ "NHEJ",
                                       mutation == 2 ~ "SSTR", 
                                       mutation == 0 ~ "TIF", 
                                       T ~ "other"),
         pathway = factor(pathway, levels = c("TIF", "NHEJ", "MMEJ", "SSTR", "other")),
         ssODN = case_when(grepl("ssODN", condition) ~ TRUE,
                           T ~ FALSE),
         condition = gsub("_ssODN", "", condition),
         condition = factor(condition, levels = c("DMSO", "NU7441", "Decitabine", "Decitabine_NU7441")),
         percentage = case_when(pathway == "TIF" ~ 100-percentage,
                                T ~ percentage)
  )
  

decitabine_nu7441_df = decitabine_nu7441_all %>%
  mutate(percentage_mean = ave(percentage, mutation, condition, ssODN, FUN = mean),
         percentage_sd = ave(percentage, mutation, condition, ssODN, FUN = sd)) %>%
  distinct(pathway, mutation, condition, 
           percentage_mean, percentage_sd, ssODN, rep) %>% 
  filter(ssODN, condition %in% c("DMSO", "Decitabine"))

decitabine_df = decitabine_nu7441_all %>%
  distinct(pathway, mutation, condition, percentage, ssODN, rep) %>% 
  filter(ssODN, condition %in% c("DMSO", "Decitabine"))

colors_DecNu = c(Decitabine = "#D69C81", 
                 NU7441 = "#779ed7", 
                 Decitabine_NU7441 = "grey50", 
                 DMSO = "grey70")

# Comparisons I care about
my_comparisons <- list(c("DMSO", "NU7441"),
                       c("DMSO", "Decitabine"),
                       c("DMSO", "Decitabine_NU7441"),
                       c("NU7441", "Decitabine_NU7441"),
                       c("Decitabine", "Decitabine_NU7441"))

for(i in unique(decitabine_nu7441_all$pathway)) {
stats_mean = decitabine_nu7441_all %>%
  filter(ssODN, pathway == i) %>%
compare_means(percentage~condition, data = ., method = "t.test")
print(i)
print(stats_mean)
}

ggplot(decitabine_nu7441_df, 
            aes(mutation, percentage_mean, group = condition, alpha = condition)) + 
  geom_bar(stat = "identity", 
           aes(fill = pathway), 
           position = position_dodge(width = 1)) + 
  geom_jitter(data = decitabine_df, 
              aes(mutation, percentage, fill = pathway, 
                  shape = factor(rep)), 
              position = position_dodge(width = 1)) + 
  scale_fill_manual("legend", values = colors_pathways) + 
  theme_pubr()
```
*Conclusion Figure 5C: Decitabine blocks resection-dependent repair.*


## 5D: Effect size of target group per chromatin group
```{r 5D MMEJFC per target, fig.width = 3, fig.height = 10}
chromatin_ipr <- chromatin %>%
  rownames_to_column("IPR")

balance.data.heatmap3 <- balance.data.heatmap2 %>%
  pivot_longer(cols = contains("IPR"), names_to = "IPR", values_to = "MMEJratio_FC")

#balance.data.heatmap3$target[!balance.data.heatmap3$target %in% c("HDAC", "Epigenetic Reader Domain")] <- "Rest"

chromatin_effect <- left_join(balance.data.heatmap3, chromatin_ipr) %>%
  filter(target %in% c("HDAC", "Epigenetic Reader Domain", "Aurora Kinase")) %>%
  filter(!drug %in% c("Barasertib")) %>%
  mutate(MMEJratio_FC = ave(MMEJratio_FC, drug, chromatin, conc_char, FUN = function(x) mean(x, na.rm = TRUE)),
         drug_conc = paste(drug, conc_char, sep = " ")) %>%
  distinct(MMEJratio_FC, drug, chromatin, conc_char, target, drug_conc)

ggplot(chromatin_effect,
       aes(x = chromatin, y = MMEJratio_FC, fill = chromatin)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.7) +
  geom_quasirandom(color = ifelse(chromatin_effect$drug_conc == "Vorinostat 1 µM", "red", "black")) +
  geom_signif(comparisons = combn(sort(unique(chromatin_effect$chromatin)), 2, simplify = F), 
              map_signif_level=sigFunc, 
              step_increase = 0.1) +
  theme_classic(base_size = 16) +
    geom_hline(yintercept = 0, linetype = 2) + 
  scale_fill_manual(values = group_colors) +
  theme(legend.position = "none") +
  facet_wrap(target ~ ., ncol = 1)
```

## Vorinostat & GSK

```{r 5F Validations vs screen in HDACi and EZH2i, fig.width=8, fig.height=4}
vorinostat_validation = indel.data.validation %>% 
  filter(replicate == "mean" & plasmid == "LBR2", drug %in% c("DMSO", "Vorinostat"), sum_bc_reads > 1000)%>% 
  dplyr::select(barcode, drug, MMEJ_NHEJ, efficiency, all_of(chromatin_cols)) %>%
  distinct() 

barcde_all_reps_vorino = vorinostat_validation %>% 
  distinct(barcode, drug) %>% 
  group_by(barcode) %>%
  summarise(bccount = n()) %>% 
  filter(bccount == 2) %>%
  pull(barcode)

vorinostat_ratios = vorinostat_validation  %>% 
  filter(barcode %in% barcde_all_reps_vorino) %>%
  pivot_wider(names_from = drug, values_from = c(efficiency, MMEJ_NHEJ)) %>%
  mutate(diff_TIF = efficiency_Vorinostat - efficiency_DMSO,
         ratio_TIF = efficiency_Vorinostat/efficiency_DMSO,
         log2_FC_TIF = log2(ratio_TIF),
         diff_MMEJ_NHEJ = MMEJ_NHEJ_Vorinostat - MMEJ_NHEJ_DMSO,
         ratio_MMEJ_NHEJ = MMEJ_NHEJ_Vorinostat/MMEJ_NHEJ_DMSO,
         log2_FC_MMEJ_NHEJ = log2(ratio_MMEJ_NHEJ),
         drug = "Vorinostat") 


valid_ratios_long = vorinostat_ratios %>% 
  dplyr::select(barcode, drug, all_of(chromatin.features.short.val), log2_FC_TIF, log2_FC_MMEJ_NHEJ) %>% 
  distinct() %>%
  pivot_longer(cols = chromatin.features.short.val, names_to = "feature", values_to = "zscore")

vorino_screen_K27 = indel.data %>% 
  filter((grepl("Vorinostat", drug) & conc_char == "1 µM")) %>% 
  distinct(drug, barcode, replicate, tech, freqCut_norm_mean, 
           H3K27me3,POL2, MMEJ_FC) %>%
  group_by(barcode, drug) %>% 
  summarise(log2_FC_TIF = log2(mean(freqCut_norm_mean)),
            log2_FC_MMEJ_NHEJ = log2(mean(MMEJ_FC, na.rm = TRUE)),
            H3K27me3 = mean(H3K27me3),
            POL2 = mean(POL2),
            source = "screen") %>%
  pivot_longer(cols = c("POL2", "H3K27me3"), names_to = "feature", values_to = "zscore") %>%
  mutate(drug = ifelse(grepl("Vorinostat", drug), "HDACi", "EZH2i"))

vorino_pool_K27 = valid_ratios_long%>% 
  filter(feature %in% c("H3K27me3" , "POL2"), 
         # barcode %in% barcode_set_match_clone
         # barcode %in% c(vorino_bc_85, gsk_bc_85)
         ) %>%
  mutate(source = "pool",
         drug = ifelse(grepl("Vorinostat", drug), "HDACi", "EZH2i"))

vorino_pool_K27_cloneset = valid_ratios_long %>% 
  filter(feature %in% c("H3K27me3" , "POL2"), barcode %in% paste0(unique(indel.data$barcode), ".B")) %>%
  mutate(source = "pool_clone",
         drug = ifelse(grepl("Vorinostat", drug), "HDACi", "EZH2i"))


vorino_k27 = bind_rows(vorino_screen_K27, vorino_pool_K27, vorino_pool_K27_cloneset)

# ggplot(vorino_k27, aes(zscore, log2_FC_MMEJ_NHEJ, color = source)) + 
#   geom_point() +
#   geom_smooth(method = "lm", se = F) +
#   stat_cor(method = "pearson") +
#   ggtitle("log2 FC Balance") +
#   stat_poly_eq(aes(label = paste(after_stat(eq.label),
#                                  after_stat(rr.label), sep = "*\", \"*")),
#                label.x = "left", label.y = "bottom") +
#   facet_grid(drug ~ feature) +
#   theme_bw(base_size = 16)

vorino_k27.plot <- vorino_k27 %>%
  mutate(source_2 = ifelse(source %in% c("pool_clone", "pool"), "1_pool", "0_screen")) %>%
  mutate(source = ifelse(source %in% c("pool_clone", "screen"), "screen", "pool"))

ggplot(vorino_k27.plot %>%
         filter(feature == "H3K27me3"), 
       aes(zscore, log2_FC_MMEJ_NHEJ, color = drug)) + 
  geom_point(aes(alpha = source))+
  geom_smooth(method = "lm", se = F) +
  stat_cor(method = "pearson") +
  ggtitle("log2 FC Balance") +
  stat_poly_eq(aes(label = paste(after_stat(eq.label),
                                 after_stat(rr.label), sep = "*\", \"*")),
               label.x = "left", label.y = "bottom") +
  facet_grid(.~source_2) +
  scale_alpha_discrete(range = c(0.2,1)) +
  scale_color_manual(values = c("HDACi" = "#60988D", "EZH2i" = "#FDCDAC"))
```


# Supplementary Figure 5


*Conclusion Figure S5B: Triple heterochromatin is unaltered from treatment, H3K27me3 domains are affected*

*Conclusion Figure S5B: H3K27me3 is the feature that correlates the most with reduction in MMEJ ratio upon Vorinostat treatment*


## S5A Boosting heatmap

```{r prep boosting heatmap}
top_10_MMEJ_hits = balance.data.heatmap %>% 
  distinct(drug_conc, MMEJ_log2_FC_mean) %>%
  arrange(desc((MMEJ_log2_FC_mean))) %>% 
  distinct(drug_conc) %>%
  dplyr::slice_head(n = 6)


#eff.data.heatmap2$freqCut_norm_mean[eff.data.heatmap2$mean_eff_zscore_comb > 0.05] <- NA
balance.data.heatmap2 <- balance.data.heatmap %>% 
  filter(drug_conc %in% top_10_MMEJ_hits$drug_conc) %>%
  dplyr::select(-min_score, -p_filter) %>%
  spread(IPR, MMEJ_log2_FC_mean) %>%
  filter(!is.nan(IPR3))

balance.data.heatmap2 <- balance.data.heatmap2[,c("drug", "target", "conc_char", iprs)]
balance.data.heatmap2$drug <- gsub(" [(].*[)]", "", balance.data.heatmap2$drug) #shorten name of drug


breaks <- summary(unlist(balance.data.heatmap2 %>% 
                            dplyr::select(contains('IPR'))), c(.001,.999), na.rm = T) # change these numbers according to where you want to set the cutoff
palette_length <- 50

breaks[1] = -0.5

myBreaks <- c(seq(breaks[1], 0, length.out=ceiling(palette_length/2) + 1),
              seq(-breaks[1]/palette_length, -breaks[1], length.out=floor(palette_length/2)))

# myBreaks <- c(seq(breaks[1], 0, length.out=ceiling(palette_length/2) + 1),
#               seq(breaks[2]/palette_length, breaks[2]+.5, length.out=floor(palette_length/2)))

# myBreaks <- c(seq(-0.5, 0, length.out=ceiling(palette_length/2) + 1), 
#               seq(0.5/palette_length, 0.5, length.out=floor(palette_length/2)))

ordered_marks2 <- balance.data.heatmap2 %>% 
  dplyr::select(target) %>%
  distinct() %>%
  arrange(target)

ordered_marks2 <- ordered_marks2$target

annotation_colors_scr_set = annotation_colors_scr
annotation_colors_scr_set$target <- annotation_colors_scr$target[ordered_marks2]

# Add cluster annotation
balance.data.heatmap2.clusters <- balance.data.heatmap2 %>% 
  as_tibble() %>%
  mutate(drug_conc = paste(drug, conc_char, sep = " "))


target_set_all <- target_set_drugs %>%
  rownames_to_column("drug_conc") %>%
  na.omit() %>%
  filter(drug_conc %in% balance.data.heatmap2.clusters$drug_conc)

rownames(target_set_all) <- target_set_all$drug_conc
target_all <- target_set_all %>%
  dplyr::select(target, viab)
```

```{r S5A MMEJ boosting FC heatmap, warning = FALSE, fig.width = 8, fig.height = 8}
# pdf(paste0(figure_out, "rs20220623_indelfrequency_heatmap_allconc.pdf"), width=20, height=8)
balance.data.matrix = balance.data.heatmap2.clusters %>%
  arrange(target_all) %>%
  column_to_rownames('drug_conc') %>%
  dplyr::select(contains('IPR'))

plt1 = pheatmap(balance.data.matrix[ , clone5_map_ipr$labels],
                cluster_cols = clone5_map_ipr,
                border_color = F,
                cellwidth = 8,
                cellheight = 8,
                breaks = myBreaks,
                clustering_distance_rows = "manhattan",
                cluster_rows = T,
                na_col = "white",
                main = 'MMEJ ratio FC (log2), only boosting',
                annotation_row = target_all,
                annotation_col = chromatin,
                color = colorRampPalette(c("#c0332b", "#E2E2E2", "#2d4284"))(palette_length),
                # color = diverge_hcl(palette_length, "Blue-Red"),
                annotation_colors = annotation_colors_scr_set, 
                annotation_legend = T)
```


## S5B: Cell cycle analysis
Aim: Show which drugs are affected by G2 arrest. 
```{r S5B Cell cycle FACS, fig.width = 8, fig.height = 6}
# rmarkdown::render("3_Processing_FACS.Rmd")
all.samples = read_csv2("/DATA/usr/m.trauernicht/projects/EpiScreen/FACS/Data/mt20220802_facs_all_drugs.csv")

drugs_tworeps = all.samples %>% filter(exp == "effective_drugs" & variable == "G2" & !is.na(value)) %>%
  mutate(drug_conc = paste(drug, conc, sep = " ")) %>% 
  group_by(drug_conc) %>% 
  count() %>% 
  filter(n > 1) %>% 
  pull(drug_conc)

  
exps.facs.G2 = all.samples %>% 
  mutate(drug_conc = paste(drug, conc, sep = " ")) %>% 
  filter(variable == "G2" & drug_conc %in% drugs_tworeps) %>% 
  distinct(drug_conc, value, rep)

exps.facs.G2 %>% t_test(., value ~ drug_conc, ref.group = "DMSO 10um", p.adjust.method = "BH") %>% filter(p.adj < 0.05)

exps.facs.G1 = all.samples %>%
mutate(drug_conc = paste(drug, conc, sep = " ")) %>% 
  filter(variable == "G1" & drug_conc %in% drugs_tworeps) %>% 
  distinct(drug_conc, value, rep)

exps.facs.G1 %>% t_test(., value ~ drug_conc, ref.group = "DMSO 10um", p.adjust.method = "BH") %>% filter(p.adj < 0.05)

exps.facs.S = all.samples %>%
mutate(drug_conc = paste(drug, conc, sep = " ")) %>% 
  filter(variable == "S" & drug_conc %in% drugs_tworeps) %>% 
  distinct(drug_conc, value, rep)

exps.facs.S %>% t_test(., value ~ drug_conc, ref.group = "DMSO 10um", p.adjust.method = "BH") %>% filter(p.adj < 0.05)

all.samples <- all.samples %>%
  mutate(drug_conc = paste(drug, conc, sep = " ")) %>%
  mutate(drug_conc_exp = paste(drug, conc, exp, sep = "_")) %>%
  mutate(mean_value = ave(value, drug_conc, variable, exp, FUN = mean)) %>%
  mutate(SD = ave(value, drug_conc, variable, exp, FUN = sd)) %>%
  #filter(exp == "five_drugs") %>%
  distinct(drug, conc, drug_conc_exp, variable, mean_value, SD, value, exp, drug_conc) %>%
  mutate(pval = "")


all.samples <- all.samples %>%
  dplyr::select(-value) %>%
  distinct()

vadj.G2 = all.samples %>% filter(variable %in% c("G2", "S", "G1")) %>% group_by(drug_conc_exp) %>% summarise(vadj = sum(mean_value)) %>% mutate(variable = "G2")
vadj.S = all.samples %>% filter(variable %in% c("S", "G1")) %>% group_by(drug_conc_exp) %>% summarise(vadj = sum(mean_value)) %>% mutate(variable = "S")
vadj.G1 = all.samples %>% filter(variable %in% c("G1")) %>% group_by(drug_conc_exp) %>% summarise(vadj = sum(mean_value)) %>% mutate(variable = "G1")

vadj.tib = rbind(vadj.G1, vadj.S, vadj.G2) %>% na.omit()
targets <- target_set_drugs %>% 
  distinct(drug, target) #%>%
  #filter(!target %in% c("Aurora Kinase", "JAK", "PARP", "PIM", "HIF"))

all.samples.plot = all.samples  %>%
  as_tibble() %>%
  filter(variable != "Apoptotic cells") %>%
  left_join(vadj.tib) %>%
  left_join(targets, by = "drug") %>%
  mutate(variable = factor(variable, levels = c("G2", "S", "G1")),
         target = ifelse(drug == "CX-6258", "PIM",
                         ifelse(drug == "DMSO", "Vehicle",
                                ifelse(drug == "DZNeP", "HMT",
                                       ifelse(drug == "Suramin", "Sirtuin",target))))) %>%
  na.omit()


#aurk.inhibitors <- c("Alisertib 100 nM", "Aurora A Inhibitor I 1 µM", "Barasertib 1 µM", "CYC116 1 µM", "SNS-314 Mesylate 10 µM")

g2_order <- all.samples.plot %>%
  filter(variable == "G2") %>%
  dplyr::select(drug_conc_exp, "g2_value" = mean_value) %>%
  distinct()

all.samples.plot <- merge(all.samples.plot, g2_order, all = T)

drugs_order <- all.samples.plot %>%
  distinct(drug_conc, g2_value) %>%
  filter(str_detect(drug_conc, "DMSO", negate = T)) %>%
  arrange(desc(g2_value))

all.samples.plot <- all.samples.plot %>% 
  filter(drug != "PAO") %>%
  mutate(drug_conc = factor(drug_conc, levels = c("DMSO 10um", drugs_order$drug_conc)))

ggplot(all.samples.plot %>%
         filter(exp == "effective_drugs"), aes(y = mean_value, x = drug_conc)) +
  geom_linerange(aes(ymin = vadj, ymax = vadj+SD, color = target), size = 1) +
  geom_bar(stat="identity", aes(alpha = variable, fill = target), size = .5, width = .75) +
  labs(title = "cell cycle arrest upon treatment with Aurora Kinase inhibitors") +
  scale_color_manual(values = annotation_colors_scr$target) +
  scale_fill_manual(values = annotation_colors_scr$target) +
  scale_alpha_discrete(range = c(0.3,1)) +
  theme_pubr(border = T, x.text.angle = 90)
```
*Conclusion Figure S4C: Mostly AURKi affect cell cycle, some other drugs (Azacitdine, NSC-3852) also do to a limited extent which might explain their MMEJ ratio reduction capacity.*

## S5C: Synergies
```{r Synergies chromatin prep, fig.width= 10, fig.height= 20}
file = list.files(in.dir, pattern = "CCD_table", full.names = T) %>% tail(n = 1)
CCD_tib <- readRDS(file)
file = list.files(in.dir, pattern = "CCD_vali", full.names = T) %>% tail(n = 1)
CCD_val_tib <- readRDS(file)
file = list.files(in.dir, pattern = "IPR_annotation_heatmap", full.names = T) %>% tail(n = 1)
chromatin_TIF <- readRDS(file)
file = list.files(in.dir, pattern = "compound_annotation_heatmap", full.names = T) %>% tail(n = 1)
target <- readRDS(file)
file = list.files(in.dir, pattern = "chrom_cluster_heatmap", full.names = T) %>% tail(n = 1)
TRIP_chrom_clust <- readRDS(file)
file = list.files(in.dir, pattern = "FC_ratios", full.names = T) %>% tail(n = 1)
ratios_tib_fc <- readRDS(file)

all_compounds_epistasis_bal = CCD_tib %>%
  #mutate(drug_conc = paste(drug, conc_char, sep = " ")) %>%
  dplyr::select(drug_conc, ratio_slope_plot, feature) %>%
  filter(!grepl("control", drug_conc)) %>% # remove the control sample of DNA-PK
  group_by(drug_conc) %>%
  mutate(onlyNA = sum(is.na(ratio_slope_plot))) %>% 
  filter(onlyNA != 25) %>%
  reshape2::dcast(drug_conc ~ feature, value.var = "ratio_slope_plot", fill = 0) %>% 
  column_to_rownames(var = "drug_conc")

target_ctrl = target %>% 
  dplyr::select(-conc_char, -bal_signif, -TIF_signif)
```


```{r heatmap clustering, fig.width= 10, fig.height= 20}
drugs_concs_tib = indel.data %>% distinct(drug, conc_char) %>% 
  mutate(drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " "))

clust_CCD = CCD_tib %>%
  dplyr::select(drug_conc, ratio_slope_plot, feature) %>% 
  left_join(drugs_concs_tib) %>%
  mutate(ratio_slope_plot = ifelse(ratio_slope_plot < 0, NA, ratio_slope_plot),
         ratio_slope_plot = ave(ratio_slope_plot, drug, feature, 
                                    FUN = function(x) mean(x, na.rm = TRUE))) %>% 
  distinct(ratio_slope_plot, feature, drug) %>%
  pivot_wider(values_from = ratio_slope_plot, names_from = drug) %>% 
  dplyr::select(where(~sum(!is.na(.x)) > 0 )) %>% 
  replace(is.na(.), 0) %>%
  column_to_rownames(var = "feature") %>%
  t() %>%
  dist(., method = "euclidean") %>%
  hclust(., method = "ward.D2")

drug_order_grouped = CCD_tib %>% 
  distinct(drug_conc) %>%
  left_join(drugs_concs_tib) %>%
  filter(drug %in% labels(clust_CCD)) %>%
  mutate(conc_char = factor(conc_char, levels = c("100 nM", "1 µM", "10 µM"))) %>%
  arrange(conc_char) %>%
  arrange(factor(drug, levels = labels(clust_CCD))) %>%
  filter(drug_conc %in% rownames(all_compounds_epistasis_bal)) %>%
  pull(drug_conc)
```

How many CCDs do we have in total?
```{r}
drug_conc_table = target_set_drugs %>% rownames_to_column(var = "drug_conc") %>% distinct(drug_conc, drug)

# CCDs for the TIF
CCD_tib %>% 
  filter(!grepl("DNA-PK", drug_conc)) %>%
  filter(!is.na(ratio_slope_plot)) %>% 
  left_join(drug_conc_table) %>% 
  distinct(drug_conc) %>% 
  nrow()

CCD_tib %>% 
  filter(!grepl("DNA-PK", drug_conc)) %>%
  filter(!is.na(ratio_slope_plot)) %>% 
  left_join(drug_conc_table) %>% 
  distinct(drug) %>% 
  nrow()
```

### Heatmaps
```{r S5C CCD heatmap, fig.width= 14, fig.height= 14}
# target_drugs = indel.data %>%
#   filter(!target %in% c("Aurora Kinase", "JAK", "PARP", "PIM", "HIF"), drug != "DNA-PKi") %>%
#   mutate(drug_conc = paste(drug, conc_char, sep = " ")) %>%
#   distinct(drug_conc)
#   

# Make matrix with drugs from selected target
bal_synergy_matrix = all_compounds_epistasis_bal #%>% 
  # rownames_to_column(var = "drug_conc") %>%
  # filter(drug_conc %in% target_set_all$drug_conc) %>%
  # column_to_rownames(var = "drug_conc")

cluster_rows = ifelse(nrow(bal_synergy_matrix) > 1, TRUE, FALSE)

# change these numbers according to where you want to set the cutoff
quant_breaks <- quantile(bal_synergy_matrix, c(.01,.99), na.rm = T) 
max_quant = max(abs(quant_breaks))
palette_length <- 100
breaks <- c(seq(-max_quant, 0, length.out=ceiling(palette_length/2) + 1), 
            seq(max_quant/palette_length, max_quant, length.out=floor(palette_length/2)))
slope.colors.temp = slope.colors
colors = colorRampPalette(slope.colors.temp %>% pull(color))(length(breaks))
#colors[which(quant_breaks == 0)-1] = "gray90"

p = pheatmap(bal_synergy_matrix[drug_order_grouped, TRIP_chrom_clust$labels],
             border_color = F,
             cellwidth = 8,
             cellheight = 8,
             cluster_rows = F,
             breaks = breaks,
             cluster_cols = TRIP_chrom_clust,
             annotation_row = target_set_drugs %>% dplyr::select(-drug),
             main = paste("Chromatin synergies - All effective drugs cluster"),
             color = colors,
             annotation_colors = annotation_colors_scr, 
             annotation_legend = T)

# bal_synergy_cluster <- bal_synergy_matrix %>%
#   rownames_to_column("drug_conc") %>%
#   left_join(cluster_HDAC) %>%
#   mutate(cluster_HDAC = as.character(cluster_HDAC))


```

```{r Fisher test CCD}
drug_conc_tib = indel.data %>% distinct(drug, conc_char, target) %>% mutate(drug = gsub(" [(].*[)]", "", drug),
                                                                            drug_conc = paste(drug, conc_char,sep = " "))

bal_hits = CCD_tib %>% filter(!is.na(ratio_slope_plot) & 
                                !grepl("DNA-PK", drug_conc) # remove DNA-PK from this count
                              ) %>% 
  left_join(drug_conc_tib) %>%
  distinct(drug_conc, target) %>% 
  group_by(target) %>%
  count() %>%
  rename(effect = n) %>%
  rbind(tibble(target = "other", effect = 0)) %>%
  arrange(target) %>%
  column_to_rownames(var = "target")

all_drugs = indel.data %>% filter(sample == "Epigenetic Compound") %>% 
  mutate(drug = gsub(" [(].*[)]", "", drug),
        drug_conc = paste(drug, conc_char, sep = " "),
        target = case_when(target %in% rownames(bal_hits) ~ target,
         T ~ "other")) %>%
  distinct(drug_conc, target) %>%
  group_by(target) %>%
  count() %>%
  rename(no_effect = n) %>%
  arrange(target) %>%
  column_to_rownames(var = "target")

all_drugs = all_drugs-bal_hits

cont_table = cbind(bal_hits,all_drugs) %>% as.matrix()
rownames(cont_table) = c("AurK", "DNMT", "ERD", "HDAC","HDM", "HMT", "JAK", "other", "PARP", "PIM", "Sirtuin")

xtab_effect = as.table(cont_table)

dimnames(xtab_effect) <- list(
  Groups = rownames(xtab_effect),
  Effect = c("Yes", "No")
)

# Compare the proportion of males and females in each category
row_wise_fisher_test(xtab_effect, p.adjust.method = "BH")
```

```{r, fig.width= 12, fig.height= 6, eval=F}
# Highligh top 4 strongest hits + and - bal. In the end we kept only LMNB1, but let's keep this code for flexibility.
ratios_tib_fc %>% 
  filter(drug_conc == "Belinostat 100 nM" |
           drug_conc == "PCI-24781 100 nM"
  )  %>% 
  ggplot(.,aes(H3K4me1, log2.fc.ratio)) + geom_point() +
  geom_smooth(method = "lm", se = F) +
  stat_cor(method = "pearson") +
  stat_poly_eq(aes(label = paste(after_stat(eq.label),
                                 after_stat(rr.label), sep = "*\", \"*")),
               label.x = "left", label.y = "bottom") +
  geom_vline(xintercept = 0, linetype = 2) + 
  geom_hline(yintercept = 0, linetype = 2) + 
  facet_wrap(. ~ drug_conc) +
  theme_classic(base_size = 16) 
```


## S5D K27me3 top CCDs
```{r S5D strongest effect in H3K27me3, fig.width= 6, fig.height= 6}
rank_dt = CCD_tib %>% 
  left_join(rownames_to_column(target, var = "drug_conc")) %>%
  #filter(!target %in% c("Aurora Kinase", "JAK", "PARP", "PIM", "HIF")) %>%
  filter(feature == "H3K27me3", !is.na(ratio_slope_plot)) %>%
  distinct(drug_conc, ratio_slope_plot, target, viab) %>%
  arrange(ratio_slope_plot) %>%
  mutate(rank = seq(1:n()))

maxrank = nrow(rank_dt)

p1 = rank_dt %>% 
  ggplot(., aes(x = rank, fill = target)) +
  geom_bar() + 
  scale_x_reverse() +
  coord_flip() +
  xlab("Rank") +
theme_classic2(base_size = 16) +
  scale_fill_manual(values = colors_targets) +
  # geom_label(aes(label = ifelse(width == 2, drug_conc,''))) +
  theme(legend.position = "none",
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
  # add horizontal line for 0.01 slope cutoff which is highlighted in the heatmap
  geom_vline(xintercept = rank_dt[rank_dt$ratio_slope_plot  < -0.01, ]$rank[1] - 0.5)  +
  geom_vline(xintercept = max(rank_dt[rank_dt$ratio_slope_plot  > 0.01, ]$rank) + 0.5)



p2 = rank_dt %>% 
  filter(!between(rank, 25, maxrank-0)) %>%
  mutate(rank = seq(1:n())) %>% 
  ggplot(., aes(x = rank, y = ratio_slope_plot, fill = target)) +
  geom_bar(stat = "identity") + 
  scale_x_reverse() +
  coord_flip() +
  ylab("Synergy score") +
theme_classic2(base_size = 16) +
  scale_fill_manual(values = colors_targets) +
  # geom_label(aes(label = ifelse(width == 2, drug_conc,''))) +
  geom_text(aes(label=drug_conc)) +
  theme(legend.position = "none",
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())


plot_grid(p1, p2, labels = c("E", "F"), rel_widths = c(1, 5))

# Samples to highlight in the heatmap S3C
all_compounds_epistasis_bal %>% 
  filter(!between(H3K27me3, -0.01, .01)) %>%
  rownames()
```

## S5x: HDACi only heatmap
```{r HDACi only, fig.width = 10, fig.height = 10, eval = F}
HDAC_tib = read.table("rs20220708_HDAC_targets.txt", sep = "\t", fill = NA, header = T) %>%
  dplyr::select(-target_main, -target_second) %>%
  as_tibble()

# cluster1 = target_all %>% filter(target == "HDAC") %>% rownames()
# cluster1 = cluster1[!grepl("Nullscript", cluster1)]
# 
# top_50_hits_hdacs <- top_50_hits %>%
#   mutate(drug_conc = paste(drug, conc_char, sep = " "))

balance.data.heatmap.HDAC = balance.data.heatmap %>% 
  mutate(drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " ")) %>% 
  filter(target == "HDAC")  %>% 
  dplyr::select(-min_score) %>%
  spread(IPR, MMEJ_log2_FC_mean)

eff.data.heatmap.cluster1 = balance.data.heatmap.HDAC %>% 
  dplyr::select(-drug, -conc_char, -target) %>% column_to_rownames(var = "drug_conc")

  # filter(drug_conc %in% cluster1) %>%
  # filter(drug_conc %in% top_50_hits_hdacs$drug_conc) 

target.cluster1 <- target_set_drugs %>%
  filter(target == "HDAC") %>%
  rownames_to_column("drug_conc") %>%
  left_join(HDAC_tib) %>%
  select_if(~sum(!is.na(.)) > 0) %>%
  replace(is.na(.), 0) %>% 
  dplyr::select(-drug, -target) %>%
  column_to_rownames("drug_conc")

target.cluster1

HDAC_matrix = eff.data.heatmap.cluster1 %>%
  t()

breaks <- quantile(unlist(balance.data.heatmap.HDAC %>% 
                            dplyr::select(contains('IPR'))), c(.01,.99), na.rm = T) # change these numbers according to where you want to set the cutoff

max_break = max(abs(breaks))

palette_length <- 100

myBreaks <- c(seq(-max_break, 0, length.out=ceiling(palette_length/2) + 1), 
              seq(max_break/palette_length, max_break, length.out=floor(palette_length/2)))


# pdf(paste0(figure_out, "rs20220623_indelfrequency_heatmap_HDAC.pdf"), width=16, height=8)
plt3 = pheatmap(HDAC_matrix[clone5_map_ipr$labels,],
                border_color = F,
                cellwidth = 8,
                cellheight = 8,
                breaks = myBreaks,
                cluster_rows = clone5_map_ipr,
                cluster_cols = T,
                angle_col = 90,
                na_col = "white",
                clustering_method = "ward.D",
                main = 'MMEJ ratio FC (log2), all concentrations',
                annotation_col = target.cluster1,
                annotation_row = chromatin,
                color = colorRampPalette(c("#c0332b", "#E2E2E2", "#2d4284"))(palette_length),
                annotation_colors = annotation_colors_scr,
                annotation_legend = T)
```





```{r top CCDs for all chromatin features, fig.width= 6, fig.height= 6, eval = FALSE}
for(i in unique(CCD_tib$feature)) {
  rank_dt = CCD_tib %>% 
    left_join(rownames_to_column(target, var = "drug_conc"), by = "drug_conc") %>%
    #filter(!target %in% c("Aurora Kinase", "JAK", "PARP", "PIM", "HIF")) %>%
    filter(feature == i, !is.na(ratio_slope_plot)) %>%
    distinct(drug_conc, ratio_slope_plot, target, viab, feature) %>%
    arrange(desc(ratio_slope_plot)) %>%
    mutate(rank = seq(1:n()))
  
  if(nrow(rank_dt) > 1) {
    rank_dt <- rank_dt %>%
      mutate(rank = seq(1:n()))
    
    maxrank = nrow(rank_dt)
    
    p1 = rank_dt %>% 
      ggplot(., aes(x = rank, fill = target)) +
      geom_bar() + 
      scale_x_reverse() +
      coord_flip() +
      xlab("Rank") +
      theme_classic2(base_size = 16) +
      scale_fill_manual(values = colors_targets) +
      # geom_label(aes(label = ifelse(width == 2, drug_conc,''))) +
      theme(legend.position = "none",
            axis.title.x=element_blank(),
            axis.text.x=element_blank(),
            axis.ticks.x=element_blank())+
      # add horizontal line for 0.01 slope cutoff which is highlighted in the heatmap
      geom_vline(xintercept = rank_dt[rank_dt$ratio_slope_plot  < -0.01, ]$rank[1] - 0.5)  +
      geom_vline(xintercept = max(rank_dt[rank_dt$ratio_slope_plot  > 0.01, ]$rank) + 0.5)
    
    
    p2 = rank_dt %>% 
      filter(!between(rank, 15, maxrank-15)) %>%
      mutate(rank = seq(1:n())) %>% 
      ggplot(., aes(x = rank, y = ratio_slope_plot, fill = target)) +
      geom_bar(stat = "identity") + 
      scale_x_reverse() +
      coord_flip() +
      ylab("Synergy score") +
      theme_classic2(base_size = 16) +
      scale_fill_manual(values = colors_targets) +
      # geom_label(aes(label = ifelse(width == 2, drug_conc,''))) +
      geom_text(aes(label=drug_conc)) +
      theme(legend.position = "none",
            axis.title.y=element_blank(),
            axis.text.y=element_blank(),
            axis.ticks.y=element_blank()) +
      ggtitle(paste0("Top synergies with: ", i))
    
    
    p = plot_grid(p1, p2, labels = c("E", "F"), rel_widths = c(1, 5))
    print(p)
  }
}
```


## S5E Vorinostat MMEJ FC correlation with chromatin features
Aim: Show that H3K27me3 is the strongest correlating factor. 
```{r S5E Vorino bal FC Correlations, fig.width = 6, fig.height = 8}
## Vorinostat
chrom.mods.cols <- seq(grep("CTCF", names(vorinostat_ratios)), grep("H3K27me3_domain", names(vorinostat_ratios))-1)

vorinostat.hist.corr <- CorrelationDFMean(vorinostat_ratios, "log2_FC_MMEJ_NHEJ", targets = chrom.mods.cols) %>%
  arrange(corr) %>% pull(rowname) %>% factor(.,levels = .)

lims = 1

CorrelationPlotMean(vorinostat_ratios, "log2_FC_MMEJ_NHEJ", targets = vorinostat.hist.corr, title = "with log2 FC bal after Vorinostat treatment")
```

## 5x CCD Pool
```{r S5x CCD pool filtered, fig.height= 6, fig.width= 8, eval = FALSE}
# Load pool data
validation_epistasis_bal <- CCD_val_tib %>%
  dplyr::select(drug, ratio_slope_plot, feature) %>%
  group_by(drug) %>%
  mutate(onlyNA = sum(is.na(ratio_slope_plot))) %>% 
  filter(onlyNA != 25) %>%
  reshape2::dcast(drug ~ feature, value.var = "ratio_slope_plot", fill = 0) %>% 
  column_to_rownames(var = "drug")

all_compounds_epistasis_bal_HDM = CCD_tib %>%
  #mutate(drug_conc = paste(drug, conc_char, sep = " ")) %>%
  dplyr::select(drug_conc, ratio_slope_plot, feature) %>%
  filter(grepl("Vorinostat|EPZ-6438|3-Deazaneplanocin", drug_conc)) %>%
  group_by(drug_conc) %>%
  mutate(onlyNA = sum(is.na(ratio_slope_plot))) %>% 
  filter(onlyNA != 25 & feature != "H3K9me3") %>%
  reshape2::dcast(drug_conc ~ feature, value.var = "ratio_slope_plot", fill = 0) %>% 
  column_to_rownames(var = "drug_conc")

validation_epistasis_bal <- rbind(validation_epistasis_bal, all_compounds_epistasis_bal_HDM)

quant_breaks <- quantile(validation_epistasis_bal, c(.01,.99), na.rm = T)
palette_length <- 100
breaks.validation <- c(seq(quant_breaks[1], 0, length.out=ceiling(palette_length/2) + 1), 
            seq(-quant_breaks[1]/palette_length, -quant_breaks[1], length.out=floor(palette_length/2)))
colors.validations = colorRampPalette(slope.colors %>% pull(color))(length(breaks.validation))
#colors.validations[which(quant_breaks == 0)-1] = "gray90"

order_chrom = TRIP_chrom_clust$labels
order_chrom = order_chrom[!grepl("H3K9me3", order_chrom)]


pheatmap(validation_epistasis_bal[ , order_chrom],
             border_color = F,
             cellwidth = 8,
             cellheight = 8,
             breaks = breaks.validation,
             clustering_distance_rows = "correlation",
             main = paste("Chromatin synergies - Balance"),
             color = colors.validations,
             annotation_legend = T)
```




# Session Info
```{r}
paste("Run time: ",format(Sys.time()-StartTime))
getwd()
date()
sessionInfo()
```

