---
title: "EpiScreen: Exploring other HDACs"
author: 
  - name: "Ruben Schep"
    email: "r.schep@nki.nl"
    affiliation: "Netherlands Cancer Institute"
date: '`r format(Sys.time(), "%d/%m/%Y")`'
output: 
  html_document:
    theme: united
    highlight: pygments
    fig_caption: yes
    code_folding: hide
    df_print: kable
    toc: true
    toc_depth: 4
    toc_float:
      collapsed: false
  pdf_document:
    toc: yes
    toc_depth: '4'
---

*knitr document van Steensel lab*


# Introduction
We see that many HDACs affect the TIF, here we want to see what's up with the HDAC's that have no effect.

# Setup {.tabset}

<!-- little HTML script to do indentation of the table of contents -->
<script>
$(document).ready(function() {
$items = $('div#TOC li');
$items.each(function(idx) {
num_ul = $(this).parentsUntil('#TOC').length;
$(this).css({'text-indent': num_ul * 10, 'padding-left': 0});
});
});
</script>

```{css, echo = FALSE}
div.sourceCode {
overflow-x: hidden;
}
```

## Libraries
```{r setup}
knitr::opts_chunk$set(echo = TRUE)
pdf.options(useDingbats = FALSE)
StartTime <-Sys.time()

# 8-digit Date tag:
Date <- substr(gsub("-","",Sys.time()),1,8)
```



```{r libraries, warning=FALSE}
# libraries:
library(tidyverse)
# library(outliers)
library(ggplot2)
# library(ggbeeswarm)
# library(data.table)
# library(ggrepel)
# library(GGally)
# library(gghighlight)
# library(ggpubr)
library(pheatmap)
# library(RColorBrewer)
# library(ggrastr)
# library(rstatix)
# library(cowplot)
library(colorspace)
# library(MASS)
library(magrittr)
library(onewaytests)
```


```{r directories}
## Select outdir
out.dir = paste0("./figures/", Date, "/")

dir.create(out.dir)
in.dir = list.dirs(path = "/DATA/projects/DSBrepair/data/R") %>% .[grepl("episcreen", .)] %>% tail(n = 1)
knitr::opts_chunk$set(dev=c('png', 'pdf'), fig.path = file.path(out.dir))
pdf.options(useDingbats = FALSE)
```


## Custom functions
```{r functions}
p.adjust <- function(p, method = p.adjust.methods, n = length(p))
{
  ## Methods 'Hommel', 'BH', 'BY' and speed improvements
  ## contributed by Gordon Smyth
  method <- match.arg(method)
  if(method == "fdr") method <- "BH"	# back compatibility
  nm <- names(p)
  p <- as.numeric(p)
  p0 <- setNames(p, nm)
  if(all(nna <- !is.na(p))) nna <- TRUE
  p <- p[nna]
  lp <- length(p)
  # stopifnot(n >= lp)
  if (n <= 1) return(p0)
  if (n == 2 && method == "hommel") method <- "hochberg"
  
  p0[nna] <-
    switch(method,
           bonferroni = pmin(1, n * p),
           holm = {
             i <- seq_len(lp)
             o <- order(p)
             ro <- order(o)
             pmin(1, cummax( (n - i + 1L) * p[o] ))[ro]
           },
           hommel = { ## needs n-1 >= 2 in for() below
             if(n > lp) p <- c(p, rep.int(1, n-lp))
             i <- seq_len(n)
             o <- order(p)
             p <- p[o]
             ro <- order(o)
             q <- pa <- rep.int( min(n*p/i), n)
             for (j in (n-1):2) {
               ij <- seq_len(n-j+1)
               i2 <- (n-j+2):n
               q1 <- min(j*p[i2]/(2:j))
               q[ij] <- pmin(j*p[ij], q1)
               q[i2] <- q[n-j+1]
               pa <- pmax(pa,q)
             }
             pmax(pa,p)[if(lp < n) ro[1:lp] else ro]
           },
           hochberg = {
             i <- lp:1L
             o <- order(p, decreasing = TRUE)
             ro <- order(o)
             pmin(1, cummin( (n - i + 1L) * p[o] ))[ro]
           },
           BH = {
             i <- lp:1L
             o <- order(p, decreasing = TRUE)
             ro <- order(o)
             pmin(1, cummin( n / i * p[o] ))[ro]
           },
           BY = {
             i <- lp:1L
             o <- order(p, decreasing = TRUE)
             ro <- order(o)
             q <- sum(1L/(1L:n))
             pmin(1, cummin(q * n / i * p[o]))[ro]
           },
           none = p)
  p0
}
```

# Data import
```{r data import, warning=FALSE}
# Import data from preprocessing script
file = list.files(in.dir, pattern = "episcreen_ratios", full.names = T) %>% tail(n = 1)
indel.data <- readRDS(file)

HDAC_tib = read.table("rs20220708_HDAC_targets.txt", sep = "\t", fill = NA, header = T) %>%
  dplyr::select(-target_main, -target_second) %>%
  as_tibble()

viab_colors = sequential_hcl(11, "Peach", rev = TRUE)
names(viab_colors) = seq(0, 1, by = 0.1)

annotation_colors_scr = list(
  chromatin = group_colors,
  target = c(HDAC="#60988D", HAT="#C6D0A8", Sirtuin="#8FCAAC",
             HMT="#FDCDAC", DNMT="#D69C81", `Histone Demethylase`="#FFF2AE",
             HIF="#E3DCD5", JAK="#C8D7E2", PIM="#9AB8C4", `Aurora Kinase`="#F4CAE4",
             PARP="#CB546F", `Epigenetic Reader Domain`= "#476D61", `DNA-PK`="#779ed7"),
  clusters_drugs = sequential_hcl(7, "Plasma"),
  # viab_rep1 = c('#ffeee9', '#ffdcd4', '#ffcbbe', '#ffb8a8', '#fda693', '#f9947e', '#f4826a', '#ef6f56', '#e95b43', '#e24530'),
  # viab_rep2 = c('#ffeee9', '#ffdcd4', '#ffcbbe', '#ffb8a8', '#fda693', '#f9947e', '#f4826a', '#ef6f56', '#e95b43', '#e24530'),
  viab = viab_colors,
  ctrl_TIF = colorRampPalette(c("white", "black"))(10))

# Order the annotation legend
ordered_marks <- c("Euchromatin", 
                   "H3K27me3", 
                   "other-heterochromatin",  
                   "Triple Heterochromatin")

annotation_colors_scr$chromatin <- annotation_colors_scr$chromatin[ordered_marks]
```

## Processing
```{r data processing, warning=FALSE}
drug_conc_table = indel.data %>%
  distinct(drug, conc_char, target) %>%
  mutate(drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " "))

HDACs = indel.data %>% 
  distinct(drug, conc_char, target) %>%
  mutate(drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " ")) %>% 
  filter(target == "HDAC" & drug != "Nullscript") %>% 
  pull(drug_conc)

viab_drug = indel.data %>% filter(drug != "PAO") %>% 
  mutate(drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " ")) %>% 
  distinct(viab_mean, drug_conc, replicate) %>% 
  group_by(drug_conc) %>%
  summarise(viab = mean(viab_mean))

target_set_drugs <- indel.data %>% 
  filter(!target %in% c("Negative Control", "MRN", "DNA-PK")) %>%
  mutate(drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " ")) %>%
  left_join(viab_drug) %>%
  distinct(drug, drug_conc, conc_char, target, viab) %>% 
  column_to_rownames(var="drug_conc")

target.HDAC <- target_set_drugs %>%
  rownames_to_column("drug_conc") %>%
  left_join(HDAC_tib) %>%
  filter(drug_conc %in% HDACs) %>%
  replace(is.na(.), 0)

rownames(target.HDAC) <- target.HDAC$drug_conc
target.HDAC <- target.HDAC %>%
  dplyr::select(pan_HDAC, HDAC1,HDAC2, HDAC3,
                HDAC4, HDAC5, HDAC6,HDAC7, HDAC8, HDAC9,  HDAC10, other_human, non_human, viab)
```

---

# Plotting

## 2D: Heatmap of TIF differences {.tabset}

### Prepare the annotations
This is reused later in the script.
```{r heatmap annotation}
# Order IPRs by their starting freqCut value
dmso_freq <- indel.data %>%
  filter(drug == "DMSO") %>%
  distinct(IPR, freqCut) %>%
  mutate(freqCut = ave(freqCut, IPR, FUN = function(x) mean(x, na.rm = TRUE))*100) %>%
  dplyr::select('ctrl_TIF' = freqCut, IPR) %>%
  distinct() %>%
  arrange(desc(ctrl_TIF))

iprs <- dmso_freq$IPR
iprs <- as.character(iprs)


# Set annotation for heatmap
# viability
viab_drug = indel.data %>% filter(drug != "PAO") %>% 
  mutate(drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " ")) %>% 
  distinct(viab_mean, drug_conc, replicate) %>% 
  group_by(drug_conc) %>%
  summarise(viab = mean(viab_mean))
# Row annotation: annotate drugs with the target group
target_set_drugs <- indel.data %>% 
  filter(!target %in% c("Negative Control", "MRN", "DNA-PK")) %>%
  mutate(drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " ")) %>%
  left_join(viab_drug) %>%
  distinct(drug, drug_conc, conc_char, target, viab) %>% 
  column_to_rownames(var="drug_conc")

ctrl.vals <- indel.data %>%
  filter(drug == "DMSO") %>%
  distinct(IPR, freqCut, MMEJratio) %>%
  mutate(ctrl_TIF = ave(freqCut, IPR, FUN = function(x) mean(x, na.rm = TRUE))*100,
         ctrl_balance = ave(MMEJratio, IPR, FUN = function(x) mean(x, na.rm = TRUE))*100) %>%
  distinct(ctrl_TIF, 
           ctrl_balance,
           IPR)

clone5.matrix = indel.data %>% 
  dplyr::select(IPR, ends_with(".zscore")) %>% 
  distinct() %>% 
  rename_with(., ~gsub(".zscore", "", .x)) %>%
  # left_join(ctrl.vals) %>%
  column_to_rownames(var="IPR")

clone5_map_ipr = hclust(dist(clone5.matrix), method = "ward.D") %>% 
  # Rotate the middle node to math better the TIF in CTRL conditions
  dendextend::rotate(c(1:6, 10:7, 11:18))

# Chromatin annotation
chromatin <- readRDS(
  "/DATA/usr/x.vergara/XV_ChIPIndels/XV20200902_DDR_RS_revision/XV20200902_DDR_RS_revision/data/xv20200915_DDR_data_CHIP.rds") %>% 
  distinct(barcode, chromatin) %>%
  left_join(distinct(indel.data, barcode, IPR)) %>%
  left_join(dmso_freq)

# chromatin$IPR[is.na(chromatin$IPR)] <- "IPR1"
chromatin <- chromatin %>%
  filter(IPR != "<NA>") %>% 
  dplyr::select(-barcode) %>%
  column_to_rownames(var="IPR")

## Chromatin groups
group_colors = c("Euchromatin" = "#f7941d",
                 "other-heterochromatin" = "#838687",
                 "Triple Heterochromatin" = "#662d91",
                 "H3K27me3" = "#d21f8a")


viab_colors = sequential_hcl(11, "Peach", rev = TRUE)
names(viab_colors) = seq(0, 1, by = 0.1)

annotation_colors_scr = list(
  chromatin = group_colors,
  target = c(HDAC="#60988D", HAT="#C6D0A8", Sirtuin="#8FCAAC",
             HMT="#FDCDAC", DNMT="#D69C81", `Histone Demethylase`="#FFF2AE",
             HIF="#E3DCD5", JAK="#C8D7E2", PIM="#9AB8C4", `Aurora Kinase`="#F4CAE4",
             PARP="#CB546F", `Epigenetic Reader Domain`= "#476D61", `DNA-PK`="#779ed7"),
  p.adj.Welch = c(n.s. = "#F9F9F9", `p < 0.01` = "#0066A5"),
  clusters_drugs = sequential_hcl(4, "Greens"),
  # viab_rep1 = c('#ffeee9', '#ffdcd4', '#ffcbbe', '#ffb8a8', '#fda693', '#f9947e', '#f4826a', '#ef6f56', '#e95b43', '#e24530'),
  # viab_rep2 = c('#ffeee9', '#ffdcd4', '#ffcbbe', '#ffb8a8', '#fda693', '#f9947e', '#f4826a', '#ef6f56', '#e95b43', '#e24530'),
  viab = viab_colors,
  ctrl_TIF = colorRampPalette(c("white", "black"))(10))

# Order the annotation legend
ordered_marks <- c("Euchromatin", 
                   "H3K27me3", 
                   "other-heterochromatin",  
                   "Triple Heterochromatin")

annotation_colors_scr$chromatin <- annotation_colors_scr$chromatin[ordered_marks]
```

### Prepare the data
```{r prepare data for heatmaps}
# Generate heatmap: select top drugs (highest change at any IPR) per concentration
eff.data <- indel.data %>%
  #filter(target != "Aurora Kinase") %>%
  filter(target == "HDAC", indel_freq_filter, viab_reproducibility) %>%
  distinct(conc_char, drug, target, IPR, zscore_TIF_comb_rep, freqCut_diff_mean, replicate, tech, filter_zscore_TIF_comb_rep)

mean_data_drug = indel.data %>%
  #filter(target != "Aurora Kinase") %>%
  filter(target == "HDAC", indel_freq_filter, viab_reproducibility) %>%
  distinct(conc_char, drug, target, IPR, zscore_TIF_comb_rep, freqCut_diff_mean, filter_zscore_TIF_comb_rep) %>%
  mutate(mean_eff_drug = ave(freqCut_diff_mean, drug, IPR, FUN = mean),
         drug = gsub(" [(].*[)]", "", drug)) %>%
  distinct(mean_eff_drug, drug, IPR) %>% 
  pivot_wider(names_from = IPR, values_from = mean_eff_drug) %>%
  column_to_rownames(var = "drug")

eff.clustering.dist = dist(mean_data_drug, method = "manhattan")

eff.clustering.clust = hclust(eff.clustering.dist, method = "ward.D2")

eff.data.heatmap <- eff.data %>%
  group_by(drug, conc_char) %>%
  # ave to add IPR grouping level to calculate mean of the replicates
  mutate(drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " "),
         freqCut_diff_mean = ave((freqCut_diff_mean*100), IPR, FUN = function(x) mean(x, na.rm = TRUE)),
  ## Select drugs that have a large effect size in at least one location 
         ## (some drugs might have a small global effect size, but large local)
         zscore_TIF_comb_rep_temp = ifelse(filter_zscore_TIF_comb_rep, zscore_TIF_comb_rep, 0)) %>%
  ungroup() %>%
  mutate(p_value = 2*pnorm(q = abs(zscore_TIF_comb_rep_temp), lower.tail = F),
         # Adjust p value for false discovery rate
         adj_pvalue = p.adjust(p_value, method = 'BH')) %>%
         # Pick the smallest per compound & concentration
  group_by(drug_conc) %>%
         mutate(min_score = min(adj_pvalue)) %>%
  # filter for adjusted p.val < 0.01 so we keep compounds with at least one signif effect.
  # filter(min_score < 0.01) %>%
  ungroup() %>%
  distinct(drug_conc, drug, conc_char, target, freqCut_diff_mean, IPR, min_score)

drug_order_grouped = eff.data.heatmap %>% distinct(drug, conc_char, drug_conc) %>%
  mutate(conc_char = factor(conc_char, levels = c("100 nM", "1 µM", "10 µM"))) %>%
  arrange(conc_char) %>%
  arrange(factor(drug, levels = labels(eff.clustering.clust))) %>%
  pull(drug_conc)

eff.clustering = eff.data.heatmap %>%
  dplyr::select(-min_score, -target) %>%
  spread(IPR, freqCut_diff_mean) %>%
  column_to_rownames(var = "drug_conc")

# List samples with significant effect in IPR to gray them out in the plot.
pvals_drug_conc = indel.data %>%
  mutate(drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " ")) %>%
  distinct(drug_conc, IPR, zscore_TIF_comb_rep, filter_zscore_TIF_comb_rep) %>%
   group_by(drug_conc) %>%
  mutate(zscore_TIF_comb_rep_temp = ifelse(filter_zscore_TIF_comb_rep, zscore_TIF_comb_rep, 0),
         p_value = 2*pnorm(q = abs(zscore_TIF_comb_rep_temp), lower.tail = F)) %>%
  filter(!is.na(zscore_TIF_comb_rep)) %>%
  mutate(adj_pvalue = p.adjust(p_value, method = 'BH'),
         p_filter = ifelse(adj_pvalue < 0.01 & filter_zscore_TIF_comb_rep, TRUE, FALSE)) %>%
  filter(filter_zscore_TIF_comb_rep) %>%
  distinct(drug_conc, IPR, p_filter)

eff.data.heatmap2 = eff.data.heatmap %>% left_join(pvals_drug_conc) %>%
  mutate(p_filter = replace_na(p_filter, FALSE),
         # This changes the samples that are not significant to 0.
         # freqCut_diff_mean = ifelse(p_filter, freqCut_diff_mean, 0) 
         ) %>%
  dplyr::select(-min_score, -p_filter, -target) %>% 
  spread(IPR, freqCut_diff_mean) %>%
  column_to_rownames(var = "drug_conc")

kinase_andco_targets = c("PIM", "Aurora Kinase", "JAK", "HIF", "PARP", "HIF", "Epigenetic Reader Domain")
chromatin_targets = c("HDAC", "HAT", "Sirtuin", "HMT",  "DNMT", "Histone Demethylase")

# Number of individual drugs (Same piece of code as above)
number_drugs = eff.data %>%
  group_by(drug, conc_char) %>%
  mutate(freqCut_diff_mean = ave((freqCut_diff_mean*100), IPR, FUN = function(x) mean(x, na.rm = TRUE)),
         zscore_TIF_comb_rep_temp = ifelse(filter_zscore_TIF_comb_rep, zscore_TIF_comb_rep, 0)) %>%
  ungroup() %>%
  mutate(p_value = 2*pnorm(q = abs(zscore_TIF_comb_rep_temp), lower.tail = F),
         adj_pvalue = p.adjust(p_value, method = 'BH')) %>% 
  # Add filtering for significant increases
  filter(adj_pvalue < 0.01 & zscore_TIF_comb_rep_temp > 1) %>% 
  # unique the drugs
  distinct(drug) %>% 
  # count the rows
  nrow()
# Statement
paste(number_drugs, "of the 160 epigenetic compounds significantly boost the TIF in at least one IPR")


breaks <- quantile(unlist(eff.data.heatmap2 %>% 
                            dplyr::select(contains('IPR'))), c(.01,.99), na.rm = T) # change these numbers according to where you want to set the cutoff
palette_length <- 100

myBreaks <- c(seq(breaks[1], 0, length.out=ceiling(palette_length/2) + 1), 
              seq(breaks[2]/palette_length, breaks[2], length.out=floor(palette_length/2)))

ordered_marks2 <- eff.data.heatmap %>% 
  dplyr::select(target) %>%
  distinct() %>%
  arrange(target) %>% pull(target)

annotation_colors_scr_set = annotation_colors_scr

annotation_colors_scr_set$target <- annotation_colors_scr_set$target[ordered_marks2]

dplyr::select(eff.data.heatmap2, contains('IPR')) %>% summary()
```

### Welch's test and Fisher test on chromatin sensitive drugs
```{r}
sample_set = eff.data.heatmap %>%
  pull(drug_conc) %>% 
  unique()

freqCut_diff_tib = indel.data %>% 
  mutate(drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " ")) %>% 
  filter(drug_conc %in% sample_set) %>%
  distinct(drug_conc, IPR, freqCut_diff, tech, replicate)

welch_tib = map_dfr(sample_set, function(x) {
  tibble("drug_conc" = x,
         "welch.p" = welch.test(freqCut_diff ~ IPR, data = filter(freqCut_diff_tib, drug_conc == x), alpha = 0.01, verbose = F)$p.value)
         }
  )

welch_tib %<>%
  left_join(drug_conc_table) %>%
  mutate(p.adj = p.adjust(welch.p, method = "BH"),
          p.adj.Welch = ifelse(p.adj < 0.01, "p < 0.01", "n.s."))

table(welch_tib$p.adj.signif)

paste(nrow(welch_tib %>% filter(p.adj < 0.01)), 
      "out of", nrow(welch_tib), 
      "drug-concentration samples are significantly different between IPRs")
paste(welch_tib %>% filter(p.adj < 0.01) %>% distinct(drug) %>% nrow(), 
      "out of", 
      welch_tib %>% distinct(drug) %>% nrow(),
      "drugs are significantly different between IPRs")

# Add this information to the heatmap
target_all <- target_set_drugs %>% 
  rownames_to_column(var = "drug_conc") %>%
  left_join(welch_tib) %>%
  filter(drug_conc %in% rownames(eff.data.heatmap2)) %>%
  column_to_rownames(var = "drug_conc") %>%
  dplyr::select(target, viab, p.adj.Welch)

# Control samples
freqCut_ctrl_tib = indel.data %>% 
  mutate(drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " ")) %>% 
  filter(sample != "Epigenetic Compound", !grepl("1 µM", drug_conc)) %>%
  distinct(drug_conc, IPR, freqCut_diff, tech, replicate)

ctrl_dc = unique(freqCut_ctrl_tib$drug_conc)

welch_ctrl_tib = map_dfr(ctrl_dc, function(x) {
  tibble("drug_conc" = x,
         "welch.p" = welch.test(freqCut_diff ~ IPR, data = filter(freqCut_ctrl_tib, drug_conc == x), alpha = 0.001, verbose = F)$p.value)
         }
  )

welch_ctrl_tib %<>%
  mutate(p.adj = p.adjust(welch.p, method = "BH")) %>%
  add_significance("p.adj") 

welch_ctrl_tib


freqCut_diff_tib %>% 
  filter(drug_conc == "Scriptaid 1 µM") %>%
  ggplot(., aes(IPR, freqCut_diff)) +
  geom_quasirandom()

freqCut_ctrl_tib %>% 
  ggplot(., aes(IPR, freqCut_diff)) +
  geom_quasirandom() +
  facet_grid(~ drug_conc)
```


### Plot the heatmap
```{r 2D TIF heatmap, warning = FALSE, fig.width = 10, fig.height = 12}
plt1 = pheatmap(eff.data.heatmap2[drug_order_grouped , clone5_map_ipr$labels],
                cluster_cols = clone5_map_ipr,
                cluster_rows = F,
                border_color = F,
                cellwidth = 12,
                cellheight = 12,
                breaks = myBreaks,
                na_col = "white",
                main = 'efficiency change, all concentrations',
                annotation_row = target.HDAC,
                annotation_col = chromatin,
                # color = colorRampPalette(c("#e07a5f", "#e5e5e5", "#3d405b"))(palette_length),
                color = rev(diverge_hcl(palette_length, "Broc")),
                annotation_colors = annotation_colors_scr_set,
                annotation_legend = T)
```

## Plot 1
```{r Figure 1, fig.width= 12, fig.height= 12, warning=FALSE}

```



## Plot 2
```{r Figure 2, fig.width= 12, fig.height= 12, warning=FALSE}
```

--- 

# Export
```{r export}
```

# Conclusions
<!--write the conclusions in one or two sentences-->

# Bibliography
```{r citations}
cite_packages()
```

# Session Info  
<!--Some basic session info-->
```{r session info QC}
sessionInfo()
getwd()
date()
paste("Run time: ",format(Sys.time()-StartTime))
rm(list = ls(all.names = TRUE)) #will clear all objects includes hidden objects.
gc() #free up memrory and report the memory usage.
```
