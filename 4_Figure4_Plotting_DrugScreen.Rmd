---
title: "DSB Episcreen data analysis & plotting"
author: 
  - name: "Max Trauernicht"
    email: "m.trauernicht@nki.nl"
    affiliation: "Netherlands Cancer Institute"
date: '`r format(Sys.time(), "%d/%m/%Y")`'
output: 
  html_document:
    theme: united
    highlight: pygments
    fig_caption: yes
    code_folding: hide
    df_print: kable
    toc: true
    toc_depth: 4
    toc_float:
      collapsed: false
---

*knitr document van Steensel lab*


# Introduction
Clone 5 with ~18 sgRNA target site IPRs was cut and treated with 160 epigenetic drugs. The repair outcomes of that experiment will be visualized here. I previously processed the raw sequencing data, and calculated the repair outcomes. In this script, the main results plots will be generated.


## Setup {.tabset}

<!-- little HTML script to do indentation of the table of contents -->
<script>
$(document).ready(function() {
$items = $('div#TOC li');
$items.each(function(idx) {
num_ul = $(this).parentsUntil('#TOC').length;
$(this).css({'text-indent': num_ul * 10, 'padding-left': 0});
});

});
</script>

```{css, echo = FALSE}
div.sourceCode {
overflow-x: hidden;
}
```
### Libraries
### Libraries

```{r load_packages, results = 'hide', warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE)
StartTime <-Sys.time()

# 8-digit Date tag:
Date <- substr(gsub("-","",Sys.time()),1,8) 
# libraries:
library(knitr)
library(tidyverse)
library(outliers)
library(ggplot2)
library(ggbeeswarm)
library(data.table)
# library(ggrepel)
library(GGally)
library(MASS)
# library(DESeq2)
library(gghighlight)
library(ggrepel)
# library(platetools)
library(ggpubr)
# library(Laurae)
library(pheatmap)
library(RColorBrewer)
# # library(ggrastr)
library(broom)
# library(ggsignif)
# library(rstatix)
library(colorspace)
library(analogue)

## Select outdir
out.dir = paste0("./figures/", Date, "/")
dir.create(out.dir)
in.dir = list.dirs(path = "/DATA/projects/DSBrepair/data/R") %>% .[grepl("episcreen", .)] %>% tail(n = 1)
opts_chunk$set(dev=c('png', 'pdf'), fig.path = file.path(out.dir))
pdf.options(useDingbats = FALSE)
```

### Functions

```{r load_functions, echo = FALSE, warning = FALSE}

p.adjust <- function(p, method = p.adjust.methods, n = length(p))
{
  ## Methods 'Hommel', 'BH', 'BY' and speed improvements
  ## contributed by Gordon Smyth
  method <- match.arg(method)
  if(method == "fdr") method <- "BH"	# back compatibility
  nm <- names(p)
  p <- as.numeric(p)
  p0 <- setNames(p, nm)
  if(all(nna <- !is.na(p))) nna <- TRUE
  p <- p[nna]
  lp <- length(p)
  # stopifnot(n >= lp)
  if (n <= 1) return(p0)
  if (n == 2 && method == "hommel") method <- "hochberg"
  
  p0[nna] <-
    switch(method,
           bonferroni = pmin(1, n * p),
           holm = {
             i <- seq_len(lp)
             o <- order(p)
             ro <- order(o)
             pmin(1, cummax( (n - i + 1L) * p[o] ))[ro]
           },
           hommel = { ## needs n-1 >= 2 in for() below
             if(n > lp) p <- c(p, rep.int(1, n-lp))
             i <- seq_len(n)
             o <- order(p)
             p <- p[o]
             ro <- order(o)
             q <- pa <- rep.int( min(n*p/i), n)
             for (j in (n-1):2) {
               ij <- seq_len(n-j+1)
               i2 <- (n-j+2):n
               q1 <- min(j*p[i2]/(2:j))
               q[ij] <- pmin(j*p[ij], q1)
               q[i2] <- q[n-j+1]
               pa <- pmax(pa,q)
             }
             pmax(pa,p)[if(lp < n) ro[1:lp] else ro]
           },
           hochberg = {
             i <- lp:1L
             o <- order(p, decreasing = TRUE)
             ro <- order(o)
             pmin(1, cummin( (n - i + 1L) * p[o] ))[ro]
           },
           BH = {
             i <- lp:1L
             o <- order(p, decreasing = TRUE)
             ro <- order(o)
             pmin(1, cummin( n / i * p[o] ))[ro]
           },
           BY = {
             i <- lp:1L
             o <- order(p, decreasing = TRUE)
             ro <- order(o)
             q <- sum(1L/(1L:n))
             pmin(1, cummin(q * n / i * p[o]))[ro]
           },
           none = p)
  p0
}

SetFileName <- function(filename, initials) {
  # Set filename with extension and initials to make filename with date integrated.
  filename <- substitute(filename)
  initials <- substitute(initials)
  filename <- paste0(initials, Date, filename)
  filename
}

# From Fede:
# ggpairs custom functions
corColor <- function(data, mapping, color = I("black"), sizeRange = c(1, 3), ...) {
  
  x   <- eval_data_col(data, mapping$x)
  y   <- eval_data_col(data, mapping$y)
  r   <- cor(x, y)
  rt  <- format(r, digits = 3)
  tt  <- as.character(rt)
  cex <- max(sizeRange)
  
  # helper function to calculate a useable size
  percent_of_range <- function(percent, range) {
    percent * diff(range) + min(range, na.rm = TRUE)
  }
  
  # plot correlation coefficient
  p <- ggally_text(label = tt, mapping = aes(), xP = 0.5, yP = 0.5,
                   size = I(percent_of_range(cex * abs(r), sizeRange)), color = color, ...) +
    theme(panel.grid.minor=element_blank(),
          panel.grid.major=element_blank())
  
  corColors <- RColorBrewer::brewer.pal(n = 7, name = "RdYlBu")[2:6]
  
  if (r <= boundaries[1]) {
    corCol <- corColors[1]
  } else if (r <= boundaries[2]) {
    corCol <- corColors[2]
  } else if (r < boundaries[3]) {
    corCol <- corColors[3]
  } else if (r < boundaries[4]) {
    corCol <- corColors[4]
  } else {
    corCol <- corColors[5]
  }
  
  p <- p +
    theme(panel.background = element_rect(fill = corCol))
  
  return(p)
}


theme_classic_lines <- function() {
  theme_pubr(border = T, legend = "top") +
    theme(panel.grid.major = element_line(colour = "#adb5bd", size = 0.25),
          strip.background = element_rect(fill = "white", color = "white")
    )
}
theme_classic_lines_45 <- function() {
  theme_pubr(border = T, legend = "top", x.text.angle = 45) +
    theme(panel.grid.major = element_line(colour = "#adb5bd", size = 0.25),
          strip.background = element_rect(fill = "white", color = "white")
    )
}

theme_classic_lines_90 <- function() {
  theme_pubr(border = T, legend = "top", x.text.angle = 90) +
    theme(panel.grid.major = element_line(colour = "#adb5bd", size = 0.25),
          strip.background = element_rect(fill = "white", color = "white")
    )
}

theme_classic_lines_90_noborder <- function() {
  theme_pubr(border = F, legend = "top", x.text.angle = 90) +
    theme(strip.background = element_rect(fill = "white", color = "white")
    )
}

theme_set(theme_classic_lines())

colors_diverse <- c("#264653", "#9AC1AE", "#5D987B", "#f2cc8f", "#e76f51")
colors_drugs <- c("#FA8D62", "#65BFA4", "#8CA0C4", "#808184", "#F6D289", "#E5E5E5", "#ACACAC", "#737373")
#colors_diverse <- c("#264653", "#2a9d8f", "#e9c46a", "#f4a261", "#e76f51") 
colors_targets <-  c(HDAC="#60988D", HAT="#C6D0A8", Sirtuin="#8FCAAC",
                     HMT="#FDCDAC", DNMT="#D69C81", `Histone Demethylase`="#FFF2AE",
                     HIF="#E3DCD5", JAK="#C8D7E2", PIM="#9AB8C4", `Aurora Kinase`="#F4CAE4",
                     PARP="#CB546F", `Epigenetic Reader Domain`= "#476D61", `DNA-PK`="#E07A43")
colors_pathways = c("wt" = "#808184", "other" = "black", "NHEJ" = "#e1251b", "MMEJ" = "#26419a", "SSTR" = "#007A4C")

conc_colors = c("100 nM" = colors_drugs[7], "1 µM" = colors_drugs[4], "10 µM" = "#000000")



ggplot_custom <- function(...) ggplot2::ggplot(...) + 
  scale_color_manual(values = colors_diverse) + 
  scale_fill_manual(values = colors_diverse)

sigFunc = function(x){
  if(x < 0.001){"***"} 
  else if(x < 0.01){"**"}
  else if(x < 0.05){"*"}
  else{NA}}

```


### Data import

```{r data import, echo = FALSE, warning = FALSE}
# Import data from preprocessing script
in.dir = list.dirs(path = "/DATA/projects/DSBrepair/data/R") %>% .[grepl("episcreen", .)] %>% tail(n = 1)
file = list.files(in.dir, pattern = "episcreen_ratios", full.names = T) %>% tail(n = 1)
indel.data <- readRDS(file) # %>% filter(pathway_bal_filter == TRUE & viab_reproducibility == TRUE)

# Import data from preprocessing validation script
file.validation = list.files(in.dir, pattern = "validation_ratio", full.names = T) %>% tail(n = 1)
indel.data.validation <- readRDS(file.validation)

chromatin.features <- colnames(indel.data)[grepl("[.]zscore", colnames(indel.data))]
chrom_data = indel.data %>% dplyr::select(barcode, all_of(chromatin.features)) %>% distinct()  %>%
  rename_with(., ~gsub(".zscore", "", .x))

chromatin.features.short = gsub(".zscore", "", chromatin.features)
```


## 2D HDACi heatmap
```{r prepare data for heatmaps}
# Order IPRs by their starting freqCut value
dmso_freq <- indel.data %>%
  filter(drug == "DMSO") %>%
  distinct(IPR, MMEJratio) %>%
  mutate(MMEJratio = ave(MMEJratio, IPR, FUN = function(x) mean(x, na.rm = TRUE))*100) %>%
  dplyr::select('ctrl_MMEJratio' = MMEJratio, IPR) %>%
  distinct() %>%
  arrange(desc(ctrl_MMEJratio))

iprs <- dmso_freq$IPR
iprs <- as.character(iprs)


# Set annotation for heatmap
# viability
viab_drug = indel.data %>% filter(drug != "PAO") %>% 
  mutate(drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " ")) %>% 
  distinct(viab_mean, drug_conc, replicate) %>% 
  group_by(drug_conc) %>%
  summarise(viab = mean(viab_mean))
# Row annotation: annotate drugs with the target group
target_set_drugs <- indel.data %>% 
  filter(!target %in% c("Negative Control", "MRN", "DNA-PK")) %>%
  mutate(drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " ")) %>%
  left_join(viab_drug) %>%
  distinct(drug, drug_conc, conc_char, target, viab) %>% 
  column_to_rownames(var="drug_conc")

ctrl.vals <- indel.data %>%
  filter(drug == "DMSO") %>%
  distinct(IPR, freqCut, MMEJratio) %>%
  mutate(ctrl_TIF = ave(freqCut, IPR, FUN = function(x) mean(x, na.rm = TRUE))*100,
         ctrl_balance = ave(MMEJratio, IPR, FUN = function(x) mean(x, na.rm = TRUE))*100) %>%
  distinct(ctrl_TIF, 
           ctrl_balance,
           IPR)

clone5.matrix = indel.data %>% 
  dplyr::select(IPR, ends_with(".zscore")) %>% 
  distinct() %>% 
  rename_with(., ~gsub(".zscore", "", .x)) %>%
  # left_join(ctrl.vals) %>%
  column_to_rownames(var="IPR")

clone5_map_ipr = hclust(dist(clone5.matrix), method = "ward.D") %>% 
  # Rotate the middle node to math better the TIF in CTRL conditions
  dendextend::rotate(c(1:6, 10:7, 11:18))

# Chromatin annotation
chromatin <- readRDS(
  "/DATA/usr/x.vergara/XV_ChIPIndels/XV20200902_DDR_RS_revision/XV20200902_DDR_RS_revision/data/xv20200915_DDR_data_CHIP.rds") %>% 
  distinct(barcode, chromatin) %>%
  left_join(distinct(indel.data, barcode, IPR)) %>%
  left_join(dmso_freq)

# chromatin$IPR[is.na(chromatin$IPR)] <- "IPR1"
chromatin <- chromatin %>%
  filter(IPR != "<NA>") %>% 
  dplyr::select(-barcode) %>%
  column_to_rownames(var="IPR")

## Chromatin groups
group_colors = c("Euchromatin" = "#f7941d",
                 "other-heterochromatin" = "#838687",
                 "Triple Heterochromatin" = "#662d91",
                 "H3K27me3" = "#d21f8a")


viab_colors = sequential_hcl(11, "Peach", rev = TRUE)
names(viab_colors) = seq(0, 1, by = 0.1)

annotation_colors_scr = list(
  chromatin = group_colors,
  target = c(HDAC="#60988D", HAT="#C6D0A8", Sirtuin="#8FCAAC",
             HMT="#FDCDAC", DNMT="#D69C81", `Histone Demethylase`="#FFF2AE",
             HIF="#E3DCD5", JAK="#C8D7E2", PIM="#9AB8C4", `Aurora Kinase`="#F4CAE4",
             PARP="#CB546F", `Epigenetic Reader Domain`= "#476D61", `DNA-PK`="#E07A43"),
  conc_char = conc_colors,
  clusters_drugs = sequential_hcl(4, "YlGn"),
  # viab_rep1 = c('#ffeee9', '#ffdcd4', '#ffcbbe', '#ffb8a8', '#fda693', '#f9947e', '#f4826a', '#ef6f56', '#e95b43', '#e24530'),
  # viab_rep2 = c('#ffeee9', '#ffdcd4', '#ffcbbe', '#ffb8a8', '#fda693', '#f9947e', '#f4826a', '#ef6f56', '#e95b43', '#e24530'),
  viab = viab_colors,
  ctrl_MMEJratio = colorRampPalette(c("white", "black"))(10))

# Order the annotation legend
ordered_marks <- c("Euchromatin", 
                   "H3K27me3", 
                   "other-heterochromatin",  
                   "Triple Heterochromatin")

annotation_colors_scr$chromatin <- annotation_colors_scr$chromatin[ordered_marks]

# Order IPRs by their starting MMEJ_log2_FC value
dmso_bal <- indel.data %>%
  filter(drug == "DMSO") %>%
  distinct(IPR, MMEJ_log2_FC) %>%
  mutate(MMEJ_log2_FC = ave(MMEJ_log2_FC, IPR, FUN = function(x) mean(x, na.rm = TRUE))*100) %>%
  dplyr::select('dmso_bal' = MMEJ_log2_FC, IPR) %>%
  distinct() %>%
  arrange(desc(dmso_bal))

iprs <- dmso_bal$IPR
iprs <- as.character(iprs)


# Generate heatmap: select top drugs (highest change at any IPR) per concentration
balance.data <- indel.data %>%
  #filter(target != "Aurora Kinase") %>%
  filter(sample == "Epigenetic Compound") %>% 
  filter(pathway_bal_filter == TRUE & viab_reproducibility == TRUE & cor_bal_filter) %>%
  filter(abs(zscore_bal_global_comb_rep) >= 2.58) %>%  # we can choose to display all drugs that have significant global hits
  distinct(conc_char, drug, target, IPR, zscore_bal_comb_rep, MMEJ_log2_FC, replicate, tech)

dmso_bal <- indel.data %>%
  filter(drug == "DMSO") %>%
  dplyr::select('dmso_bal' = MMEJ_log2_FC , IPR) %>%
  mutate(dmso_bal = ave(dmso_bal, IPR, FUN = function(x) mean(x, na.rm = TRUE))) %>%
  distinct()

balance.data.heatmap <- balance.data %>%
  # left_join(dmso_bal) %>%
  group_by(drug, conc_char) %>%
  # ave to add IPR grouping level to calculate mean of the replicates
  mutate(MMEJ_log2_FC_mean = ave(MMEJ_log2_FC, IPR, FUN = function(x) mean(x, na.rm = TRUE)),
         ## Select drugs that have a large effect size in at least one location 
         ## (some drugs might have a small global effect size, but large local)
         p_value = 2*pnorm(q = abs(zscore_bal_comb_rep), lower.tail = F),
         # Adjust p value for false discovery rate
         adj_pvalue = p.adjust(p_value, method = 'bonferroni'),
         # Pick the smallest per compound & concentration
         min_score = min(adj_pvalue)) %>%
  # filter for adjusted p.val < 0.01 so we keep compounds with at least one signif effect.
  filter(min_score < 0.01) %>%
  distinct(drug, target, conc_char, MMEJ_log2_FC_mean, IPR, min_score) %>%
  ungroup()


# replace -Inf with minimal value of the table.
min.value = min(balance.data.heatmap$MMEJ_log2_FC_mean[is.finite(balance.data.heatmap$MMEJ_log2_FC_mean)])

top_50_hits = balance.data.heatmap %>% 
  arrange(desc(abs(MMEJ_log2_FC_mean))) %>% 
  distinct(drug, conc_char, min_score) %>%
  dplyr::slice(1:60) 


#eff.data.heatmap2$freqCut_norm_mean[eff.data.heatmap2$mean_eff_zscore_comb > 0.05] <- NA
balance.data.heatmap2 <- top_50_hits %>% 
  left_join(balance.data.heatmap)%>%
  dplyr::select(-min_score) %>%
  spread(IPR, MMEJ_log2_FC_mean) %>%
  filter(!is.nan(IPR3))

balance.data.heatmap2 <- balance.data.heatmap2[,c("drug", "target", "conc_char", iprs)]
balance.data.heatmap2$drug <- gsub(" [(].*[)]", "", balance.data.heatmap2$drug) #shorten name of drug


breaks <- quantile(unlist(balance.data.heatmap2 %>% 
                            dplyr::select(contains('IPR'))), c(.05,.95), na.rm = T) # change these numbers according to where you want to set the cutoff
palette_length <- 100

myBreaks <- c(seq(breaks[1], 0, length.out=ceiling(palette_length/2) + 1), 
              seq(-breaks[1]/palette_length, -breaks[1], length.out=floor(palette_length/2)))


# myBreaks <- c(seq(-0.5, 0, length.out=ceiling(palette_length/2) + 1), 
#               seq(0.5/palette_length, 0.5, length.out=floor(palette_length/2)))

ordered_marks2 <- balance.data.heatmap2 %>% 
  dplyr::select(target) %>%
  distinct() %>%
  arrange(target)

ordered_marks2 <- ordered_marks2$target

annotation_colors_scr_set = annotation_colors_scr
annotation_colors_scr_set$target <- annotation_colors_scr$target[ordered_marks2]

# Add cluster annotation
clusters_drugs <- hclust(dist(balance.data.heatmap2), method = "ward.D")
clusters_drugs <- cutree(tree = clusters_drugs, k = 8)
clusters_drugs <- data.frame(clusters_drugs)

balance.data.heatmap2.clusters <- cbind(balance.data.heatmap2, clusters_drugs) %>% 
  as_tibble() %>%
  mutate(drug_conc = paste(drug, conc_char, sep = " "))

clusters_drugs <- balance.data.heatmap2.clusters %>%
  distinct(drug_conc, clusters_drugs)

target_set_all <- target_set_drugs %>%
  rownames_to_column("drug_conc") %>%
  left_join(clusters_drugs) %>%
  na.omit()
rownames(target_set_all) <- target_set_all$drug_conc
target_all <- target_set_all %>%
  dplyr::select(target, 
                clusters_drugs,
                conc_char, viab)
```

```{r S2A TIF heatmaps, warning = FALSE, fig.width = 10, fig.height = 20}
# pdf(paste0(figure_out, "rs20220623_indelfrequency_heatmap_allconc.pdf"), width=20, height=8)
balance.data.matrix = balance.data.heatmap2.clusters %>%
  arrange(target_all) %>%
  column_to_rownames('drug_conc') %>%
  dplyr::select(contains('IPR'))



plt1 = pheatmap(balance.data.matrix[ , clone5_map_ipr$labels],
                cluster_cols = clone5_map_ipr,
                border_color = F,
                cellwidth = 8,
                cellheight = 8,
                breaks = myBreaks,
                clustering_method = "ward.D",
                cluster_rows = T,
                na_col = "white",
                main = 'MMEJ ratio FC (log2), all concentrations',
                annotation_row = target_all,
                annotation_col = chromatin,
                # color = colorRampPalette(c("#e07a5f", "#e5e5e5", "#3d405b"))(palette_length),
                color = diverge_hcl(palette_length, "Blue-Red"),
                annotation_colors = annotation_colors_scr_set, 
                annotation_legend = T,
                cutree_row = 8)
```


## Cluster differences per chromatin group
```{r}
chromatin_ipr <- chromatin %>%
  rownames_to_column("IPR")

balance.data.heatmap3 <- balance.data.heatmap2 %>%
  pivot_longer(cols = contains("IPR"), names_to = "IPR", values_to = "MMEJratio_FC")

chromatin_effect <- left_join(balance.data.heatmap3, chromatin_ipr) %>%
  #filter(target == "HDAC") %>%
  mutate(MMEJratio_FC = ave(MMEJratio_FC, drug, chromatin, conc_char, FUN = function(x) mean(x, na.rm = TRUE)),
         drug_conc = paste(drug, conc_char, sep = " ")) %>%
  distinct(MMEJratio_FC, drug, chromatin, conc_char, target, drug_conc)

clusters_drugs = target_set_all # %>% filter(clusters_drugs %in% c(3, 4))


chromatin_effect <- left_join(clusters_drugs, chromatin_effect)

ggplot(chromatin_effect,
       aes(x = chromatin, y = MMEJratio_FC, fill = chromatin)) +
  geom_boxplot(outlier.shape = NA) +
  geom_quasirandom() +
  geom_signif(comparisons = combn(sort(unique(chromatin_effect$chromatin)), 2, simplify = F), 
              map_signif_level=sigFunc, 
              step_increase = 0.1) +
  theme_classic_lines_45() +
  scale_fill_manual(values = group_colors) +
  theme(legend.position = "none") +
  facet_wrap(~ clusters_drugs, nrow = 1)
```





```{r}
#data frame to save data
mean_sd_fits <- tibble(term = NA, estimate = NA, std.error = NA, barcode = NA, rep = NA)


# First calculate means and sd of the DMSO efficiency per replicate and barcode
dmso.eff.score <- indel.data %>%
  filter(drug == "DMSO") %>%
  dplyr::select('DMSO' = MMEJratio, well, barcode, replicate, tech, plate) %>%
  mutate(DMSO = ave(DMSO, well, replicate, tech, plate, FUN = function(x) mean(x, na.rm=T))) %>%
  distinct(replicate, tech, well, plate, DMSO) %>% 
  pull(DMSO) %>%
  fitdistr(., "normal") %>% tidy()
```

```{r Compounds that affect the balance at all the sites}
## Which compounds change the balance at all the sites in both screens?
all_balance = indel.data %>% 
  distinct(drug, conc_char, replicate, zscore_bal_comb_rep, target, 
           barcode, viab_reproducibility, pathway_bal_filter) %>% 
  filter(!is.na(zscore_bal_comb_rep) & 
           !between(zscore_bal_comb_rep, -1.96, 1.96) & 
           viab_reproducibility == T & 
           pathway_bal_filter == T) %>% 
  group_by(drug, conc_char, target) %>% 
  count() %>% 
  filter(n == 36) # 2 x 18

kable(all_balance)
all_balance %>% ungroup() %>% distinct(drug, target)

## Now with 16/18 (~ 90%) of the sites with an effect. Near global
near_all_balance = indel.data %>% 
  distinct(drug, conc_char, replicate, zscore_bal_comb_rep, target, 
           barcode, viab_reproducibility, pathway_bal_filter) %>% 
  filter(!is.na(zscore_bal_comb_rep) & 
           !between(zscore_bal_comb_rep, -1.96, 1.96) & 
           viab_reproducibility == T & 
           pathway_bal_filter == T) %>% 
  group_by(drug, conc_char, target) %>% 
  count() %>% 
  filter(n >= 32) # 2 x 16


kable(near_all_balance)
near_all_balance %>% ungroup() %>% distinct(drug, target)
```

## A: MMEJ-z-score per drug
Are the compounds (per concentration) that significantly alter the MMEJ score?
```{r warning = FALSE}
# Plot raw MMEJ ratio
dmso_bal <- indel.data %>%
  filter(drug == "DMSO") %>%
  dplyr::select('dmso_bal' = MMEJratio, IPR, replicate, tech, well, plate) %>%
  group_by(replicate, tech, well, plate) %>%
  summarise(dmso_bal = mean(dmso_bal)) %>%
  ungroup() %>%
  mutate(dmso_mean = mean(dmso_bal),
         dsmo_sd = sd(dmso_bal)) %>%
  distinct(dmso_mean, dsmo_sd)



volcano.df = indel.data %>%
  filter(sample == "Epigenetic Compound" & pathway_bal_filter == TRUE & viab_reproducibility == TRUE) %>%
  distinct(MMEJratio, drug, conc_char, zscore_bal_global_comb_rep) %>%
  mutate(GlobalMMEJratio = ave(MMEJratio, drug, conc_char, FUN = mean)) %>%
  distinct() %>%
  mutate(MMEJ_pval_global_comb = 2*pnorm(q = abs(zscore_bal_global_comb_rep), lower.tail = F)) %>%
  left_join(near_all_balance) %>%
  mutate(MMEJ_pval_adj_global_comb = log10(p.adjust(MMEJ_pval_global_comb, method = 'fdr')),
         col_bal = ifelse(MMEJ_pval_adj_global_comb < 0.01 & 
                            GlobalMMEJratio > (dmso_bal$dmso_mean + dmso_bal$dsmo_sd), "MMEJ increase", 
                          ifelse(MMEJ_pval_adj_global_comb < 0.01 & 
                                   GlobalMMEJratio < (dmso_bal$dmso_mean - dmso_bal$dsmo_sd), "NHEJ increase","blue"))) %>%
  distinct(MMEJ_pval_adj_global_comb, GlobalMMEJratio, drug, conc_char, target, n, col_bal)


ggplot(volcano.df, 
       aes(y = MMEJ_pval_adj_global_comb, 
           x = GlobalMMEJratio, 
           color = col_bal)) +
  geom_point() +
  geom_hline(linetype = "dashed", yintercept = log10(0.01)) +
  geom_vline(linetype = "solid", xintercept = (dmso_bal$dmso_mean)) +
  geom_vline(linetype = "dashed", xintercept = (dmso_bal$dmso_mean + dmso_bal$dsmo_sd)) +
  geom_vline(linetype = "dashed", xintercept = (dmso_bal$dmso_mean - dmso_bal$dsmo_sd)) +
  scale_color_manual(values = c("#C2C2C2", "#3d405b", "#e07a5f")) +
  facet_wrap(~conc_char) +
  annotate("rect",
           xmin=(dmso_bal$dmso_mean - dmso_bal$dsmo_sd),
           xmax=(dmso_bal$dmso_mean + dmso_bal$dsmo_sd),
           ymin=-Inf,ymax=Inf, alpha=0.1, fill="black") +
  annotate("rect",
           xmin=-Inf,
           xmax=Inf,
           ymin=-Inf,
           ymax= -log10(0.01), 
           alpha=0.1, 
           fill="black") +
  coord_flip() +
  ylim(0, -300) + 
  geom_label_repel(data = volcano.df, 
                   aes(y = MMEJ_pval_adj_global_comb, 
                       x = GlobalMMEJratio, 
                       label = ifelse(n == 36, drug,'')),
                   box.padding   = 1, 
                   point.padding = 0.5,
                   force = 210,
                   segment.color = 'black', 
                   inherit.aes = F) +
  geom_label_repel(aes(label = ifelse(between(n, 32, 35), drug,'')),
                   box.padding   = 1, 
                   force = 110,
                   point.padding = 0.5,
                   segment.color = 'gray50') 



indel.data %>%
  filter(sample == "Epigenetic Compound" & pathway_bal_filter == TRUE & viab_reproducibility == TRUE) %>%
  distinct(MMEJratio, drug, conc_char, zscore_bal_global_comb_rep) %>%
  mutate(GlobalMMEJratio = ave(MMEJratio, drug, conc_char, FUN = mean)) %>%
  distinct() %>%
  mutate(zscore_bal_global_comb_rep = 2*pnorm(q = abs(zscore_bal_global_comb_rep), lower.tail = F)) %>%
  mutate(MMEJ_pval_adj_global_comb = log10(p.adjust(zscore_bal_global_comb_rep, method = 'fdr')),
         col_bal = ifelse(MMEJ_pval_adj_global_comb < 0.01 & 
                            GlobalMMEJratio > (dmso_bal$dmso_mean + dmso_bal$dsmo_sd), "green", 
                          ifelse(MMEJ_pval_adj_global_comb < 0.01 & 
                                   GlobalMMEJratio < (dmso_bal$dmso_mean - dmso_bal$dsmo_sd), "yellow","blue"))) %>%  
  filter(col_bal != "blue") %>%
  distinct(drug, conc_char)
```


*Figure 3A: Compound-induced change in MMEJ ratio of all tested compounds. Mean MMEJ z-score per drug & concentration.* 

**Conclusion: Yes, there are a lot of interesting hits at all tested concentrations.**

---

## B: MMEJ ratio change per target group
Are there any target groups that are prone to changes in MMEJ ratio?
```{r warning = FALSE}
# C: Bar plot
indel.data.bal <- indel.data %>%
  filter((sample == "Epigenetic Compound" | drug == "DMSO") & 
           pathway_bal_filter & viab_reproducibility &
           cor_bal_filter & !is.na(MMEJratio)) %>%
  distinct(IPR, drug, conc_char, sample, target, viab_mean, replicate,
           MMEJratio_global, MMEJratio, IPR,
           zscore_bal_global_comb_rep , filter_zscore_bal_global_comb_rep, 
           zscore_bal_comb_rep , filter_zscore_bal_comb_rep) %>%
  filter(!(viab_mean < 0.5)) %>%
  mutate(MMEJratio_mean = ave(MMEJratio_global, drug, conc_char))


bal.data <- indel.data.bal %>%
  filter(sample == "Epigenetic Compound") %>%
  distinct(IPR, zscore_bal_global_comb_rep , filter_zscore_bal_global_comb_rep, 
           zscore_bal_comb_rep , filter_zscore_bal_comb_rep, 
           drug, target, conc_char) %>%
  mutate(mean_eff_pval_comb = 2*pnorm(q = abs(zscore_bal_comb_rep ), lower.tail = F),
         mean_eff_pval_adj_comb = p.adjust(mean_eff_pval_comb, method = 'fdr'),
         sign_local = ifelse((mean_eff_pval_adj_comb < 0.01 & 
                                filter_zscore_bal_comb_rep &
                                 zscore_bal_comb_rep > 2.58), "MMEJbal_increase", 
                             ifelse((mean_eff_pval_adj_comb < 0.01 &
                                       filter_zscore_bal_global_comb_rep &
                                 zscore_bal_comb_rep < -2.58), "MMEJbal_decrease", 
                                    "No_Change"))) %>%
  group_by(drug, conc_char) %>%
  mutate(no_change_n = length(table(sign_local))) %>%
  mutate(sign_global = ifelse(no_change_n == 1,  names(table(sign_local)), "No_Change")) %>%
  distinct(IPR, drug, conc_char, target, sign_local, sign_global)

global.effects = bal.data %>%
  distinct(drug, conc_char, target, sign_global) %>%
  group_by(target, sign_global, conc_char) %>% 
  count()

local.effects = bal.data %>% 
  filter(sign_global == "No_Change") %>% 
  distinct(drug, conc_char, target, sign_local) %>%
  group_by(target, sign_local, conc_char) %>% 
  count() %>% 
  pivot_wider(names_from = sign_local, values_from = n, values_fill = 0) %>%
  mutate(No_Change = No_Change - MMEJbal_increase - MMEJbal_decrease) %>%
  dplyr::rename(Local_MMEJbal_increase = MMEJbal_increase, Local_MMEJbal_decrease = MMEJbal_decrease) %>% 
  pivot_longer(cols = No_Change:Local_MMEJbal_decrease, values_to = "n", names_to = "sign_global")

target_effects = global.effects %>% 
  filter(sign_global != "No_Change") %>%
  rbind(local.effects) %>%
  mutate(sign_global = factor(sign_global, levels = c(c("MMEJbal_decrease", "Local_MMEJbal_decrease", "No_Change","Local_MMEJbal_increase", "MMEJbal_increase"))))

ggplot(target_effects,
       aes(y = reorder(target, n), x = n, fill = sign_global)) +
  geom_bar(stat = "identity") +
  facet_wrap(~conc_char)+
  scale_fill_manual(values = c("MMEJbal_decrease" = "#023FA5", "Local_MMEJbal_decrease" = "#A1A6C8", "No_Change" = "#E2E2E2","Local_MMEJbal_increase" = "#CA9CA4", "MMEJbal_increase" = "#8E063B")) +
  theme_pubr(border = T)

target_effects %>% filter(sign_global != "No_Change") %>% distinct(target, conc_char, n) %>% group_by(conc_char) %>% summarise(count = sum(n))
```

*Figure 2B: Number of compounds with significant changes in MMEJ ratio per target group.*

**Conclusion: Some target groups have more changes. But there are no groups significantly sticking out.**

---
```{r 2C Top TIF boosting, , fig.width = 12, fig.height = 10}
rank_dt = indel.data %>% 
  filter(drug != "DMSO" & pathway_bal_filter & viab_reproducibility & cor_bal_filter, filter_zscore_bal_global_comb_rep) %>%
  distinct(drug, conc_char, MMEJratio_global_mean , target, cor_bal, cor_bal_filter) %>% 
  arrange(MMEJratio_global_mean) %>%
  mutate(rank = seq(1:n()),
         drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " "))

p1 = rank_dt %>% 
  # filter(rank < 100 ) %>%
  ggplot(., aes(rank, MMEJratio_global_mean )) +
  geom_point()  +
  scale_color_manual(values = colors_targets) +
  geom_label_repel(aes(label = ifelse(drug == "DNA-PKi", drug_conc,'')),
                   box.padding   = 1, 
                   point.padding = 0.5,
                   segment.color = 'gray50') +
  geom_hline(linetype = "dashed", yintercept = 2.58) +
  geom_hline(linetype = "dashed", yintercept = -2.58) +
  # scale_x_reverse(limits = c(100, 0)) +
  scale_x_reverse() +
  ylab("Global combined MMEJ ratio z-score")

p2 = rank_dt %>%
  filter(rank <= 100 & drug != "DNA-PKi") %>%
  ggplot(., aes(rank, MMEJratio_global_mean , color = target)) +
  geom_point()  +
  scale_color_manual(values = colors_targets) +
  gghighlight(rank <= 8, label_key = drug_conc) +
  geom_hline(linetype = "dashed", yintercept = 2.58) +
  scale_x_reverse(limits = c(100, 0)) +
  # scale_x_reverse() +
  ylab("Global combined MMEJ ratio z-score")

maxrank = rank_dt %>% nrow()

p3 = rank_dt %>%
  filter(rank <= 150) %>%
  ggplot(., aes(rank, MMEJratio_global_mean , color = target, size = 1)) +
  geom_point()  +
  scale_color_manual(values = colors_targets) +
  gghighlight(rank <= 34, use_direct_label = F) +
  geom_hline(linetype = "dashed", yintercept = 0.3711068) +
  ylab("Global combined MMEJ ratio z-score")


plot_grid(p1, p2, p3, labels = c('A', 'B', 'C'), label_size = 12, ncol = 3)

top_hits = indel.data  %>% 
  filter(conc_char != "control" & pathway_bal_filter == T & viab_reproducibility == TRUE) %>% 
  distinct(drug, conc_char, zscore_bal_global_comb_rep , target) %>%
  arrange(desc(zscore_bal_global_comb_rep )) %>% slice_head(n = 10) %>% distinct(drug, conc_char, target, zscore_bal_global_comb_rep ) %>% 
  mutate(rank = seq(1:n()),
         drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " "))
```


## Indel plot decitabine

```{r}
# Import data from preprocessing script
in.dir = list.dirs(path = "/DATA/projects/DSBrepair/data/R") %>% .[grepl("episcreen", .)] %>% tail(n = 1)
file = list.files(in.dir, pattern = "episcreen_ratios", full.names = T) %>% tail(n = 1)
indel.data <- readRDS(file)

# Import data from preprocessing script
in.dir = list.dirs(path = "/DATA/projects/DSBrepair/data/R") %>% .[grepl("episcreen", .)] %>% tail(n = 1)
file.muts = list.files(in.dir, pattern = "episcreen_mutations", full.names = T) %>% tail(n = 1)

mutation.data <- readRDS(file.muts)


label_ratio <- indel.data %>%
  mutate(drug_conc = paste(drug, conc_char, sep = "_")) %>%
  filter(drug_conc %in% c("DMSO_control", "Vorinostat (SAHA, MK0683)_1 µM")) %>% 
  group_by(drug_conc, IPR) %>%
  summarise(MMEJratio_mean = mean(MMEJratio),
            MMEJratio_sd = sd(MMEJratio),
            freqCut_mean = mean(freqCut),
            freqCut_sd = sd(freqCut)) %>%
  ungroup() %>%
  mutate(MMEJratio_mean_global = ave(MMEJratio_mean, drug_conc, FUN = mean)) %>%
  mutate(MMEJratio_sd_global = ave(MMEJratio_mean, drug_conc, FUN = sd)) %>%
  mutate(freqCut_mean_global = ave(freqCut_mean, drug_conc, FUN = mean)) %>%
  mutate(freqCut_sd_global = ave(freqCut_mean, drug_conc, FUN = sd)) %>%
  mutate(label_efficiency = paste0("Total indel frequency = ", round(freqCut_mean_global*100, 1),"% ±", round(freqCut_sd_global*100, 1),"%"), 
         label_ratio = paste0("MMEJ ratio = ", round(MMEJratio_mean_global, 2)," ±", round(MMEJratio_sd_global, 2)))

chrom <- chromatin %>%
  rownames_to_column("IPR")

bc_mut_tib_mean <- mutation.data %>% 
  mutate(drug_conc = paste(drug, conc_char, sep = "_")) %>%
  distinct(IPR, drug_conc, freq_mean,freq_sd, color, mutation, type) %>%
  filter(drug_conc %in% c("DMSO_control", "Vorinostat (SAHA, MK0683)_1 µM"), type %in% c("core", "grouped_indel")) %>% 
  left_join(label_ratio, by = c("drug_conc", "IPR")) %>%
  left_join(chrom, by = "IPR")

ggplot(bc_mut_tib_mean, 
            aes(mutation, freq_mean)) + 
  geom_bar(stat = "identity", aes(fill = color)) + 
  # geom_quasirandom(data = bc_mut_tib, aes(mutation, freq_split, fill = color),  color = "black", shape = 21, ) + 
  scale_fill_manual("legend", values = colors_pathways) + 
  scale_color_manual("legend", values = colors_pathways) + 
  #scale_y_continuous(name="frequency", labels = percent) +
  scale_x_discrete(name="indel size", breaks = c("<-14", -7, 0, 1, ">2")) + 
  facet_wrap( ~ drug_conc, ncol = 1) +
  geom_text(aes(x = 7, y = .7, label = label_efficiency)) +
  geom_text(aes(x = 7, y = .6, label = label_ratio)) + 
  geom_errorbar(aes(ymin=freq_mean-freq_sd, ymax=freq_mean+freq_sd), width=.2,
                position=position_dodge(.9)) +
  theme_pubr(border = T)

ggplot(bc_mut_tib_mean, 
            aes(mutation, freq_mean, color = color, fill = drug_conc)) + 
  geom_boxplot(position = position_dodge(0.75), aes(alpha = 0.7)) +
  geom_quasirandom(dodge.width = 0.75, shape = 21) + 
  scale_fill_manual("legend", values = c("#D69C81", "white")) + 
  scale_color_manual("legend", values = colors_pathways) + 
  #scale_y_continuous(name="frequency", labels = percent) +
  scale_x_discrete(name="indel size", breaks = c("<-14", -7, 0, 1, ">2")) + 
  facet_wrap( ~ chromatin, ncol = 2) +
  geom_text(aes(x = 7, y = .7, label = label_efficiency)) +
  geom_text(aes(x = 7, y = .6, label = label_ratio)) + 
  theme_pubr(border = T)
```


```{r prepare heatmaps, fig.width= 10, fig.height= 20}
clone5.matrix = indel.data %>% 
  dplyr::select(IPR, ends_with(".zscore")) %>% 
  distinct() %>% 
  rename_with(., ~gsub(".zscore", "", .x)) %>%
  column_to_rownames(var="IPR")

clone5_map = hclust(dist(t(clone5.matrix)))
clone5_map_ipr = dendextend::rotate(hclust(dist(clone5.matrix)), c(1:2,5:8,3:4, 15:14, 17, 16, 18 ,13,10:12,9))

chromatin <- readRDS(
  "/DATA/usr/x.vergara/XV_ChIPIndels/XV20200902_DDR_RS_revision/XV20200902_DDR_RS_revision/data/xv20200915_DDR_data_CHIP.rds") %>% 
  distinct(barcode, chromatin) %>%
  left_join(distinct(indel.data, barcode, IPR)) 

chromatin <- chromatin %>%
  filter(IPR != "<NA>") %>% 
  dplyr::select(-barcode) %>%
  column_to_rownames(var="IPR")

# Set annotation for heatmap
viab_drug = indel.data %>% filter(drug != "PAO") %>% 
  mutate(drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " ")) %>% 
  distinct(viab_mean, drug_conc, replicate) %>% group_by(drug_conc) %>%
  summarise(viab = mean(viab_mean))

# Row annotation: annotate drugs with the target group
target <- indel.data %>% 
  # filter(!target %in% c("Negative Control", "MRN", "DNA-PK")) %>%
  mutate(drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " ")) %>%
  left_join(viab_drug) %>%
  distinct(drug_conc, conc_char, target, viab) %>% 
  column_to_rownames(var="drug_conc")

TIF_IPR = indel.data %>% filter(drug == "DMSO") %>%
  distinct(replicate, tech, freqCut,MMEJratio, IPR, well, plate) %>%
  group_by(IPR) %>%
  summarise(TIF = mean(freqCut),
            MMEJratio = mean(MMEJratio))

chromatin_TIF = chromatin %>% rownames_to_column(var = "IPR") %>%
  left_join(TIF_IPR) %>%
  column_to_rownames("IPR")
```



```{r vorinostat synergy}
vorinostat_ratios =  indel.data.validation %>% 
  filter(replicate == "mean" & plasmid == "LBR2" & pool == "AB") %>% 
  distinct(barcode, drug, NHEJ_MMEJ , efficiency) %>% 
  pivot_wider(names_from = drug, values_from = c(efficiency, NHEJ_MMEJ)) %>%
  mutate(diff_efficiency = efficiency_Vorinostat - efficiency_DMSO,
         ratio_efficiency = efficiency_Vorinostat/efficiency_DMSO,
         logFC_NHEJ_MMEJ = log2(NHEJ_MMEJ_Vorinostat / NHEJ_MMEJ_DMSO))  %>%
  filter(!is.na(logFC_NHEJ_MMEJ) & !is.na(ratio_efficiency) & !is.infinite(logFC_NHEJ_MMEJ))

vorinostat_ratios %<>% left_join(unique(indel.data.validation[, c(1, 42:75)]), by = "barcode") %>% distinct(barcode, .keep_all = TRUE)

chromatin.features <- colnames(indel.data.validation)[42:65]

slope.vorinostat.features <- tibble(feature = NA,  term = NA, 
                                    ratio = NA, p.value = NA)

for (j in chromatin.features) {
  model_tib <- vorinostat_ratios
  
  # Pathway balance
  model.ratio.log2 <- lm(formula = logFC_NHEJ_MMEJ ~ unlist(model_tib[j]), 
                         data = model_tib) %>% 
    tidy()
  
  slope.vorinostat.features <- slope.vorinostat.features %>% 
    add_row(feature = j, 
            term = model.indelrate.log2 %>%
              pull(term),
            ratio = model.ratio.log2 %>% 
              pull(estimate), 
            p.value = model.ratio.log2 %>% 
              pull(p.value))
}

# Remove the 1st NA column
slope.vorinostat.features %<>% 
  filter(!is.na(feature)) %>%
  mutate(term = ifelse(term == "(Intercept)", "intercept", "slope"))

# Calculate postition where the linear model crosses y = 0, we do this by -intercept / slope
synergy_tib = slope.vorinostat.features %>% 
  distinct(term, feature, ratio, p.value) %>% 
  pivot_wider(., names_from = term, values_from = c(ratio, p.value)) %>%
  mutate(x_intercept_ratio = -ratio_intercept / ratio_slope,
         p.adj.slope = p.adjust(p.value_slope, method = "fdr"))

synergy_tib %>% 
  mutate(x_intercept_ratio = ifelse(p.adj.slope < 0.05, x_intercept_ratio, NA),
         ratio_slope_plot = ifelse(x_intercept_ratio < 1, ratio_slope, NA)) %>%
  filter(!is.na(ratio_slope_plot))


# pdf(paste0(figure_out, "rs20220210_vorinostat_synergy.pdf"), width=8, height=4)
p1 = vorinostat_ratios %>% ggplot(., aes(H3K27me3, logFC_NHEJ_MMEJ)) + geom_point() + stat_cor() + geom_smooth(method = "lm") + theme_bw(base_size = 16)
p2 = vorinostat_ratios %>% ggplot(., aes(EZH2, logFC_NHEJ_MMEJ)) + geom_point() + stat_cor() + geom_smooth(method = "lm") + theme_bw(base_size = 16)
plot_grid(p1, p2)
# dev.off()
```



```{r}
ratios_tib <- ratios_tib %>%
  left_join(chrom_data)

vorino_screen = ratios_tib %>% filter(drug == "Vorinostat (SAHA, MK0683)") %>% 
  ungroup() %>%
  dplyr::select(all_of(chromatin.features.short), barcode, MMEJratio.log2, DMSO.ratio) %>% 
  dplyr::rename(screen_FC = MMEJratio.log2, DMSO_screen = DMSO.ratio) %>%
  distinct(barcode, screen_FC, H3K27me3, DMSO_screen) %>%
  filter(!is.na(screen_FC))

vorino_pool_screen = vorinostat_ratios %>% 
  mutate(barcode = gsub(".[AB]$", "", barcode)) %>% 
  filter(barcode %in% vorino_screen$barcode) %>% 
  distinct(barcode, logFC_NHEJ_MMEJ, H3K27me3, NHEJ_MMEJ_Vorinostat, NHEJ_MMEJ_DMSO) %>%
  dplyr::rename(H3K27me3_pool = H3K27me3,
                pool_FC = logFC_NHEJ_MMEJ, 
                NHEJratio_pool = NHEJ_MMEJ_Vorinostat, 
                DMSO_pool = NHEJ_MMEJ_DMSO) %>%
  left_join(vorino_screen)

ggplot(vorino_pool_screen, aes(pool_FC, screen_FC)) + 
  geom_point() + 
  stat_cor() + 
  geom_smooth(method = "lm") + 
  xlab("Log2 FC pool") + 
  ylab("Log2 FC screen")

ggplot(vorino_pool_screen, aes(H3K27me3_pool, H3K27me3)) + 
  geom_point() + 
  stat_cor() + 
  geom_smooth(method = "lm") + 
  xlab("Log2 FC pool") + 
  ylab("Log2 FC screen")


#ggplot(vorino_pool_screen, aes(NHEJratio_pool, NHEJratio)) + geom_point() + stat_cor() + geom_smooth(method = "lm") + theme_bw(base_size = 16) + xlab("NHEJ/MMEJ pool") + ylab("NHEJ/MMEJ screen")

ggplot(vorino_pool_screen, aes(DMSO_pool, DMSO_screen)) + 
  geom_point() + 
  stat_cor() + 
  geom_smooth(method = "lm") + 
  xlab("NHEJ/MMEJ pool") +
  ylab("NHEJ/MMEJ screen")
```

```{r}
FC_ttest = indel.data %>% 
  filter(pathway_bal_filter == T) %>%
  distinct(MMEJ_log2_FC, IPR, conc_char, drug, chromatin, replicate, tech) %>% 
  group_by(IPR, drug, conc_char) %>%
  do(tidy(t.test(.$MMEJ_log2_FC))) %>% 
  ungroup() %>%
  mutate(p.adj = p.adjust(p.value, method = "fdr"))


```


```{r}
Vorino_rep_check = indel.data %>% 
  filter(drug == "Vorinostat (SAHA, MK0683)") %>% 
  distinct(MMEJ_log2_FC, IPR, tech, replicate, chromatin) %>% 
  mutate(tech_rep = paste(replicate, tech, sep = "_"))

ggplot(Vorino_rep_check, aes(IPR, MMEJ_log2_FC)) + 
  geom_quasirandom(aes(shape = tech_rep, color = chromatin)) + 
  geom_boxplot(aes(color = chromatin), alpha = 0.2) + ggtitle("Vorinostat MMEJ log2 fold change")


```

```{r}
indel.data %>% pull(drug) %>% unique() %>% .[grepl("MC-1293", .)]

Vorino_rep_check = indel.data %>% 
  filter(drug == "PCI-24781 (Abexinostat)") %>% 
  distinct(MMEJ_log2_FC, IPR, tech, replicate, chromatin) %>% 
  mutate(tech_rep = paste(replicate, tech, sep = "_"))

ggplot(Vorino_rep_check, aes(IPR, MMEJ_log2_FC)) + 
  geom_quasirandom(aes(shape = tech_rep, color = chromatin)) + 
  geom_boxplot(aes(color = chromatin), alpha = 0.2) + ggtitle("PCI-24781 (Abexinostat) MMEJ log2 fold change")


Vorino_rep_check = indel.data %>% 
  filter(drug == "CI994 (Tacedinaline)") %>% 
  distinct(MMEJ_log2_FC, MMEJ_zscore, IPR, tech, replicate, chromatin) %>% 
  mutate(tech_rep = paste(replicate, tech, sep = "_"))

p1 = ggplot(Vorino_rep_check, aes(IPR, MMEJ_log2_FC)) + 
  geom_quasirandom(aes(shape = tech_rep, color = chromatin)) + 
  geom_boxplot(aes(color = chromatin), alpha = 0.2) + ggtitle("CI994 (Tacedinaline) MMEJ log2 fold change")
p2 = ggplot(Vorino_rep_check, aes(IPR, MMEJ_zscore)) + 
  geom_quasirandom(aes(shape = tech_rep, color = chromatin)) + 
  geom_boxplot(aes(color = chromatin), alpha = 0.2) + ggtitle("CI994 (Tacedinaline) MMEJ zscores") +
  geom_hline(linetype = "dashed", yintercept = 1.96) +
  geom_hline(linetype = "dashed", yintercept = -1.96)

plot_grid(p1, p2, ncol = 1)

Vorino_rep_check = indel.data %>% 
  filter(drug == "Scriptaid") %>% 
  distinct(MMEJ_log2_FC, MMEJ_zscore, IPR, tech, replicate, chromatin) %>% 
  mutate(tech_rep = paste(replicate, tech, sep = "_"))

p1 = ggplot(Vorino_rep_check, aes(IPR, MMEJ_log2_FC)) + 
  geom_quasirandom(aes(shape = tech_rep, color = chromatin)) + 
  geom_boxplot(aes(color = chromatin), alpha = 0.2) + ggtitle("Scriptaid MMEJ log2 fold change")
p2 = ggplot(Vorino_rep_check, aes(IPR, MMEJ_zscore)) + 
  geom_quasirandom(aes(shape = tech_rep, color = chromatin)) + 
  geom_boxplot(aes(color = chromatin), alpha = 0.2) + ggtitle("Scriptaid MMEJ zscores") +
  geom_hline(linetype = "dashed", yintercept = 1.96) +
  geom_hline(linetype = "dashed", yintercept = -1.96)

plot_grid(p1, p2, ncol = 1)

Vorino_rep_check = indel.data %>% 
  filter(drug == "Resminostat") %>% 
  distinct(MMEJ_log2_FC, MMEJ_zscore, IPR, tech, replicate, chromatin) %>% 
  mutate(tech_rep = paste(replicate, tech, sep = "_"))

p1 = ggplot(Vorino_rep_check, aes(IPR, MMEJ_log2_FC)) + 
  geom_quasirandom(aes(shape = tech_rep, color = chromatin)) + 
  geom_boxplot(aes(color = chromatin), alpha = 0.2) + ggtitle("Resminostat MMEJ log2 fold change")
p2 = ggplot(Vorino_rep_check, aes(IPR, MMEJ_zscore)) + 
  geom_quasirandom(aes(shape = tech_rep, color = chromatin)) + 
  geom_boxplot(aes(color = chromatin), alpha = 0.2) + ggtitle("Resminostat MMEJ zscores") +
  geom_hline(linetype = "dashed", yintercept = 1.96) +
  geom_hline(linetype = "dashed", yintercept = -1.96)

plot_grid(p1, p2, ncol = 1)

Vorino_rep_check = indel.data %>% 
  filter(drug == "MC-1293") %>% 
  distinct(MMEJ_log2_FC, MMEJ_zscore, IPR, tech, replicate, chromatin) %>% 
  mutate(tech_rep = paste(replicate, tech, sep = "_"))

p1 = ggplot(Vorino_rep_check, aes(IPR, MMEJ_log2_FC)) + 
  geom_quasirandom(aes(shape = tech_rep, color = chromatin)) + 
  geom_boxplot(aes(color = chromatin), alpha = 0.2) + ggtitle("MC-1293 MMEJ log2 fold change")
p2 = ggplot(Vorino_rep_check, aes(IPR, MMEJ_zscore)) + 
  geom_quasirandom(aes(shape = tech_rep, color = chromatin)) + 
  geom_boxplot(aes(color = chromatin), alpha = 0.2) + ggtitle("MC-1293 MMEJ zscores") +
  geom_hline(linetype = "dashed", yintercept = 1.96) +
  geom_hline(linetype = "dashed", yintercept = -1.96)

plot_grid(p1, p2, ncol = 1)
```

```{r}
indel.data %>% pull(drug) %>% unique() %>% .[grepl("MC-1293", .)]

HDAC_followup = indel.data %>% 
  filter(drug %in% c("PCI-24781 (Abexinostat)", "MC-1293", "Resminostat", "Scriptaid", 
                     "CI994 (Tacedinaline)", "PCI-24781 (Abexinostat)", "Vorinostat (SAHA, MK0683)")) %>% 
  distinct(MMEJ_log2_FC, MMEJ_zscore_comb, IPR, chromatin, drug, conc_char) %>% 
  mutate(mean_MMEJ_FC = ave(MMEJ_log2_FC, IPR, conc_char, drug, FUN = mean)) %>%
  distinct(mean_MMEJ_FC, MMEJ_zscore_comb, IPR, chromatin, drug)

p1 = ggplot(HDAC_followup, aes(IPR, mean_MMEJ_FC)) + 
  geom_quasirandom(aes(shape = drug, color = chromatin)) + 
  geom_boxplot(aes(color = chromatin), alpha = 0.2) + ggtitle("PCI-24781 (Abexinostat) MMEJ log2 fold change")
p2 = ggplot(HDAC_followup, aes(IPR, MMEJ_zscore_comb)) + 
  geom_quasirandom(aes(shape = drug, color = chromatin)) + 
  geom_boxplot(aes(color = chromatin), alpha = 0.2) + ggtitle("PCI-24781 (Abexinostat) MMEJ zscores") +
  geom_hline(linetype = "dashed", yintercept = 1.96) +
  geom_hline(linetype = "dashed", yintercept = -1.96)

plot_grid(p1, p2, ncol = 1)
```


```{r}
Vorino_rep_check = indel.data %>% 
  filter(target == "HDAC") %>% 
  distinct(MMEJ_log2_FC, MMEJ_zscore, IPR, tech, replicate, chromatin) %>% 
  mutate(tech_rep = paste(replicate, tech, sep = "_"))

p1 = ggplot(Vorino_rep_check, aes(IPR, MMEJ_log2_FC)) + 
  geom_quasirandom(aes(color = chromatin)) + 
  geom_boxplot(aes(color = chromatin), alpha = 0.2) + ggtitle("HDAC MMEJ log2 fold change")
p2 = ggplot(Vorino_rep_check, aes(IPR, MMEJ_zscore)) + 
  geom_quasirandom(aes(color = chromatin)) + 
  geom_boxplot(aes(color = chromatin), alpha = 0.2) + ggtitle("HDAC MMEJ zscores")

plot_grid(p1, p2, ncol = 1)
```


```{r}
GSK_BIX_molcell_tib <- readRDS("/DATA/projects/DSBrepair/data/R/rs20210311/RSTP2_IndelRatios_Chromatin_2kb.RDS") %>% 
  filter(exp_pool %in% c("mean_RSTP2_2000_LBR2_DMSOGSK_64", 
                         "mean_RSTP2_2000_LBR2_GSK126_64")) 

GSK_fc = GSK_BIX_molcell_tib %>% 
  distinct(barcode, drug, NHEJ, MMEJ) %>%
  mutate(NHEJ_MMEJ = NHEJ/MMEJ) %>%
  dplyr::select(-NHEJ, -MMEJ) %>%
  pivot_wider(values_from = NHEJ_MMEJ, names_from = drug) %>%
  filter(complete.cases(.)) %>%
  mutate(logFC_GSK= log2(GSK126 / DMSO_GSK))  %>%
  filter(!is.na(logFC_GSK) & !is.infinite(logFC_GSK)) %>%
  dplyr::select(barcode, logFC_GSK)

chrom_data_pool = GSK_BIX_molcell_tib %>% dplyr::select(barcode, all_of(chromatin.features)) %>% distinct()

GSK_fc %<>% left_join(chrom_data_pool)

slope.compound.features <- tibble(feature = NA,  term = NA,
                                  ratio = NA, p.value = NA)

for (j in chromatin.features) {
  model_tib <- GSK_fc
  
  # Pathway balance
  model.ratio.log2 <- lm(formula = logFC_GSK ~ unlist(model_tib[j]), 
                         data = model_tib) %>% 
    tidy()
  
  slope.compound.features <- slope.compound.features %>% 
    add_row(feature = j, 
            term = model.ratio.log2 %>%
              pull(term),
            ratio = model.ratio.log2 %>% 
              pull(estimate), 
            p.value = model.ratio.log2 %>% 
              pull(p.value))
}


# Remove the 1st NA column
slope.compound.features %<>% 
  filter(!is.na(feature)) %>%
  mutate(term = ifelse(term == "(Intercept)", "intercept", "slope"))

# Calculate postition where the linear model crosses y = 0, we do this by -intercept / slope
synergy_tib = slope.compound.features %>% 
  distinct(term, feature, ratio, p.value) %>% 
  pivot_wider(., names_from = term, values_from = c(ratio, p.value)) %>%
  mutate(x_intercept_ratio = -ratio_intercept / ratio_slope,
         p.adj.slope = p.adjust(p.value_slope, method = "fdr"))

synergy_tib_filtered = synergy_tib %>% 
  mutate(x_intercept_ratio = ifelse(p.adj.slope < 0.05, x_intercept_ratio, NA),
         ratio_slope_plot = ifelse(x_intercept_ratio < 1, ratio_slope, NA)) %>%
  filter(!is.na(ratio_slope_plot))

synergy_tib_filtered


# pdf(paste0(figure_out, "rs20220210_GSK_schepetal.pdf"), width=8, height=4)
p1 = GSK_fc %>% ggplot(., aes(H3K27me3, logFC_GSK)) + geom_point() + stat_cor() + geom_smooth(method = "lm") + theme_bw(base_size = 16)
p2 = GSK_fc  %>% ggplot(., aes(EZH2, logFC_GSK)) + geom_point() + stat_cor() + geom_smooth(method = "lm") + theme_bw(base_size = 16)
plot_grid(p1, p2)
# dev.off()
```


```{r testing}
test_drug_short = "PJ34"

drug_df <- indel.data %>%
  mutate(drug = gsub(" [(].*[)]", "", drug)) %>%
  filter(drug == test_drug_short) %>%
  # distinct(drug, conc_char, replicate, tech,MMEJratio , MMEJ_log2_FC, viab_mean, barcode)  
  distinct(replicate, tech, conc_char, 
           zscore_bal_global, 
           zscore_bal_global_comb_tech, 
           zscore_bal_global_comb_rep, 
           filter_zscore_bal_global_comb_tech,
           filter_zscore_bal_global_comb_rep)
drug_df

p1 = drug_df %>% 
  pivot_wider(names_from = replicate, values_from = c(MMEJ_log2_FC, viab_mean, MMEJratio)) %>%
  ggplot_custom(.,
                aes(x = MMEJ_log2_FC_E1504, y = MMEJ_log2_FC_E177)) +
  geom_point() +
  geom_abline(lty = "twodash") +
  geom_smooth(method = "lm", color = "red", lty = "dashed") +
  stat_cor(method = "pearson") +
  xlab("MMEJ FC to Control E1504") +
  ylab("MMEJ FC to Contro E177")  +
  facet_grid(. ~ conc_char)

p2 = drug_df %>% 
  pivot_wider(names_from = replicate, values_from = c(MMEJ_log2_FC, viab_mean, MMEJratio)) %>%
  ggplot_custom(.,
                aes(x = MMEJratio_E1504, y = MMEJratio_E177)) +
  geom_point() +
  geom_abline(lty = "twodash") +
  geom_smooth(method = "lm", color = "red", lty = "dashed") +
  stat_cor(method = "pearson") +
  xlab("MMEJ ratio E1504") +
  ylab("MMEJ ratio E177")  +
  facet_grid(. ~ conc_char)
plot_grid(p1, p2, nrow = 2)
```


## Cell cycle analysis
```{r, fig.width = 8, fig.height = 4, eval = FALSE}
# rmarkdown::render("3_Processing_FACS.Rmd")
all.samples = read_csv2("/DATA/usr/m.trauernicht/projects/EpiScreen/FACS/Data/mt20220802_facs_all_drugs.csv")

all.samples <- all.samples %>%
  mutate(drug_conc = paste(drug, conc, sep = " ")) %>%
  mutate(drug_conc_exp = paste(drug, conc, exp, sep = "_")) %>%
  mutate(mean_value = ave(value, drug_conc, variable, exp, FUN = mean)) %>%
  mutate(SD = ave(value, drug_conc, variable, exp, FUN = sd)) %>%
  filter(exp == "effective_drugs") %>%
  distinct(drug, conc, drug_conc_exp, variable, mean_value, SD, value, exp, drug_conc) %>%
  mutate(pval = "")

for (i in unique(all.samples$drug_conc_exp)) {
  if (length(all.samples$value[all.samples$drug_conc_exp == i & all.samples$variable == "G2" & !is.na(all.samples$value)]) > 1) { 
    if (all.samples$exp[all.samples$drug_conc_exp == i] == "five_drugs") {

      all.samples$pval[all.samples$drug_conc_exp == i] <- t.test(all.samples$value[all.samples$drug_conc == "DMSO 10um" & all.samples$exp == "five_drugs" & all.samples$variable == "G2"], 
                                                                 all.samples$value[all.samples$drug_conc_exp == i & all.samples$variable == "G2"])$p.value
      } else {
        all.samples$pval[all.samples$drug_conc_exp == i] <- t.test(all.samples$value[all.samples$drug_conc == "DMSO 10um" & all.samples$exp == "effective_drugs" & all.samples$variable == "G2"], 
                                                               all.samples$value[all.samples$drug_conc_exp == i & all.samples$variable == "G2"])$p.value
  }
  }
}

all.samples <- all.samples %>%
  dplyr::select(-value) %>%
  distinct()

vadj.G2 = all.samples %>% filter(variable %in% c("G2", "S", "G1")) %>% group_by(drug_conc_exp) %>% summarise(vadj = sum(mean_value)) %>% mutate(variable = "G2")
vadj.S = all.samples %>% filter(variable %in% c("S", "G1")) %>% group_by(drug_conc_exp) %>% summarise(vadj = sum(mean_value)) %>% mutate(variable = "S")
vadj.G1 = all.samples %>% filter(variable %in% c("G1")) %>% group_by(drug_conc_exp) %>% summarise(vadj = sum(mean_value)) %>% mutate(variable = "G1")

vadj.tib = rbind(vadj.G1, vadj.S, vadj.G2) %>% na.omit()
targets <- target_set_drugs %>% 
  distinct(drug, target)

all.samples.plot = all.samples  %>%
  as_tibble() %>%
  filter(variable != "Apoptotic cells") %>%
  left_join(vadj.tib) %>%
  left_join(targets, by = "drug") %>%
  mutate(variable = factor(variable, levels = c("G2", "S", "G1")),
         target = ifelse(drug == "CX-6258", "PIM",
                         ifelse(drug == "DMSO", "Vehicle",
                                ifelse(drug == "DZNeP", "HMT",
                                       ifelse(drug == "Suramin", "Sirtuin",target))))) %>%
  na.omit()


#aurk.inhibitors <- c("Alisertib 100 nM", "Aurora A Inhibitor I 1 µM", "Barasertib 1 µM", "CYC116 1 µM", "SNS-314 Mesylate 10 µM")

g2_order <- all.samples.plot %>%
  filter(variable == "G2") %>%
  dplyr::select(drug_conc_exp, "g2_value" = mean_value) %>%
  distinct()

all.samples.plot <- merge(all.samples.plot, g2_order, all = T)

drugs_order <- all.samples.plot %>%
  distinct(drug_conc, g2_value) %>%
  filter(str_detect(drug_conc, "DMSO", negate = T)) %>%
  arrange(desc(g2_value))

all.samples.plot <- all.samples.plot %>% 
  filter(drug != "PAO") %>%
  mutate(drug_conc = factor(drug_conc, levels = c("DMSO 10um", drugs_order$drug_conc)))

ggplot(all.samples.plot, aes(y = mean_value, x = drug_conc)) +
  geom_linerange(aes(ymin = vadj, ymax = vadj+SD, color = target), size = 1) +
  geom_bar(stat="identity", aes(alpha = variable, fill = target), color = ifelse(all.samples.plot$pval < 0.05, "grey40", NA), size = .5, width = .75) +
  labs(title = "cell cycle arrest upon treatment with Aurora Kinase inhibitors") +
  scale_color_manual(values = annotation_colors_scr$target) +
  scale_fill_manual(values = annotation_colors_scr$target) +
  scale_alpha_discrete(range = c(0.3,1)) +
  theme_pubr(border = T, x.text.angle = 90)

all.samples %>%
  ggplot(., aes(y = mean_value, x = conc, color = target)) +
  geom_line()+
  geom_pointrange(aes(ymin=mean_value, ymax=mean_value+SD)
                  #, position = position_dodge(width = 0.1)
                  ) +
  geom_hline(yintercept = 0.08419397, lty = "dashed") + 
  ylim(0,0.7) +
  gghighlight(pval < 0.05, label_key = drug_conc) +
  scale_color_manual(values = colors_targets) 


all.samples = read_csv2("/DATA/usr/m.trauernicht/projects/EpiScreen/FACS/Data/mt20220802_facs_all_drugs.csv")

all.samples <- all.samples %>%
  mutate(drug_conc = paste(drug, conc, sep = "_")) %>%
  mutate(drug_conc_exp = paste(drug, conc, exp, sep = "_")) %>%
  mutate(mean_value = ave(value, drug_conc, variable, exp, FUN = mean)) %>%
  mutate(SD = ave(value, drug_conc, variable, exp, FUN = sd)) %>%
  filter(variable == "G2") %>%
  dplyr::select(-variable) %>%
  na.omit() %>%
  mutate(pval = "")



pval_list <- list()
for (i in unique(all.samples$drug_conc_exp)) {
  if (all.samples$exp[all.samples$drug_conc_exp == i] == "five_drugs") {
    all.samples$pval[all.samples$drug_conc_exp == i] <- t.test(all.samples$value[all.samples$drug_conc == "DMSO_10um" & all.samples$exp == "five_drugs"], 
                                                               all.samples$value[all.samples$drug_conc_exp == i])$p.value
  } else {
    all.samples$pval[all.samples$drug_conc_exp == i] <- t.test(all.samples$value[all.samples$drug_conc == "DMSO_10um" & all.samples$exp == "effective_drugs"], 
                                                               all.samples$value[all.samples$drug_conc_exp == i])$p.value
  }
}

target_set_drugs2 <- target_set_drugs %>% distinct(drug, target)

all.samples <- all.samples %>%
  dplyr::select(-value) %>%
  mutate(pval_adj = p.adjust(pval, method = "fdr")) %>%
  left_join(target_set_drugs2) %>%
  distinct()

all.samples %>%
  ggplot(., aes(y = mean_value, x = conc, color = target)) +
  geom_quasirandom() +
 #geom_hline(yintercept = 0.08419397, lty = "dashed") + 
  ylim(0,0.7) +
  gghighlight(pval < 0.05 & mean_value > 0.2, label_key = drug_conc) +
  scale_color_manual(values = colors_targets) 

other_drugs <- unique(all.samples.plot$drug_conc[all.samples.plot$drug_conc != "DMSO 10 µM" & all.samples.plot$target != "Aurora Kinase"])
all.samples.plot %>% filter(!target %in% c("Aurora Kinase"), ID == "LBR2") %>%
mutate(drug_conc = factor(drug_conc, levels = c("DMSO 10 µM", other_drugs))) %>%
ggplot(., aes(y = mean_value, x = drug_conc, fill = variable)) +
  geom_bar(stat="identity") + 
   geom_errorbar(aes(ymin = vadj-SD, ymax = vadj+SD, color = variable), width = 0.2, size = 1.5)+
  labs(title = "cell cycle arrest upon treatment with Aurora Kinase inhibitors", 
       x = "GFP/LBR2 transfection", y = "G1, S, and G2 fractions") + 
  scale_fill_manual(values = c("grey80","grey60","grey40")) +
  scale_color_manual(values = c("grey80","grey60","grey40")) +
  theme_pubr(border = T, x.text.angle = 45)
```

```{r, fig.width = 4, fig.height = 4}
# Barplot of each drug next to each other
all.samples.plot %>% filter(target %in% c("Vehicle")) %>%
ggplot(., aes(y = mean_value, x = ID, fill = variable)) +
  geom_bar(stat="identity") + 
   geom_errorbar(aes(ymin = vadj-SD, ymax = vadj+SD, color = variable), width = 0.2)+
  labs(title = "Cll cycle distribution in control setting", 
       x = "GFP/LBR2 transfection", y = "G1, S, and G2 fractions") + 
  scale_fill_manual(values = c("#DED89C","#BF7538","#749075"))
```


## HDACi only heatmap
```{r}
HDAC_tib = read.table("rs20220708_HDAC_targets.txt", sep = "\t", fill = NA, header = T) %>%
  dplyr::select(-target_main, -target_second) %>%
  as_tibble()

cluster1 = target_all %>% filter(target == "HDAC") %>% rownames()
cluster1 = cluster1[!grepl("Nullscript", cluster1)]

top_50_hits_hdacs <- top_50_hits %>%
  mutate(drug_conc = paste(drug, conc_char, sep = " "))

eff.data.heatmap.cluster1 = balance.data.heatmap2 %>% 
  mutate(drug_conc = paste(drug, conc_char, sep = " ")) %>% 
  filter(drug_conc %in% cluster1) %>%
  filter(drug_conc %in% top_50_hits_hdacs$drug_conc) 

# Add cluster annotation
cluster_HDAC <- hclust(dist(eff.data.heatmap.cluster1), method = "ward.D")
cluster_HDAC <- cutree(tree = cluster_HDAC, k = 2)
cluster_HDAC <- data.frame(cluster_HDAC)

eff.data.heatmap.cluster1 <- cbind(eff.data.heatmap.cluster1, cluster_HDAC) %>% 
  as_tibble()

cluster_HDAC <- eff.data.heatmap.cluster1 %>%
  distinct(drug_conc, cluster_HDAC)

target.cluster1 <- target_set_drugs %>%
  rownames_to_column("drug_conc") %>%
  left_join(HDAC_tib) %>%
  left_join(cluster_HDAC) %>%
  filter(!is.na(cluster_HDAC)) %>%
  replace(is.na(.), 0)

rownames(target.cluster1) <- target.cluster1$drug_conc
target.cluster1 <- target.cluster1 %>%
  dplyr::select(cluster_HDAC, conc_char, pan_HDAC, HDAC1,HDAC2, HDAC3,
                HDAC4, HDAC6, HDAC8, HDAC10, viab)

target.cluster1

HDAC_matrix = eff.data.heatmap.cluster1 %>%
  arrange(target.cluster1) %>%
  column_to_rownames('drug_conc') %>%
  dplyr::select(contains('IPR')) %>%
  t()

breaks <- quantile(unlist(balance.data.heatmap2 %>% 
                            dplyr::select(contains('IPR'))), c(.05,.95), na.rm = T) # change these numbers according to where you want to set the cutoff
palette_length <- 100

myBreaks <- c(seq(breaks[1], 0, length.out=ceiling(palette_length/2) + 1), 
              seq(-breaks[1]/palette_length, -breaks[1], length.out=floor(palette_length/2)))


# pdf(paste0(figure_out, "rs20220623_indelfrequency_heatmap_HDAC.pdf"), width=16, height=8)
plt3 = pheatmap(HDAC_matrix[clone5_map_ipr$labels,],
                border_color = F,
                cellwidth = 8,
                cellheight = 8,
                breaks = myBreaks,
                cluster_rows = clone5_map_ipr,
                cluster_cols = T,
                angle_col = 90,
                na_col = "white",
                clustering_method = "ward.D",
                main = 'MMEJ ratio FC (log2), all concentrations',
                annotation_col = target.cluster1,
                annotation_row = chromatin,
                color = diverge_hcl(palette_length, "Blue-Red"),
                annotation_colors = annotation_colors_scr,
                annotation_legend = T,
                cutree_cols = 2)
```





## Plot HDAC inhibitor effects on different chromatin types
```{r, fig.width = 4, fig.height = 4}
chromatin_ipr <- chromatin %>%
  rownames_to_column("IPR")

balance.data.heatmap3 <- balance.data.heatmap2 %>%
  pivot_longer(cols = contains("IPR"), names_to = "IPR", values_to = "MMEJratio_FC")

chromatin_effect <- left_join(balance.data.heatmap3, chromatin_ipr) %>%
  #filter(target == "HDAC") %>%
  mutate(MMEJratio_FC = ave(MMEJratio_FC, drug, chromatin, conc_char, FUN = function(x) mean(x, na.rm = TRUE)),
         drug_conc = paste(drug, conc_char, sep = " ")) %>%
  distinct(MMEJratio_FC, drug, chromatin, conc_char, target, drug_conc)

clusters_drugs = target_set_all # %>% filter(clusters_drugs %in% c(3, 4))


chromatin_effect <- left_join(clusters_drugs, chromatin_effect)

ggplot(chromatin_effect,
       aes(x = chromatin, y = MMEJratio_FC, fill = chromatin)) +
  geom_boxplot(outlier.shape = NA) +
  geom_quasirandom() +
  geom_signif(comparisons = combn(sort(unique(chromatin_effect$chromatin)), 2, simplify = F), 
              map_signif_level=sigFunc, 
              step_increase = 0.1) +
  theme_classic_lines_45() +
  scale_fill_manual(values = group_colors) +
  theme(legend.position = "none") +
  facet_wrap(~ clusters_drugs, nrow = 1)
```




## D: Correlation of MMEJ-ratio z-score with Efficiency z-score
Do the changes in MMEJ-ratio change correlate with changes in efficiency? Can MMEJ changes be explained by opened up/closed chromatin?

```{r, fig.width = 8, fig.height = 8,  warning = F}
for (i in unique(indel.data$target)[-1]) {
  
  x <- indel.data %>%
    filter(sample == "Epigenetic Compound") %>%
    filter(target == i) %>%
    mutate(mean_eff_pval_global_comb = 2*pnorm(q = abs(zscore_TIF_global_comb_rep), lower.tail = F)) %>%
    mutate(mean_eff_pval_adj_global_comb = p.adjust(mean_eff_pval_global_comb, method = 'fdr')) %>%
    filter(mean_eff_pval_adj_global_comb < 0.01) %>%
    distinct(MMEJratio_norm, freqCut_norm_mean, drug, conc_char, target, IPR) %>%
    mutate(MMEJratio_norm = log2(ave(MMEJratio_norm, drug, conc_char, IPR, FUN = function(x) mean(x, na.rm=T)))) %>%
    mutate(freqCut_norm_mean = log2(ave(freqCut_norm_mean, drug, conc_char, IPR, FUN = function(x) mean(x, na.rm=T)))) %>%
    distinct() %>%
    mutate(drug_conc = paste(drug, conc_char, sep = "_")) %>%
    filter(!is.na(MMEJratio_norm))
  
  if (length(unique(x$drug_conc)) > 1) {
  p<- ggplot(x ,
       aes(x = MMEJratio_norm, y = freqCut_norm_mean)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(~drug_conc) +
  stat_cor(method = "spearman") +
  ggtitle(paste("efficiency vs. mmej-ratio per target group", i))
  
  print(p)
  }
}

ggplot_custom(indel.data %>%
    filter(sample == "Epigenetic Compound") %>%
    filter(drug == "PCI-24781 (Abexinostat)", conc_char == "100 nM") %>%
    mutate(mean_eff_pval_global_comb = 2*pnorm(q = abs(zscore_TIF_global_comb_rep), lower.tail = F)) %>%
    mutate(mean_eff_pval_adj_global_comb = p.adjust(mean_eff_pval_global_comb, method = 'fdr')) %>%
    filter(mean_eff_pval_adj_global_comb < 0.001) %>%
    distinct(MMEJratio_norm, freqCut_norm_mean, drug, conc_char, target, IPR) %>%
    mutate(MMEJratio_norm = log2(ave(MMEJratio_norm, drug, conc_char, IPR, FUN = function(x) mean(x, na.rm=T)))) %>%
    mutate(freqCut_norm_mean = log2(ave(freqCut_norm_mean, drug, conc_char, IPR, FUN = function(x) mean(x, na.rm=T)))) %>%
    mutate(drug_conc = paste(drug, conc_char, sep = "_")),
    aes(x = MMEJratio_norm, y = freqCut_norm_mean)) +
  geom_point() +
  geom_smooth(method = "lm") +
  stat_cor(method = "spearman") +
  ggtitle("efficiency vs. mmej-ratio per target group")


eff_mmej_corr <- indel.data %>%
  filter(sample == "Epigenetic Compound") %>%
  filter(abs(zscore_TIF_global_comb_rep) > 4) %>%
  filter(abs(zscore_bal_global_comb_rep) > 4) %>%
  distinct(MMEJratio_norm, freqCut_norm_mean, drug, conc_char, target, IPR) %>%
  mutate(MMEJratio_norm = log2(ave(MMEJratio_norm, drug, conc_char, IPR, FUN = function(x) mean(x, na.rm=T)))) %>%
  mutate(freqCut_norm_mean = log2(ave(freqCut_norm_mean, drug, conc_char, IPR, FUN = function(x) mean(x, na.rm=T)))) %>%
  mutate(drug_conc = paste(drug, conc_char, sep = "_")) %>%
  mutate(slope = NA, term = NA, p.value = NA)

for (i in unique(eff_mmej_corr$drug_conc)) {
    model.correlation <- lm(formula = MMEJratio_norm ~ freqCut_norm_mean, 
                               data = eff_mmej_corr[eff_mmej_corr$drug_conc == i,]) %>% 
      tidy()
    
    eff_mmej_corr$slope[eff_mmej_corr$drug_conc == i] <- 
      model.correlation$estimate
    
    eff_mmej_corr$term[eff_mmej_corr$drug_conc == i] <- 
      model.correlation$term
    
    eff_mmej_corr$p.value[eff_mmej_corr$drug_conc == i] <- 
      model.correlation$p.value
}



```

```{r, fig.width = 4, fig.height = 4}
eff_mmej_corr_heatmap <- eff_mmej_corr %>%
  filter(term != "(Intercept)") %>%
  mutate(p.value = p.adjust(p.value, method = "fdr")) %>%
  #filter(p.value < 0.05) %>%
  dplyr::select(-term, -IPR, -freqCut_norm_mean, -MMEJratio_norm) %>%
  distinct()

ggplot_custom(eff_mmej_corr_heatmap %>%
                mutate(mean_slope = ave(slope, target, FUN = function(x) mean(x, na.rm=T))),
              aes(x = reorder(target, slope), y = slope)) +
  geom_boxplot(alpha = 0.4, outlier.shape = NA) +
  geom_quasirandom(aes(color = ifelse(p.value < 0.05, "green", "black"))) +
  theme_classic_lines_90()

```

```{r, fig.width = 4, fig.height = 4}
eff_mmej_corr_heatmap_plot <- indel.data %>%
  mutate(drug_conc = paste(drug, conc_char, sep = "_")) %>%
  filter(drug_conc %in% eff_mmej_corr_heatmap$drug_conc) %>%
  distinct(MMEJratio_norm, freqCut_norm_mean, drug_conc, conc_char, target, IPR) %>%
  mutate(MMEJratio_norm = log2(ave(MMEJratio_norm, drug_conc, IPR, FUN = function(x) mean(x, na.rm=T)))) %>%
  mutate(freqCut_norm_mean = log2(ave(freqCut_norm_mean, drug_conc, IPR, FUN = function(x) mean(x, na.rm=T)))) %>%
  distinct()

pval <- eff_mmej_corr_heatmap %>%
  distinct(drug_conc, p.value, slope)

eff_mmej_corr_heatmap_plot <- merge(eff_mmej_corr_heatmap_plot, pval)

eff_mmej_corr_heatmap_plot <- eff_mmej_corr_heatmap_plot %>%
         filter(target %in% c("HDAC", "Aurora Kinase", "Epigenetic Reader Domain"))

ggplot(eff_mmej_corr_heatmap_plot,
       aes(x = MMEJratio_norm, y = freqCut_norm_mean, group = drug_conc)) +
  geom_abline(linetype = "twodash") +
  geom_vline(xintercept = 0) +
  geom_hline(yintercept = 0) +
  geom_point(alpha = 0.1, aes(color = ifelse(p.value < 0.05 & slope < -0.1, "green", 
                                                       ifelse(p.value < 0.05 & slope > 0.1, "yellow","blue")))) +
  geom_smooth(method = "lm", se = F, aes(color = ifelse(p.value < 0.05 & slope < -0.1, "green", 
                                                       ifelse(p.value < 0.05 & slope > 0.1, "yellow","blue")))) +
  facet_wrap(~target, nrow = 3) +
  ggtitle("efficiency vs. mmej-ratio per target group") +
  scale_color_manual(values = c("#C2C2C2", "#3d405b", "#e07a5f")) 
```

## Vorinostat and GSK changes to pathway balance

```{r eval = FALSE}
## Vorinostat
chrom.mods.cols <- seq(grep("CTCF", names(vorinostat_ratios)), grep("H3K27me3_domain", names(vorinostat_ratios))-1)

vorinostat.hist.corr <- CorrelationDFMean(vorinostat_ratios, "log2_FC_MMEJ_NHEJ", targets = chrom.mods.cols) %>%
  arrange(corr) %>% pull(rowname) %>% factor(.,levels = .)

lims = 1

CorrelationPlotMean(vorinostat_ratios, "log2_FC_MMEJ_NHEJ", targets = vorinostat.hist.corr, title = "with log2 FC balance after Vorinostat treatment")

## GSK126
chrom.mods.cols <- seq(grep("CTCF", names(GSK_ratios)), grep("H3K27me3_domain", names(GSK_ratios))-1)

GSK.hist.corr <- CorrelationDFMean(GSK_ratios, "log2_FC_MMEJ_NHEJ", targets = chrom.mods.cols) %>%
  arrange(corr) %>% pull(rowname) %>% factor(.,levels = .)

lims = 1

CorrelationPlotMean(GSK_ratios, "log2_FC_MMEJ_NHEJ", targets = GSK.hist.corr, title = "with log2 FC balance after GSK126 treatment")
```

 Vorinostat & GSK126 validations

```{r}
vorinostat_validation = indel.validation.data %>% 

  filter(replicate == "mean" & plasmid == "LBR2", drug %in% c("DMSO", "Vorinostat"), sum_bc_reads > 1000)%>% 
  dplyr::select(barcode, drug, MMEJ_NHEJ, efficiency, all_of(chromatin_cols)) %>%
  distinct() 

barcde_all_reps_vorino = vorinostat_validation %>% 
  distinct(barcode, drug) %>% 
  group_by(barcode) %>%
  summarise(bccount = n()) %>% 
  filter(bccount == 2) %>%
  pull(barcode)

vorinostat_ratios = vorinostat_validation  %>% 
  filter(barcode %in% barcde_all_reps_vorino) %>%
  pivot_wider(names_from = drug, values_from = c(efficiency, MMEJ_NHEJ)) %>%
  mutate(diff_TIF = efficiency_Vorinostat - efficiency_DMSO,
         ratio_TIF = efficiency_Vorinostat/efficiency_DMSO,
         log2_FC_TIF = log2(ratio_TIF),
         diff_MMEJ_NHEJ = MMEJ_NHEJ_Vorinostat - MMEJ_NHEJ_DMSO,
         ratio_MMEJ_NHEJ = MMEJ_NHEJ_Vorinostat/MMEJ_NHEJ_DMSO,
         log2_FC_MMEJ_NHEJ = log2(ratio_MMEJ_NHEJ)) 

barcde_all_reps_gsk = RSTP2_IndelRatios_Chromatin_2kb %>% 
  distinct(barcode, drug) %>% 
  group_by(barcode) %>%
  summarise(bccount = n()) %>% 
  filter(bccount == 2) %>%
  pull(barcode)

GSK_ratios = RSTP2_IndelRatios_Chromatin_2kb %>% 
  filter(barcode %in% barcde_all_reps_gsk) %>%
  # distinct(barcode, drug, MMEJ_NHEJ , efficiency) %>% 
  pivot_wider(names_from = drug, values_from = c(efficiency, MMEJ_NHEJ)) %>%
  mutate(diff_TIF = efficiency_GSK126 - efficiency_DMSO_GSK,
         ratio_TIF = efficiency_GSK126/efficiency_DMSO_GSK,
         log2_FC_TIF = log2(ratio_TIF),
         diff_MMEJ_NHEJ = MMEJ_NHEJ_GSK126 - MMEJ_NHEJ_DMSO_GSK,
         ratio_MMEJ_NHEJ = MMEJ_NHEJ_GSK126/MMEJ_NHEJ_DMSO_GSK,
         log2_FC_MMEJ_NHEJ = log2(ratio_MMEJ_NHEJ))

vorinostat_ctrl <- vorinostat_ratios %>%
  distinct(efficiency_DMSO, barcode)

GSK_ratios <- GSK_ratios %>%
  distinct(efficiency_DMSO_GSK, barcode)

ctrl_compare <- merge(vorinostat_ctrl, GSK_ratios, by = "barcode")

ggplot(ctrl_compare,
       aes(x = efficiency_DMSO, y = efficiency_DMSO_GSK)) +
  geom_point() +
  geom_smooth(method = "lm")

```

## S3B GSK TIF FC correlation with chromatin features
```{r S3B GSK TIF FC Correlations}
## GSK126
chrom.mods.cols <- seq(grep("CTCF", names(GSK_ratios)), grep("H3K27me3_domain", names(GSK_ratios))-1)

GSK.hist.corr <- CorrelationDFMean(GSK_ratios, "log2_FC_TIF", targets = chrom.mods.cols) %>%
  arrange(corr) %>% pull(rowname) %>% factor(.,levels = .)

lims = 1

CorrelationPlotMean(GSK_ratios, "log2_FC_TIF", targets = GSK.hist.corr, title = "with log2 FC TIF after GSK126 treatment")
```

## S3C Vorinostat TIF FC correlation with chromatin features
```{r S3C Vorino TIF FC Correlations}
## Vorinostat
chrom.mods.cols <- seq(grep("CTCF", names(vorinostat_ratios)), grep("H3K27me3_domain", names(vorinostat_ratios))-1)

vorinostat.hist.corr <- CorrelationDFMean(vorinostat_ratios, "log2_FC_TIF", targets = chrom.mods.cols) %>%
  arrange(corr) %>% pull(rowname) %>% factor(.,levels = .)

lims = 1

CorrelationPlotMean(vorinostat_ratios, "log2_FC_TIF", targets = vorinostat.hist.corr, title = "with log2 FC TIF after Vorinostat treatment")
```


## S3D Vorinostat per cluster
```{r S3D Vorino density, fig.height=5, fig.width=7}
domain_levels = c('late_replicating', 'LAD', 'H3K9me2', 'H3K27me3')

domains = paste0(domain_levels, '_domain')

vorino.dt = vorinostat_ratios %>%
  filter(!is.na(ratio_MMEJ_NHEJ)) %>%
  dplyr::select(barcode, ratio_MMEJ_NHEJ, log2_FC_MMEJ_NHEJ, domains) %>%
  distinct(barcode, .keep_all = TRUE) %>%
  data.table()

dim(vorino.dt)


vorino.dt[vorino.dt=='iDomain'] <- 0
vorino.dt[vorino.dt=='Domain'] <- 1
vorino.dt[vorino.dt=='DHS'] <- 1

vorino.dt[is.na(LAD_domain), LAD_domain:=0]
# vorino.dt[is.na(DHS_domain), DHS_domain:=0]

vorino.dt[, (domains) := lapply(.SD, as.numeric), .SDcols = domains]

colnames(vorino.dt) = gsub('_domain', '', colnames(vorino.dt))

opt_df = get_combinations(domain_levels)

# Ratio of SSTR vs MME
# p1 = plot_comb_grid_beeswarm(vorino.dt, opt_df,
#                         domain_levels, 'diff_TIF', min_count = 10, y_plabel=c(-.2, .2))
# p2 = plot_comb_grid_beeswarm(vorino.dt, opt_df,
#                         domain_levels, 'ratio_MMEJ_NHEJ', min_count = 10, y_plabel=c(-2.5, 2.5))
# p3 = plot_comb_grid_beeswarm(vorino.dt, opt_df,
#                         domain_levels, 'log2_FC_MMEJ_NHEJ', min_count = 10, y_plabel=c(-2.5, 2.5))
# p4 = plot_comb_grid_beeswarm(vorino.dt, opt_df,
#                         domain_levels, 'log2_FC_TIF', min_count = 10, y_plabel=c(-.5, .5))
# 
# plot_grid(p1, p2, p3, p4, labels = c("ΔTIF", "M/N", "LogBal", "LogTIF"))

k27me3 = vorino.dt %>% filter(late_replicating == 0, 
                             LAD == 0,
                             H3K9me2 == 0,
                             H3K27me3 == 1) %>% 
  pull(log2_FC_MMEJ_NHEJ)

any.k27me3 = vorino.dt %>% filter(H3K27me3 == 1) %>% 
  pull(log2_FC_MMEJ_NHEJ)

not.k27me3 = vorino.dt %>% filter(H3K27me3 != 1) %>% 
  pull(log2_FC_MMEJ_NHEJ)

hetcomb = vorino.dt %>% filter(late_replicating == 1, 
                              LAD == 1,
                              H3K9me2 == 1,
                              H3K27me3 == 0) %>% 
  pull(log2_FC_MMEJ_NHEJ)

idomain = vorino.dt %>% filter(late_replicating == 0, 
                              LAD == 0,
                              H3K9me2 == 0,
                              H3K27me3 == 0) %>% 
  pull(log2_FC_MMEJ_NHEJ)

# DHS = vorino.dt %>% filter(late_replicating == 0,
#                           LAD == 0,
#                           H3K9me2 == 0,
#                           H3K27me3 == 0,
#                           DHS == 1) %>%
#   pull(diff_TIF)

wilcox.test(idomain, k27me3, alternative = "two.sided")

wilcox.test(idomain, any.k27me3, alternative = "two.sided")
wilcox.test(not.k27me3, any.k27me3, alternative = "two.sided")

wilcox.test(idomain, hetcomb, alternative = "two.sided")

vorino.dt %>% mutate(state = ifelse(late_replicating == 1 & 
                                      LAD == 1 &
                                      H3K9me2 == 1 &
                                      H3K27me3 == 0, "Triple Heterochromatin", ifelse(
                                        late_replicating == 0 & 
                                          LAD == 0 & 
                                          H3K9me2 == 0 & 
                                          H3K27me3 == 0, "Euchromatin", ifelse(late_replicating == 0 &  
                                                                                 LAD == 0 & 
                                                                                 H3K9me2 == 0 & 
                                                                                 H3K27me3 == 1, "H3K27me3", "other-heterochromatin")))) %>%
  mutate(state = factor(state, levels = c("Euchromatin", "other-heterochromatin", "H3K27me3", "Triple Heterochromatin"))) %>%
  ggplot(., aes(log2_FC_MMEJ_NHEJ, fill = state)) +
  geom_density(alpha = 0.6, color = "white", size = .25) +
  scale_fill_manual(values = group_colors)

vorino.dt %>% mutate(state = ifelse(late_replicating == 1 & 
                                      LAD == 1 &
                                      H3K9me2 == 1 &
                                      H3K27me3 == 0, "Triple Heterochromatin", ifelse(
                                        late_replicating == 0 & 
                                          LAD == 0 & 
                                          H3K9me2 == 0 & 
                                          H3K27me3 == 0, "Euchromatin", ifelse(late_replicating == 0 &  
                                                                                 LAD == 0 & 
                                                                                 H3K9me2 == 0 & 
                                                                                 H3K27me3 == 1, "H3K27me3", "other-heterochromatin")))) %>%
  mutate(state = factor(state, levels = c("Euchromatin", "other-heterochromatin", "H3K27me3", "Triple Heterochromatin"))) %>%
  ggplot(., aes(log2_FC_MMEJ_NHEJ, color = state)) +
  stat_ecdf() +
  scale_color_manual(values = group_colors)


vorinostat_df <- vorino.dt %>% mutate(state = ifelse(late_replicating == 1 & 
                                                       LAD == 1 &
                                                       H3K9me2 == 1 &
                                                       H3K27me3 == 0, "Triple Heterochromatin", ifelse(
                                                         late_replicating == 0 & 
                                                           LAD == 0 & 
                                                           H3K9me2 == 0 & 
                                                           H3K27me3 == 0, "Euchromatin", ifelse(late_replicating == 0 &  
                                                                                                  LAD == 0 & 
                                                                                                  H3K9me2 == 0 & 
                                                                                                  H3K27me3 == 1, "H3K27me3", "other-heterochromatin")))) %>%
  distinct(barcode, "vorinostat_mmej_FC" = log2_FC_MMEJ_NHEJ)


gsk_df <- GSK.dt %>% mutate(state = ifelse(late_replicating == 1 & 
                                             LAD == 1 &
                                             H3K9me2 == 1 &
                                             H3K27me3 == 0, "Triple Heterochromatin", ifelse(
                                               late_replicating == 0 & 
                                                 LAD == 0 & 
                                                 H3K9me2 == 0 & 
                                                 H3K27me3 == 0, "Euchromatin", ifelse(late_replicating == 0 &  
                                                                                        LAD == 0 & 
                                                                                        H3K9me2 == 0 & 
                                                                                        H3K27me3 == 1, "H3K27me3", "other-heterochromatin")))) %>%
  distinct(barcode, "gsk_mmej_FC" = log2_FC_MMEJ_NHEJ, state)

vorino_gsk_compare <- merge(vorinostat_df, gsk_df, by = "barcode")

ggplot(vorino_gsk_compare,
       aes(x = gsk_mmej_FC, y = vorinostat_mmej_FC)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(~state) 
```


```{r}
p1 = plot_comb_grid_beeswarm(vorino.dt, opt_df,
                        domain_levels, 'log2_FC_MMEJ_NHEJ', min_count = 10, y_plabel=c(-2, 2))
p2 = plot_comb_grid_beeswarm(GSK.dt, opt_df,
                        domain_levels, 'log2_FC_MMEJ_NHEJ', min_count = 10, y_plabel=c(-2, 2))
plot_grid(p1, p2, labels = c("Balance HDACi", "Balance EZH2i"))
```

## S3E Vorinostat per cluster
```{r S3E GSK density, fig.height=6, fig.width=6}
domain_levels = c('late_replicating', 'LAD', 'H3K9me2', 'H3K27me3')

domains = paste0(domain_levels, '_domain')

GSK.dt = GSK_ratios %>%
  filter(!is.na(diff_TIF)) %>%
  dplyr::select(barcode, log2_FC_MMEJ_NHEJ, ratio_MMEJ_NHEJ, log2_FC_TIF, efficiency_GSK126, efficiency_DMSO_GSK, domains) %>%
  distinct(barcode, .keep_all = TRUE) %>%
  data.table()

dim(GSK.dt)

GSK.dt[GSK.dt=='iDomain'] <- 0
GSK.dt[GSK.dt=='Domain'] <- 1
GSK.dt[GSK.dt=='DHS'] <- 1

GSK.dt[is.na(LAD_domain), LAD_domain:=0]
# GSK.dt[is.na(DHS_domain), DHS_domain:=0]

GSK.dt[, (domains) := lapply(.SD, as.numeric), .SDcols = domains]

colnames(GSK.dt) = gsub('_domain', '', colnames(GSK.dt))

opt_df = get_combinations(domain_levels)

# Ratio of SSTR vs MME
# p1 = plot_comb_grid_beeswarm(GSK.dt, opt_df,
#                         domain_levels, 'diff_TIF', min_count = 10, y_plabel=c(-.25, .25))
# p1 = plot_comb_grid_beeswarm(GSK.dt, opt_df,
#                         domain_levels, 'ratio_MMEJ_NHEJ', min_count = 10, y_plabel=c(-2, 2))
# p1 = plot_comb_grid_beeswarm(GSK.dt, opt_df,
#                         domain_levels, 'log2_FC_MMEJ_NHEJ', min_count = 10, y_plabel=c(-1.5, 1.5))
# p1 = plot_comb_grid_beeswarm(GSK.dt, opt_df,
#                         domain_levels, 'log2_FC_TIF', min_count = 10, y_plabel=c(-1.5, 1.5))
# 
# plot_grid(p1, p2, p3, p4, labels = c("ΔTIF", "M/N", "LogBal", "LogTIF"))


# p1 = plot_comb_grid_beeswarm(GSK.dt, opt_df,
#                         domain_levels, 'efficiency_DMSO_GSK', min_count = 10, y_plabel=c(0, 1))
# p2 = plot_comb_grid_beeswarm(GSK.dt, opt_df,
#                         domain_levels, 'efficiency_GSK126', min_count = 10, y_plabel=c(0, 1))
# 
# plot_grid(p1, p2, labels = c("TIF CTRL", "TIF Ezh2i"))


k27me3 = GSK.dt %>% filter(late_replicating == 0, 
                             LAD == 0,
                             H3K9me2 == 0,
                             H3K27me3 == 1) %>% 
  pull(diff_TIF)

any.k27me3 = GSK.dt %>% filter(H3K27me3 == 1) %>% 
  pull(diff_TIF)

not.k27me3 = GSK.dt %>% filter(H3K27me3 != 1) %>% 
  pull(diff_TIF)

hetcomb = GSK.dt %>% filter(late_replicating == 1, 
                              LAD == 1,
                              H3K9me2 == 1,
                              H3K27me3 == 0) %>% 
  pull(diff_TIF)

idomain = GSK.dt %>% filter(late_replicating == 0, 
                              LAD == 0,
                              H3K9me2 == 0,
                              H3K27me3 == 0) %>% 
  pull(diff_TIF)

# DHS = GSK.dt %>% filter(late_replicating == 0,
#                           LAD == 0,
#                           H3K9me2 == 0,
#                           H3K27me3 == 0,
#                           DHS == 1) %>%
#   pull(diff_TIF)

wilcox.test(idomain, k27me3, alternative = "two.sided")
wilcox.test(idomain, any.k27me3, alternative = "two.sided")
wilcox.test(not.k27me3, any.k27me3, alternative = "two.sided")
wilcox.test(idomain, hetcomb, alternative = "two.sided")

GSK.dt %>% mutate(state = ifelse(late_replicating == 1 & 
                                     LAD == 1 &
                                     H3K9me2 == 1 &
                                     H3K27me3 == 0, "Triple Heterochromatin", ifelse(
                                       late_replicating == 0 & 
                                         LAD == 0 & 
                                         H3K9me2 == 0 & 
                                         H3K27me3 == 0, "Euchromatin", ifelse(late_replicating == 0 &  
                                                                            LAD == 0 & 
                                                                            H3K9me2 == 0 & 
                                                                            H3K27me3 == 1, "H3K27me3", "other-heterochromatin")))) %>%
  ggplot(., aes(diff_TIF, fill = state)) +
  geom_density(alpha = 0.6, color = "white", size = .25) +
  scale_fill_manual(values = group_colors) +
  theme_classic()
```
## S3FG Upset plots pool
```{r S3FG Upset plots pool TIF FC, fig.width= 12, fig.height= 6}
p1 = plot_comb_grid_beeswarm(vorino.dt, opt_df,
                        domain_levels, 'log2_FC_MMEJ_NHEJ', min_count = 10, y_plabel=c(-2, 2))
p2 = plot_comb_grid_beeswarm(GSK.dt, opt_df,
                        domain_levels, 'log2_FC_MMEJ_NHEJ', min_count = 10, y_plabel=c(-2, 2))
plot_grid(p1, p2, labels = c("Balance HDACi", "Balance EZH2i"))
```



# Session Info
```{r}
paste("Run time: ",format(Sys.time()-StartTime))
getwd()
date()
sessionInfo()
```

