---
title: "DSB epigenetic drug screen - Figure 2"
author:
  - name: "Max Trauernicht & Ruben Schep"
    email: "m.trauernicht@nki.nl"
    affiliation: "Netherlands Cancer Institute"
date: '`r format(Sys.time(), "%d/%m/%Y")`'
output:
  html_document:
    theme: united
    highlight: pygments
    fig_caption: yes
    code_folding: hide
    df_print: kable
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: no
  pdf_document:
    toc: yes
    toc_depth: '4'
---

*knitr document van Steensel lab*


# Introduction
Clone 5 with ~18 sgRNA target site IPRs was cut and treated with 160 epigenetic drugs. The repair outcomes of that experiment will be visualized here. I previously processed the raw sequencing data, and calculated the repair outcomes. In this script, the main results plots will be generated.


# Setup {.tabset}

<!-- little HTML script to do indentation of the table of contents -->
<script>
$(document).ready(function() {
  $items = $('div#TOC li');
  $items.each(function(idx) {
    num_ul = $(this).parentsUntil('#TOC').length;
    $(this).css({'text-indent': num_ul * 10, 'padding-left': 0});
  });
});
</script>

```{css, echo = FALSE}
div.sourceCode {
overflow-x: hidden;
}
```
## Libraries

```{r load_packages, results = 'hide', warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE)
StartTime <-Sys.time()

# 8-digit Date tag:
Date <- substr(gsub("-","",Sys.time()),1,8) 
# libraries:
library(knitr)
library(tidyverse)
library(outliers)
library(ggplot2)
library(ggbeeswarm)
library(data.table)
library(ggrepel)
library(GGally)
# library(DESeq2)
library(gghighlight)
# library(platetools)
library(ggpubr)
# library(Laurae)
library(pheatmap)
library(RColorBrewer)
library(ggrastr)
library(rstatix)
library(cowplot)
library(colorspace)
library(MASS)

## Select outdir
out.dir = paste0("./figures/", Date, "/")
dir.create(out.dir)
in.dir = list.dirs(path = "/DATA/projects/DSBrepair/data/R") %>% .[grepl("episcreen", .)] %>% tail(n = 1)
opts_chunk$set(dev=c('png', 'pdf'), fig.path = file.path(out.dir))
pdf.options(useDingbats = FALSE)
```

## Functions

```{r load_functions, echo = FALSE, warning = FALSE}

p.adjust <- function(p, method = p.adjust.methods, n = length(p))
{
  ## Methods 'Hommel', 'BH', 'BY' and speed improvements
  ## contributed by Gordon Smyth
  method <- match.arg(method)
  if(method == "fdr") method <- "BH"	# back compatibility
  nm <- names(p)
  p <- as.numeric(p)
  p0 <- setNames(p, nm)
  if(all(nna <- !is.na(p))) nna <- TRUE
  p <- p[nna]
  lp <- length(p)
  # stopifnot(n >= lp)
  if (n <= 1) return(p0)
  if (n == 2 && method == "hommel") method <- "hochberg"
  
  p0[nna] <-
    switch(method,
           bonferroni = pmin(1, n * p),
           holm = {
             i <- seq_len(lp)
             o <- order(p)
             ro <- order(o)
             pmin(1, cummax( (n - i + 1L) * p[o] ))[ro]
           },
           hommel = { ## needs n-1 >= 2 in for() below
             if(n > lp) p <- c(p, rep.int(1, n-lp))
             i <- seq_len(n)
             o <- order(p)
             p <- p[o]
             ro <- order(o)
             q <- pa <- rep.int( min(n*p/i), n)
             for (j in (n-1):2) {
               ij <- seq_len(n-j+1)
               i2 <- (n-j+2):n
               q1 <- min(j*p[i2]/(2:j))
               q[ij] <- pmin(j*p[ij], q1)
               q[i2] <- q[n-j+1]
               pa <- pmax(pa,q)
             }
             pmax(pa,p)[if(lp < n) ro[1:lp] else ro]
           },
           hochberg = {
             i <- lp:1L
             o <- order(p, decreasing = TRUE)
             ro <- order(o)
             pmin(1, cummin( (n - i + 1L) * p[o] ))[ro]
           },
           BH = {
             i <- lp:1L
             o <- order(p, decreasing = TRUE)
             ro <- order(o)
             pmin(1, cummin( n / i * p[o] ))[ro]
           },
           BY = {
             i <- lp:1L
             o <- order(p, decreasing = TRUE)
             ro <- order(o)
             q <- sum(1L/(1L:n))
             pmin(1, cummin(q * n / i * p[o]))[ro]
           },
           none = p)
  p0
}

SetFileName <- function(filename, initials) {
  # Set filename with extension and initials to make filename with date integrated.
  filename <- substitute(filename)
  initials <- substitute(initials)
  filename <- paste0(initials, Date, filename)
  filename
}

# From Fede:
# ggpairs custom functions
boundaries <- c(0.7,0.75,0.8,0.85)
corColor <- function(data, mapping, color = I("black"), sizeRange = c(1, 3), ...) {
  
  x   <- eval_data_col(data, mapping$x)
  y   <- eval_data_col(data, mapping$y)
  r   <- cor(x, y)
  rt  <- format(r, digits = 3)
  tt  <- as.character(rt)
  cex <- max(sizeRange)
  
  # helper function to calculate a useable size
  percent_of_range <- function(percent, range) {
    percent * diff(range) + min(range, na.rm = TRUE)
  }
  
  # plot correlation coefficient
  p <- ggally_text(label = tt, mapping = aes(), xP = 0.5, yP = 0.5,
                   size = I(percent_of_range(cex * abs(r), sizeRange)), color = color, ...) +
    theme(panel.grid.minor=element_blank(),
          panel.grid.major=element_blank())
  
  corColors <- RColorBrewer::brewer.pal(n = 7, name = "RdYlBu")[2:6]
  
  if (r <= boundaries[1]) {
    corCol <- corColors[1]
  } else if (r <= boundaries[2]) {
    corCol <- corColors[2]
  } else if (r < boundaries[3]) {
    corCol <- corColors[3]
  } else if (r < boundaries[4]) {
    corCol <- corColors[4]
  } else {
    corCol <- corColors[5]
  }
  
  p <- p +
    theme(panel.background = element_rect(fill = corCol))
  
  return(p)
}

theme_classic_lines <- function() {
  theme_pubr(border = T, legend = "top") +
    theme(panel.grid.major = element_line(colour = "#adb5bd", size = 0.25),
          strip.background = element_rect(fill = "white", color = "white")
    )
}
theme_classic_lines_45 <- function() {
  theme_pubr(border = T, legend = "top", x.text.angle = 45) +
    theme(panel.grid.major = element_line(colour = "#adb5bd", size = 0.25),
          strip.background = element_rect(fill = "white", color = "white")
    )
}

theme_classic_lines_90 <- function() {
  theme_pubr(border = T, legend = "top", x.text.angle = 90) +
    theme(panel.grid.major = element_line(colour = "#adb5bd", size = 0.25),
          strip.background = element_rect(fill = "white", color = "white")
    )
}

theme_set(theme_classic_lines())

colors_diverse <- c("#264653", "#9AC1AE", "#5D987B", "#f2cc8f", "#e76f51")
colors_drugs <- c("#FA8D62", "#65BFA4", "#8CA0C4", "#808184", "#F6D289", "#E5E5E5", "#ACACAC", "#737373")
#colors_diverse <- c("#264653", "#2a9d8f", "#e9c46a", "#f4a261", "#e76f51") 
colors_targets <-  c(HDAC="#60988D", HAT="#C6D0A8", Sirtuin="#8FCAAC",
                     HMT="#FDCDAC", DNMT="#D69C81", `Histone Demethylase`="#FFF2AE",
                     HIF="#E3DCD5", JAK="#C8D7E2", PIM="#9AB8C4", `Aurora Kinase`="#F4CAE4",
                     PARP="#CB546F", `Epigenetic Reader Domain`= "#476D61", `DNA-PK`="#E07A43")

conc_colors = c("100 nM" = colors_drugs[7], "1 µM" = colors_drugs[4], "10 µM" = "#000000")



ggplot_custom <- function(...) ggplot2::ggplot(...) + 
  scale_color_manual(values = colors_diverse) + 
  scale_fill_manual(values = colors_diverse)

sigFunc = function(x){
  if(x < 0.001){"***"} 
  else if(x < 0.01){"**"}
  else if(x < 0.05){"*"}
  else{NA}}
```


## Data import

```{r data import, results = 'hide', warning = FALSE}
# Import data from preprocessing script
in.dir = list.dirs(path = "/DATA/projects/DSBrepair/data/R") %>% .[grepl("episcreen", .)] %>% tail(n = 1)
file = list.files(in.dir, pattern = "episcreen_ratios", full.names = T) %>% tail(n = 1)
indel.data <- readRDS(file)

# Complete data without exlcluding wells <0.5 viability (I need this for plotting)
meta.viab.file = list.files(in.dir, full.names = T)  %>% .[grepl("Viab_Meta", .)] %>% tail(n = 1)
indel.statistics.dt = readRDS(meta.viab.file) %>%
  dplyr::select(ID, drug, target, replicate, viability, conc_char, tech)
```

---

# Main Figures

## 2A: Heatmap of TIF differences
### Prepare the annotations
This is reused later in the script.
```{r heatmap annotation}
# Order IPRs by their starting freqCut value
dmso_freq <- indel.data %>%
  filter(drug == "DMSO") %>%
  distinct(IPR, freqCut) %>%
  mutate(freqCut = ave(freqCut, IPR, FUN = function(x) mean(x, na.rm = TRUE))*100) %>%
  dplyr::select('dmso_eff' = freqCut, IPR) %>%
  distinct() %>%
  arrange(desc(dmso_eff))

iprs <- dmso_freq$IPR
iprs <- as.character(iprs)


# Set annotation for heatmap
# viability
viab_drug = indel.data %>% filter(drug != "PAO") %>% 
  mutate(drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " ")) %>% 
  distinct(viab_mean, drug_conc, replicate) %>% 
  group_by(drug_conc) %>%
  summarise(viab = mean(viab_mean))
# Row annotation: annotate drugs with the target group
target_set_drugs <- indel.data %>% 
  filter(!target %in% c("Negative Control", "MRN", "DNA-PK")) %>%
  mutate(drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " ")) %>%
  left_join(viab_drug) %>%
  distinct(drug, drug_conc, conc_char, target, viab) %>% 
  column_to_rownames(var="drug_conc")

ctrl.vals <- indel.data %>%
  filter(drug == "DMSO") %>%
  distinct(IPR, freqCut, MMEJratio) %>%
  mutate(ctrl_TIF = ave(freqCut, IPR, FUN = function(x) mean(x, na.rm = TRUE))*100,
         ctrl_balance = ave(MMEJratio, IPR, FUN = function(x) mean(x, na.rm = TRUE))*100) %>%
  distinct(ctrl_TIF, 
           ctrl_balance,
           IPR)

clone5.matrix = indel.data %>% 
  dplyr::select(IPR, ends_with(".zscore")) %>% 
  distinct() %>% 
  rename_with(., ~gsub(".zscore", "", .x)) %>%
  # left_join(ctrl.vals) %>%
  column_to_rownames(var="IPR")

clone5_map_ipr = hclust(dist(clone5.matrix), method = "ward.D") %>% 
  # Rotate the middle node to math better the TIF in CTRL conditions
  dendextend::rotate(c(1:6, 10:7, 11:18))

# Chromatin annotation
chromatin <- readRDS(
  "/DATA/usr/x.vergara/XV_ChIPIndels/XV20200902_DDR_RS_revision/XV20200902_DDR_RS_revision/data/xv20200915_DDR_data_CHIP.rds") %>% 
  distinct(barcode, chromatin) %>%
  left_join(distinct(indel.data, barcode, IPR)) %>%
  left_join(dmso_freq)

# chromatin$IPR[is.na(chromatin$IPR)] <- "IPR1"
chromatin <- chromatin %>%
  filter(IPR != "<NA>") %>% 
  dplyr::select(-barcode) %>%
  column_to_rownames(var="IPR")

## Chromatin groups
group_colors = c("Euchromatin" = "#f7941d",
                 "other-heterochromatin" = "#838687",
                 "Triple Heterochromatin" = "#662d91",
                 "H3K27me3" = "#d21f8a")


viab_colors = sequential_hcl(11, "Peach", rev = TRUE)
names(viab_colors) = seq(0, 1, by = 0.1)

annotation_colors_scr = list(
  chromatin = group_colors,
  target = c(HDAC="#60988D", HAT="#C6D0A8", Sirtuin="#8FCAAC",
             HMT="#FDCDAC", DNMT="#D69C81", `Histone Demethylase`="#FFF2AE",
             HIF="#E3DCD5", JAK="#C8D7E2", PIM="#9AB8C4", `Aurora Kinase`="#F4CAE4",
             PARP="#CB546F", `Epigenetic Reader Domain`= "#476D61", `DNA-PK`="#E07A43"),
  conc_char = conc_colors,
  clusters_drugs = sequential_hcl(7, "Plasma"),
  # viab_rep1 = c('#ffeee9', '#ffdcd4', '#ffcbbe', '#ffb8a8', '#fda693', '#f9947e', '#f4826a', '#ef6f56', '#e95b43', '#e24530'),
  # viab_rep2 = c('#ffeee9', '#ffdcd4', '#ffcbbe', '#ffb8a8', '#fda693', '#f9947e', '#f4826a', '#ef6f56', '#e95b43', '#e24530'),
  viab = viab_colors,
  ctrl_TIF = colorRampPalette(c("white", "black"))(10))

# Order the annotation legend
ordered_marks <- c("Euchromatin", 
                   "H3K27me3", 
                   "other-heterochromatin",  
                   "Triple Heterochromatin")

annotation_colors_scr$chromatin <- annotation_colors_scr$chromatin[ordered_marks]
```

### Prepare the data
```{r prepare data for heatmaps}
# Generate heatmap: select top drugs (highest change at any IPR) per concentration
eff.data <- indel.data %>%
  #filter(target != "Aurora Kinase") %>%
  filter(sample == "Epigenetic Compound", indel_freq_filter, viab_reproducibility) %>%
  filter(abs(zscore_TIF_global_comb_rep) >= 2.58) %>%  # we can choose to display all drugs that have significant global hits
  distinct(conc_char, drug, target, IPR, zscore_TIF_comb_rep, freqCut_diff_mean, replicate, tech, filter_zscore_TIF_comb_rep)

eff.data.heatmap <- eff.data %>%
  group_by(drug, conc_char) %>%
  # ave to add IPR grouping level to calculate mean of the replicates
  mutate(freqCut_diff_mean = ave((freqCut_diff_mean*100), IPR, FUN = function(x) mean(x, na.rm = TRUE)),
  ## Select drugs that have a large effect size in at least one location 
         ## (some drugs might have a small global effect size, but large local)
         zscore_TIF_comb_rep_temp = ifelse(filter_zscore_TIF_comb_rep, 0, zscore_TIF_comb_rep),
         p_value = 2*pnorm(q = abs(zscore_TIF_comb_rep_temp), lower.tail = F),
         # Adjust p value for false discovery rate
         adj_pvalue = p.adjust(p_value, method = 'fdr'),
         # Pick the smallest per compound & concentration
         min_score = min(adj_pvalue)) %>%
  # filter for adjusted p.val < 0.001 so we keep compounds with at least one signif effect.
  # filter(min_score < 10e-8) %>%
  distinct(drug, target, conc_char, freqCut_diff_mean, IPR, min_score) %>%
  ungroup()

top_50_hits = eff.data.heatmap %>% 
  arrange(desc(abs(freqCut_diff_mean))) %>% 
  distinct(drug, conc_char, min_score) %>%
  slice(1:50) 


#eff.data.heatmap2$freqCut_norm_mean[eff.data.heatmap2$mean_eff_zscore_comb > 0.05] <- NA
eff.data.heatmap2 <- top_50_hits %>% 
  left_join(eff.data.heatmap)%>%
  dplyr::select(-min_score) %>%
  spread(IPR, freqCut_diff_mean) %>%
  filter(!is.nan(IPR3))

eff.data.heatmap2 <- eff.data.heatmap2[,c("drug", "target", "conc_char", iprs)]
eff.data.heatmap2$drug <- gsub(" [(].*[)]", "", eff.data.heatmap2$drug) #shorten name of drug


breaks <- quantile(unlist(eff.data.heatmap2 %>% 
                            dplyr::select(contains('IPR'))), c(.01,.99), na.rm = T) # change these numbers according to where you want to set the cutoff
palette_length <- 100

myBreaks <- c(seq(breaks[1], 0, length.out=ceiling(palette_length/2) + 1), 
              seq(breaks[2]/palette_length, breaks[2], length.out=floor(palette_length/2)))

ordered_marks2 <- eff.data.heatmap2 %>% 
  dplyr::select(target) %>%
  distinct() %>%
  arrange(target)

ordered_marks2 <- ordered_marks2$target

annotation_colors_scr_set = annotation_colors_scr
annotation_colors_scr_set$target <- annotation_colors_scr_set$target[ordered_marks2]


# Add cluster annotation
clusters_drugs <- hclust(dist(eff.data.heatmap2), method = "ward.D")
clusters_drugs <- cutree(tree = clusters_drugs, k = 4)
clusters_drugs <- data.frame(clusters_drugs)

eff.data.heatmap2.clusters <- cbind(eff.data.heatmap2, clusters_drugs) %>% 
  as_tibble() %>%
  mutate(drug_conc = paste(drug, conc_char, sep = " "))

clusters_drugs <- eff.data.heatmap2.clusters %>%
  distinct(drug_conc, clusters_drugs)

target_set_all <- target_set_drugs %>%
  rownames_to_column("drug_conc") %>%
  left_join(clusters_drugs) %>%
  na.omit()
rownames(target_set_all) <- target_set_all$drug_conc
target_all <- target_set_all %>%
  dplyr::select(target, 
                clusters_drugs,
                conc_char, viab)
```

### Plot the heatmap
```{r 2A TIF heatmap, warning = FALSE, fig.width = 10, fig.height = 20}
# pdf(paste0(figure_out, "rs20220623_indelfrequency_heatmap_allconc.pdf"), width=20, height=8)
eff.data.matrix = eff.data.heatmap2.clusters %>%
  arrange(target_all) %>%
  column_to_rownames('drug_conc') %>%
  dplyr::select(contains('IPR'))

plt1 = pheatmap(eff.data.matrix[ , clone5_map_ipr$labels],
                cluster_cols = clone5_map_ipr,
                border_color = F,
                cellwidth = 8,
                cellheight = 8,
                breaks = myBreaks,
                clustering_method = "ward.D",
                cluster_rows = T,
                na_col = "white",
                main = 'efficiency change, all concentrations',
                annotation_row = target_all,
                annotation_col = chromatin,
                # color = colorRampPalette(c("#e07a5f", "#e5e5e5", "#3d405b"))(palette_length),
                color = diverge_hcl(palette_length, "Blue-Red"),
                annotation_colors = annotation_colors_scr_set, 
                annotation_legend = T,
                cutree_row = 4)
```

---

## 2B: Cutting efficiency change per target group
Are there any target groups that are prone to changes in cutting efficiency?
```{r 2B effect per compound target, warning = FALSE}
eff.data <- indel.data.freq %>%
  filter(sample == "Epigenetic Compound") %>%
  distinct(IPR, zscore_TIF_global_comb_rep , filter_zscore_TIF_global_comb_rep, 
           zscore_TIF_comb_rep , filter_zscore_TIF_comb_rep, 
           drug, target, conc_char, freqCut_diff_global_mean) %>%
  mutate(mean_eff_pval_comb = 2*pnorm(q = abs(zscore_TIF_comb_rep ), lower.tail = F),
         mean_eff_pval_adj_comb = p.adjust(mean_eff_pval_comb, method = 'fdr'),
         sign_local = ifelse((mean_eff_pval_adj_comb < 0.01 & 
                                filter_zscore_TIF_comb_rep &
                                 zscore_TIF_comb_rep > 2.58), "TIF_Increase", 
                             ifelse((mean_eff_pval_adj_comb < 0.01 &
                                       filter_zscore_TIF_global_comb_rep &
                                 zscore_TIF_comb_rep < -2.58), "TIF_Decrease", 
                                    "No_Change"))) %>%
  group_by(drug, conc_char) %>%
  mutate(sign_global = ifelse(length(table(sign_local) == 1),  names(table(sign_local)), "No_Change")) %>%
  distinct(IPR, drug, conc_char, target, sign_local, sign_global)

global.effects = eff.data %>%
  distinct(drug, conc_char, target, sign_global) %>%
  group_by(target, sign_global, conc_char) %>% 
  count()

local.effects = eff.data %>% 
  filter(sign_global == "No_Change") %>% 
  distinct(drug, conc_char, target, sign_local) %>%
  group_by(target, sign_local, conc_char) %>% 
  count() %>% 
  pivot_wider(names_from = sign_local, values_from = n, values_fill = 0) %>%
  mutate(No_Change = No_Change - TIF_Increase - TIF_Decrease) %>%
  dplyr::rename(Local_TIF_Increase = TIF_Increase, Local_TIF_Decrease = TIF_Decrease) %>% 
  pivot_longer(cols = No_Change:Local_TIF_Increase, values_to = "n", names_to = "sign_global")

target_effects = global.effects %>% 
  filter(sign_global != "No_Change") %>%
  rbind(local.effects) %>%
  mutate(sign_global = factor(sign_global, levels = c(c("TIF_Decrease", "Local_TIF_Decrease", "No_Change","Local_TIF_Increase", "TIF_Increase"))))

ggplot(target_effects,
       aes(y = reorder(target, n), x = n, fill = sign_global)) +
  geom_bar(stat = "identity") +
  facet_wrap(~conc_char)+
  scale_fill_manual(values = c("TIF_Decrease" = "#023FA5", "Local_TIF_Decrease" = "#A1A6C8", "No_Change" = "#E2E2E2","Local_TIF_Increase" = "#CA9CA4", "TIF_Increase" = "#8E063B")) +
  theme_pubr(border = T)

target_effects %>% filter(sign_global != "No_Change") %>% distinct(target, conc_char, n) %>% group_by(conc_char) %>% summarise(count = sum(n))
```

## 2C: Cutting efficiency change per drug
Are there any drugs (per concentration) that significantly change the cutting efficiency significantly across all IPRs?
```{r}
#data frame to save data
mean_sd_fits <- tibble(term = NA, estimate = NA, std.error = NA, barcode = NA, rep = NA)

# First calculate means and sd of the DMSO efficiency per replicate and barcode
dmso.eff.score <- indel.data %>%
  filter(drug == "DMSO") %>%
  dplyr::select('DMSO' = freqCut, well, barcode, replicate, tech, plate) %>%
  mutate(DMSO = ave(DMSO, well, replicate, tech, plate, FUN = function(x) mean(x, na.rm=T))) %>%
  distinct(replicate, tech, well, plate, DMSO) %>% 
  pull(DMSO) %>%
  fitdistr(., "normal") %>% tidy()
```

```{r Compounds that affect the balance at all the sites}
## Which compounds change the balance at all the sites in both screens?
all_TIF = indel.data %>% 
  distinct(drug, conc_char, replicate, zscore_TIF_comb_tech, filter_zscore_TIF_comb_tech, target, 
           barcode, viab_reproducibility, indel_freq_filter) %>% 
  filter(filter_zscore_TIF_comb_tech & 
           !is.na(zscore_TIF_comb_tech) & 
           !between(zscore_TIF_comb_tech, -2.58, 2.58) & 
           viab_reproducibility == T & 
           indel_freq_filter == T) %>% 
  group_by(drug, conc_char, target) %>% 
  count() %>% 
  filter(n == 36) # 2 x 18

kable(all_TIF)
all_TIF %>% ungroup() %>% distinct(drug, target, conc_char)

## Now with 16/18 (~ 90%) of the sites with an effect. Near global
near_all_TIF = indel.data %>% 
  distinct(drug, conc_char, replicate, zscore_TIF_comb_tech, filter_zscore_TIF_comb_tech, target, 
           barcode, viab_reproducibility, indel_freq_filter) %>% 
  filter(filter_zscore_TIF_comb_tech & 
           !is.na(zscore_TIF_comb_tech) & 
           !between(zscore_TIF_comb_tech, -2.58, 2.58) & 
           viab_reproducibility == T & 
           indel_freq_filter == T) %>% 
  group_by(drug, conc_char, target) %>% 
  count() %>% 
  filter(n >= 32) # 2 x 16


kable(near_all_TIF)
near_all_TIF %>% ungroup() %>% distinct(drug, target, conc_char)
```

```{r 2C TIF changes at the three concentrations, warning = FALSE}
# A: Global cutting efficiency change induced by all drugs 
## Plot mean DMSO cutting efficiency in middle, and difference from that to the left and right in percent
indel.data.freq <- indel.data %>%
  filter((sample == "Epigenetic Compound" | drug == "DMSO") & 
           indel_freq_filter & viab_reproducibility &
           cor_TIF_filter & !is.na(freqCut)) %>%
  distinct(IPR, drug, conc_char, sample, target, viab_mean, replicate,
           freqCut_global, freqCut, IPR,
           freqCut_diff_global, freqCut_diff_global_mean,
           zscore_TIF_global_comb_rep , filter_zscore_TIF_global_comb_rep, 
           zscore_TIF_comb_rep , filter_zscore_TIF_comb_rep) %>%
  filter(!(freqCut_diff_global < -0.1 & viab_mean < 0.5)) %>%
  mutate(freqCut_mean = ave(freqCut_global, drug, conc_char),
         freqCut_diff_mean =  ave(freqCut_diff_global, drug, conc_char))

# DMSO TIF mean and SD
dmso_freq <- indel.data %>%
  filter(drug == "DMSO") %>%
  dplyr::select('dmso_freq' = freqCut, IPR, replicate, tech, well, plate) %>%
  group_by(replicate, tech, well, plate) %>%
  summarise(dmso_freq = mean(dmso_freq)) %>%
  ungroup() %>%
  mutate(dmso_mean = mean(dmso_freq),
         dsmo_sd = sd(dmso_freq)) %>%
  distinct(dmso_mean, dsmo_sd)


volcano.df = indel.data %>%
  filter(sample == "Epigenetic Compound" & indel_freq_filter == TRUE & viab_reproducibility == TRUE) %>%
  distinct(freqCut, drug, conc_char, zscore_TIF_global_comb_rep, freqCut_diff_global_mean, filter_zscore_TIF_global_comb_rep) %>%
  mutate(GlobalfreqCut = ave(freqCut, drug, conc_char, FUN = function(x) mean(x, na.rm=T))) %>%
  distinct() %>%
  mutate(TIF_pval_global_comb = 2*pnorm(q = abs(zscore_TIF_global_comb_rep), lower.tail = F)) %>%
  left_join(near_all_TIF) %>%
  mutate(TIF_pval_adj_global_comb = log10(p.adjust(TIF_pval_global_comb, method = 'fdr')),
         col_bal = ifelse(TIF_pval_adj_global_comb < 0.01 & 
                            GlobalfreqCut > (dmso_freq$dmso_mean + dmso_freq$dsmo_sd) & 
                                   filter_zscore_TIF_global_comb_rep, "TIF increase", 
                          ifelse(TIF_pval_adj_global_comb < 0.01 & 
                                   GlobalfreqCut < (dmso_freq$dmso_mean - dmso_freq$dsmo_sd) & 
                                   filter_zscore_TIF_global_comb_rep, "TIF decrease","N.S."))) %>%
  distinct(TIF_pval_adj_global_comb, GlobalfreqCut, drug, conc_char, target, n, col_bal, filter_zscore_TIF_global_comb_rep)


ggplot(volcano.df, 
       aes(y = TIF_pval_adj_global_comb, 
           x = GlobalfreqCut, 
           color = col_bal)) +
  geom_point() +
  geom_hline(linetype = "dashed", yintercept = log10(0.01)) +
  geom_vline(linetype = "solid", xintercept = (dmso_freq$dmso_mean)) +
  geom_vline(linetype = "dashed", xintercept = (dmso_freq$dmso_mean + dmso_freq$dsmo_sd)) +
  geom_vline(linetype = "dashed", xintercept = (dmso_freq$dmso_mean - dmso_freq$dsmo_sd)) +
  scale_color_manual(values = c("#C2C2C2", "#3d405b", "#e07a5f")) +
  facet_wrap(~conc_char) +
  annotate("rect",
           xmin=(dmso_freq$dmso_mean - dmso_freq$dsmo_sd),
           xmax=(dmso_freq$dmso_mean + dmso_freq$dsmo_sd),
           ymin=-Inf,ymax=Inf, alpha=0.1, fill="black") +
  annotate("rect",
           xmin=-Inf,
           xmax=Inf,
           ymin=-Inf,
           ymax= -log10(0.01), 
           alpha=0.1, 
           fill="black") +
  coord_flip() +
  ylim(0, -300) +
  geom_label_repel(data = volcano.df, 
                   aes(y = TIF_pval_adj_global_comb, 
                       x = GlobalfreqCut, 
                       label = ifelse(n == 36, drug,'')),
                   box.padding   = 1, 
                   point.padding = 0.5,
                   force = 210,
                   segment.color = 'black', 
                   inherit.aes = F) +
  geom_label_repel(aes(label = ifelse(between(n, 32, 35), drug,'')),
                   box.padding   = 1, 
                   force = 110,
                   point.padding = 0.5,
                   segment.color = 'gray50') +
  theme_classic()



indel.data %>%
  filter(sample == "Epigenetic Compound" & pathway_bal_filter == TRUE & viab_reproducibility == TRUE) %>%
  distinct(freqCut, drug, conc_char, zscore_TIF_global_comb_rep ) %>%
  mutate(GlobalfreqCut = ave(freqCut, drug, conc_char, FUN = mean)) %>%
  distinct() %>%
  mutate(TIF_pval_global_comb = 2*pnorm(q = abs(zscore_TIF_global_comb_rep ), lower.tail = F)) %>%
  mutate(TIF_pval_adj_global_comb = log10(p.adjust(TIF_pval_global_comb, method = 'fdr')),
         col_bal = ifelse(TIF_pval_adj_global_comb < 0.01 & 
                            GlobalfreqCut > (dmso_freq$dmso_mean + dmso_freq$dsmo_sd), "green", 
                          ifelse(TIF_pval_adj_global_comb < 0.01 & 
                                   GlobalfreqCut < (dmso_freq$dmso_mean - dmso_freq$dsmo_sd), "yellow","blue"))) %>%  
  filter(col_bal != "blue") %>%
  distinct(drug, conc_char) %>%
  kable()


# # Alternative: label drugs and color targets
indel.data.freq2  <- indel.data.freq %>%
  filter(sample == "Epigenetic Compound") %>%
  distinct(freqCut_mean, freqCut_diff_mean, drug, conc_char, zscore_TIF_global_comb_rep , target) %>%
  mutate(mean_eff_pval_global_comb = 2*pnorm(q = abs(zscore_TIF_global_comb_rep ), lower.tail = F)) %>%
  mutate(mean_eff_pval_adj_global_comb = p.adjust(mean_eff_pval_global_comb, method = 'fdr'))

labels <- indel.data.freq2 %>%
  mutate(freqCut_diff_mean = abs(freqCut_diff_mean)) %>%
  group_by(conc_char) %>%
  top_n(3, freqCut_diff_mean) %>%
  ungroup() %>%
  mutate(flag = "TRUE") %>%
  distinct(drug, conc_char, flag)

indel.data.freq2 <- merge(indel.data.freq2, labels, all = T)
indel.data.freq2$flag[is.na(indel.data.freq2$flag)] <- "FALSE"
indel.data.freq2$drug <- gsub(" [(].*[)]", "", indel.data.freq2$drug) #shorten name of drug

indel.data.freq2 %>% filter(mean_eff_pval_adj_global_comb < 0.05) %>%
  distinct(drug, conc_char, mean_eff_pval_adj_global_comb) %>%
  group_by(conc_char) %>%
  summarise(count = n())
```


*Figure 2A: Compound-induced change in cutting efficiency of all tested compounds. Mean per drug & concentration vs. p-value from t-test.*

**Conclusion: Yes, some drugs do alter cutting efficiency significantly. Changes go in both directions, at lower concentration the efficiency is mostly increased (at higher concentrations the decrease might be due to toxicity)**



---
## 2D Rank
### Boosting 
```{r 2D Top TIF boosting, }
rank_dt = indel.data %>% 
  filter(drug != "DMSO" & indel_freq_filter & viab_reproducibility) %>%
  distinct(drug, conc_char, zscore_TIF_global_comb_rep , target, viab_reproducibility) %>% 
  arrange(desc(zscore_TIF_global_comb_rep )) %>%
  mutate(rank = seq(1:n()),
         drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " "))

p1 = rank_dt %>% 
  # filter(rank < 100 ) %>%
  ggplot(., aes(rank, zscore_TIF_global_comb_rep )) +
  geom_point()  +
  scale_color_manual(values = colors_targets) +
  geom_hline(linetype = "dashed", yintercept = 2.58) +
  geom_hline(linetype = "dashed", yintercept = -2.58) +
  # scale_x_reverse(limits = c(100, 0)) +
  scale_x_reverse() +
  ylab("Global combined TIF z-score")

p2 = rank_dt %>%
  filter(rank <= 100 & drug != "DNA-PKi") %>%
  ggplot(., aes(rank, zscore_TIF_global_comb_rep , color = target)) +
  geom_point()  +
  scale_color_manual(values = colors_targets) +
  gghighlight(rank <= 8 & cor_bal_FC > .3, label_key = drug_conc) +
  geom_hline(linetype = "dashed", yintercept = 2.58) +
  scale_x_reverse(limits = c(100, 0)) +
  # scale_x_reverse() +
  ylab("Global combined TIF z-score")

maxrank = rank_dt %>% nrow()

p3 = rank_dt %>%
  filter(rank > nrow(.)-100) %>%
  ggplot(., aes(rank, zscore_TIF_global_comb_rep , color = target)) +
  geom_point()  +
  scale_color_manual(values = colors_targets) +
  gghighlight(rank <= 10, label_key = drug_conc) +
  geom_hline(linetype = "dashed", yintercept = -2.58) +
  scale_x_reverse(limits = c(maxrank, maxrank-100)) +
  # scale_x_reverse() +
  ylab("Global combined TIF z-score")


left_col_zoom <- plot_grid(p1, p3, labels = c('B', 'C'), label_size = 12, ncol = 1)

plot_grid(p1, left_col_zoom, labels = c('A', ''), label_size = 12, ncol = 2, rel_widths = c(3, 2))




indel.data %>% 
  filter(conc_char != "control" & indel_freq_filter & viab_reproducibility & cor_TIF_filter) %>%
  distinct(drug, conc_char, zscore_TIF_global_comb_rep , target, viab_reproducibility) %>% 
  arrange(desc(zscore_TIF_global_comb_rep )) %>%
  mutate(rank = seq(1:n()),
         drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " ")) %>%
  filter(rank < 100) %>%
  ggplot(., aes(rank, zscore_TIF_global_comb_rep , color = target)) +
  geom_point()  +
  scale_color_manual(values = colors_targets) +
  gghighlight(rank <= 10, label_key = drug_conc) +
  geom_hline(linetype = "dashed", yintercept = 2.58) +
  scale_x_reverse(limits = c(100, 0)) +
  ylab("Global combined TIF z-score")

top_hits = indel.data  %>% 
  filter(conc_char != "control" & indel_freq_filter & viab_reproducibility & cor_TIF_filter) %>% 
  distinct(drug, conc_char, zscore_TIF_global_comb_rep , target) %>%
  arrange(desc(zscore_TIF_global_comb_rep )) %>% 
  slice_head(n = 10) %>% 
  distinct(drug, conc_char, target, zscore_TIF_global_comb_rep ) %>% 
  mutate(rank = seq(1:n()),
         drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " "))
```

### Inhibiting
```{r 2D top hits heatmap, fig.width= 5, fig.height=6}
eff.data.heatmap.top = top_hits %>%
  left_join(eff.data.heatmap2) %>% 
  filter(!is.na(IPR3))

minmax_row = data.frame(conc_char = c(NA, NA), target = c(NA, NA), viab = c(0, 1), row.names = c("min", "max"))

target_set <- top_hits %>% 
  left_join(target_set_drugs) %>%
  column_to_rownames("drug_conc") %>%
  dplyr::select(-drug, -rank) %>%
  bind_rows(minmax_row)

tophit_matrix = eff.data.heatmap.top %>%
  column_to_rownames('drug_conc') %>%
  dplyr::select(contains('IPR'))

plt3 = pheatmap(tophit_matrix[, clone5_map_ipr$labels],
                cluster_cols = clone5_map_ipr,
                clustering_method = "ward.D",
                border_color = F,
                cellwidth = 8,
                cellheight = 8,
                breaks = myBreaks,
                cluster_rows = T,
                angle_col = 90,
                na_col = "white",
                main = 'efficiency change, all concentrations',
                annotation_col = chromatin,
                annotation_row = target_set,
                color = diverge_hcl(palette_length, "Blue-Red"),
                annotation_colors = annotation_colors_scr,
                annotation_legend = T)
```
# Chormatin specific (Figure 3?)
## 2E HDAC specific
```{r 2E TIF HDAC heatmap, warning = FALSE, fig.width= 12, fig.height=16}
HDAC_tib = read.table("rs20220708_HDAC_targets.txt", sep = "\t", fill = NA, header = T) %>%
  dplyr::select(-target_main, -target_second) %>%
  as_tibble()

cluster1 = target_all %>% filter(target == "HDAC") %>% rownames()
cluster1 = cluster1[!grepl("Nullscript", cluster1)]

eff.data.heatmap.cluster1 = eff.data.heatmap2 %>% 
  mutate(drug_conc = paste(drug, conc_char, sep = " ")) %>% 
  filter(drug_conc %in% cluster1)

# Add cluster annotation
cluster_HDAC <- hclust(dist(eff.data.heatmap.cluster1), method = "complete")
cluster_HDAC <- cutree(tree = cluster_HDAC, k = 4)
cluster_HDAC <- data.frame(cluster_HDAC)

eff.data.heatmap.cluster1 <- cbind(eff.data.heatmap.cluster1, cluster_HDAC) %>% 
  as_tibble()

cluster_HDAC <- eff.data.heatmap.cluster1 %>%
  distinct(drug_conc, cluster_HDAC)

target.cluster1 <- target_set_drugs %>%
  rownames_to_column("drug_conc") %>%
  left_join(HDAC_tib) %>%
  left_join(cluster_HDAC) %>%
  filter(!is.na(cluster_HDAC)) %>%
  replace(is.na(.), 0)

rownames(target.cluster1) <- target.cluster1$drug_conc
target.cluster1 <- target.cluster1 %>%
  dplyr::select(cluster_HDAC, conc_char, pan_HDAC, HDAC1,HDAC2, HDAC3,
                HDAC4, HDAC6, HDAC8, HDAC10, viab)

target.cluster1

HDAC_matrix = eff.data.heatmap.cluster1 %>%
  arrange(target.cluster1) %>%
  column_to_rownames('drug_conc') %>%
  dplyr::select(contains('IPR')) %>%
  t()

# pdf(paste0(figure_out, "rs20220623_indelfrequency_heatmap_HDAC.pdf"), width=16, height=8)
plt3 = pheatmap(HDAC_matrix[clone5_map_ipr$labels,],
                border_color = F,
                cellwidth = 8,
                cellheight = 8,
                breaks = myBreaks,
                cluster_rows = clone5_map_ipr,
                cluster_cols = T,
                angle_col = 90,
                na_col = "white",
                main = 'efficiency change, all concentrations',
                annotation_col = target.cluster1,
                annotation_row = chromatin,
                color = diverge_hcl(palette_length, "Blue-Red"),
                annotation_colors = annotation_colors_scr,
                annotation_legend = T,
                cutree_cols = 4)
```


## 2F Plot HDACi effects on different chromatin types
```{r 2F HDACi in different clusters}
chromatin_ipr <- chromatin %>%
  rownames_to_column("IPR")

eff.data.heatmap3 <- eff.data.heatmap.cluster1 %>%
  pivot_longer(contains("IPR"), names_to = "IPR", values_to = "freqCut_dif")

chromatin_effect <- merge(eff.data.heatmap3, chromatin_ipr) %>%
  #filter(target == "HDAC") %>%
  mutate(freqCut_dif = ave(freqCut_dif, drug, chromatin, conc_char, FUN = function(x) mean(x, na.rm = TRUE))) %>%
  distinct(freqCut_dif, drug, chromatin, conc_char, target, cluster_HDAC)

sigFunc = function(x){
  if(x < 0.001){"***"} 
  else if(x < 0.01){"**"}
  else if(x < 0.05){"*"}
  else{NA}}

ggplot(chromatin_effect %>%
         filter(target == "HDAC" & 
                  cluster_HDAC != 4
         ),
       aes(x = chromatin, y = freqCut_dif, fill = chromatin)) +
  geom_boxplot(outlier.shape = NA) +
  geom_quasirandom() +
  geom_signif(comparisons = combn(sort(unique(chromatin_effect$chromatin)), 2, simplify = F), 
              map_signif_level=sigFunc, 
              step_increase = 0.1) +
  theme_classic_lines_45() +
  scale_fill_manual(values = group_colors) +
  theme(legend.position = "none") +
  facet_wrap(~cluster_HDAC) +
  ylab("Total indel frequency change") +
  xlab("Chromatin cluster")
```

## 2G Aurora A vs. Aurora B

```{r 2G TIF AurK inhibitor heatmap, warning = FALSE, fig.width= 8, fig.height=10}
AurK_tib = read.table("rs20220711_AurK_inhibitors.txt", sep = "\t", fill = NA, header = T) %>%
  as_tibble()

cluster_AurK = target_all %>% filter(target == "Aurora Kinase") %>% rownames()

eff.data.heatmap.aurK = eff.data.heatmap2 %>% 
  mutate(drug_conc = paste(drug, conc_char, sep = " ")) %>% 
  filter(drug_conc %in% cluster_AurK)

# Add cluster annotation
cluster_AurK <- hclust(dist(eff.data.heatmap.aurK), method = "complete")
cluster_AurK <- cutree(tree = cluster_AurK, k = 4)
cluster_AurK <- data.frame(cluster_AurK)

eff.data.heatmap.aurK <- cbind(eff.data.heatmap.aurK, cluster_AurK) %>% 
  as_tibble()

cluster_AurK <- eff.data.heatmap.aurK %>%
  distinct(drug_conc, cluster_AurK)

target.aurK <- target_set_drugs %>%
  rownames_to_column("drug_conc") %>%
  left_join(AurK_tib) %>%
  left_join(cluster_AurK) %>%
  filter(!is.na(cluster_AurK)) %>%
  replace(is.na(.), 0)

rownames(target.aurK) <- target.aurK$drug_conc
target.AurK.selection <- target.aurK %>%
  dplyr::select(conc_char,pan_AurK, AurC, 
                AurB,	AurA, viab)

target.AurK.selection

AurK_matrix = eff.data.heatmap.aurK %>%
  arrange(target.AurK.selection) %>%
  column_to_rownames('drug_conc') %>%
  dplyr::select(contains('IPR')) %>%
  t()

# pdf(paste0(figure_out, "rs20220623_indelfrequency_heatmap_HDAC.pdf"), width=16, height=8)
plt3 = pheatmap(AurK_matrix[clone5_map_ipr$labels, ],
                border_color = F,
                cellwidth = 8,
                cellheight = 8,
                breaks = myBreaks,
                clustering_method = "ward.D",
                cluster_rows = clone5_map_ipr,
                cluster_cols = T,
                angle_col = 90,
                na_col = "white",
                main = 'efficiency change, all concentrations',
                annotation_col = target.AurK.selection,
                annotation_row = chromatin,
                color = diverge_hcl(palette_length, "Blue-Red"),
                annotation_colors = annotation_colors_scr,
                annotation_legend = T,
                cutree_cols = 4)
```


## 2H Aurora A vs. Aurora B global 
```{r 2H AurK inhib global effects, fig.width= 4.5, fig.height= 5}
CTRL.mean = dmso.eff.score$estimate[1]
CTRL.SD = dmso.eff.score$estimate[2]

indel.data.freq2 %>%
  filter(target == "Aurora Kinase") %>%
  left_join(AurK_tib) %>%
  filter(!is.na(mean_eff_pval_global_comb)) %>%
  mutate(AurK_Target = ifelse((AurB == 1 & AurA == 0), "B", ifelse(
    (AurB == 0 & AurA == 1), "A", "A+B"))) %>%
  ggplot(.,
         aes(y = -log10(mean_eff_pval_adj_global_comb), x = freqCut_mean, 
             color = AurK_Target)) +
  geom_point(size = 3) +
  #geom_label_repel(data = indel.data.freq2 %>% filter(flag == "TRUE") %>% unique(), 
  #aes(label = drug)) +
  geom_hline(linetype = "dashed", yintercept = -log10(0.01)) +
  geom_vline(linetype = "solid", xintercept = (CTRL.mean)) +
  geom_vline(linetype = "dashed", xintercept = (CTRL.mean + CTRL.SD)) +
  geom_vline(linetype = "dashed", xintercept = (CTRL.mean - CTRL.SD)) +
  #geom_vline(linetype = "twodash", xintercept = unique(indel.data.freq$max_dmso_freq))+
  scale_color_manual(values = c("#6d6875", "#b5838d", "#ffb4a2")) +
  scale_x_continuous(labels = scales::percent) +
  coord_flip() +
  theme_classic_lines_90()
```


## 2I Aurora A vs. Aurora B
```{r 2I AurA vs AurB inhibitors, fig.width= 3, fig.height= 4}
viab_tib = indel.data %>% filter(viab_reproducibility & indel_freq_filter & cor_TIF_filter) %>% 
  distinct(replicate, drug, conc_char, viab_mean) %>%
  group_by(drug, conc_char) %>%
  summarise(viab_mean = mean(viab_mean, na.rm = TRUE)) %>%
  mutate(drug = gsub(" [(].*[)]", "", drug))

aurora_df <- eff.data.heatmap2 %>%
  filter(target == "Aurora Kinase") %>%
  pivot_longer(contains("IPR"), names_to = "IPR", values_to = "freqCut_dif") %>%
  mutate(freqCut_dif = ave(freqCut_dif, drug, conc_char, FUN = function(x) mean(x, na.rm = TRUE))) %>%
  dplyr::select(-IPR) %>%
  left_join(viab_tib) %>%
  distinct() 

aurora_df <- merge(aurora_df, AurK_tib) %>%
  filter(!is.na(viab_mean)) %>%
  mutate(AurK_Target = ifelse((AurB == 1 & AurA == 0), "B", ifelse(
    (AurB == 0 & AurA == 1), "A", "A+B")))

ggplot(aurora_df, 
       aes(x = AurK_Target, y = freqCut_dif, fill = viab_mean)) + 
  geom_quasirandom(size = 2, shape = 21) +
  geom_signif(comparisons = combn(sort(unique(aurora_df$AurK_Target)), 2, simplify = F), 
              map_signif_level=sigFunc, 
              step_increase = 0.1) +
  scale_fill_continuous_sequential(palette = "Peach", rev = TRUE) +
  scale_color_manual(values= "black") +
  theme_classic_lines() +
  ylab("global TIF change")
```


*Figure S2A: Correlation between cutting efficiency of significant hits.*

**Conclusion: The correlation between 'strong' changers of efficiency is OK, not very good, but OK.**
# Supplementary Figures 
## S2A Complete TIF heatmap
```{r S2A All TIF Hits}
#eff.data.heatmap2$freqCut_norm_mean[eff.data.heatmap2$mean_eff_zscore_comb > 0.05] <- NA
eff.data.heatmap2 <- eff.data.heatmap %>%
  dplyr::select(-min_score) %>%
  spread(IPR, freqCut_diff_mean) %>%
  filter(!is.nan(IPR3))

eff.data.heatmap2 <- eff.data.heatmap2[,c("drug", "target", "conc_char", iprs)]
eff.data.heatmap2$drug <- gsub(" [(].*[)]", "", eff.data.heatmap2$drug) #shorten name of drug


breaks <- quantile(unlist(eff.data.heatmap2 %>% 
                            dplyr::select(contains('IPR'))), c(.01,.99), na.rm = T) # change these numbers according to where you want to set the cutoff
palette_length <- 100

myBreaks <- c(seq(breaks[1], 0, length.out=ceiling(palette_length/2) + 1), 
              seq(breaks[2]/palette_length, breaks[2], length.out=floor(palette_length/2)))

ordered_marks2 <- eff.data.heatmap2 %>% 
  dplyr::select(target) %>%
  distinct() %>%
  arrange(target)

ordered_marks2 <- ordered_marks2$target

annotation_colors_scr_set = annotation_colors_scr
annotation_colors_scr_set$target <- annotation_colors_scr$target[ordered_marks2]


# Add cluster annotation
clusters_drugs <- hclust(dist(eff.data.heatmap2), method = "ward.D")
clusters_drugs <- cutree(tree = clusters_drugs, k = 5)
clusters_drugs <- data.frame(clusters_drugs)

eff.data.heatmap2.clusters <- cbind(eff.data.heatmap2, clusters_drugs) %>% 
  as_tibble() %>%
  mutate(drug_conc = paste(drug, conc_char, sep = " "))

clusters_drugs <- eff.data.heatmap2.clusters %>%
  distinct(drug_conc, clusters_drugs)

target_set_all <- target_set_drugs %>%
  rownames_to_column("drug_conc") %>%
  left_join(clusters_drugs) %>%
  na.omit()
rownames(target_set_all) <- target_set_all$drug_conc
target_all <- target_set_all %>%
  dplyr::select(target, 
                clusters_drugs,
                conc_char, viab)
```

```{r S2A TIF heatmap all, warning = FALSE, fig.width = 10, fig.height = 30}
# pdf(paste0(figure_out, "rs20220623_indelfrequency_heatmap_allconc.pdf"), width=20, height=8)
eff.data.matrix = eff.data.heatmap2.clusters %>%
  arrange(target_all) %>%
  column_to_rownames('drug_conc') %>%
  dplyr::select(contains('IPR'))

plt1 = pheatmap(eff.data.matrix[ , clone5_map_ipr$labels],
                cluster_cols = clone5_map_ipr,
                border_color = F,
                cellwidth = 8,
                cellheight = 8,
                breaks = myBreaks,
                clustering_method = "ward.D",
                cluster_rows = T,
                na_col = "white",
                main = 'efficiency change, all concentrations',
                annotation_row = target_all,
                annotation_col = chromatin,
                # color = colorRampPalette(c("#e07a5f", "#e5e5e5", "#3d405b"))(palette_length),
                color = diverge_hcl(palette_length, "Blue-Red"),
                annotation_colors = annotation_colors_scr_set, 
                annotation_legend = T,
                cutree_row = 5)
```


## S2B Plot postive regulator effects on different chromatin types (clusters 3, 4 and 5)
```{r S2B chromatin effect per cluster}
chromatin_ipr <- chromatin %>%
  rownames_to_column("IPR")

eff.data.heatmap3 <- eff.data.heatmap2 %>%
  pivot_longer(cols = contains("IPR"), names_to = "IPR", values_to = "freqCut_dif")

chromatin_effect <- left_join(eff.data.heatmap3, chromatin_ipr) %>%
  #filter(target == "HDAC") %>%
  mutate(freqCut_dif = ave(freqCut_dif, drug, chromatin, conc_char, FUN = function(x) mean(x, na.rm = TRUE)),
         drug_conc = paste(drug, conc_char, sep = " ")) %>%
  distinct(freqCut_dif, drug, chromatin, conc_char, target, drug_conc)

clusters_drugs = target_set_all %>% filter(clusters_drugs %in% c(3, 4))


chromatin_effect <- left_join(clusters_drugs, chromatin_effect)

ggplot(chromatin_effect,
       aes(x = chromatin, y = freqCut_dif, fill = chromatin)) +
  geom_boxplot(outlier.shape = NA) +
  geom_quasirandom() +
  geom_signif(comparisons = combn(sort(unique(chromatin_effect$chromatin)), 2, simplify = F), 
              map_signif_level=sigFunc, 
              step_increase = 0.1) +
  theme_classic_lines_45() +
  scale_fill_manual(values = group_colors) +
  theme(legend.position = "none") +
  facet_wrap(~ clusters_drugs, nrow = 1)
```

```{r}
indel.data %>% filter(filter_zscore_TIF_global_comb_rep, viab_mean > 0.75 & freqCut_diff_global < -0.08)

```

# What is causing a decrease that is not directly due to viability change?
## S2C
```{r S2C Top TIF inhibiting}
indel.data %>% 
  filter(conc_char != "control" & pathway_bal_filter & viab_reproducibility & cor_TIF_filter) %>%
  distinct(drug, conc_char, zscore_TIF_global_comb_rep , target, viab_reproducibility) %>% 
  arrange(zscore_TIF_global_comb_rep) %>%
  mutate(rank = seq(1:n()),
         drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " ")) %>%
  filter(rank < 100) %>%
  ggplot(., aes(rank, zscore_TIF_global_comb_rep , color = target)) +
  geom_point()  +
  scale_color_manual(values = colors_targets) +
  gghighlight(rank <= 10, label_key = drug_conc) +
  geom_hline(linetype = "dashed", yintercept = -2.58) +
  xlim(0, 100) +
  ylab("Global combined TIF z-score") +
  theme_classic2()

bottom_hits = indel.data  %>% 
  filter(conc_char != "control" & pathway_bal_filter & viab_reproducibility & cor_TIF_filter) %>% 
  distinct(drug, conc_char, zscore_TIF_global_comb_rep , target) %>%
  arrange(zscore_TIF_global_comb_rep) %>% 
  slice_head(n = 10) %>% 
  distinct(drug, conc_char, target, zscore_TIF_global_comb_rep ) %>% 
  mutate(rank = seq(1:n()),
         drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " "))
```

## S2C
```{r S2D}
all_compounds_lowerTIF = indel.data %>% 
  filter(conc_char != "control" & indel_freq_filter & viab_reproducibility & cor_TIF_filter) %>% 
  mutate(drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " ")) %>% 
  distinct(zscore_TIF_global_comb_rep, viab_mean, drug_conc, target, freqCut_diff_global_mean) %>%
  mutate(viab = ave(viab_mean, drug_conc, target, FUN = mean),
         TIF_diff = ave(freqCut_diff_global_mean, drug_conc, target,  FUN = mean)) %>%
  distinct(target, drug_conc, TIF_diff, viab)

indel.data %>% mutate(drug = gsub(" [(].*[)]", "", drug),
         drug_conc = paste(drug, conc_char, sep = " ")) %>% 
  filter(drug_conc %in% bottom_hits$drug_conc) %>%
  distinct(zscore_TIF_global_comb_rep, viab_mean, drug_conc, target, freqCut_diff_global_mean) %>%
  mutate(viab = ave(viab_mean, drug_conc, target, FUN = mean),
         TIF_diff = ave(freqCut_diff_global_mean, drug_conc, target,  FUN = mean)) %>%
  # group_by(drug_conc, target) %>%
  # summarise(viab_mean = mean(viab_mean),
  #           freqCut_diff_global_mean = mean(freqCut_diff_global_mean)) %>%
  ggplot(., aes(viab_mean, freqCut_diff_global_mean, color = target, alpha = 0.8)) +
  geom_point(size = 3) +
  geom_point(data = all_compounds_lowerTIF, aes(viab, TIF_diff, color = "gray70", alpha = 0.8)) +
  scale_x_continuous(labels = scales::percent) +
  scale_y_continuous(labels = scales::percent) +
  geom_point(aes(viab, TIF_diff, color = target, alpha = 1), size = 4) +
  geom_line(aes(group = drug_conc)) +
  scale_color_manual(values = 
                       annotation_colors_scr$target[names(annotation_colors_scr$target) %in%
                                                      unique(bottom_hits$target)]) +
  theme_classic2(base_size = 16) +
  geom_vline(xintercept = 0.50, color = "red", linetype="dotted") +
  annotate("rect",xmin=0,xmax=0.50,ymin=-Inf,ymax=Inf, alpha=0.05, fill="red") +
  ylab("Global TIF change") +
  xlab("Viability compared to control")
```




```{r S2D PJ34 replicates, fig.width= 6, fig.height=4}
test_drug_short = "PJ34"

drug_df <- indel.data %>%
  mutate(drug = gsub(" [(].*[)]", "", drug)) %>%
  filter(drug == test_drug_short) %>%
  distinct(drug, conc_char, replicate, freqCut_mean, freqCut_diff_mean, viab_mean, barcode)
  # distinct(drug, conc_char, replicate, tech, freqCut, freqCut_diff, viab_mean, barcode)
  # distinct(replicate, tech, conc_char, 
  #          zscore_bal_global, 
  #          zscore_bal_global_comb_tech, 
  #          zscore_bal_global_comb_rep, 
  #          filter_zscore_bal_global_comb_tech,
  #          filter_zscore_bal_global_comb_rep)
drug_wide_df = drug_df %>% 
  pivot_wider(names_from = replicate, values_from = c(freqCut_diff_mean, viab_mean, freqCut_mean))

p1 = ggplot_custom(drug_wide_df,
                aes(x = freqCut_diff_mean_E1504, y = freqCut_diff_mean_E177)) +
  geom_point() +
  geom_abline(lty = "twodash") +
  geom_smooth(method = "lm", color = "red", lty = "dashed") +
  stat_cor(method = "pearson") +
  xlab("ΔTIF E1504") +
  ylab("ΔTIF E177")  +
  facet_grid(. ~ conc_char)

p2 = ggplot_custom(drug_wide_df,
                aes(x = freqCut_mean_E1504, y = freqCut_mean_E177)) +
  geom_point() +
  geom_abline(lty = "twodash") +
  geom_smooth(method = "lm", color = "red", lty = "dashed") +
  stat_cor(method = "pearson") +
  xlab("TIF E1504") +
  ylab("TIF E177")  +
  facet_grid(. ~ conc_char)

plot_grid(p1, p2, nrow = 2)

ggplot(drug_df, 
       aes(x = replicate, y = freqCut_diff_mean)) + 
  geom_quasirandom(position=position_dodge(), aes(fill=viab_mean), shape = 21) +
  # geom_signif(comparisons = combn(sort(unique(PJ34_df$replicate)), 2, simplify = F), 
  #             map_signif_level=sigFunc, 
  #             step_increase = 0.1) +
  scale_fill_continuous_sequential(palette = "Peach", rev = TRUE) +
  scale_color_manual(values= conc_colors) +
  theme_classic_lines() +
  ylab("ΔTIF") +
  facet_grid(. ~ conc_char)
```



# Session Info
```{r}
paste("Run time: ",format(Sys.time()-StartTime))
getwd()
date()
sessionInfo()
```

