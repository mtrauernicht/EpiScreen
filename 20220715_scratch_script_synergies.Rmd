

## Are the changes in indel rate correlated with the starting indel rates?

```{r warning = FALSE}
## Add correlation with DMSO values to heatmap
dmso_freq <- indel.data %>%
  filter(drug == "DMSO") %>%
  distinct(IPR, freqCut) %>%
  mutate(freqCut = ave(freqCut, IPR, FUN = function(x) mean(x, na.rm = TRUE))) %>%
  dplyr::select('dmso_eff' = freqCut, IPR) %>%
  distinct()

corr_dmso <- merge(eff.data.heatmap, dmso_freq) %>%
  mutate(drug = gsub(" [(].*[)]", "", drug),
    drug_conc = paste(drug, conc_char, sep = " ")) %>%
  mutate(mean_effect = ave(freqCut_dif, drug, conc_char, FUN = function(x) mean(x, na.rm = TRUE))) %>%
  mutate(sign = sign(mean_effect))

## Correlation with H3K27me3 (not included in the heatmaps atm, can be added)
h3k27me3 <- indel.data %>%
  distinct(IPR, EZH2.zscore, late_replicating.zscore)

corr_dmso <- merge(corr_dmso, h3k27me3) 

corr_heatmap <- corr_dmso

for (i in unique(corr_heatmap$drug_conc)) {
  
  corr_heatmap$cor_dmso[corr_heatmap$drug_conc == i] <- 
    cor(corr_heatmap$freqCut_dif[corr_heatmap$drug_conc == i],
        corr_heatmap$dmso_eff[corr_heatmap$drug_conc == i])
  
  corr_heatmap$cor_h3k27me3[corr_heatmap$drug_conc == i] <- 
    cor(corr_heatmap$freqCut_dif[corr_heatmap$drug_conc == i],
        corr_heatmap$EZH2.zscore[corr_heatmap$drug_conc == i])
  
  corr_heatmap$cor_repl[corr_heatmap$drug_conc == i] <- 
    cor(corr_heatmap$freqCut_dif[corr_heatmap$drug_conc == i],
        corr_heatmap$late_replicating.zscore[corr_heatmap$drug_conc == i])
}

# pdf(paste0(figure_out, "rs20220214_3cluster_corr_DMSO.pdf"), width=5, height=5)
corr_heatmap %>% distinct(drug_conc, cor_dmso) %>% left_join(rownames_to_column(target, var = "drug_conc")) %>%
  ggplot(., aes(as.character(clusters_drugs), cor_dmso)) +
  geom_boxplot(outlier.shape = NA) +
  geom_quasirandom(aes(color = target, size = conc_char)) +
  scale_color_manual(values = annotation_colors_scr$target) + 
  theme_classic_lines_45() +
  theme(legend.position = "none")
# dev.off()

## Only include compounds at lowest concentration
corr_dmso <- corr_dmso %>%
  mutate(compound_n = ave(drug, drug, IPR, FUN = length))
all_conc <- corr_dmso[corr_dmso$compound_n == "3" & corr_dmso$conc_char %in% c("1 µM", "10 µM"),]
corr_dmso <- anti_join(corr_dmso, all_conc)

corr_dmso$conc <- 1
corr_dmso$conc[corr_dmso$conc_char == "1 µM"] <- 2
corr_dmso$conc[corr_dmso$conc_char == "10 µM"] <- 3

for (i in unique(corr_dmso$drug)) {
  if (corr_dmso$compound_n[corr_dmso$drug == i] == "2") {
    max_conc <- max(corr_dmso$conc[corr_dmso$compound_n == "2" & corr_dmso$drug == i])
    remove <- corr_dmso[corr_dmso$compound_n == "2" & corr_dmso$drug == i & corr_dmso$conc == max_conc,]
    corr_dmso <-anti_join(corr_dmso, remove)
  }
}

corr_dmso <- corr_dmso %>%
  dplyr::select(-compound_n, -conc)




## Calculate correlations by linear model
corr_dmso <- corr_dmso %>%
  mutate(slope_dmso = NA, p.value_dmso = NA,
          slope_h3k27me3 = NA, p.value_h3k27me3 = NA) %>%
  filter(!is.na(freqCut))

for (i in unique(corr_dmso$drug_conc)) {
    model.correlation <- lm(formula = freqCut_dif ~ dmso_eff, 
                               data = corr_dmso[corr_dmso$drug_conc == i,]) %>% 
      tidy()
    
    corr_dmso$slope_dmso[corr_dmso$drug_conc == i] <- 
      model.correlation$estimate[2]
    
    corr_dmso$p.value_dmso[corr_dmso$drug_conc == i] <- 
      model.correlation$p.value[2]
}

for (i in unique(corr_dmso$drug_conc)) {
    model.correlation <- lm(formula = freqCut_dif ~ EZH2.zscore, 
                               data = corr_dmso[corr_dmso$drug_conc == i,]) %>% 
      tidy()
    
    corr_dmso$slope_h3k27me3[corr_dmso$drug_conc == i] <- 
      model.correlation$estimate[2]
    
    corr_dmso$p.value_h3k27me3[corr_dmso$drug_conc == i] <- 
      model.correlation$p.value[2]
}



corr_dmso <- corr_dmso %>%
  mutate(p.value_dmso = p.adjust(p.value_dmso, method = "fdr")) #%>%
  # mutate(p.value_h3k27me3 = p.adjust(p.value_h3k27me3, method = "fdr"))

ggplot(corr_dmso %>%
         filter(abs(mean_effect) > 0.025) %>%
         filter(sign == 1) %>%
         distinct(p.value_dmso, drug_conc, sign, target, conc_char),
       aes(y = -log10(p.value_dmso), x = target, 
           #color = as.character(sign), 
           shape = ifelse(p.value_dmso < 0.01, "1", "2"))) +
  geom_quasirandom() +
  #scale_color_manual(values = c("#e07a5f", "#3d405b")) +
  theme_classic_lines_90() +
  geom_hline(yintercept = -log10(0.01), lty = "dashed") #+
  #facet_wrap(~sign, nrow = 2)
  
corr_hits <- corr_dmso %>% filter(drug_conc %in% c("PCI-24781 (Abexinostat) 100 nM", "Fluoro-SAHA 1 µM")) 

corr_h3k27me3_hits <- corr_dmso %>% filter(drug %in% c("EPZ-6438"))
corr_hits <- merge(corr_hits, chromatin)

ggplot(corr_hits %>%
         mutate(freqCut = dmso_eff + freqCut_dif)) +
  geom_abline(lty = "twodash", slope = 1) +
  geom_hline(yintercept = max(dmso_freq$dmso_eff)*100, lty = "dashed") + 
  geom_point(aes(y = freqCut*100, x = dmso_eff*100, fill = chromatin), color = ifelse(corr_hits$freqCut_dif > 0.02, "red", "black"), shape = 21, size = 3) +
  #scale_color_manual(values = c("#e07a5f", "#3d405b")) +
  #stat_cor(method = "pearson") +
  #annotate("rect",xmin=(dmso_freq$dmso_eff + 0.02),xmax=unique(indel.data.freq$max_dmso_freq),ymin=-log10(0.05),ymax=Inf, alpha=0.1, fill="#e07a5f") +
  facet_wrap(~drug_conc) +
  scale_fill_manual(values = chrom_colors) 


ggplot(corr_h3k27me3_hits,
       aes(y = freqCut_dif, x = EZH2.zscore, color = ifelse(sign == 1, "red", "black"))) +
  geom_point() +
  geom_smooth(method = "lm", lty = "dashed") +
  scale_color_manual(values = c("#e07a5f", "#3d405b")) +
  stat_cor(method = "pearson") +
  facet_wrap(~conc_char, scales = "free_y")


# Drug-induced changes per chromatin type
chrom_corr <- indel.data %>%
  distinct(drug, conc_char, freqCut_norm_mean, IPR, target) %>%
  mutate(drug_conc = paste(drug, conc_char, sep = "_"))

drugs_sel <- corr_dmso %>%
  filter(abs(mean_effect) > 0.025) %>%
  #filter(sign == 1) %>%
  distinct(drug_conc, p.value_dmso, p.value_h3k27me3, slope_h3k27me3, sign)

chrom_corr <- merge(chrom_corr, drugs_sel)

chrom_corr$global <- "no"
chrom_corr$global[abs(chrom_corr$p.value_dmso) < 0.01] <- "yes"

ggplot(chrom_corr %>%
         filter(sign == 1) %>%
         filter(target == "HDAC") %>%
         distinct(drug_conc, p.value_dmso, p.value_h3k27me3, target, global, sign),
       aes(x = global, y = -log10(p.value_h3k27me3), shape = ifelse(p.value_h3k27me3 < 0.05, "1", "2"))) +
  #geom_boxplot(outlier.shape = NA) +
  geom_hline(yintercept = -log10(0.05), lty = "dashed") +
  geom_quasirandom() #+
  #facet_wrap(~target) 
```

*Figure 2C: Heatmap of cutting efficiency change induced by HDAC inhibitors at 19 genomic locations.*

**Conclusion: Many different HDAC inhibitors can change cutting efficiency locally. As expected, heterochromatin is more prone to an increase in cutting efficiency.**

## Epistasis per cluster
```{r}
drug_clusters <- eff.data.heatmap2.clusters %>%
  mutate(drug_conc = paste(drug, conc_char, sep = "_")) %>%
  distinct(drug_conc, clusters_drugs, target)

epistasis_cluster <- epistasis_tib %>%
  distinct(drug_conc, feature, indelrate_slope) %>%
  mutate(drug_conc = gsub(" [(].*[)]", "", drug_conc)) %>%
  left_join(drug_clusters) %>%
  na.omit() %>%
  mutate(clusters_drugs = as.character(clusters_drugs)) %>%
  filter(target == "Aurora Kinase")# %>%
  #filter(clusters_drugs %in% c('4','2','5','7'))

ggplot(epistasis_cluster,
       aes(x = clusters_drugs, y = indelrate_slope)) +
  geom_quasirandom() +
  facet_wrap(~feature)

 





epistasis_cluster <- epistasis_cluster %>%
  #filter(feature %in% c("HDAC1.zscore", "HDAC2.zscore", "LMNB1.zscore", "EZH2.zscore")) %>%
  spread(feature, indelrate_slope)

rownames(drug_clusters) <- drug_clusters$drug_conc
drug_clusters <- drug_clusters %>%
  mutate(clusters_drugs = as.character(clusters_drugs)) %>%
  dplyr::select(-drug_conc, -target)

pheatmap(epistasis_cluster %>%
           column_to_rownames(var = "drug_conc") %>%
           dplyr::select(contains("zscore")),
         cluster_rows = T,
         cluster_cols = T,
         cellwidth = 8,
         cellheight = 8,
         annotation_row = drug_clusters,
         annotation_colors = annotation_colors_scr,
         border_color = NA,
         color = colorRampPalette(c("#8c510a", "#f5f5f5","#01665e"))(palette_length))

```




## UMAP
```{r}
eff.data.heatmap3 <- eff.data.heatmap2.clusters %>%
  mutate(drug_conc = paste(drug, conc_char, sep = "_"))

umap_df <- indel.data %>% 
  distinct(freqCut, drug, conc_char, IPR, target) %>% 
  mutate(freqCut = ave(freqCut, drug, conc_char, IPR, FUN = function(x) mean(x, na.rm = TRUE))) %>% 
  mutate(drug_conc = paste(drug, conc_char, sep = "_")) %>%
  filter(drug_conc %in% eff.data.heatmap3$drug_conc) %>%
  distinct(drug_conc, target, freqCut, IPR) %>%
  spread(IPR, freqCut)

epistasis_umap <- epistasis_tib %>%
  distinct(drug_conc, feature, indelrate_slope) %>%
  spread(feature, indelrate_slope) %>%
  distinct()

targets <- indel.data %>%
  mutate(drug_conc = paste(drug, conc_char, sep = "_")) %>%
  distinct(drug_conc, target)

epistasis_umap <- merge(epistasis_umap, targets) %>%
  filter(target == "HDAC")

umap_df_umap <- umap::umap(epistasis_umap %>% dplyr::select(contains("zscore")))

layout <- umap_df_umap[["layout"]] 
layout <- data.frame(layout) 
final <- cbind(layout, 'drug_conc' = epistasis_umap$drug_conc, 'target' = epistasis_umap$target, 'EZH2.zscore' = epistasis_umap$EZH2.zscore)

ggplot(final,
       aes(x = X1, y = X2, color = EZH2.zscore)) +
  geom_point() +
  scale_color_viridis()

```




## SA: Correlation of cutting efficiency between replicates of significant hits
We know that the cutting efficiency does not correlate well if all data is taken. However, because of the high noise level and the low effect size of the efficiency changes, it makes more sense to only investigate whether significant hits are robust throughout all replicates. 
```{r warning = FALSE}
# SA: Correlation between technical replicates efficiency: only significant hits
# significant_hits_efficiency <- eff.data %>%
#   filter(pval_adj < 0.05) %>%
#   distinct(drug, conc_char, IPR) %>%
#   mutate(drug_conc = paste(drug, conc_char, IPR, paste = "_"))

# techn_repl <- indel.data %>%
#   mutate(drug_conc = paste(drug, conc_char, IPR, paste = "_")) %>%
#   #filter(drug_conc %in% significant_hits_efficiency$drug_conc) %>%
#   dplyr::distinct(freqCut_norm, drug, tech, replicate, conc_char, sample, IPR) %>%
#   mutate(freqCut_norm = log2(ave(freqCut_norm, drug, tech, replicate, conc_char, IPR, FUN = function(x) mean(x, na.rm = TRUE)))) %>%
#   unique() %>%
#   mutate(rep = paste(replicate, tech, sep = "_")) %>%
#   dplyr::select(-replicate, -tech) %>%
#   mutate(max = ave(freqCut_norm, drug, conc_char, IPR, FUN = max),
#          min = ave(freqCut_norm, drug, conc_char, IPR, FUN = min)) %>%
#   distinct() %>%
#   spread(rep, freqCut_norm) %>%
#   na.omit() 
#   
# techn_repl$large_effect <- "1_no"
# techn_repl$large_effect[techn_repl$max > 0.3 | techn_repl$min < -0.3] <- "0_yes"
# 
# ggpairs(techn_repl %>% 
#        #filter(conc_char == "1 µM") %>% #1 µM
#        # filter(drug %in% c("Vorinostat (SAHA, MK0683)", "Scriptaid",   "Decitabine" , "(+)-JQ1" ,  "PCI-24781 (Abexinostat)")) %>%
#           dplyr::select(contains("E1")),
#        mapping = aes(color = techn_repl$large_effect),
#                upper = list(continuous = corColor),
#                lower = list(continuous = function(data, mapping, ...) {
#                    ggally_points(data = data, mapping = mapping, alpha = 0.5, size = 0.2) +
#                    geom_abline(slope = 1, lty = "dashed", col = "red")}),
#                diag = list(continuous = function(data, mapping, ...) {
#                    ggally_densityDiag(data = data, mapping = mapping, alpha = 0.3, fill = "red")})) +
#   # xlim(.4, .7) + 
#   xlab("Cutting efficiency") +
#   ylab("Cutting efficiency") +
#   scale_color_manual(values = colors_diverse)
```

## Are the changes in indel rate correlated with the starting indel rates?

```{r warning = FALSE}
## Add correlation with DMSO values to heatmap
dmso_freq <- indel.data %>%
  filter(drug == "DMSO") %>%
  distinct(IPR, freqCut) %>%
  mutate(freqCut = ave(freqCut, IPR, FUN = function(x) mean(x, na.rm = TRUE))) %>%
  dplyr::select('dmso_eff' = freqCut, IPR) %>%
  distinct()

corr_dmso <- merge(eff.data.heatmap, dmso_freq) %>%
  mutate(drug = gsub(" [(].*[)]", "", drug),
    drug_conc = paste(drug, conc_char, sep = " ")) %>%
  mutate(mean_effect = ave(freqCut_dif, drug, conc_char, FUN = function(x) mean(x, na.rm = TRUE))) %>%
  mutate(sign = sign(mean_effect))

## Correlation with H3K27me3 (not included in the heatmaps atm, can be added)
h3k27me3 <- indel.data %>%
  distinct(IPR, EZH2.zscore, late_replicating.zscore)

corr_dmso <- merge(corr_dmso, h3k27me3) 

corr_heatmap <- corr_dmso

for (i in unique(corr_heatmap$drug_conc)) {
  
  corr_heatmap$cor_dmso[corr_heatmap$drug_conc == i] <- 
    cor(corr_heatmap$freqCut_dif[corr_heatmap$drug_conc == i],
        corr_heatmap$dmso_eff[corr_heatmap$drug_conc == i])
  
  corr_heatmap$cor_h3k27me3[corr_heatmap$drug_conc == i] <- 
    cor(corr_heatmap$freqCut_dif[corr_heatmap$drug_conc == i],
        corr_heatmap$EZH2.zscore[corr_heatmap$drug_conc == i])
  
  corr_heatmap$cor_repl[corr_heatmap$drug_conc == i] <- 
    cor(corr_heatmap$freqCut_dif[corr_heatmap$drug_conc == i],
        corr_heatmap$late_replicating.zscore[corr_heatmap$drug_conc == i])
}

# pdf(paste0(figure_out, "rs20220214_3cluster_corr_DMSO.pdf"), width=5, height=5)
corr_heatmap %>% distinct(drug_conc, cor_dmso) %>% left_join(rownames_to_column(target, var = "drug_conc")) %>%
  ggplot(., aes(as.character(clusters_drugs), cor_dmso)) +
  geom_boxplot(outlier.shape = NA) +
  geom_quasirandom(aes(color = target, size = conc_char)) +
  scale_color_manual(values = annotation_colors_scr$target) + 
  theme_classic_lines_45() +
  theme(legend.position = "none")
# dev.off()

## Only include compounds at lowest concentration
corr_dmso <- corr_dmso %>%
  mutate(compound_n = ave(drug, drug, IPR, FUN = length))
all_conc <- corr_dmso[corr_dmso$compound_n == "3" & corr_dmso$conc_char %in% c("1 µM", "10 µM"),]
corr_dmso <- anti_join(corr_dmso, all_conc)

corr_dmso$conc <- 1
corr_dmso$conc[corr_dmso$conc_char == "1 µM"] <- 2
corr_dmso$conc[corr_dmso$conc_char == "10 µM"] <- 3

for (i in unique(corr_dmso$drug)) {
  if (corr_dmso$compound_n[corr_dmso$drug == i] == "2") {
    max_conc <- max(corr_dmso$conc[corr_dmso$compound_n == "2" & corr_dmso$drug == i])
    remove <- corr_dmso[corr_dmso$compound_n == "2" & corr_dmso$drug == i & corr_dmso$conc == max_conc,]
    corr_dmso <-anti_join(corr_dmso, remove)
  }
}

corr_dmso <- corr_dmso %>%
  dplyr::select(-compound_n, -conc)




## Calculate correlations by linear model
corr_dmso <- corr_dmso %>%
  mutate(slope_dmso = NA, p.value_dmso = NA,
          slope_h3k27me3 = NA, p.value_h3k27me3 = NA) %>%
  filter(!is.na(freqCut))

for (i in unique(corr_dmso$drug_conc)) {
    model.correlation <- lm(formula = freqCut_dif ~ dmso_eff, 
                               data = corr_dmso[corr_dmso$drug_conc == i,]) %>% 
      tidy()
    
    corr_dmso$slope_dmso[corr_dmso$drug_conc == i] <- 
      model.correlation$estimate[2]
    
    corr_dmso$p.value_dmso[corr_dmso$drug_conc == i] <- 
      model.correlation$p.value[2]
}

for (i in unique(corr_dmso$drug_conc)) {
    model.correlation <- lm(formula = freqCut_dif ~ EZH2.zscore, 
                               data = corr_dmso[corr_dmso$drug_conc == i,]) %>% 
      tidy()
    
    corr_dmso$slope_h3k27me3[corr_dmso$drug_conc == i] <- 
      model.correlation$estimate[2]
    
    corr_dmso$p.value_h3k27me3[corr_dmso$drug_conc == i] <- 
      model.correlation$p.value[2]
}



corr_dmso <- corr_dmso %>%
  mutate(p.value_dmso = p.adjust(p.value_dmso, method = "fdr")) #%>%
  # mutate(p.value_h3k27me3 = p.adjust(p.value_h3k27me3, method = "fdr"))

ggplot(corr_dmso %>%
         filter(abs(mean_effect) > 0.025) %>%
         filter(sign == 1) %>%
         distinct(p.value_dmso, drug_conc, sign, target, conc_char),
       aes(y = -log10(p.value_dmso), x = target, 
           #color = as.character(sign), 
           shape = ifelse(p.value_dmso < 0.01, "1", "2"))) +
  geom_quasirandom() +
  #scale_color_manual(values = c("#e07a5f", "#3d405b")) +
  theme_classic_lines_90() +
  geom_hline(yintercept = -log10(0.01), lty = "dashed") #+
  #facet_wrap(~sign, nrow = 2)
  
corr_hits <- corr_dmso %>% filter(drug_conc %in% c("PCI-24781 (Abexinostat) 100 nM", "Fluoro-SAHA 1 µM")) 

corr_h3k27me3_hits <- corr_dmso %>% filter(drug %in% c("EPZ-6438"))
corr_hits <- merge(corr_hits, chromatin)

ggplot(corr_hits %>%
         mutate(freqCut = dmso_eff + freqCut_dif)) +
  geom_abline(lty = "twodash", slope = 1) +
  geom_hline(yintercept = max(dmso_freq$dmso_eff)*100, lty = "dashed") + 
  geom_point(aes(y = freqCut*100, x = dmso_eff*100, fill = chromatin), color = ifelse(corr_hits$freqCut_dif > 0.02, "red", "black"), shape = 21, size = 3) +
  #scale_color_manual(values = c("#e07a5f", "#3d405b")) +
  #stat_cor(method = "pearson") +
  #annotate("rect",xmin=(dmso_freq$dmso_eff + 0.02),xmax=unique(indel.data.freq$max_dmso_freq),ymin=-log10(0.05),ymax=Inf, alpha=0.1, fill="#e07a5f") +
  facet_wrap(~drug_conc) +
  scale_fill_manual(values = chrom_colors) 


ggplot(corr_h3k27me3_hits,
       aes(y = freqCut_dif, x = EZH2.zscore, color = ifelse(sign == 1, "red", "black"))) +
  geom_point() +
  geom_smooth(method = "lm", lty = "dashed") +
  scale_color_manual(values = c("#e07a5f", "#3d405b")) +
  stat_cor(method = "pearson") +
  facet_wrap(~conc_char, scales = "free_y")


# Drug-induced changes per chromatin type
chrom_corr <- indel.data %>%
  distinct(drug, conc_char, freqCut_norm_mean, IPR, target) %>%
  mutate(drug_conc = paste(drug, conc_char, sep = "_"))

drugs_sel <- corr_dmso %>%
  filter(abs(mean_effect) > 0.025) %>%
  #filter(sign == 1) %>%
  distinct(drug_conc, p.value_dmso, p.value_h3k27me3, slope_h3k27me3, sign)

chrom_corr <- merge(chrom_corr, drugs_sel)

chrom_corr$global <- "no"
chrom_corr$global[abs(chrom_corr$p.value_dmso) < 0.01] <- "yes"

ggplot(chrom_corr %>%
         filter(sign == 1) %>%
         filter(target == "HDAC") %>%
         distinct(drug_conc, p.value_dmso, p.value_h3k27me3, target, global, sign),
       aes(x = global, y = -log10(p.value_h3k27me3), shape = ifelse(p.value_h3k27me3 < 0.05, "1", "2"))) +
  #geom_boxplot(outlier.shape = NA) +
  geom_hline(yintercept = -log10(0.05), lty = "dashed") +
  geom_quasirandom() #+
  #facet_wrap(~target) 
```

*Figure 2C: Heatmap of cutting efficiency change induced by HDAC inhibitors at 19 genomic locations.*

**Conclusion: Many different HDAC inhibitors can change cutting efficiency locally. As expected, heterochromatin is more prone to an increase in cutting efficiency.**

## Epistasis per cluster
```{r}
drug_clusters <- eff.data.heatmap2.clusters %>%
  mutate(drug_conc = paste(drug, conc_char, sep = "_")) %>%
  distinct(drug_conc, clusters_drugs, target)

epistasis_cluster <- epistasis_tib %>%
  distinct(drug_conc, feature, indelrate_slope) %>%
  mutate(drug_conc = gsub(" [(].*[)]", "", drug_conc)) %>%
  left_join(drug_clusters) %>%
  na.omit() %>%
  mutate(clusters_drugs = as.character(clusters_drugs)) %>%
  filter(target == "Aurora Kinase")# %>%
  #filter(clusters_drugs %in% c('4','2','5','7'))

ggplot(epistasis_cluster,
       aes(x = clusters_drugs, y = indelrate_slope)) +
  geom_quasirandom() +
  facet_wrap(~feature)

 





epistasis_cluster <- epistasis_cluster %>%
  #filter(feature %in% c("HDAC1.zscore", "HDAC2.zscore", "LMNB1.zscore", "EZH2.zscore")) %>%
  spread(feature, indelrate_slope)

rownames(drug_clusters) <- drug_clusters$drug_conc
drug_clusters <- drug_clusters %>%
  mutate(clusters_drugs = as.character(clusters_drugs)) %>%
  dplyr::select(-drug_conc, -target)

pheatmap(epistasis_cluster %>%
           column_to_rownames(var = "drug_conc") %>%
           dplyr::select(contains("zscore")),
         cluster_rows = T,
         cluster_cols = T,
         cellwidth = 8,
         cellheight = 8,
         annotation_row = drug_clusters,
         annotation_colors = annotation_colors_scr,
         border_color = NA,
         color = colorRampPalette(c("#8c510a", "#f5f5f5","#01665e"))(palette_length))

```




## UMAP
```{r}
eff.data.heatmap3 <- eff.data.heatmap2.clusters %>%
  mutate(drug_conc = paste(drug, conc_char, sep = "_"))

umap_df <- indel.data %>% 
  distinct(freqCut, drug, conc_char, IPR, target) %>% 
  mutate(freqCut = ave(freqCut, drug, conc_char, IPR, FUN = function(x) mean(x, na.rm = TRUE))) %>% 
  mutate(drug_conc = paste(drug, conc_char, sep = "_")) %>%
  filter(drug_conc %in% eff.data.heatmap3$drug_conc) %>%
  distinct(drug_conc, target, freqCut, IPR) %>%
  spread(IPR, freqCut)

epistasis_umap <- epistasis_tib %>%
  distinct(drug_conc, feature, indelrate_slope) %>%
  spread(feature, indelrate_slope) %>%
  distinct()

targets <- indel.data %>%
  mutate(drug_conc = paste(drug, conc_char, sep = "_")) %>%
  distinct(drug_conc, target)

epistasis_umap <- merge(epistasis_umap, targets) %>%
  filter(target == "HDAC")

umap_df_umap <- umap::umap(epistasis_umap %>% dplyr::select(contains("zscore")))

layout <- umap_df_umap[["layout"]] 
layout <- data.frame(layout) 
final <- cbind(layout, 'drug_conc' = epistasis_umap$drug_conc, 'target' = epistasis_umap$target, 'EZH2.zscore' = epistasis_umap$EZH2.zscore)

ggplot(final,
       aes(x = X1, y = X2, color = EZH2.zscore)) +
  geom_point() +
  scale_color_viridis()

```



# KDM6A/B KNOCKDOWN
```{r}
indel.validation.data %>% 
  filter(siRNA != "-" & replicate != "mean", plasmid == "LBR2") %>% 
  distinct(replicate, siRNA, barcode, efficiency, MMEJ_NHEJ) %>% 
  pivot_longer(cols = c("efficiency", "MMEJ_NHEJ")) %>% 
  ggplot(., aes(name, value, color = siRNA)) + 
  geom_quasirandom(position = "dodge", dodge.width = 1) +
  facet_grid(. ~ replicate)

bc_IPR = indel.data %>% distinct(barcode, IPR)

control.KDM.KD = indel.validation.data %>% 
  filter(siRNA == "siNT" & replicate != "mean", plasmid == "LBR2") %>%
  distinct(replicate, barcode, efficiency, MMEJ_NHEJ) %>%
  mutate(barcode = gsub("[.]B", "", barcode)) %>%
  left_join(bc_IPR) %>%
  filter(!is.na(IPR)) %>% # remove the 19th IPR just to match the rest
  dplyr::rename(CTRL_TIF = efficiency, CTRL_bal = MMEJ_NHEJ)
 
KDM6_KD = indel.validation.data %>% 
  filter(siRNA != "-" & replicate != "mean", plasmid == "LBR2"
         ) %>%
  distinct(replicate, barcode, siRNA, efficiency, MMEJ_NHEJ) %>%
  mutate(barcode = gsub("[.]B", "", barcode)) %>%
  left_join(control.KDM.KD) %>%
  filter(!is.na(IPR)) %>% 
    mutate(diff_TIF = efficiency - CTRL_TIF,
         ratio_TIF = efficiency/CTRL_TIF,
         log2_FC_TIF = log2(ratio_TIF),
         diff_MMEJ_NHEJ = MMEJ_NHEJ - CTRL_bal,
         ratio_MMEJ_NHEJ = MMEJ_NHEJ/CTRL_bal,
         log2_FC_MMEJ_NHEJ = log2(ratio_MMEJ_NHEJ)) %>%
  filter(diff_TIF != 0)


P1 = ggplot(KDM6_KD, aes(IPR, log2_FC_MMEJ_NHEJ, fill = replicate)) + 
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(. ~ siRNA) +
  theme_classic() + 
  ggtitle("Log2 FC MMEJ balance") +
  theme(legend.position = "none")

P2 =ggplot(KDM6_KD, aes(IPR, log2_FC_TIF, fill = replicate)) + 
  geom_bar(stat = "identity", position = "dodge") +
  facet_grid(. ~ siRNA) +
  theme_classic() + 
  ggtitle("Log2 FC TIF balance") +
  theme(legend.position = "none")

plot_grid(P1, P2)
ggsave("/DATA/projects/DSBrepair/git/EpiScreen/figures/rs20220811_KDM6AB_KD_replicates.pdf")
```



## SA: Correlation of cutting efficiency between replicates of significant hits
We know that the cutting efficiency does not correlate well if all data is taken. However, because of the high noise level and the low effect size of the efficiency changes, it makes more sense to only investigate whether significant hits are robust throughout all replicates. 
```{r warning = FALSE}
# SA: Correlation between technical replicates efficiency: only significant hits
# significant_hits_efficiency <- eff.data %>%
#   filter(pval_adj < 0.05) %>%
#   distinct(drug, conc_char, IPR) %>%
#   mutate(drug_conc = paste(drug, conc_char, IPR, paste = "_"))

# techn_repl <- indel.data %>%
#   mutate(drug_conc = paste(drug, conc_char, IPR, paste = "_")) %>%
#   #filter(drug_conc %in% significant_hits_efficiency$drug_conc) %>%
#   dplyr::distinct(freqCut_norm, drug, tech, replicate, conc_char, sample, IPR) %>%
#   mutate(freqCut_norm = log2(ave(freqCut_norm, drug, tech, replicate, conc_char, IPR, FUN = function(x) mean(x, na.rm = TRUE)))) %>%
#   unique() %>%
#   mutate(rep = paste(replicate, tech, sep = "_")) %>%
#   dplyr::select(-replicate, -tech) %>%
#   mutate(max = ave(freqCut_norm, drug, conc_char, IPR, FUN = max),
#          min = ave(freqCut_norm, drug, conc_char, IPR, FUN = min)) %>%
#   distinct() %>%
#   spread(rep, freqCut_norm) %>%
#   na.omit() 
#   
# techn_repl$large_effect <- "1_no"
# techn_repl$large_effect[techn_repl$max > 0.3 | techn_repl$min < -0.3] <- "0_yes"
# 
# ggpairs(techn_repl %>% 
#        #filter(conc_char == "1 µM") %>% #1 µM
#        # filter(drug %in% c("Vorinostat (SAHA, MK0683)", "Scriptaid",   "Decitabine" , "(+)-JQ1" ,  "PCI-24781 (Abexinostat)")) %>%
#           dplyr::select(contains("E1")),
#        mapping = aes(color = techn_repl$large_effect),
#                upper = list(continuous = corColor),
#                lower = list(continuous = function(data, mapping, ...) {
#                    ggally_points(data = data, mapping = mapping, alpha = 0.5, size = 0.2) +
#                    geom_abline(slope = 1, lty = "dashed", col = "red")}),
#                diag = list(continuous = function(data, mapping, ...) {
#                    ggally_densityDiag(data = data, mapping = mapping, alpha = 0.3, fill = "red")})) +
#   # xlim(.4, .7) + 
#   xlab("Cutting efficiency") +
#   ylab("Cutting efficiency") +
#   scale_color_manual(values = colors_diverse)
```